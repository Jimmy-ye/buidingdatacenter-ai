# BDC-AI 开发服务管理方案

## 问题总结

### 为什么会出现两个进程监听同一端口？

1. **进程未完全终止**：Windows 上进程终止需要时间
2. **端口释放延迟**：TCP 连接有 TIME_WAIT 状态（通常 2-4 分钟）
3. **手动管理困难**：每次修改代码都要手动查找并停止进程

### 开发阶段的痛点

- 代码修改频繁，需要反复重启服务
- 手动管理进程容易出错
- 多个进程占用同一端口导致冲突
- 难以追踪哪些进程在运行

---

## 解决方案

我已经为您创建了以下工具：

### 1. Python 服务管理工具（推荐）

**文件**: `stop_services.py`

**使用方法**:

```bash
# 查看服务状态
python stop_services.py status

# 停止所有服务
python stop_services.py stop

# 停止指定服务
python stop_services.py stop --service backend  # 停止后端
python stop_services.py stop --service pcui     # 停止 PC UI

# 重启服务（在终端中运行，会保持运行）
python stop_services.py restart --service backend
python stop_services.py restart --service pcui
```

**优点**:
- 跨平台兼容
- 智能检测端口占用
- 安全停止进程
- 清晰的状态显示

---

### 2. Windows 批处理脚本

**文件**:
- `restart_backend.bat` - 后端服务启动器
- `restart_pc_ui.bat` - PC UI 启动器
- `start_all.bat` - 同时启动前后端（推荐）
- `stop_all.bat` - 停止所有服务

**使用方法**:
双击 `.bat` 文件即可运行

**优点**:
- 一键启动，无需记忆命令
- 自动停止旧进程
- 独立窗口，日志清晰

---

### 3. 自动重载功能

**后端服务**（已启用）:
```bash
python -m uvicorn services.backend.app.main:app --reload
```
保存 Python 文件后自动重载，无需重启！

**PC UI 服务**:
目前 NiceGUI 不支持完全自动重载，需要：
1. 关闭 PC UI 窗口（Ctrl+C 或关闭窗口）
2. 重新运行启动脚本
3. 浏览器按 F5 刷新

---

## 推荐开发工作流

### 方案 A：使用批处理脚本（最简单）

1. **启动开发环境**:
   ```
   双击: start_all.bat
   ```

2. **修改后端代码**:
   - 保存文件
   - 后端窗口自动显示 "Reloading..."
   - 浏览器刷新测试

3. **修改 PC UI 代码**:
   - 关闭 PC UI 窗口
   - 双击: `desktop\nicegui_app\restart_pc_ui.bat`
   - 浏览器按 F5

4. **结束开发**:
   - 关闭两个服务窗口（Ctrl+C）
   - 或双击: `stop_all.bat`

---

### 方案 B：使用 Python 工具（推荐）

1. **查看当前状态**:
   ```bash
   python stop_services.py status
   ```

2. **启动后端**（终端 1）:
   ```bash
   python stop_services.py start --service backend
   ```

3. **启动 PC UI**（终端 2）:
   ```bash
   python stop_services.py start --service pcui
   ```

4. **修改代码后重启**:
   ```bash
   # 重启后端
   python stop_services.py restart --service backend

   # 重启 PC UI
   python stop_services.py restart --service pcui
   ```

---

## 快速命令参考

### 手动管理（当脚本无法使用时）

```bash
# 查看端口占用
netstat -ano | findstr ":8000"
netstat -ano | findstr ":8080"

# 停止指定进程
taskkill /F /PID <进程ID>

# 使用 Python 停止进程（跨平台）
python -c "import subprocess; subprocess.run(['taskkill', '/F', '/PID', '<进程ID>'])"
```

---

## 常见问题解决

### Q1: 两个进程监听同一端口怎么办？

**方法 1**（推荐）:
```bash
python stop_services.py stop --service pcui
```

**方法 2**（手动）:
```bash
# 查找占用端口的进程
netstat -ano | findstr ":8080"

# 记下 PID，然后逐个停止
taskkill /F /PID <PID1>
taskkill /F /PID <PID2>
```

---

### Q2: 脚本提示 "无法停止进程"

**原因**: 进程可能正在执行关键操作，或权限不足

**解决**:
1. 以管理员身份运行命令提示符
2. 或关闭对应的服务窗口
3. 或使用任务管理器结束进程

---

### Q3: 修改代码后服务没有更新

**后端**: 检查后端窗口是否显示 "Reloading..."
- 如果没有，手动重启后端服务

**PC UI**: 需要完全重启
1. 关闭 PC UI 窗口
2. 重新运行启动脚本
3. 浏览器强制刷新（Ctrl+Shift+R）

---

### Q4: 端口一直被占用

**彻底清理**:
```bash
# 停止所有相关服务
python stop_services.py stop

# 等待 5 秒
timeout /t 5

# 检查状态
python stop_services.py status

# 如果仍有进程，使用任务管理器手动结束
```

---

## 文件清单

### Python 脚本
- `stop_services.py` - 服务管理工具（推荐）

### 批处理脚本
- `restart_backend.bat` - 后端启动器
- `restart_pc_ui.bat` - PC UI 启动器
- `start_all.bat` - 一键启动所有服务
- `stop_all.bat` - 一键停止所有服务

### 文档
- `desktop/nicegui_app/开发启动指南.md` - 详细使用指南

---

## 下一步优化建议

### 1. 添加 Watchdog 自动重载

可以使用 `watchdog` 库监控文件变化，自动重启 PC UI：

```python
# 安装
pip install watchdog

# 创建自动重载脚本
# watchdog 监控 pc_app.py 修改，自动重启服务
```

### 2. 使用进程管理器

- **PM2** (Node.js 生态，也支持 Python)
- **Honcho** / **Foreman** (Procfile 管理工具)
- **systemd service** (Linux 生产环境)

### 3. Docker 容器化

```
docker-compose up --build  # 自动重启所有服务
```

---

## 总结

**当前最佳实践**:

1. **日常开发**: 双击 `start_all.bat` 启动所有服务
2. **后端修改**: 保存后自动重载（uvicorn --reload）
3. **PC UI 修改**: 关闭窗口后重新运行 `restart_pc_ui.bat`
4. **问题排查**: 使用 `python stop_services.py status` 查看状态
5. **强制清理**: 双击 `stop_all.bat` 或手动 taskkill

这样可以大大减少手动管理进程的麻烦，专注于代码开发！
