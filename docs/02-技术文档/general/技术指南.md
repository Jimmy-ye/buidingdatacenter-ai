# æŠ€æœ¯è§£ææ–‡æ¡£

æœ¬æ–‡æ¡£é›†åˆç”¨äºæ·±å…¥è§£æé¡¹ç›®ä¸­å„ä¸ªæ¨¡å—çš„å·¥ä½œåŸç†ã€æŠ€æœ¯ç»†èŠ‚å’Œå®é™…åº”ç”¨ã€‚

---

## ç›®å½•

1. [Backend éª¨æ¶è¯¦è§£](#backend-éª¨æ¶è¯¦è§£)
   - [æ ¸å¿ƒç»„æˆ](#æ ¸å¿ƒç»„æˆ)
   - [ä¾èµ–åº“è¯¦è§£](#ä¾èµ–åº“è¯¦è§£)
   - [å·¥ä½œæµç¨‹](#å·¥ä½œæµç¨‹)
   - [ä»£ç å±‚é¢è§£æ](#ä»£ç å±‚é¢è§£æ)
   - [å®é™…åº”ç”¨åœºæ™¯](#å®é™…åº”ç”¨åœºæ™¯)
   - [éª¨æ¶çš„è§’è‰²å®šä½](#éª¨æ¶çš„è§’è‰²å®šä½)

2. [å¤šæ¨¡æ€æ•°æ®å¤„ç†è¯¦è§£](#å¤šæ¨¡æ€æ•°æ®å¤„ç†è¯¦è§£)
   - [æ ¸å¿ƒç»„æˆ](#æ ¸å¿ƒç»„æˆ-1)
   - [ä¾èµ–åº“è¯¦è§£](#ä¾èµ–åº“è¯¦è§£-1)
   - [OCR å›¾ç‰‡è¯†åˆ«æµç¨‹](#ocr-å›¾ç‰‡è¯†åˆ«æµç¨‹)
   - [GLM-4V åœºæ™¯é—®é¢˜åˆ†ææµç¨‹](#glm-4v-åœºæ™¯é—®é¢˜åˆ†ææµç¨‹)
   - [ä»£ç å±‚é¢è§£æ](#ä»£ç å±‚é¢è§£æ-1)
   - [å®é™…åº”ç”¨åœºæ™¯](#å®é™…åº”ç”¨åœºæ™¯-1)
   - [å¸¸è§é—®é¢˜ä¸è§£å†³](#å¸¸è§é—®é¢˜ä¸è§£å†³)

---

# Backend éª¨æ¶è¯¦è§£

## ğŸ“– æ¦‚è¿°

Backend éª¨æ¶æ˜¯æ•´ä¸ª BDC-AI é¡¹ç›®çš„**åŸºç¡€è®¾æ–½å’Œæ ¸å¿ƒæ¡†æ¶**ï¼Œå°±åƒå»ºç­‘çš„åœ°åŸºå’Œæ¡†æ¶ï¼Œä¸ºæ‰€æœ‰ä¸šåŠ¡åŠŸèƒ½æä¾›æ”¯æ’‘ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- âœ… æä¾›ç¨³å®šçš„ Web æœåŠ¡èƒ½åŠ›
- âœ… æä¾›æ•°æ®åº“è¿æ¥å’Œ ORM æ”¯æŒ
- âœ… æä¾›é…ç½®ç®¡ç†å’Œç¯å¢ƒé€‚é…
- âœ… æä¾›è§„èŒƒçš„ä»£ç ç»“æ„
- âœ… æ”¯æŒå¿«é€Ÿæ‰©å±•æ–°åŠŸèƒ½

---

## æ ¸å¿ƒç»„æˆ

### é¡¹ç›®ç»“æ„

```
services/backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py              # FastAPI åº”ç”¨å…¥å£ï¼ˆæ€»ç»ç†ï¼‰
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ v1/
â”‚           â”œâ”€â”€ health.py    # API è·¯ç”±ï¼ˆæœåŠ¡å‘˜ï¼‰
â”‚           â”œâ”€â”€ projects.py  # é¡¹ç›®ç®¡ç†
â”‚           â””â”€â”€ assets.py    # èµ„äº§ç®¡ç†
â”‚   â”œâ”€â”€ schemas/             # Pydantic æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ services/            # ä¸šåŠ¡é€»è¾‘
â”‚       â””â”€â”€ image_pipeline.py
â”œâ”€â”€ requirements.txt         # Python ä¾èµ–æ¸…å•

shared/                      # å…±äº«èµ„æºåº“
â”œâ”€â”€ config/
â”‚   â””â”€â”€ settings.py          # é…ç½®ä¸­å¿ƒ
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ base.py              # æ•°æ®åº“åœ°åŸºï¼ˆORM åŸºç±»ï¼‰
â”‚   â”œâ”€â”€ session.py           # æ•°æ®åº“è¿æ¥æ± 
â”‚   â”œâ”€â”€ models_project.py    # é¡¹ç›®ç›¸å…³æ¨¡å‹
â”‚   â””â”€â”€ models_asset.py      # èµ„äº§ç›¸å…³æ¨¡å‹
â””â”€â”€ utils/                   # å·¥å…·ç®±ï¼ˆå¾…å¼€å‘ï¼‰
```

### ç»„ä»¶èŒè´£

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ | ç±»æ¯” |
|------|------|------|------|
| Web æ¡†æ¶ | main.py | ç»Ÿç­¹å…¨å±€ï¼Œç®¡ç†è·¯ç”± | æ€»ç»ç† |
| API è·¯ç”± | health.py, projects.py, assets.py | å¤„ç†å…·ä½“è¯·æ±‚ | æœåŠ¡å‘˜ |
| é…ç½®ç®¡ç† | settings.py | ç®¡ç†ç¯å¢ƒé…ç½® | é…ç½®ä¸­å¿ƒ |
| æ•°æ®åº“åŸºç±» | base.py | ORM å£°æ˜å¼åŸºç±» | èŠ±åå†Œæ¨¡æ¿ |
| ä¼šè¯ç®¡ç† | session.py | æ•°æ®åº“è¿æ¥æ±  | è¿æ¥æ± ç®¡ç†å™¨ |
| æ•°æ®æ¨¡å‹ | models_project.py, models_asset.py | æ•°æ®è¡¨å®šä¹‰ | æ•°æ®å­—å…¸ |

---

## ä¾èµ–åº“è¯¦è§£

### requirements.txt

```txt
fastapi==0.104.1
uvicorn[standard]==0.24.0
sqlalchemy==2.0.23
psycopg2-binary==2.9.9
python-dotenv
```

### 1. FastAPI - Web æ¡†æ¶

**ä½œç”¨**ï¼šæä¾› Web æœåŠ¡çš„åŸºç¡€æ¶æ„

**é€šä¿—ç†è§£**ï¼šå°±åƒé¤å…çš„**å»ºç­‘è®¾è®¡å›¾**

```
FastAPI æä¾›ï¼š
â”œâ”€â”€ è·¯ç”±ç³»ç»Ÿï¼šå“ªä¸ªåœ°å€å¯¹åº”å“ªä¸ªåŠŸèƒ½
â”œâ”€â”€ è¯·æ±‚å¤„ç†ï¼šæ¥æ”¶å®¢æˆ·è®¢å•
â”œâ”€â”€ å“åº”æ ¼å¼ï¼šè§„èŒƒè¿”å›æ•°æ®
â”œâ”€â”€ æ•°æ®éªŒè¯ï¼šæ£€æŸ¥è®¢å•æ˜¯å¦åˆæ³•
â””â”€â”€ è‡ªåŠ¨æ–‡æ¡£ï¼šè‡ªåŠ¨ç”Ÿæˆèœå•ï¼ˆSwagger UIï¼‰
```

**ä»£ç ç¤ºä¾‹**ï¼š

```python
from fastapi import FastAPI

app = FastAPI(title="BDC-AI Backend", version="0.3.0")

@app.get("/api/v1/health/")
async def health_check():
    return {"status": "ok"}

# FastAPI è‡ªåŠ¨å¸®ä½ åšï¼š
# âœ“ ç›‘å¬ /api/v1/health/ è¿™ä¸ªåœ°å€
# âœ“ æ”¶åˆ°è¯·æ±‚æ—¶è°ƒç”¨ health_check å‡½æ•°
# âœ“ æŠŠè¿”å›çš„å­—å…¸è½¬æˆ JSON æ ¼å¼
# âœ“ åŠ ä¸Šæ­£ç¡®çš„ HTTP å¤´
# âœ“ è®°å½•è¯·æ±‚æ—¥å¿—
```

### 2. Uvicorn - ASGI æœåŠ¡å™¨

**ä½œç”¨**ï¼šå®é™…è¿è¡Œ Web æœåŠ¡çš„æœåŠ¡å™¨

**é€šä¿—ç†è§£**ï¼šå°±åƒé¤å…çš„**å®ä½“å¨æˆ¿å’Œå¨å¸ˆ**

```
Uvicorn æä¾›ï¼š
â”œâ”€â”€ ç›‘å¬ç«¯å£ï¼šç›¸å½“äº"å¼€é—¨è¥ä¸š"
â”œâ”€â”€ æ¥æ”¶è¿æ¥ï¼šç›¸å½“äº"æ¥å¾…å®¢äºº"
â”œâ”€â”€ å¤„ç†è¯·æ±‚ï¼šç›¸å½“äº"åšèœ"
â”œâ”€â”€ è¿”å›å“åº”ï¼šç›¸å½“äº"ä¸Šèœ"
â””â”€â”€ å¹¶å‘å¤„ç†ï¼šå¯ä»¥åŒæ—¶æ¥å¾…å¤šä¸ªå®¢äºº
```

**ç±»æ¯”**ï¼š
```
FastAPI = é¤å…è®¾è®¡å›¾ï¼ˆçº¸ä¸Šè°ˆå…µï¼‰
Uvicorn = çœŸæ­£çš„å¨æˆ¿ï¼ˆå®é™…å¹²æ´»ï¼‰

å…‰æœ‰è®¾è®¡å›¾æ²¡æ³•è¥ä¸šï¼Œå¿…é¡»æŠŠå¨æˆ¿å»ºèµ·æ¥ã€è¯·å¨å¸ˆã€å¼€ç«
æ‰èƒ½çœŸæ­£æ¥å¾…å®¢äºº
```

**å¯åŠ¨å‘½ä»¤**ï¼š

```bash
python -m uvicorn services.backend.app.main:app --host localhost --port 8000 --reload

# è¿™ä¸ªå‘½ä»¤åšäº†ä»€ä¹ˆï¼š
# 1. æ‰¾åˆ° FastAPI åº”ç”¨ï¼šservices.backend.app.main:app
# 2. åœ¨ localhost çš„ 8000 ç«¯å£å¼€åº—
# 3. å¼€å§‹ç›‘å¬ï¼Œç­‰å¾…å®¢äººï¼ˆç”¨æˆ·è¯·æ±‚ï¼‰
# 4. æ”¶åˆ°è¯·æ±‚åï¼ŒæŒ‰ç…§ FastAPI å®šä¹‰çš„å¤„ç†
# 5. å¤„ç†å®Œè¿”å›ç»“æœ

# --reloadï¼šä»£ç ä¿®æ”¹åè‡ªåŠ¨é‡å¯ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
```

### 3. SQLAlchemy - ORM å·¥å…·

**ä½œç”¨**ï¼šPython å¯¹è±¡ä¸æ•°æ®åº“ä¹‹é—´çš„ç¿»è¯‘å®˜

**é€šä¿—ç†è§£**ï¼šå°±åƒ**æ•°æ®åº“ç¿»è¯‘å®˜**

```
SQLAlchemy æä¾›ï¼š
â”œâ”€â”€ Python ç±» â†’ æ•°æ®åº“è¡¨ï¼ˆç¿»è¯‘ï¼‰
â”œâ”€â”€ Python å¯¹è±¡ â†’ æ•°æ®åº“è®°å½•ï¼ˆç¿»è¯‘ï¼‰
â”œâ”€â”€ Python æ“ä½œ â†’ SQL è¯­å¥ï¼ˆç¿»è¯‘ï¼‰

ç±»æ¯”ï¼š
ä½ ï¼ˆPython ç¨‹åºå‘˜ï¼‰ï¼šåªä¼šè¯´ Python
æ•°æ®åº“ï¼ˆPostgreSQLï¼‰ï¼šåªå¬å¾—æ‡‚ SQL
SQLAlchemyï¼ˆç¿»è¯‘å®˜ï¼‰ï¼šäº’ç›¸ç¿»è¯‘
```

**ä»£ç å¯¹æ¯”**ï¼š

```python
# âŒ æ²¡æœ‰ SQLAlchemyï¼ˆæ‰‹åŠ¨å†™ SQLï¼‰ï¼š
import psycopg2

def create_project(name, location):
    conn = psycopg2.connect(...)
    cursor = conn.cursor()

    # æ‰‹å†™ SQLï¼ˆå®¹æ˜“å‡ºé”™ï¼‰
    sql = """
        INSERT INTO projects (id, name, location, created_at)
        VALUES (gen_random_uuid(), %s, %s, NOW())
        RETURNING id
    """
    cursor.execute(sql, (name, location))
    project_id = cursor.fetchone()[0]
    conn.commit()
    return project_id

# âœ“ æœ‰ SQLAlchemyï¼ˆç”¨ Python å¯¹è±¡ï¼‰ï¼š
from shared.db.session import SessionLocal
from shared.db.models_project import Project
import uuid

def create_project(name, location):
    db = SessionLocal()
    project = Project(id=uuid.uuid4(), name=name, location=location)
    db.add(project)
    db.commit()
    db.refresh(project)
    return project.id
```

### 4. PostgreSQL - å…³ç³»å‹æ•°æ®åº“

**ä½œç”¨**ï¼šå­˜å‚¨å’Œç®¡ç†é¡¹ç›®æ•°æ®

**é€šä¿—ç†è§£**ï¼šå°±åƒ**æ–‡ä»¶æŸœ + ç´¢å¼•ç³»ç»Ÿ**

```
PostgreSQL æä¾›ï¼š
â”œâ”€â”€ æ•°æ®æŒä¹…åŒ–ï¼šæ•°æ®ä¸ä¼šä¸¢å¤±
â”œâ”€â”€ UUID ç±»å‹ï¼šåŸç”Ÿæ”¯æŒ UUIDï¼ˆä¸»é”®ï¼‰
â”œâ”€â”€ JSON ç±»å‹ï¼šå­˜å‚¨ç»“æ„åŒ–æ•°æ®
â”œâ”€â”€ å¤–é”®çº¦æŸï¼šä¿è¯æ•°æ®å®Œæ•´æ€§
â”œâ”€â”€ äº‹åŠ¡æ”¯æŒï¼šACID ç‰¹æ€§
â””â”€â”€ å¹¶å‘æ§åˆ¶ï¼šå¤šç”¨æˆ·åŒæ—¶è®¿é—®

å¯¹æ¯” SQLiteï¼š
SQLiteï¼šè½»é‡çº§ï¼Œé€‚åˆå•æœºã€å•ç”¨æˆ·
PostgreSQLï¼šä¼ä¸šçº§ï¼Œé€‚åˆæœåŠ¡å™¨ã€å¤šç”¨æˆ·ã€é«˜å¹¶å‘
```

**è¿ç§»åŸå› **ï¼š
```python
# SQLite çš„é—®é¢˜ï¼š
# âœ— ä¸æ”¯æŒ UUID(as_uuid=True)
# âœ— å¤–é”®çº¦æŸè¾ƒå¼±
# âœ— å¹¶å‘æ€§èƒ½æœ‰é™

# PostgreSQL çš„ä¼˜åŠ¿ï¼š
# âœ“ åŸç”Ÿ UUID æ”¯æŒ
# âœ“ ä¸¥æ ¼çš„å¤–é”®çº¦æŸ
# âœ“ æ›´å¥½çš„å¹¶å‘æ€§èƒ½
# âœ“ æ”¯æŒ JSONã€æ•°ç»„ç­‰é«˜çº§ç±»å‹
# âœ“ ç”Ÿäº§ç¯å¢ƒå°±ç»ª
```

### 5. psycopg2-binary - PostgreSQL é©±åŠ¨

**ä½œç”¨**ï¼šPython ä¸ PostgreSQL ä¹‹é—´çš„æ¡¥æ¢

**é€šä¿—ç†è§£**ï¼šå°±åƒ**ç”µè¯çº¿**

```
psycopg2-binary æä¾›ï¼š
â”œâ”€â”€ ç½‘ç»œè¿æ¥ï¼šè¿æ¥åˆ° PostgreSQL æœåŠ¡å™¨
â”œâ”€â”€ åè®®è½¬æ¢ï¼šPython è°ƒç”¨ â†’ PostgreSQL åè®®
â”œâ”€â”€ æ•°æ®ä¼ è¾“ï¼šå‘é€ SQLã€æ¥æ”¶ç»“æœ
â””â”€â”€ äºŒè¿›åˆ¶æ¨¡å¼ï¼šé«˜æ•ˆä¼ è¾“æ•°æ®ï¼ˆbyteaï¼‰

ç±»æ¯”ï¼š
SQLAlchemy = ç¿»è¯‘å®˜ï¼ˆPython â†” SQLï¼‰
psycopg2-binary = ç”µè¯çº¿ï¼ˆPython â†” PostgreSQLï¼‰
```

---

## å·¥ä½œæµç¨‹

### å®Œæ•´è¯·æ±‚å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·ï¼ˆæµè§ˆå™¨ï¼‰                           â”‚
â”‚                  è®¿é—® http://localhost:8000/api/v1/projects/  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 1. HTTP è¯·æ±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Uvicorn æœåŠ¡å™¨ï¼ˆç›‘å¬ 8000 ç«¯å£ï¼‰                â”‚
â”‚  å·¥ä½œï¼šç›‘å¬ç«¯å£ï¼Œç­‰å¾…è¯·æ±‚ï¼Œæ”¶åˆ°åè½¬äº¤ç»™ FastAPI              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 2. ä¼ é€’è¯·æ±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FastAPI åº”ç”¨ï¼ˆmain.py ä¸­çš„ appï¼‰                â”‚
â”‚  å·¥ä½œï¼šæŸ¥çœ‹è·¯ç”±è¡¨ï¼Œæ‰¾åˆ°å¯¹åº”çš„å¤„ç†å‡½æ•°                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 3. è°ƒç”¨å¤„ç†å‡½æ•°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          projects.py ä¸­çš„ list_projects() å‡½æ•°               â”‚
â”‚  å·¥ä½œï¼šæ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢ï¼Œè¿”å›ç»“æœåˆ—è¡¨                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 4. è¿”å›ç»“æœ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FastAPI åº”ç”¨                              â”‚
â”‚  å·¥ä½œï¼šè½¬æˆ JSONï¼Œæ·»åŠ çŠ¶æ€ç å’Œå“åº”å¤´                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 5. HTTP å“åº”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç”¨æˆ·æµè§ˆå™¨                                 â”‚
â”‚           æ˜¾ç¤ºï¼š[{"id": "...", "name": "..."}, ...]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä»£ç å±‚é¢è§£æ

### 1. main.py - åº”ç”¨å…¥å£

**ä½ç½®**ï¼š`services/backend/app/main.py`

**ä»£ç **ï¼š

```python
from fastapi import FastAPI
from .api.v1 import health, projects, assets

# åˆ›å»º FastAPI åº”ç”¨å®ä¾‹
# å°±åƒæ³¨å†Œä¸€å®¶å…¬å¸ï¼Œé¢†å–è¥ä¸šæ‰§ç…§
app = FastAPI(title="BDC-AI Backend", version="0.3.0")

# æ³¨å†Œè·¯ç”±ï¼ˆæŒ‚è½½æœåŠ¡å°ï¼‰
# å°±åƒåœ¨å…¬å¸å¤§å…è®¾ç½®æœåŠ¡å°
app.include_router(health.router, prefix="/api/v1/health", tags=["health"])
app.include_router(projects.router, prefix="/api/v1/projects", tags=["projects"])
app.include_router(assets.router, prefix="/api/v1/assets", tags=["assets"])

@app.on_event("startup")
def on_startup() -> None:
    """åº”ç”¨å¯åŠ¨æ—¶åˆ›å»ºæ‰€æœ‰æ•°æ®åº“è¡¨"""
    from shared.db.base import Base
    from shared.db.session import engine

    Base.metadata.create_all(bind=engine)

# æ ¹è·¯å¾„å¤„ç†
@app.get("/")
async def read_root() -> dict:
    return {"status": "ok"}
```

### 2. settings.py - é…ç½®ç®¡ç†

**ä½ç½®**ï¼š`shared/config/settings.py`

**ä»£ç **ï¼š

```python
import os
from functools import lru_cache
from dotenv import load_dotenv
from pathlib import Path

# åŠ è½½ .env æ–‡ä»¶
load_dotenv(Path(__file__).parent.parent.parent / ".env")

class Settings:
    def __init__(self) -> None:
        # ä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œå¦‚æœæ²¡æœ‰å°±ç”¨é»˜è®¤å€¼
        self.database_url = os.getenv(
            "BDC_DATABASE_URL",
            "postgresql://admin:password@localhost:5432/bdc_ai"
        )
        self.local_storage_dir = os.getenv("BDC_LOCAL_STORAGE_DIR", "data/assets")

        # GLM API é…ç½®
        self.glm_api_key = os.getenv("GLM_API_KEY", "")
        self.glm_base_url = os.getenv("GLM_BASE_URL", "https://open.bigmodel.cn/api/paas/v4/")
        self.glm_vision_model = os.getenv("GLM_VISION_MODEL", "glm-4v")

# ä½¿ç”¨ lru_cache è£…é¥°å™¨å®ç°å•ä¾‹æ¨¡å¼
@lru_cache()
def get_settings() -> Settings:
    return Settings()
```

### 3. session.py - æ•°æ®åº“ä¼šè¯

**ä½ç½®**ï¼š`shared/db/session.py`

**ä»£ç **ï¼š

```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from shared.config.settings import get_settings

settings = get_settings()

# åˆ›å»ºå¼•æ“
engine = create_engine(settings.database_url, future=True)
#                            â†‘
#                            future=True: å¯ç”¨ SQLAlchemy 2.0 æ–°ç‰¹æ€§

# åˆ›å»ºä¼šè¯å·¥å‚
SessionLocal = sessionmaker(
    bind=engine,
    autocommit=False,   # ä¸è‡ªåŠ¨æäº¤ï¼ˆéœ€è¦æ‰‹åŠ¨ commitï¼‰
    autoflush=False,    # ä¸è‡ªåŠ¨åˆ·æ–°
    future=True         # SQLAlchemy 2.0 æ¨¡å¼
)

# ä¾èµ–æ³¨å…¥å‡½æ•°
def get_db() -> Generator:
    db = SessionLocal()  # åˆ›å»ºä¼šè¯ï¼ˆä»è¿æ¥æ± æ‹¿ä¸€ä¸ªè¿æ¥ï¼‰
    try:
        yield db         # æä¾›ç»™ä½¿ç”¨
    finally:
        db.close()       # ç”¨å®Œåå½’è¿˜è¿æ¥æ± 
```

**Engineï¼ˆå¼•æ“ï¼‰çš„å·¥ä½œåŸç†**ï¼š

```python
engine = create_engine("postgresql://...", pool_size=5, max_overflow=10)

# å¼•æ“ç»´æŠ¤ä¸€ä¸ªè¿æ¥æ± ï¼š
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ è¿æ¥1   â”‚ è¿æ¥2   â”‚ è¿æ¥3   â”‚ è¿æ¥4   â”‚ è¿æ¥5   â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# å½“ä½ è°ƒç”¨ SessionLocal()ï¼š
# â†’ ä»æ± å­é‡Œæ‹¿ä¸€ä¸ªç©ºé—²è¿æ¥ç»™ä½ 
#
# å½“ä½ è°ƒç”¨ db.close()ï¼š
# â†’ æŠŠè¿æ¥å½’è¿˜æ± å­ï¼Œç»™å…¶ä»–äººç”¨
```

---

## éª¨æ¶çš„è§’è‰²å®šä½

### è§’è‰² 1ï¼šæ¡†æ¶ - æä¾›ç»“æ„å’Œè§„èŒƒ

```
å°±åƒç›–æˆ¿å­çš„æ¡†æ¶ï¼š
â”œâ”€â”€ è§„å®šå“ªé‡Œæ˜¯æ‰¿é‡å¢™ï¼ˆä¸èƒ½ä¹±æ”¹ï¼‰
â”œâ”€â”€ è§„å®šå“ªé‡Œæ˜¯é—¨ï¼ˆè¿æ¥å¤–ç•Œï¼‰
â”œâ”€â”€ è§„å®šå“ªé‡Œæ˜¯çª—ï¼ˆé‡‡å…‰é€šé£ï¼‰
â””â”€â”€ ä¿è¯æˆ¿å­ç»“æ„ç¨³å›º

FastAPI + Uvicorn = Web æœåŠ¡æ¡†æ¶ï¼š
â”œâ”€â”€ è§„å®šè¯·æ±‚æ€ä¹ˆæ¥æ”¶ï¼ˆè·¯ç”±ç³»ç»Ÿï¼‰
â”œâ”€â”€ è§„å®šå“åº”æ€ä¹ˆè¿”å›ï¼ˆJSON æ ¼å¼ï¼‰
â”œâ”€â”€ è§„å®šé”™è¯¯æ€ä¹ˆå¤„ç†ï¼ˆå¼‚å¸¸æœºåˆ¶ï¼‰
â””â”€â”€ ä¿è¯æœåŠ¡ç¨³å®šè¿è¡Œ
```

### è§’è‰² 2ï¼šè¿æ¥å™¨ - è¿æ¥å„ä¸ªç»„ä»¶

```
å°±åƒæ°´ç”µç®¡ç½‘è¿æ¥å„ä¸ªæˆ¿é—´ï¼š
â”œâ”€â”€ æ°´ç®¡è¿æ¥å¨æˆ¿å’Œæµ´å®¤
â”œâ”€â”€ ç”µçº¿è¿æ¥å„ä¸ªæˆ¿é—´å’Œæ’åº§
â”œâ”€â”€ ç½‘çº¿è¿æ¥å„ä¸ªè®¾å¤‡

éª¨æ¶è¿æ¥ï¼š
â”œâ”€â”€ settings.py â”€â”€â”€â”€â”€â”
â”‚   é…ç½®æ•°æ®         â”œâ”€â”€â†’ è¿æ¥é…ç½®å’Œä»£ç 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”œâ”€â”€ session.py â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®åº“ä¼šè¯       â”œâ”€â”€â†’ è¿æ¥ä¸šåŠ¡é€»è¾‘å’Œæ•°æ®åº“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”œâ”€â”€ base.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ORM åŸºç±»         â”œâ”€â”€â†’ è¿æ¥ Python ç±»å’Œæ•°æ®åº“è¡¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è§’è‰² 3ï¼šåŸºç¡€è®¾æ–½ - æä¾›åŸºç¡€èƒ½åŠ›

```
å°±åƒåŸå¸‚çš„åŸºç¡€è®¾æ–½ï¼š
â”œâ”€â”€ é“è·¯ï¼šæä¾›é€šè¡Œèƒ½åŠ›
â”œâ”€â”€ æ°´ç”µï¼šæä¾›èƒ½æºä¾›åº”
â”œâ”€â”€ é€šä¿¡ï¼šæä¾›ä¿¡æ¯ä¼ è¾“

éª¨æ¶æä¾›ï¼š
â”œâ”€â”€ Web æœåŠ¡èƒ½åŠ›ï¼ˆFastAPIï¼‰
â”œâ”€â”€ å¹¶å‘å¤„ç†èƒ½åŠ›ï¼ˆUvicornï¼‰
â”œâ”€â”€ æ•°æ®æŒä¹…åŒ–èƒ½åŠ›ï¼ˆPostgreSQL + SQLAlchemyï¼‰
â”œâ”€â”€ é…ç½®ç®¡ç†èƒ½åŠ›ï¼ˆsettingsï¼‰
â””â”€â”€ ä¾èµ–æ³¨å…¥èƒ½åŠ›ï¼ˆFastAPI Dependsï¼‰
```

---

## æŠ€æœ¯äº®ç‚¹

### 1. SQLAlchemy 2.0 æ–°ç‰¹æ€§

```python
# future=True å¯ç”¨ SQLAlchemy 2.0
engine = create_engine(url, future=True)

# æ–°ç‰¹æ€§ï¼š
# 1. æ›´å¥½çš„ç±»å‹æç¤º
# 2. æ›´ç®€æ´çš„æŸ¥è¯¢è¯­æ³•
# 3. æ›´å¥½çš„å¼‚æ­¥æ”¯æŒ
# 4. æ›´æ˜ç¡®çš„é”™è¯¯æç¤º
```

### 2. UUID åŸç”Ÿæ”¯æŒ

```python
from sqlalchemy.dialects.postgresql import UUID
import uuid

class Project(Base):
    __tablename__ = "projects"

    # PostgreSQL åŸç”Ÿ UUID ç±»å‹
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = Column(String(200), nullable=False)

# ä¼˜åŠ¿ï¼š
# âœ“ è‡ªåŠ¨ç”Ÿæˆ UUID
# âœ“ å ç”¨ç©ºé—´å°ï¼ˆ16 å­—èŠ‚ï¼‰
# âœ“ ç´¢å¼•æ€§èƒ½å¥½
# âœ“ å…¨å±€å”¯ä¸€æ€§
```

### 3. é…ç½®ç®¡ç†å•ä¾‹æ¨¡å¼

```python
@lru_cache()
def get_settings() -> Settings:
    return Settings()

# å…¨å±€å”¯ä¸€é…ç½®å¯¹è±¡
# èŠ‚çœå†…å­˜ï¼Œä¿è¯ä¸€è‡´æ€§
```

---

# å¤šæ¨¡æ€æ•°æ®å¤„ç†è¯¦è§£

## ğŸ“– æ¦‚è¿°

å¤šæ¨¡æ€æ•°æ®å¤„ç†æ˜¯ BDC-AI é¡¹ç›®çš„**æ ¸å¿ƒèƒ½åŠ›å±‚**ï¼Œå°±åƒ"çœ¼ç›"å’Œ"å¤§è„‘"ï¼Œè®©ç³»ç»Ÿèƒ½å¤Ÿçœ‹æ‡‚å›¾ç‰‡ã€è¯»æ‡‚æ–‡æ¡£ã€ç†è§£å†…å®¹ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- âœ… å›¾ç‰‡æ–‡å­—è¯†åˆ«ï¼ˆOCRï¼‰ï¼šæå–è®¾å¤‡é“­ç‰Œã€ä»ªè¡¨è¯»æ•°ç­‰å…³é”®ä¿¡æ¯
- âœ… åœºæ™¯é—®é¢˜åˆ†æï¼ˆGLM-4Vï¼‰ï¼šæ™ºèƒ½è¯Šæ–­ç°åœºé—®é¢˜ï¼Œç»™å‡ºå»ºè®®æªæ–½
- âœ… æ™ºèƒ½å›¾ç‰‡è·¯ç”±ï¼šæ ¹æ®å†…å®¹è‡ªåŠ¨é€‰æ‹©å¤„ç†æ–¹å¼
- âœ… ç»“æ„åŒ–æ•°æ®å­˜å‚¨ï¼šå°†éç»“æ„åŒ–æ•°æ®è½¬ä¸ºå¯æŸ¥è¯¢çš„ç»“æ„åŒ–æ•°æ®
- âœ… å¤šç‰ˆæœ¬ç®¡ç†ï¼šä¿ç•™è§£æå†å²ï¼Œæ”¯æŒè¿½æº¯å’Œå¯¹æ¯”

**é€šä¿—ç†è§£**ï¼š
```
å¤šæ¨¡æ€æ•°æ®å¤„ç†å™¨ = è¶…çº§ç¿»è¯‘å®˜ + æ™ºèƒ½åˆ†æå¸ˆ

è¾“å…¥ï¼šå„ç§"çœ‹ä¸æ‡‚"çš„ä¸œè¥¿
â”œâ”€â”€ å›¾ç‰‡ï¼ˆè®¾å¤‡é“­ç‰Œã€ç°åœºç…§ç‰‡ï¼‰
â””â”€â”€ å¤‡æ³¨ï¼ˆå·¥ç¨‹å¸ˆè¯´æ˜ï¼‰

è¾“å‡ºï¼š
â”œâ”€â”€ OCR å¤„ç†ï¼ˆç”µè¡¨ã€é“­ç‰Œï¼‰â†’ æ–‡å­—å†…å®¹ + ä½ç½®åæ ‡
â”œâ”€â”€ GLM åˆ†æï¼ˆç°åœºé—®é¢˜ï¼‰â†’ é—®é¢˜è¯Šæ–­ + å»ºè®®æªæ–½
â””â”€â”€ ç»“æ„åŒ– JSON â†’ å­˜æ•°æ®åº“
```

---

## æ ¸å¿ƒç»„æˆ

### é¡¹ç›®ç»“æ„

```
services/backend/
â””â”€â”€ app/
    â”œâ”€â”€ api/v1/
    â”‚   â””â”€â”€ assets.py              # API æ¥å£
    â””â”€â”€ services/
        â””â”€â”€ image_pipeline.py      # å›¾ç‰‡å¤„ç†æµæ°´çº¿ï¼ˆæ™ºèƒ½è·¯ç”±ï¼‰

services/worker/
â””â”€â”€ scene_issue_glm_worker.py     # GLM Workerï¼ˆåå°å¤„ç†ï¼‰

shared/
â””â”€â”€ db/
    â””â”€â”€ models_asset.py            # Asset æ•°æ®æ¨¡å‹
```

### ç»„ä»¶èŒè´£

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ | ç±»æ¯” |
|------|------|------|------|
| æ™ºèƒ½è·¯ç”± | image_pipeline.py | æ ¹æ®å†…å®¹é€‰æ‹©å¤„ç†æ–¹å¼ | æ™ºèƒ½åˆ†æ‹£å‘˜ |
| OCR å¼•æ“ | PaddleOCR | å›¾ç‰‡æ–‡å­—è¯†åˆ« | ç¿»è¯‘å®˜ |
| GLM å¼•æ“ | GLM-4V API | åœºæ™¯é—®é¢˜æ™ºèƒ½åˆ†æ | ä¸“å®¶é¡¾é—® |
| Worker | scene_issue_glm_worker.py | åå°è‡ªåŠ¨å¤„ç† | è‡ªåŠ¨åŒ–æµæ°´çº¿ |
| æ•°æ®æ¨¡å‹ | models_asset.py | å­˜å‚¨åˆ†æç»“æœ | æ¡£æ¡ˆæŸœ |
| API æ¥å£ | assets.py | æ¥æ”¶ä¸Šä¼ ã€è¿”å›ç»“æœ | æœåŠ¡çª—å£ |

---

## ä¾èµ–åº“è¯¦è§£

### requirements.txtï¼ˆå¤šæ¨¡æ€éƒ¨åˆ†ï¼‰

```txt
# OCR ä¸å›¾åƒå¤„ç†
paddleocr==2.7.0.3          # ç™¾åº¦ OCR å¼•æ“
paddlepaddle==2.6.2         # æ·±åº¦å­¦ä¹ æ¡†æ¶åç«¯
opencv-python<=4.6.0.66     # å›¾åƒå¤„ç†åº“

# GLM API
openai                      # GLM API å®¢æˆ·ç«¯ï¼ˆå…¼å®¹ OpenAI SDKï¼‰
```

### 1. PaddleOCR - æ–‡å­—è¯†åˆ«å¼•æ“

**ä½œç”¨**ï¼šä»å›¾ç‰‡ä¸­æå–æ–‡å­—ä¿¡æ¯

**é€šä¿—ç†è§£**ï¼šå°±åƒ**äººç±»çš„çœ¼ç› + å¤§è„‘**

```
PaddleOCR çš„å·¥ä½œè¿‡ç¨‹ï¼š
â”œâ”€â”€ æ–‡å­—æ£€æµ‹ï¼šæ‰¾åˆ°æ–‡å­—åœ¨å“ªé‡Œï¼ˆåƒçœ¼ç›æ‰¾å­—ï¼‰
â”œâ”€â”€ æ–‡å­—åˆ†ç±»ï¼šåˆ¤æ–­æ–‡å­—æ–¹å‘ï¼ˆåƒæ­ªå¤´çœ‹ä¹¦ï¼‰
â”œâ”€â”€ æ–‡å­—è¯†åˆ«ï¼šè¯†åˆ«æ˜¯ä»€ä¹ˆå­—ï¼ˆåƒå¤§è„‘è®¤å­—ï¼‰
â””â”€â”€ ç»“æœè¾“å‡ºï¼šæ–‡å­— + åæ ‡ + ç½®ä¿¡åº¦
```

**ä»£ç ç¤ºä¾‹**ï¼š

```python
from paddleocr import PaddleOCR

# åˆå§‹åŒ– OCRï¼ˆé¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½æ¨¡å‹ï¼‰
ocr = PaddleOCR(
    use_angle_cls=True,    # å¯ç”¨æ–‡å­—æ–¹å‘åˆ†ç±»
    lang='ch'              # ä¸­æ–‡æ¨¡å‹ï¼ˆä¹Ÿæ”¯æŒè‹±æ–‡ï¼‰
)

# è¯†åˆ«å›¾ç‰‡
result = ocr.ocr('electric_meter.jpg', cls=True)

# è¿”å›ç»“æœæ ¼å¼ï¼š
# [
#   [
#     [[x1, y1], [x2, y2], [x3, y3], [x4, y4]],  # æ–‡å­—æ¡†åæ ‡
#     ('1234.5', 0.998)                           # (æ–‡å­—, ç½®ä¿¡åº¦)
#   ],
#   [
#     [[x1, y1], [x2, y2], [x3, y3], [x4, y4]],
#     ('kWÂ·h', 0.996)
#   ],
#   # ... æ›´å¤šæ–‡å­—è¡Œ
# ]
```

**æ€§èƒ½æŒ‡æ ‡**ï¼ˆCPU æ¨¡å¼ï¼ŒIntel i7ï¼‰ï¼š
- æ–‡å­—æ£€æµ‹ï¼š~0.6 ç§’
- æ–‡å­—åˆ†ç±»ï¼š~0.25 ç§’
- æ–‡å­—è¯†åˆ«ï¼š~3.3 ç§’
- **æ€»è€—æ—¶**ï¼šçº¦ 4.2 ç§’/å¼ 

### 2. GLM-4V - è§†è§‰å¤§æ¨¡å‹

**ä½œç”¨**ï¼šç†è§£å›¾ç‰‡å†…å®¹ï¼Œè¿›è¡Œåœºæ™¯é—®é¢˜åˆ†æ

**é€šä¿—ç†è§£**ï¼šå°±åƒ**èµ„æ·±å·¥ç¨‹å¸ˆä¸“å®¶**

```
GLM-4V çš„å·¥ä½œè¿‡ç¨‹ï¼š
â”œâ”€â”€ ç†è§£å›¾ç‰‡ï¼šçœ‹åˆ°ç°åœºç…§ç‰‡ï¼ˆåƒå·¥ç¨‹å¸ˆçœ‹ç°åœºï¼‰
â”œâ”€â”€ åˆ†æé—®é¢˜ï¼šè¯†åˆ«å¼‚å¸¸æƒ…å†µï¼ˆåƒä¸“å®¶è¯Šæ–­ï¼‰
â”œâ”€â”€ æ¨æ–­åŸå› ï¼šåˆ†æå¯èƒ½åŸå› ï¼ˆåƒç»éªŒåˆ¤æ–­ï¼‰
â””â”€â”€ ç»™å‡ºå»ºè®®ï¼šæä¾›æ”¹è¿›æªæ–½ï¼ˆåƒä¸“å®¶å»ºè®®ï¼‰
```

**ä»£ç ç¤ºä¾‹**ï¼š

```python
from openai import OpenAI

# åˆå§‹åŒ– GLM å®¢æˆ·ç«¯ï¼ˆä½¿ç”¨ OpenAI SDK å…¼å®¹æ¥å£ï¼‰
client = OpenAI(
    api_key="your_glm_api_key",
    base_url="https://open.bigmodel.cn/api/paas/v4/"
)

# è°ƒç”¨ GLM-4V
response = client.chat.completions.create(
    model="glm-4v",
    messages=[
        {
            "role": "user",
            "content": [
                {
                    "type": "image_url",
                    "image_url": {
                        "url": "data:image/jpeg;base64,..."
                    }
                },
                {
                    "type": "text",
                    "text": "åˆ†æè¿™å¼ ç°åœºç…§ç‰‡ï¼Œè¯†åˆ«é—®é¢˜å¹¶ç»™å‡ºå»ºè®®"
                }
            ]
        }
    ],
    response_format={"type": "json_object"},
    temperature=0.1
)

result = response.choices[0].message.content
```

**è¿”å›ç»“æœç¤ºä¾‹**ï¼š

```json
{
  "title": "åˆ¶å†·ç³»ç»Ÿæ•ˆç‡ä½ä¸‹",
  "issue_category": "å†·æºæ•ˆç‡",
  "severity": "high",
  "summary": "å†·å´å¡”æ°´ä½è¿‡é«˜ï¼Œå¯¼è‡´æ¢çƒ­æ•ˆç‡ä¸‹é™",
  "suspected_causes": [
    "æ°´ä½æ§åˆ¶å™¨æ•…éšœ",
    "æ°´ä½ä¼ æ„Ÿå™¨å¤±çµ"
  ],
  "recommended_actions": [
    "æ›´æ¢æ°´ä½æ§åˆ¶å™¨",
    "æ ¡å‡†æ°´ä½ä¼ æ„Ÿå™¨"
  ],
  "confidence": 0.8,
  "tags": ["å†·å´å¡”", "æ°´ä½", "æ•ˆç‡ä½ä¸‹"]
}
```

**æ€§èƒ½æŒ‡æ ‡**ï¼š
- API å“åº”æ—¶é—´ï¼š~10-30 ç§’
- å‡†ç¡®ç‡ï¼šé«˜ï¼ˆå¤§æ¨¡å‹èƒ½åŠ›ï¼‰
- æˆæœ¬ï¼šæŒ‰æ¬¡è®¡è´¹

### 3. OpenAI SDK - GLM API å®¢æˆ·ç«¯

**ä½œç”¨**ï¼šPython ä¸ GLM API ä¹‹é—´çš„æ¡¥æ¢

**é€šä¿—ç†è§£**ï¼šå°±åƒ**ç”µè¯**

```
OpenAI SDK æä¾›ï¼š
â”œâ”€â”€ API è°ƒç”¨å°è£…ï¼šç®€åŒ– HTTP è¯·æ±‚
â”œâ”€â”€ æ•°æ®ç±»å‹è½¬æ¢ï¼šPython å¯¹è±¡ â†” JSON
â”œâ”€â”€ é”™è¯¯å¤„ç†ï¼šç½‘ç»œå¼‚å¸¸ã€API é”™è¯¯
â””â”€â”€ æµå¼å“åº”ï¼šæ”¯æŒé€å­—è¾“å‡ºï¼ˆå¯é€‰ï¼‰

ç±»æ¯”ï¼š
æˆ‘ä»¬ï¼ˆPython ç¨‹åºï¼‰â†’ OpenAI SDK â†’ GLM API
     è¯´ä¸­æ–‡            æ‰“ç”µè¯          å¬ä¸­æ–‡
```

---

## OCR å›¾ç‰‡è¯†åˆ«æµç¨‹

### å®Œæ•´å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡                              â”‚
â”‚           é€‰æ‹©ç”µè¡¨ç…§ç‰‡ + å¤‡æ³¨"ç”µè¡¨è¯»æ•°" â†’ ç‚¹å‡»ä¸Šä¼              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 1. æ–‡ä»¶ä¸Šä¼ 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        API: POST /api/v1/assets/upload_image_with_note       â”‚
â”‚  å·¥ä½œï¼šæ¥æ”¶æ–‡ä»¶ï¼Œä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œåˆ›å»º Asset è®°å½•              â”‚
â”‚  ç»“æœï¼šè¿”å› asset_id                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 2. è‡ªåŠ¨è·¯ç”±
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              route_image_asset() å‡½æ•°                        â”‚
â”‚  åˆ¤æ–­ content_roleï¼š                                          â”‚
â”‚  â€¢ "meter" â†’ OCR æ–‡å­—æå–                                     â”‚
â”‚  â€¢ "scene_issue" â†’ GLM-4V åœºæ™¯é—®é¢˜åˆ†æï¼ˆä¸è‡ªåŠ¨è°ƒç”¨ï¼Œéœ€ Workerï¼‰â”‚
â”‚  â€¢ å…¶ä»– â†’ ä»…å­˜å‚¨                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 3. OCR å¤„ç†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PaddleOCR æ–‡å­—è¯†åˆ«ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰                   â”‚
â”‚  æ­¥éª¤ 1: æ–‡å­—æ£€æµ‹ï¼ˆ0.6ç§’ï¼‰                                    â”‚
â”‚      â†’ æ‰¾åˆ°æ‰€æœ‰æ–‡å­—æ¡†ä½ç½®                                     â”‚
â”‚  æ­¥éª¤ 2: æ–‡å­—åˆ†ç±»ï¼ˆ0.25ç§’ï¼‰                                   â”‚
â”‚      â†’ åˆ¤æ–­æ–‡å­—æ˜¯å¦éœ€è¦æ—‹è½¬                                   â”‚
â”‚  æ­¥éª¤ 3: æ–‡å­—è¯†åˆ«ï¼ˆ3.3ç§’ï¼‰                                    â”‚
â”‚      â†’ è¯†åˆ«æ¯ä¸ªæ–‡å­—æ¡†çš„å†…å®¹                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 4. ç»“æœå¤„ç†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ„é€ ç»“æ„åŒ– JSON æ•°æ®                             â”‚
â”‚  {                                                          â”‚
â”‚    "annotations": {                                         â”‚
â”‚      "ocr_lines": [                                         â”‚
â”‚        {"text": "1234.5", "bbox": [...], "confidence": 0.998},â”‚
â”‚        {"text": "kWÂ·h", "bbox": [...], "confidence": 0.996}  â”‚
â”‚      ]                                                      â”‚
â”‚    },                                                       â”‚
â”‚    "stats": {"avg_confidence": 0.997, "engine": "paddleocr"} â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 5. ä¿å­˜åˆ°æ•°æ®åº“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         åˆ›å»º AssetStructuredPayload è®°å½•                      â”‚
â”‚  â€¢ schema_type: "image_annotation"                           â”‚
â”‚  â€¢ version: 1.0                                              â”‚
â”‚  â€¢ payload: <ä¸Šé¢æ„é€ çš„ JSON>                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 6. æ›´æ–°çŠ¶æ€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ›´æ–° Asset.status å­—æ®µ                          â”‚
â”‚  â€¢ å¦‚æœå¹³å‡ç½®ä¿¡åº¦ >= 0.8: "parsed_ocr_ok"                    â”‚
â”‚  â€¢ å¦‚æœå¹³å‡ç½®ä¿¡åº¦ < 0.8: "parsed_ocr_low_conf"               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 7. è¿”å›ç»“æœ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     è¿”å›ç»™ç”¨æˆ·                                â”‚
â”‚  {                                                          â”‚
â”‚    "id": "asset-uuid",                                      â”‚
â”‚    "status": "parsed_ocr_ok",                               â”‚
â”‚    "structured_payloads": [...]                            â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## GLM-4V åœºæ™¯é—®é¢˜åˆ†ææµç¨‹

### Worker åå°è‡ªåŠ¨å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  GLM Worker å¯åŠ¨ï¼ˆåå°è¿›ç¨‹ï¼‰                  â”‚
â”‚            python scene_issue_glm_worker.py                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ æ¯ 60 ç§’è½®è¯¢ä¸€æ¬¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æŸ¥è¯¢å¾…å¤„ç†çš„ scene_issue å›¾ç‰‡                    â”‚
â”‚  GET /api/v1/assets?modality=image&content_role=scene_issue  â”‚
â”‚  ç­›é€‰æ¡ä»¶ï¼šstatus IS NULL æˆ– status = "pending_scene_llm"    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ æ‰¾åˆ°å¾…å¤„ç†å›¾ç‰‡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  è¯»å–å›¾ç‰‡å’Œå¤‡æ³¨ä¿¡æ¯                            â”‚
â”‚  1. è·å– Asset è¯¦æƒ…ï¼ˆfile_path, descriptionï¼‰                â”‚
â”‚  2. ä»æœ¬åœ°å­˜å‚¨è¯»å–å›¾ç‰‡æ–‡ä»¶                                   â”‚
â”‚  3. è½¬æ¢ä¸º Base64 ç¼–ç                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ æ„é€  Prompt
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ„å»º GLM-4V åˆ†æ Prompt                      â”‚
â”‚  Prompt: "ä½ æ˜¯å»ºç­‘èŠ‚èƒ½è¯Šæ–­å·¥ç¨‹å¸ˆ...                          â”‚
â”‚           åˆ†æè¿™å¼ ç°åœºç…§ç‰‡ï¼Œè¯†åˆ«é—®é¢˜ã€åŸå› ã€å»ºè®®..."           â”‚
â”‚  å¤‡æ³¨ï¼š"ç®¡é“æ¥å£å¤„æœ‰æ¸—æ¼"                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ è°ƒç”¨ GLM API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è°ƒç”¨ GLM-4V APIï¼ˆ10-30ç§’ï¼‰                       â”‚
â”‚  â€¢ å‘é€å›¾ç‰‡ï¼ˆBase64ï¼‰+ Prompt                                â”‚
â”‚  â€¢ ç­‰å¾… GLM åˆ†æ                                            â”‚
â”‚  â€¢ æ¥æ”¶ JSON ç»“æœ                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ ç»“æœå¤„ç†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è§„èŒƒåŒ–åˆ†æç»“æœ                                   â”‚
â”‚  â€¢ ç¡®ä¿ JSON æ ¼å¼æ­£ç¡®                                       â”‚
â”‚  â€¢ è¡¥å……é»˜è®¤å€¼ï¼ˆå¦‚ç©ºåˆ—è¡¨ï¼‰                                    â”‚
â”‚  â€¢ æ•°æ®ç±»å‹è½¬æ¢ï¼ˆå­—ç¬¦ä¸² â†’ åˆ—è¡¨ï¼‰                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ æäº¤ç»“æœ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      POST /api/v1/assets/{asset_id}/scene_issue_report       â”‚
â”‚  æäº¤åˆ†æç»“æœåˆ°åç«¯ API                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ æ›´æ–°çŠ¶æ€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ›´æ–° Asset.status = "parsed_scene_llm"         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ ç»§ç»­è½®è¯¢
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç­‰å¾… 60 ç§’ï¼Œç»§ç»­ä¸‹ä¸€è½®è½®è¯¢                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Worker é…ç½®

**ç¯å¢ƒå˜é‡**ï¼š

```bash
# .env æ–‡ä»¶
GLM_API_KEY=your_glm_api_key_here
GLM_BASE_URL=https://open.bigmodel.cn/api/paas/v4/
GLM_VISION_MODEL=glm-4v
BDC_BACKEND_BASE_URL=http://localhost:8000
BDC_LOCAL_STORAGE_DIR=data/assets
BDC_SCENE_WORKER_POLL_INTERVAL=60  # è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰
```

**è½®è¯¢é€»è¾‘**ï¼š

```python
import time
from openai import OpenAI

client = OpenAI(api_key=GLM_API_KEY, base_url=GLM_BASE_URL)

def main():
    print("Starting GLM-4V scene_issue worker...")

    while True:
        # 1. æŸ¥è¯¢å¾…å¤„ç†å›¾ç‰‡
        assets = get_pending_scene_assets()

        if not assets:
            print("No pending assets found")
        else:
            # 2. å¤„ç†æ¯ä¸ªå¾…å¤„ç†å›¾ç‰‡
            for asset in assets:
                print(f"Processing asset {asset['id']}...")

                # 3. è¯»å–å›¾ç‰‡
                image_content = get_image_content(asset)
                if not image_content:
                    continue

                # 4. è°ƒç”¨ GLM-4V
                result = call_glm_vision(image_content, asset['description'])
                if not result:
                    continue

                # 5. æäº¤ç»“æœ
                post_scene_issue_report(asset['id'], result)

        # 6. ç­‰å¾…ä¸‹ä¸€è½®
        time.sleep(POLL_INTERVAL)

if __name__ == "__main__":
    main()
```

---

## ä»£ç å±‚é¢è§£æ

### 1. image_pipeline.py - æ™ºèƒ½è·¯ç”±

**ä½ç½®**ï¼š`services/backend/app/services/image_pipeline.py`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š

```python
from paddleocr import PaddleOCR
import logging

logger = logging.getLogger(__name__)

# å•ä¾‹æ¨¡å¼ï¼šå…¨å±€åªåˆ›å»ºä¸€ä¸ª OCR å®ä¾‹
_ocr_client = None

def _get_ocr_client():
    """è·å– OCR å®¢æˆ·ç«¯ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰"""
    global _ocr_client

    if _ocr_client is None:
        logger.info("åˆå§‹åŒ– PaddleOCR å®¢æˆ·ç«¯...")
        _ocr_client = PaddleOCR(
            use_angle_cls=True,
            lang='ch',
            show_log=False,
        )
        logger.info("PaddleOCR å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ")

    return _ocr_client


def route_image_asset(db: Session, asset_id: UUID) -> Asset:
    """
    æ™ºèƒ½å›¾ç‰‡è·¯ç”±ï¼šæ ¹æ® content_role è‡ªåŠ¨é€‰æ‹©å¤„ç†æ–¹å¼

    å¤„ç†æµç¨‹ï¼š
    1. æŸ¥è¯¢ Asset è®°å½•
    2. æ£€æŸ¥ modality å’Œ content_role
    3. æ ¹æ®ç±»å‹é€‰æ‹©å¤„ç†ï¼š
       - meter â†’ OCR æ–‡å­—æå–
       - scene_issue â†’ æ›´æ–°çŠ¶æ€ä¸º pending_scene_llm
       - å…¶ä»– â†’ ä»…å­˜å‚¨
    4. æ›´æ–° Asset çŠ¶æ€
    """
    asset = db.query(Asset).filter(Asset.id == asset_id).one()

    if asset.modality != "image":
        raise ValueError(f"ä¸æ”¯æŒçš„æ¨¡æ€ç±»å‹: {asset.modality}")

    role = (asset.content_role or "").lower()

    # è·¯ç”±é€»è¾‘
    if role == "meter":
        # ç”µè¡¨ã€é“­ç‰Œ â†’ OCR æ–‡å­—æå–
        logger.info(f"Asset {asset_id}: è·¯ç”±åˆ° OCR å¤„ç†")
        structured = process_image_with_ocr(db, asset_id)

    elif role == "scene_issue":
        # åœºæ™¯é—®é¢˜ â†’ æ›´æ–°çŠ¶æ€ï¼Œç­‰å¾… GLM Worker å¤„ç†
        logger.info(f"Asset {asset_id}: è·¯ç”±åˆ° GLM-4V å¤„ç†")
        asset.status = "pending_scene_llm"
        db.commit()
        db.refresh(asset)

    else:
        # å…¶ä»–ç±»å‹ â†’ ä»…å­˜å‚¨
        logger.info(f"Asset {asset_id}: ä»…å­˜å‚¨ï¼Œä¸è‡ªåŠ¨å¤„ç†")
        asset.status = "uploaded"
        db.commit()
        db.refresh(asset)

    return asset
```

### 2. scene_issue_glm_worker.py - GLM Worker

**ä½ç½®**ï¼š`services/worker/scene_issue_glm_worker.py`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š

```python
import time
import base64
import io
from pathlib import Path
from PIL import Image
from openai import OpenAI
import requests

# ç¯å¢ƒå˜é‡é…ç½®
BACKEND_BASE_URL = os.getenv("BDC_BACKEND_BASE_URL", "http://127.0.0.1:8000")
LOCAL_STORAGE_DIR = os.getenv("BDC_LOCAL_STORAGE_DIR", "./data/local_storage")
GLM_API_KEY = os.getenv("GLM_API_KEY", "")
GLM_BASE_URL = os.getenv("GLM_BASE_URL", "https://open.bigmodel.cn/api/paas/v4/")
VISION_MODEL = os.getenv("GLM_VISION_MODEL", "glm-4v")
POLL_INTERVAL = int(os.getenv("BDC_SCENE_WORKER_POLL_INTERVAL", "60"))

# åˆå§‹åŒ– GLM å®¢æˆ·ç«¯
client = OpenAI(api_key=GLM_API_KEY, base_url=GLM_BASE_URL)


def get_pending_scene_assets():
    """ä»åç«¯è·å–å¾…å¤„ç†çš„ scene_issue å›¾ç‰‡"""
    params = {
        "modality": "image",
        "content_role": "scene_issue",
    }

    resp = requests.get(
        f"{BACKEND_BASE_URL}/api/v1/assets",
        params=params,
        timeout=30
    )

    if resp.status_code != 200:
        return []

    assets = resp.json()
    # ç­›é€‰å¾…å¤„ç†çš„å›¾ç‰‡
    pending = [a for a in assets if a.get("status") in (None, "pending_scene_llm")]
    return pending


def get_image_content_from_detail(detail: dict):
    """ä» Asset è¯¦æƒ…è·å–å›¾ç‰‡å†…å®¹ï¼ˆBase64 ç¼–ç ï¼‰"""
    file_path = detail.get("file_path")
    if not file_path:
        return None

    full_path = Path(LOCAL_STORAGE_DIR) / file_path
    if not full_path.is_file():
        return None

    # è¯»å–å›¾ç‰‡å¹¶è½¬æ¢
    try:
        with Image.open(full_path) as img:
            if img.mode in ("RGBA", "P"):
                img = img.convert("RGB")

            buffered = io.BytesIO()
            img.save(buffered, format="JPEG")
            img_str = base64.b64encode(buffered.getvalue()).decode()

            return {
                "type": "image_url",
                "image_url": {
                    "url": f"data:image/jpeg;base64,{img_str}"
                }
            }
    except Exception as e:
        print(f"Error processing image: {e}")
        return None


def call_glm_vision(image_content: dict, note: str = None):
    """è°ƒç”¨ GLM-4V API è¿›è¡Œåœºæ™¯é—®é¢˜åˆ†æ"""
    prompt = """
ä½ æ˜¯ä¸€åå»ºç­‘èŠ‚èƒ½ä¸è¿è¡Œè¯Šæ–­å·¥ç¨‹å¸ˆåŠ©æ‰‹ã€‚
è¯·ç»“åˆç°åœºç…§ç‰‡åˆ†æç°åœºé—®é¢˜æˆ–è¿è¡ŒçŠ¶æ€ã€‚

ä¸¥æ ¼æŒ‰ç…§ä¸‹åˆ— JSON ç»“æ„è¾“å‡ºï¼š
{
  "title": "ä¸€å¥è¯çš„ç®€çŸ­æ ‡é¢˜",
  "issue_category": "é—®é¢˜ç±»åˆ«",
  "severity": "low | medium | high",
  "summary": "å¯¹ç°åœºä¸»è¦é—®é¢˜æˆ–çŠ¶æ€çš„ç®€è¦æè¿°",
  "suspected_causes": ["å¯èƒ½åŸå› 1", "å¯èƒ½åŸå› 2"],
  "recommended_actions": ["å»ºè®®æªæ–½1", "å»ºè®®æªæ–½2"],
  "confidence": 0.0 åˆ° 1.0 ä¹‹é—´çš„æ•°å­—,
  "tags": ["è‹¥å¹²çŸ­æ ‡ç­¾"]
}
"""

    if note:
        prompt += f"\n\nå·¥ç¨‹å¸ˆå¤‡æ³¨ï¼š{note}"

    try:
        response = client.chat.completions.create(
            model=VISION_MODEL,
            messages=[
                {
                    "role": "user",
                    "content": [
                        image_content,
                        {"type": "text", "text": prompt}
                    ]
                }
            ],
            response_format={"type": "json_object"},
            temperature=0.1
        )

        content = response.choices[0].message.content
        return json.loads(content)

    except Exception as e:
        print(f"GLM API Error: {e}")
        return None


def post_scene_issue_report(asset_id: str, payload: dict):
    """æäº¤åœºæ™¯é—®é¢˜æŠ¥å‘Šåˆ°åç«¯ API"""
    url = f"{BACKEND_BASE_URL}/api/v1/assets/{asset_id}/scene_issue_report"

    try:
        resp = requests.post(url, json=payload, timeout=60)
        if resp.status_code in (200, 201):
            print(f"[OK] Reported scene_issue for asset {asset_id}")
            return True
        else:
            print(f"[WARN] Failed: HTTP {resp.status_code}")
            return False
    except Exception as e:
        print(f"[ERROR] Exception: {e}")
        return False


def main():
    """ä¸»å¾ªç¯"""
    print("Starting GLM-4V scene_issue worker...")
    print(f"Backend: {BACKEND_BASE_URL}")
    print(f"Local storage: {LOCAL_STORAGE_DIR}")

    while True:
        print(f"\n[{time.strftime('%Y-%m-%d %H:%M:%S')}] Checking for pending assets...")

        assets = get_pending_scene_assets()
        print(f"Found {len(assets)} pending assets")

        for asset in assets:
            asset_id = asset.get("id")
            print(f"Processing {asset_id}...")

            # è·å–è¯¦æƒ…
            resp = requests.get(f"{BACKEND_BASE_URL}/api/v1/assets/{asset_id}")
            detail = resp.json()

            # è¯»å–å›¾ç‰‡
            image_content = get_image_content_from_detail(detail)
            if not image_content:
                continue

            # è°ƒç”¨ GLM
            note = detail.get("description") or ""
            result = call_glm_vision(image_content, note)
            if not result:
                continue

            # æäº¤ç»“æœ
            post_scene_issue_report(asset_id, result)

        # ç­‰å¾…ä¸‹ä¸€è½®
        print(f"Waiting {POLL_INTERVAL} seconds...")
        time.sleep(POLL_INTERVAL)


if __name__ == "__main__":
    main()
```

---

## å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šè¯†åˆ«ç”µè¡¨è¯»æ•°

**ç›®æ ‡**ï¼šä»ç”µè¡¨ç…§ç‰‡ä¸­æå–è¯»æ•°

**è¾“å…¥**ï¼šç”µè¡¨ç…§ç‰‡ + å¤‡æ³¨"ç”µè¡¨è¯»æ•°"

**OCR è¯†åˆ«ç»“æœ**ï¼š

```json
{
  "annotations": {
    "ocr_lines": [
      {"text": "1234.5", "confidence": 0.998},
      {"text": "kWÂ·h", "confidence": 0.996}
    ]
  },
  "stats": {
    "avg_confidence": 0.997,
    "engine": "paddleocr"
  }
}
```

**åç»­å¤„ç†**ï¼šå¯ä»¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æˆ– LLM æå–æ•°å€¼ï¼š`1234.5`

### åœºæ™¯ 2ï¼šåˆ†æç°åœºé—®é¢˜

**ç›®æ ‡**ï¼šè¯†åˆ«ç°åœºé—®é¢˜å¹¶ç»™å‡ºå»ºè®®

**è¾“å…¥**ï¼šç®¡é“æ¸—æ¼ç…§ç‰‡ + å¤‡æ³¨"ç®¡é“æ¥å£å¤„æœ‰æ¸—æ¼"

**GLM-4V åˆ†æç»“æœ**ï¼š

```json
{
  "title": "ç®¡é“æ¥å£æ¸—æ¼",
  "issue_category": "è®¾å¤‡ç»´æŠ¤",
  "severity": "medium",
  "summary": "ç®¡é“æ¥å£å¤„å‡ºç°æ¸—æ¼ï¼Œå¯èƒ½å½±å“ç³»ç»Ÿæ­£å¸¸è¿è¡Œ",
  "suspected_causes": [
    "å¯†å°å«è€åŒ–",
    "æ¥å£æ¾åŠ¨",
    "å‹åŠ›è¿‡å¤§"
  ],
  "recommended_actions": [
    "æ›´æ¢å¯†å°å«",
    "ç´§å›ºæ¥å£",
    "æ£€æŸ¥ç³»ç»Ÿå‹åŠ›"
  ],
  "confidence": 0.85,
  "tags": ["ç®¡é“", "æ¸—æ¼", "ç»´æŠ¤"]
}
```

### åœºæ™¯ 3ï¼šæ‰¹é‡å¤„ç†ç°åœºç…§ç‰‡

**å®ç°**ï¼š

```bash
# 1. ä¸Šä¼ å¤šå¼ ç°åœºé—®é¢˜ç…§ç‰‡
for file in issue_*.jpg; do
    curl -X POST "http://localhost:8000/api/v1/assets/upload_image_with_note" \
        -F "project_id=$PROJECT_ID" \
        -F "modality=image" \
        -F "content_role=scene_issue" \
        -F "file=@$file" \
        -F "note=ç°åœºé—®é¢˜ç…§ç‰‡"
done

# 2. å¯åŠ¨ GLM Workerï¼ˆä¼šè‡ªåŠ¨å¤„ç†ï¼‰
python services/worker/scene_issue_glm_worker.py

# Worker ä¼šï¼š
# - æ¯ 60 ç§’è½®è¯¢ä¸€æ¬¡
# - æ‰¾åˆ°å¾…å¤„ç†çš„å›¾ç‰‡
# - è°ƒç”¨ GLM-4V åˆ†æ
# - æäº¤ç»“æœåˆ°åç«¯
# - æ›´æ–°çŠ¶æ€ä¸º "parsed_scene_llm"
```

---

## å¸¸è§é—®é¢˜ä¸è§£å†³

### âŒ é—®é¢˜ 1ï¼šPaddleOCR é¦–æ¬¡è¿è¡Œæ…¢

**ç°è±¡**ï¼šç¬¬ä¸€æ¬¡è°ƒç”¨ OCR æ—¶å¡ä½ 2-3 åˆ†é’Ÿ

**åŸå› **ï¼šPaddleOCR é¦–æ¬¡è¿è¡Œéœ€è¦ä¸‹è½½æ¨¡å‹æ–‡ä»¶

```
ä¸‹è½½å†…å®¹ï¼š
â”œâ”€â”€ æ£€æµ‹æ¨¡å‹ï¼šch_PP-OCRv4_det_infer.tar (~4.9 MB)
â”œâ”€â”€ è¯†åˆ«æ¨¡å‹ï¼šch_PP-OCRv4_rec_infer.tar (~11 MB)
â””â”€â”€ åˆ†ç±»æ¨¡å‹ï¼šch_ppocr_mobile_v2.0_cls_infer.tar (~2.2 MB)

ä¸‹è½½ä½ç½®ï¼š
C:\Users\<ç”¨æˆ·å>\.paddleocr\whl\
```

**è§£å†³**ï¼š
- âœ… è€å¿ƒç­‰å¾…ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰
- âœ… åç»­è¿è¡Œä¼šä½¿ç”¨ç¼“å­˜ï¼Œé€Ÿåº¦å¿«
- âœ… å¯ä»¥æå‰ä¸‹è½½æ¨¡å‹åˆ°ç¦»çº¿ç¯å¢ƒ

### âŒ é—®é¢˜ 2ï¼šGLM API è°ƒç”¨å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
openai.error.AuthenticationError: Incorrect API key provided
```

**åŸå› **ï¼šAPI Key é…ç½®é”™è¯¯æˆ–æœªé…ç½®

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥ .env æ–‡ä»¶
cat .env | grep GLM_API_KEY

# åº”è¯¥è¾“å‡ºï¼š
# GLM_API_KEY=your_actual_api_key_here

# å¦‚æœæ²¡æœ‰é…ç½®ï¼Œæ·»åŠ åˆ° .envï¼š
echo "GLM_API_KEY=your_glm_api_key_here" >> .env
```

### âŒ é—®é¢˜ 3ï¼šå›¾ç‰‡æ–‡ä»¶è¯»å–å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
FileNotFoundError: Local image file not found
```

**åŸå› **ï¼š
- `BDC_LOCAL_STORAGE_DIR` é…ç½®é”™è¯¯
- æ–‡ä»¶è·¯å¾„ä¸åŒ¹é…
- æ–‡ä»¶æœªæ­£ç¡®ä¿å­˜

**è§£å†³**ï¼š
```python
# æ£€æŸ¥é…ç½®
from shared.config.settings import get_settings
settings = get_settings()
print(f"æœ¬åœ°å­˜å‚¨ç›®å½•: {settings.local_storage_dir}")

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
from pathlib import Path
file_path = Path(settings.local_storage_dir) / "project_id" / "uuid.jpg"
print(f"æ–‡ä»¶å­˜åœ¨: {file_path.exists()}")
```

---

## æœ€ä½³å®è·µ

### 1. ä½¿ç”¨æ™ºèƒ½è·¯ç”±

```python
# âœ“ æ¨èï¼šè®©ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©å¤„ç†æ–¹å¼
POST /api/v1/assets/upload_image_with_note
?content_role=meter
&auto_route=true

# æ ¹æ® content_role è‡ªåŠ¨ï¼š
# â€¢ meter â†’ OCR
# â€¢ scene_issue â†’ GLM-4V
# â€¢ å…¶ä»– â†’ ä»…å­˜å‚¨
```

### 2. ä½¿ç”¨ Worker åå°å¤„ç†

```python
# âœ“ æ¨èï¼šå¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡ API
# 1. ä¸Šä¼ å›¾ç‰‡ï¼ˆç«‹å³è¿”å›ï¼‰
POST /api/v1/assets/upload_image_with_note
?content_role=scene_issue

# 2. Worker åå°è‡ªåŠ¨å¤„ç†
# ï¼ˆæ— éœ€æ‰‹åŠ¨è§¦å‘ï¼Œè½®è¯¢å¤„ç†ï¼‰
```

### 3. å¤šç‰ˆæœ¬ç®¡ç†

```python
# âœ“ æ¨èï¼šä¿ç•™æ‰€æœ‰å†å²ç‰ˆæœ¬
# æ¯æ¬¡é‡æ–°è§£æç”Ÿæˆæ–°ç‰ˆæœ¬
# é€šè¿‡ created_at æ’åºè·å–æœ€æ–°ç‰ˆ
payloads = db.query(AssetStructuredPayload)\
    .filter(AssetStructuredPayload.asset_id == asset_id)\
    .order_by(AssetStructuredPayload.created_at.desc())\
    .all()

# æœ€æ–°ç‰ˆæœ¬
latest = payloads[0] if payloads else None
```

---

## æ€»ç»“

å¤šæ¨¡æ€æ•°æ®å¤„ç†æ¨¡å—æä¾›ï¼š

| èƒ½åŠ› | å®ç°æ–¹å¼ | æ€§èƒ½ |
|------|----------|------|
| å›¾ç‰‡æ–‡å­—è¯†åˆ« | PaddleOCR 2.7.0.3 | 4.2 ç§’/å¼  |
| åœºæ™¯é—®é¢˜åˆ†æ | GLM-4V API | 10-30 ç§’/å¼  |
| æ™ºèƒ½è·¯ç”± | content_role åˆ¤æ–­ | è‡ªåŠ¨ |
| ç»“æ„åŒ–å­˜å‚¨ | PostgreSQL + JSON | è‡ªåŠ¨ |
| ç‰ˆæœ¬ç®¡ç† | AssetStructuredPayload | è‡ªåŠ¨ |
| åå°å¤„ç† | GLM Worker | 60 ç§’è½®è¯¢ |

**ç®€å•è¯´**ï¼šè¿™ä¸ªæ¨¡å—è®©"çœ‹ä¸æ‡‚å›¾ç‰‡"çš„è®¡ç®—æœºï¼Œå˜æˆäº†"èƒ½è¯»æ‡‚å†…å®¹ + åˆ†æé—®é¢˜"çš„æ™ºèƒ½åŠ©æ‰‹ï¼

---

# å·¥ç¨‹ç»“æ„æ ‘è¯¦è§£

## ğŸ“– æ¦‚è¿°

å·¥ç¨‹ç»“æ„æ ‘æ˜¯ BDC-AI é¡¹ç›®çš„**ç©ºé—´ç»„ç»‡æ ¸å¿ƒ**,å°±åƒ"å»ºç­‘å¸ˆçš„è®¾è®¡è“å›¾",è®©ç³»ç»Ÿèƒ½å¤ŸæŒ‰ç…§"å»ºç­‘-åŒºåŸŸ-ç³»ç»Ÿ-è®¾å¤‡"çš„å±‚çº§å…³ç³»ç»„ç»‡å’Œç®¡ç†æ‰€æœ‰èµ„æ–™ã€‚

**æ ¸å¿ƒä»·å€¼**:
- âœ… å±‚çº§ç»“æ„ç®¡ç†:Building â†’ Zone/System â†’ Device çš„å®Œæ•´æ ‘å½¢ç»“æ„
- âœ… è·¯å¾„è¿½è¸ª:ç”Ÿæˆ"å·¥ç¨‹å¸ˆè·¯å¾„"(å¦‚"Aåº§åŠå…¬æ¥¼ / HVACç³»ç»Ÿ / é£æœºç›˜ç®¡FCU-03")
- âœ… çµæ´»æŸ¥è¯¢:æ”¯æŒæŒ‰ä»»æ„å±‚çº§èŠ‚ç‚¹æŸ¥è¯¢ä¸‹çº§è®¾å¤‡å’Œèµ„äº§
- âœ… å•æ ‘æ¨¡å‹:Device å½’å± System,ä½ç½®åœ¨ Zone,é¿å…æ•°æ®å†²çª
- âœ… æ˜“äºæ‰©å±•:bigtree åº“æä¾›ä¸°å¯Œçš„æ ‘æ“ä½œ API

**é€šä¿—ç†è§£**:
```
å·¥ç¨‹ç»“æ„æ ‘ = å»ºç­‘å¸ˆçš„è®¾è®¡è“å›¾ + æ¡£æ¡ˆç®¡ç†å‘˜çš„ç´¢å¼•ç³»ç»Ÿ

æ•°æ®åº“ä¸­æ‰å¹³çš„å…³ç³»è¡¨:
â”œâ”€â”€ buildings (å»ºç­‘åˆ—è¡¨)
â”œâ”€â”€ zones (åŒºåŸŸåˆ—è¡¨)
â”œâ”€â”€ systems (ç³»ç»Ÿåˆ—è¡¨)
â””â”€â”€ devices (è®¾å¤‡åˆ—è¡¨)

bigtree å°†å…¶è½¬æ¢ä¸ºæœ‰ç»„ç»‡çš„æ ‘:
ğŸ“¦ é¡¹ç›®æ ¹
  â””â”€â”€ ğŸ¢ Aåº§åŠå…¬æ¥¼
      â”œâ”€â”€ ğŸ¢ 5FåŠå…¬åŒº
      â””â”€â”€ âš™ï¸ HVACç³»ç»Ÿ
          â””â”€â”€ ğŸ”§ é£æœºç›˜ç®¡FCU-03
```

---

## æ ¸å¿ƒç»„æˆ

### é¡¹ç›®ç»“æ„

```
services/backend/app/
â”œâ”€â”€ api/v1/
â”‚   â””â”€â”€ engineering.py         # å·¥ç¨‹ç»“æ„ API æ¥å£
â””â”€â”€ services/
    â””â”€â”€ tree_service.py         # æ ‘ç»“æ„æ„å»ºæœåŠ¡

shared/db/
â””â”€â”€ models_project.py           # Building/Zone/System/Device æ¨¡å‹
```

### ç»„ä»¶èŒè´£

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ | ç±»æ¯” |
|------|------|------|------|
| API æ¥å£ | engineering.py | æä¾› CRUD å’Œæ ‘æŸ¥è¯¢æ¥å£ | æœåŠ¡çª—å£ |
| æ ‘æœåŠ¡ | tree_service.py | æ„å»ºå’Œè½¬æ¢æ ‘ç»“æ„ | å»ºç­‘å¸ˆ |
| æ ‘æ“ä½œåº“ | bigtree | æ ‘èŠ‚ç‚¹ç®¡ç†å’Œæ“ä½œ | å·¥å…·ç®± |
| æ•°æ®æ¨¡å‹ | models_project.py | å­˜å‚¨å±‚çº§å…³ç³»æ•°æ® | æ¡£æ¡ˆæŸœ |

---

## ä¾èµ–åº“è¯¦è§£

### requirements.txt (å·¥ç¨‹ç»“æ„éƒ¨åˆ†)

```txt
# æ ‘ç»“æ„æ“ä½œ
bigtree==0.16.4               # Python æ ‘ç»“æ„æ“ä½œåº“
```

### bigtree - æ ‘ç»“æ„æ“ä½œåº“

**ä½œç”¨**: ç®¡ç†å’Œæ“ä½œå±‚çº§æ ‘ç»“æ„æ•°æ®

**é€šä¿—ç†è§£**: å°±åƒ**æ—è°±ç®¡ç†å·¥å…·**

```
bigtree çš„å·¥ä½œè¿‡ç¨‹:
â”œâ”€â”€ æ„å»º Node: åˆ›å»ºæ ‘èŠ‚ç‚¹(åƒç»™å®¶æ—æˆå‘˜ç™»è®°)
â”œâ”€â”€ å»ºç«‹å…³ç³»: æŒ‡å®šçˆ¶å­å…³ç³»(åƒæ¢³ç†è¡€ç¼˜å…³ç³»)
â”œâ”€â”€ æ ‘éå†: æŸ¥æ‰¾å­èŠ‚ç‚¹/çˆ¶èŠ‚ç‚¹(åƒæŸ¥æ‰¾ç¥–å…ˆ/åä»£)
â”œâ”€â”€ è·¯å¾„è¿½è¸ª: è·å–èŠ‚ç‚¹è·¯å¾„(åƒæ¢³ç†ä¸–ç³»)
â””â”€â”€ ç»“æ„è½¬æ¢: æ ‘ â†” å­—å…¸/åˆ—è¡¨ äº’è½¬(åƒå¯¼å‡ºå®¶è°±)
```

**æ ¸å¿ƒç‰¹æ€§**:

```python
from bigtree import Node, dict_to_tree, nested_dict_to_tree

# 1. åˆ›å»ºæ ‘èŠ‚ç‚¹
root = Node(name="é¡¹ç›®æ ¹", type="project_root")

building = Node(name="Aåº§åŠå…¬æ¥¼", type="building", parent=root)
system = Node(name="HVACç³»ç»Ÿ", type="system", parent=building)
device = Node(name="é£æœºç›˜ç®¡FCU-03", type="device", parent=system)

# 2. æŸ¥è¯¢å…³ç³»
device.parent          # â†’ è·å–çˆ¶èŠ‚ç‚¹
device.children        # â†’ è·å–å­èŠ‚ç‚¹åˆ—è¡¨
device.ancestors       # â†’ è·å–æ‰€æœ‰ç¥–å…ˆ
root.descendants       # â†’ è·å–æ‰€æœ‰åä»£

# 3. è·¯å¾„è¿½è¸ª
device.path_name       # â†’ "é¡¹ç›®æ ¹/Aåº§åŠå…¬æ¥¼/HVACç³»ç»Ÿ/é£æœºç›˜ç®¡FCU-03"

# 4. ä»åµŒå¥—å­—å…¸æ„å»ºæ ‘(æ¨èä½¿ç”¨)
tree_dict = {
    "name": "é¡¹ç›®æ ¹",
    "type": "project_root",
    "children": [
        {
            "name": "Aåº§åŠå…¬æ¥¼",
            "type": "building",
            "children": [
                {"name": "HVACç³»ç»Ÿ", "type": "system"}
            ]
        }
    ]
}
root = nested_dict_to_tree(tree_dict)

# ä¼˜åŠ¿:
# âœ“ è‡ªåŠ¨æ„å»ºçˆ¶å­å…³ç³»
# âœ“ ä¿ç•™æ‰€æœ‰è‡ªå®šä¹‰å­—æ®µ
# âœ“ æ— éœ€æ‰‹åŠ¨ç®¡ç† parent å‚æ•°
```

**ä¸ºä»€ä¹ˆé€‰æ‹© bigtree**:

| ç‰¹æ€§ | bigtree | ç½‘ç»œåº“(networkx) | è‡ªå·±å®ç° |
|------|---------|-----------------|----------|
| ä¸“ç”¨äºæ ‘ç»“æ„ | âœ… æ˜¯ | âŒ å›¾(æ›´å¤æ‚) | - |
| API æ˜“ç”¨æ€§ | â­â­â­â­â­ | â­â­â­ | â­ |
| é›¶ä¾èµ– | âœ… (ä»… pandas) | âŒ | - |
| è·¯å¾„è¿½è¸ª | âœ… å†…ç½® | âš ï¸ éœ€æ‰‹åŠ¨å®ç° | âš ï¸ éœ€æ‰‹åŠ¨å®ç° |
| å­—å…¸äº’è½¬ | âœ… å†…ç½® | âŒ éœ€æ‰‹åŠ¨å®ç° | âš ï¸ éœ€æ‰‹åŠ¨å®ç° |
| æ ‘å¯è§†åŒ– | âœ… å†…ç½® | âœ… å¤–éƒ¨åº“ | âŒ |

**æŠ€æœ¯äº®ç‚¹**:

```python
# 1. å•ä¸€ä¾èµ–(ä»… pandas,å¤§å¤šæ•°é¡¹ç›®å·²æœ‰)
pip install bigtree

# 2. æ”¯æŒ nested_dict(æœ€å¸¸ç”¨çš„ JSON æ ¼å¼)
from bigtree import nested_dict_to_tree

tree_dict = {
    "name": "æ ¹èŠ‚ç‚¹",
    "children": [
        {"name": "å­èŠ‚ç‚¹1"},
        {"name": "å­èŠ‚ç‚¹2"}
    ]
}
root = nested_dict_to_tree(tree_dict)

# 3. ä¸°å¯Œçš„æŸ¥è¯¢ API
node = root.children[0]
node.depth              # èŠ‚ç‚¹æ·±åº¦
node.is_leaf           # æ˜¯å¦å¶å­èŠ‚ç‚¹
node.is_root           # æ˜¯å¦æ ¹èŠ‚ç‚¹
node.siblings          # å…„å¼ŸèŠ‚ç‚¹
```

---

## æ ‘ç»“æ„è®¾è®¡

### è®¾è®¡æ–¹æ¡ˆå¯¹æ¯”

#### æ–¹æ¡ˆ A: åŒæ ‘æ¨¡å‹(ä¸æ¨è)

```
é—®é¢˜: Device åŒæ—¶å‡ºç°åœ¨ System æ ‘å’Œ Zone æ ‘ä¸­
System æ ‘: Building â†’ System â†’ Device
Zone æ ‘:   Building â†’ Zone â†’ Device

å†²çª: Device æ•°æ®å†—ä½™,ç»´æŠ¤å›°éš¾
```

#### æ–¹æ¡ˆ B: å•æ ‘æ¨¡å‹(âœ… æ¨è)

```
è®¾è®¡åŸåˆ™: Device å½’å± System,ä½ç½®åœ¨ Zone

Building æ ‘:
Building
  â”œâ”€â”€ System(ä¸»å½’å±)
  â”‚   â””â”€â”€ Device â†’ Device.zone å…³è” Zone å¯¹è±¡
  â””â”€â”€ Zone(ä½ç½®è§†å›¾,åŒ…å« device_count)

ä¼˜åŠ¿:
âœ… å•ä¸€æ•°æ®æº(Device åªåœ¨ System æ ‘)
âœ… Zone ä½œä¸º Device çš„å±æ€§å¼•ç”¨
âœ… Zone åŒæ—¶å±•ç¤ºä¸ºç‹¬ç«‹èŠ‚ç‚¹(å¸¦è®¾å¤‡è®¡æ•°)
âœ… æ— æ•°æ®å†—ä½™
```

### å®é™…æ ‘ç»“æ„

```
é¡¹ç›®æ ¹ (project-root)
â”‚
â””â”€â”€ Aåº§åŠå…¬æ¥¼
    â”œâ”€â”€ HVACç³»ç»Ÿ âš™ï¸
    â”‚   â””â”€â”€ é£æœºç›˜ç®¡FCU-03 ğŸ”§
    â”‚       â””â”€â”€ zone: "5FåŠå…¬åŒº"
    â”‚
    â””â”€â”€ 5FåŠå…¬åŒº ğŸ¢
        â””â”€â”€ device_count: 1
```

**ä»£ç å®ç°**:

```python
from bigtree import Node

def build_project_tree(project_id, db):
    """æ„å»ºé¡¹ç›®çš„å·¥ç¨‹ç»“æ„æ ‘"""
    from sqlalchemy.orm import joinedload

    # 1. æŸ¥è¯¢æ•°æ®(ä½¿ç”¨ eager loading é¿å… N+1)
    buildings = db.query(Building)\
        .options(
            joinedload(Building.zones),
            joinedload(Building.systems)
            .joinedload(BuildingSystem.devices)
            .joinedload(Device.zone)
        )\
        .filter(Building.project_id == project_id)\
        .all()

    # 2. æ„å»ºæ ‘æ ¹èŠ‚ç‚¹
    root = Node(
        name="é¡¹ç›®æ ¹",
        type="project_root",
        id="project-root"
    )

    # 3. é€’å½’æ„å»ºæ ‘
    for building in buildings:
        building_node = Node(
            name=building.name,
            type="building",
            id=str(building.id)
        )
        building_node.parent = root

        # 3.1 æ·»åŠ  System å­æ ‘
        for system in building.systems:
            system_node = Node(
                name=system.name or system.type,
                type="system",
                id=str(system.id),
                system_type=system.type
            )
            system_node.parent = building_node

            # æ·»åŠ  Device
            for device in system.devices:
                device_data = {
                    "name": device.model or device.device_type,
                    "type": "device",
                    "id": str(device.id),
                    "device_type": device.device_type
                }

                # å¦‚æœ Device æœ‰ Zone,æ·»åŠ å¼•ç”¨
                if device.zone:
                    device_data["zone"] = {
                        "id": str(device.zone.id),
                        "name": device.zone.name
                    }

                device_node = Node(**device_data)
                device_node.parent = system_node

        # 3.2 æ·»åŠ  Zone èŠ‚ç‚¹(ç‹¬ç«‹å±•ç¤º)
        for zone in building.zones:
            zone_node = Node(
                name=zone.name,
                type="zone",
                id=str(zone.id),
                zone_type=zone.type,
                device_count=len(zone.devices)
            )
            zone_node.parent = building_node

    return root
```

---

## å·¥ä½œæµç¨‹

### å®Œæ•´æ ‘æ„å»ºæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              API è¯·æ±‚: GET /projects/{id}/structure_tree      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 1. æŸ¥è¯¢æ•°æ®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä»æ•°æ®åº“æŸ¥è¯¢ Building/Zone/System/Device        â”‚
â”‚              ä½¿ç”¨ joinedload ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰å…³ç³»               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 2. æ„å»ºæ ‘ç»“æ„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              EngineeringTreeService.build_project_tree()      â”‚
â”‚              â€¢ åˆ›å»ºæ ¹èŠ‚ç‚¹(project-root)                       â”‚
â”‚              â€¢ é€’å½’æ·»åŠ  Building â†’ System â†’ Device          â”‚
â”‚              â€¢ æ·»åŠ  Zone èŠ‚ç‚¹(å¸¦ device_count)               â”‚
â”‚              â€¢ å»ºç«‹çˆ¶å­å…³ç³»(parent å±æ€§)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 3. è½¬æ¢ä¸ºå­—å…¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              EngineeringTreeService.tree_to_dict()           â”‚
â”‚              â€¢ é€’å½’éå†æ ‘èŠ‚ç‚¹                                  â”‚
â”‚              â€¢ æå–èŠ‚ç‚¹å±æ€§(id, name, type, ç­‰)               â”‚
â”‚              â€¢ æ„é€ åµŒå¥—å­—å…¸ç»“æ„                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 4. è¿”å› JSON
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¿”å›ç»™å®¢æˆ·ç«¯                              â”‚
â”‚  {                                                         â”‚
â”‚    "project_id": "uuid",                                    â”‚
â”‚    "tree": {                                               â”‚
â”‚      "id": "project-root",                                 â”‚
â”‚      "name": "é¡¹ç›®æ ¹",                                     â”‚
â”‚      "type": "project_root",                               â”‚
â”‚      "children": [...]                                    â”‚
â”‚    }                                                       â”‚
â”‚  }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä»£ç å±‚é¢è§£æ

### 1. tree_service.py - æ ‘æœåŠ¡

**ä½ç½®**: `services/backend/app/services/tree_service.py`

**æ ¸å¿ƒåŠŸèƒ½**:

```python
from typing import List
from bigtree import Node
from sqlalchemy.orm import Session, joinedload

from shared.db.models_project import Building, Zone, BuildingSystem, Device


class EngineeringTreeService:
    """å·¥ç¨‹ç»“æ„æ ‘æœåŠ¡ - åŸºäº Building/Zone/System/Device æ„å»ºé¡¹ç›®å·¥ç¨‹æ ‘ã€‚"""

    @staticmethod
    def build_project_tree(project_id: str, db: Session) -> Node:
        """
        æ„å»ºé¡¹ç›®çš„å·¥ç¨‹ç»“æ„æ ‘,å¹¶è¿”å› bigtree çš„æ ¹èŠ‚ç‚¹ã€‚

        è®¾è®¡åŸåˆ™:
        - Device å½’å±äº System(ä¸»å…³ç³»)
        - Device ä½äº Zone(ä»å…³ç³»,ä½œä¸ºå±æ€§å¼•ç”¨)
        - Zone ä½œä¸ºç‹¬ç«‹èŠ‚ç‚¹å±•ç¤º(å¸¦è®¾å¤‡è®¡æ•°)
        """
        # ä½¿ç”¨ eager loading ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
        buildings: List[Building] = (
            db.query(Building)
            .options(
                joinedload(Building.zones),
                joinedload(Building.systems)
                .joinedload(BuildingSystem.devices)
                .joinedload(Device.zone),
            )
            .filter(Building.project_id == project_id)
            .all()
        )

        # åˆ›å»ºæ ¹èŠ‚ç‚¹
        root = Node(name="é¡¹ç›®æ ¹", type="project_root", id="project-root")

        # é€’å½’æ„å»ºæ ‘
        for building in buildings:
            building_node = Node(
                name=building.name,
                type="building",
                id=str(building.id)
            )
            building_node.parent = root

            # æ·»åŠ  System å­æ ‘(Device çš„ä¸»å½’å±)
            for system in building.systems:
                system_node = Node(
                    name=system.name or system.type,
                    type="system",
                    id=str(system.id),
                    system_type=system.type
                )
                system_node.parent = building_node

                # æ·»åŠ  Device
                for device in system.devices:
                    device_kwargs = {
                        "name": device.model or (device.device_type or "device"),
                        "type": "device",
                        "id": str(device.id),
                        "device_type": device.device_type
                    }

                    # å¦‚æœ Device æœ‰ä½ç½®ä¿¡æ¯,æ·»åŠ  Zone å¼•ç”¨
                    if device.zone:
                        device_kwargs["zone"] = {
                            "id": str(device.zone.id),
                            "name": device.zone.name
                        }

                    device_node = Node(**device_kwargs)
                    device_node.parent = system_node

            # æ·»åŠ  Zone èŠ‚ç‚¹(ä½ç½®è§†å›¾)
            for zone in building.zones:
                zone_node = Node(
                    name=zone.name,
                    type="zone",
                    id=str(zone.id),
                    zone_type=zone.type,
                    device_count=len(zone.devices)  # è®¾å¤‡è®¡æ•°
                )
                zone_node.parent = building_node

        return root

    @staticmethod
    def tree_to_dict(node: Node) -> dict:
        """
        å°† bigtree Node è½¬æ¢ä¸ºå¯åºåˆ—åŒ–çš„å­—å…¸ã€‚

        æå–èŠ‚ç‚¹å±æ€§,ä¿ç•™ä¸šåŠ¡å­—æ®µ(id, name, type, ç­‰),
        é€’å½’å¤„ç†å­èŠ‚ç‚¹ã€‚
        """
        if node.is_leaf:
            # å¶å­èŠ‚ç‚¹: è¿”å›æ‰€æœ‰å±æ€§
            return {k: v for k, v in vars(node).items() if not k.startswith("_")}

        # éå¶å­èŠ‚ç‚¹: è¿”å›ç»“æ„åŒ–æ•°æ®
        return {
            "id": getattr(node, "id", None),
            "name": node.node_name,
            "type": getattr(node, "type", None),
            "children": [
                EngineeringTreeService.tree_to_dict(child)
                for child in node.children
            ],
        }
```

### 2. engineering.py - API æ¥å£

**ä½ç½®**: `services/backend/app/api/v1/engineering.py`

**æ ¸å¿ƒæ¥å£**:

```python
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session
from ...services.tree_service import EngineeringTreeService

router = APIRouter()

@router.get(
    "/projects/{project_id}/structure_tree",
    summary="è·å–å·¥ç¨‹ç»“æ„æ ‘",
)
async def get_project_structure_tree(
    project_id: uuid.UUID,
    db: Session = Depends(get_db),
) -> dict:
    """
    è¿”å›é¡¹ç›®çš„å®Œæ•´å·¥ç¨‹ç»“æ„æ ‘ã€‚

    æ ‘ç»“æ„:
    - é¡¹ç›®æ ¹
      - Building
        - System (Device çš„ä¸»å½’å±)
          - Device
            - zone: {id, name} (ä½ç½®å¼•ç”¨)
        - Zone (ä½ç½®è§†å›¾)
          - device_count: æ•°å­—

    è¿”å›æ ¼å¼:
    {
        "project_id": "uuid",
        "tree": {
            "id": "project-root",
            "name": "é¡¹ç›®æ ¹",
            "type": "project_root",
            "children": [...]
        }
    }
    """
    # æ„å»ºæ ‘
    root = EngineeringTreeService.build_project_tree(project_id, db)

    # è½¬æ¢ä¸ºå­—å…¸
    return {
        "project_id": str(project_id),
        "tree": EngineeringTreeService.tree_to_dict(root),
    }
```

---

## å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯ 1: æŒ‰è®¾å¤‡æŸ¥è¯¢èµ„äº§

**ç›®æ ‡**: æŸ¥è¯¢æŸä¸ªè®¾å¤‡çš„æ‰€æœ‰ç›¸å…³èµ„äº§

**API è°ƒç”¨**:

```python
# 1. è·å–é¡¹ç›®ç»“æ„æ ‘
GET /api/v1/projects/{project_id}/structure_tree

# å“åº”
{
  "project_id": "uuid",
  "tree": {
    "children": [
      {
        "name": "Aåº§åŠå…¬æ¥¼",
        "children": [
          {
            "name": "HVACç³»ç»Ÿ",
            "children": [
              {
                "name": "é£æœºç›˜ç®¡FCU-03",
                "id": "device-uuid",
                "type": "device"
              }
            ]
          }
        ]
      }
    ]
  }
}

# 2. æ ¹æ®è®¾å¤‡ ID æŸ¥è¯¢èµ„äº§
GET /api/v1/assets?device_id=device-uuid

# è¿”å›è¯¥è®¾å¤‡å…³è”çš„æ‰€æœ‰å›¾ç‰‡ã€è¡¨æ ¼ç­‰èµ„äº§
```

### åœºæ™¯ 2: å·¥ç¨‹å¸ˆè·¯å¾„ç”Ÿæˆ

**ç›®æ ‡**: ç”Ÿæˆäººç±»å¯è¯»çš„è®¾å¤‡è·¯å¾„

**å®ç°**:

```python
def get_engineer_path(device_id: uuid.UUID, db: Session) -> str:
    """
    ç”Ÿæˆ"å·¥ç¨‹å¸ˆè·¯å¾„": "Aåº§åŠå…¬æ¥¼ / HVACç³»ç»Ÿ / é£æœºç›˜ç®¡FCU-03"
    """
    device = db.query(Device).filter(Device.id == device_id).one()

    # æ‰‹åŠ¨æ„å»ºè·¯å¾„(é¿å…æ ‘éå†å¼€é”€)
    system = db.query(BuildingSystem).filter(
        BuildingSystem.id == device.system_id
    ).one()

    building = db.query(Building).filter(
        Building.id == system.building_id
    ).one()

    path_parts = [
        building.name,
        system.name or system.type,
        device.model or device.device_type
    ]

    return " / ".join(path_parts)
```

**è¾“å‡º**: `"Aåº§åŠå…¬æ¥¼ / HVACç³»ç»Ÿ / é£æœºç›˜ç®¡FCU-03"`

### åœºæ™¯ 3: Zone è®¾å¤‡ç»Ÿè®¡

**ç›®æ ‡**: æŸ¥è¯¢æŸä¸ªåŒºåŸŸåŒ…å«å“ªäº›è®¾å¤‡

**å®ç°**:

```python
# æ–¹å¼ 1: é€šè¿‡æ ‘ç»“æ„
tree = EngineeringTreeService.build_project_tree(project_id, db)
zone_node = tree.find_child(lambda n: n.id == zone_uuid)
device_count = zone_node.device_count

# æ–¹å¼ 2: é€šè¿‡æ•°æ®åº“ç›´æ¥æŸ¥è¯¢(æ›´å¿«)
zone = db.query(Zone).filter(Zone.id == zone_uuid).one()
devices = db.query(Device).filter(Device.zone_id == zone_uuid).all()

print(f"åŒºåŸŸ {zone.name} åŒ…å« {len(devices)} ä¸ªè®¾å¤‡")
for device in devices:
    print(f"  - {device.model} (ç³»ç»Ÿ: {device.system.name})")
```

---

## æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ Eager Loading ä¼˜åŒ–æŸ¥è¯¢

```python
# âŒ ä¸æ¨è: N+1 æŸ¥è¯¢é—®é¢˜
buildings = db.query(Building).all()
for building in buildings:
    for system in building.systems:  # æ¯æ¬¡è§¦å‘ä¸€æ¬¡æŸ¥è¯¢
        for device in system.devices:  # åˆè§¦å‘ä¸€æ¬¡æŸ¥è¯¢
            print(device.name)

# âœ… æ¨è: ä½¿ç”¨ joinedload é¢„åŠ è½½
buildings = db.query(Building)\
    .options(
        joinedload(Building.systems)
        .joinedload(BuildingSystem.devices)
    )\
    .all()

# æ‰€æœ‰æ•°æ®ä¸€æ¬¡æŸ¥è¯¢å®Œæˆ
```

### 2. å•æ ‘æ¨¡å‹é¿å…æ•°æ®å†—ä½™

```python
# âœ… æ­£ç¡®: Device å½’å± System
class Device(Base):
    system_id = Column(UUID, ForeignKey("systems.id"), nullable=False)  # ä¸»å½’å±
    zone_id = Column(UUID, ForeignKey("zones.id"), nullable=True)       # ä½ç½®(å¯é€‰)

# æŸ¥è¯¢: Device â†’ System â†’ Building
device.system.building.name

# æŸ¥è¯¢: Device â†’ Zone
device.zone.name if device.zone else None
```

### 3. ç¼“å­˜æ ‘ç»“æ„

```python
from functools import lru_cache
from sqlalchemy.orm import Session

@lru_cache(maxsize=128)
def get_cached_tree(project_id: str, last_update: str) -> dict:
    """
    ç¼“å­˜æ ‘ç»“æ„(åŸºäºé¡¹ç›®æœ€åæ›´æ–°æ—¶é—´)

    å½“é¡¹ç›®æ•°æ®æ›´æ–°æ—¶,last_update å˜åŒ–,ç¼“å­˜è‡ªåŠ¨å¤±æ•ˆ
    """
    db = SessionLocal()
    try:
        root = EngineeringTreeService.build_project_tree(project_id, db)
        return EngineeringTreeService.tree_to_dict(root)
    finally:
        db.close()
```

---

## å¸¸è§é—®é¢˜ä¸è§£å†³

### âŒ é—®é¢˜ 1: dict_to_tree æŠ¥é”™ "keywords must be strings"

**é”™è¯¯ä¿¡æ¯**:
```
TypeError: keywords must be strings
File "bigtree/tree/construct.py", line 872
```

**åŸå› **: ä½¿ç”¨äº†é”™è¯¯çš„å‡½æ•°

```python
# âŒ é”™è¯¯: dict_to_tree æœŸæœ›"è·¯å¾„å­—å…¸",ä¸æ˜¯åµŒå¥—å­—å…¸
from bigtree import dict_to_tree

path_dict = {
    "Aåº§åŠå…¬æ¥¼": {"type": "building"},
    "Aåº§åŠå…¬æ¥¼/HVACç³»ç»Ÿ": {"type": "system"}
}
root = dict_to_tree(path_dict)  # âœ“ è¿™æ˜¯æ­£ç¡®çš„ç”¨æ³•

nested_dict = {
    "name": "Aåº§åŠå…¬æ¥¼",
    "children": [...]
}
root = dict_to_tree(nested_dict)  # âœ— é”™è¯¯!
```

**è§£å†³**: ä½¿ç”¨ `nested_dict_to_tree`

```python
# âœ… æ­£ç¡®
from bigtree import nested_dict_to_tree

nested_dict = {
    "name": "Aåº§åŠå…¬æ¥¼",
    "children": [
        {"name": "HVACç³»ç»Ÿ", "children": [...]}
    ]
}
root = nested_dict_to_tree(nested_dict)
```

### âŒ é—®é¢˜ 2: æ ‘æ„å»ºæ€§èƒ½æ…¢

**ç°è±¡**: å¤§é‡è®¾å¤‡æ—¶,æ ‘æ„å»ºè¶…è¿‡ 10 ç§’

**åŸå› **: N+1 æŸ¥è¯¢é—®é¢˜

**è§£å†³**: ä½¿ç”¨ joinedload

```python
# âŒ æ…¢: N+1 æŸ¥è¯¢
buildings = db.query(Building).all()  # 1 æ¬¡æŸ¥è¯¢
for building in buildings:
    systems = building.systems         # N æ¬¡æŸ¥è¯¢
    for system in systems:
        devices = system.devices       # N*M æ¬¡æŸ¥è¯¢

# âœ… å¿«: é¢„åŠ è½½æ‰€æœ‰å…³ç³»
buildings = db.query(Building)\
    .options(
        joinedload(Building.systems)
        .joinedload(BuildingSystem.devices)
        .joinedload(Device.zone)
    )\
    .all()  # åªéœ€ 1-3 æ¬¡æŸ¥è¯¢
```

---

## æ€»ç»“

å·¥ç¨‹ç»“æ„æ ‘æ¨¡å—æä¾›:

| èƒ½åŠ› | å®ç°æ–¹å¼ | æ€§èƒ½ |
|------|----------|------|
| æ ‘ç»“æ„ç®¡ç† | bigtree 0.16.4 | å¿« |
| å±‚çº§å…³ç³»æŸ¥è¯¢ | joinedload | ä¼˜åŒ– |
| è·¯å¾„è¿½è¸ª | Node.path_name | å†…ç½® |
| å•æ ‘æ¨¡å‹ | System ä¸»å½’å± | æ— å†—ä½™ |
| å­—å…¸äº’è½¬ | tree_to_dict | è‡ªåŠ¨ |
| Zone è®¾å¤‡è®¡æ•° | len(zone.devices) | å‡†ç¡® |

**ç®€å•è¯´**: è¿™ä¸ªæ¨¡å—è®©"æ‰å¹³çš„æ•°æ®åº“è¡¨",å˜æˆäº†"æœ‰ç»„ç»‡çš„å·¥ç¨‹è“å›¾",å·¥ç¨‹å¸ˆå¯ä»¥æŒ‰ç†Ÿæ‚‰çš„"å»ºç­‘-ç³»ç»Ÿ-è®¾å¤‡"è§†è§’æµè§ˆå’Œç®¡ç†æ‰€æœ‰èµ„æ–™!

---

## ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®è§„åˆ’æ–‡æ¡£](../GUIDEBOOK/PLAN.md)
- [å·¥ç¨‹ç»“æ„ API è®¾è®¡](../ENGINEERING_STRUCTURE_API_DESIGN.md)
- [å¼€æºæŠ€æœ¯æ ˆæ¨è](../GUIDEBOOK/OPEN_SOURCE_RECOMMENDATIONS.md)
- [README ä¸»æ–‡æ¡£](../README.md)
- [é¡¹ç›®è¿›åº¦æ€»ç»“](../PROJECT_PROGRESS_SUMMARY.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.1
**æœ€åæ›´æ–°**: 2025-01-20
**ç»´æŠ¤è€…**: BDC-AI å¼€å‘å›¢é˜Ÿ

---

# PC UI æŠ€æœ¯æ¶æ„è¯¦è§£

## ğŸ“– æ¦‚è¿°

PC UI æ˜¯ BDC-AI é¡¹ç›®çš„**å‰ç«¯å¯è§†åŒ–å±‚**ï¼ŒåŸºäº NiceGUI æ¡†æ¶æ„å»ºï¼Œä¸ºç”¨æˆ·æä¾›ç›´è§‚çš„æ•°æ®æµè§ˆå’Œç®¡ç†ç•Œé¢ã€‚é€šè¿‡ 2025-01-22 åˆ° 2026-01-23 çš„æ¶æ„é‡æ„ï¼ŒPC UI å·²ä»å•ä½“ 1939 è¡Œä»£ç é‡æ„ä¸ºæ¨¡å—åŒ–æ¶æ„ï¼Œå…·å¤‡å¯ç»´æŠ¤ã€å¯æµ‹è¯•ã€å¯æ‰©å±•çš„ç‰¹æ€§ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- âœ… å·¥ç¨‹ç»“æ„æ ‘æµè§ˆï¼šBuilding/Zone/System/Device å±‚çº§å±•ç¤º
- âœ… èµ„äº§å¯è§†åŒ–ç®¡ç†ï¼šå›¾ç‰‡ä¸Šä¼ ã€æŸ¥çœ‹ã€åˆ é™¤
- âœ… OCR ç»“æœå±•ç¤ºï¼šæ–‡å­—è¯†åˆ«ç»“æœå’Œç»Ÿè®¡ä¿¡æ¯
- âœ… GLM-4V åˆ†ææŠ¥å‘Šï¼šåœºæ™¯é—®é¢˜æ™ºèƒ½è¯Šæ–­
- âœ… äº¤äº’å¼æ“ä½œï¼šè¡¨æ ¼è¡Œç‚¹å‡»è”åŠ¨ã€å›¾ç‰‡é¢„è§ˆ
- âœ… æ¨¡å—åŒ–æ¶æ„ï¼šä»£ç å¯ç»´æŠ¤ã€å¯æµ‹è¯•ã€å¯æ‰©å±•

**é€šä¿—ç†è§£**ï¼š
```
PC UI = ç”¨æˆ·æ“ä½œç•Œé¢ + å¯è§†åŒ–å±•ç¤ºå·¥å…·

å°±åƒæ±½è½¦ä»ªè¡¨ç›˜ï¼š
â”œâ”€â”€ å·¥ç¨‹ç»“æ„æ ‘ â†’ å¯¼èˆªåœ°å›¾ï¼ˆå‘Šè¯‰æˆ‘ç°åœ¨åœ¨å“ªé‡Œï¼‰
â”œâ”€â”€ Asset åˆ—è¡¨ â†’ è¡Œè½¦è®°å½•ï¼ˆå‘Šè¯‰æˆ‘å‘ç”Ÿäº†ä»€ä¹ˆï¼‰
â”œâ”€â”€ è¯¦æƒ…é¢æ¿ â†’ ä»ªè¡¨ç›˜ï¼ˆå‘Šè¯‰æˆ‘è¯¦ç»†ä¿¡æ¯ï¼‰
â””â”€â”€ æ“ä½œæŒ‰é’® â†’ æ§åˆ¶æŒ‰é’®ï¼ˆè®©æˆ‘å¯ä»¥æ“ä½œï¼‰
```

---

## æ ¸å¿ƒç»„æˆ

### é¡¹ç›®ç»“æ„

```
desktop/nicegui_app/
â”œâ”€â”€ pc_app.py                  # ä¸»åº”ç”¨å…¥å£ï¼ˆ1044 è¡Œï¼Œ-46%ï¼‰
â”œâ”€â”€ api/                       # API Client å°è£…
â”‚   â””â”€â”€ backend_client.py      # BackendClientï¼ˆ18 ä¸ªæ–¹æ³•ï¼‰
â”œâ”€â”€ state/                     # çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ app_state.py           # AppStateï¼ˆå…¨å±€åº”ç”¨çŠ¶æ€ï¼‰
â”‚   â”œâ”€â”€ project_state.py       # ProjectStateï¼ˆé¡¹ç›®çŠ¶æ€ï¼‰
â”‚   â”œâ”€â”€ tree_state.py          # TreeStateï¼ˆæ ‘çŠ¶æ€ï¼‰
â”‚   â””â”€â”€ asset_state.py         # AssetStateï¼ˆèµ„äº§çŠ¶æ€ï¼‰
â”œâ”€â”€ ui/                        # UI ç»„ä»¶
â”‚   â”œâ”€â”€ dialogs.py             # å¯¹è¯æ¡†ç»„ä»¶ï¼ˆ891 è¡Œï¼‰
â”‚   â”œâ”€â”€ panels.py              # è¯¦æƒ…é¢æ¿ç»„ä»¶ï¼ˆ297 è¡Œï¼‰
â”‚   â””â”€â”€ tables.py              # è¡¨æ ¼ç»„ä»¶ï¼ˆ230 è¡Œï¼‰
â”œâ”€â”€ helpers/                   # è¾…åŠ©å‡½æ•°
â”‚   â””â”€â”€ common_helpers.py      # é€šç”¨å·¥å…·å‡½æ•°ï¼ˆ312 è¡Œï¼‰
â””â”€â”€ events/                    # äº‹ä»¶å¤„ç†
    â””â”€â”€ asset_events.py        # èµ„äº§äº‹ä»¶å¤„ç†ï¼ˆ305 è¡Œï¼‰
```

### ç»„ä»¶èŒè´£

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ | ç±»æ¯” |
|------|------|------|------|
| ä¸»åº”ç”¨ | pc_app.py | åº”ç”¨å…¥å£ã€é¡µé¢å¸ƒå±€ã€ç»„ä»¶é›†æˆ | æ€»æŒ‡æŒ¥ |
| API Client | backend_client.py | å°è£…æ‰€æœ‰åç«¯ API è°ƒç”¨ | é€šè®¯å®˜ |
| çŠ¶æ€ç®¡ç† | state/*.py | é›†ä¸­å¼çŠ¶æ€ç®¡ç† | æ¡£æ¡ˆç®¡ç†å‘˜ |
| UI ç»„ä»¶ | ui/*.py | å¯¹è¯æ¡†ã€é¢æ¿ã€è¡¨æ ¼ç»„ä»¶ | å»ºç­‘æ¨¡å— |
| è¾…åŠ©å‡½æ•° | helpers/*.py | é€šç”¨å·¥å…·å‡½æ•° | å·¥å…·ç®± |
| äº‹ä»¶å¤„ç† | events/*.py | äº‹ä»¶å¤„ç†é€»è¾‘ | äº‹ä»¶è°ƒåº¦å‘˜ |

---

## ä¾èµ–åº“è¯¦è§£

### requirements.txtï¼ˆPC UI éƒ¨åˆ†ï¼‰

```txt
# Web UI æ¡†æ¶
nicegui==3.5.0             # Python Web UI æ¡†æ¶

# HTTP å®¢æˆ·ç«¯
httpx==0.28.1              # å¼‚æ­¥ HTTP å®¢æˆ·ç«¯
```

### 1. NiceGUI 3.5.0 - Web UI æ¡†æ¶

**ä½œç”¨**ï¼šæä¾›ç°ä»£åŒ–çš„ Web UI ç»„ä»¶å’Œäº¤äº’èƒ½åŠ›

**é€šä¿—ç†è§£**ï¼šå°±åƒ**ä¹é«˜ç§¯æœ¨å¥—è£…**

```
NiceGUI æä¾›ï¼š
â”œâ”€â”€ ä¸°å¯Œçš„ç»„ä»¶ï¼šæŒ‰é’®ã€è¡¨æ ¼ã€å¯¹è¯æ¡†ã€æ ‘å½¢æ§ä»¶ç­‰
â”œâ”€â”€ å“åº”å¼å¸ƒå±€ï¼šè‡ªåŠ¨é€‚é…ä¸åŒå±å¹•å°ºå¯¸
â”œâ”€â”€ äº‹ä»¶å¤„ç†ï¼šç‚¹å‡»ã€ä¸Šä¼ ã€æ‹–æ‹½ç­‰äº¤äº’
â”œâ”€â”€ æ ·å¼ç³»ç»Ÿï¼šåŸºäº Quasar/Vue çš„ç¾è§‚ UI
â””â”€â”€ Python åŸç”Ÿï¼šæ— éœ€å­¦ä¹ å‰ç«¯æŠ€æœ¯
```

**æ ¸å¿ƒç‰¹æ€§**ï¼š

```python
from nicegui import ui

# 1. ä¸°å¯Œçš„ç»„ä»¶
button = ui.button("ç‚¹å‡»æˆ‘", on_click=handle_click)
table = ui.table(columns=[...], rows=[...])
dialog = ui.dialog()

# 2. äº‹ä»¶å¤„ç†ï¼ˆNiceGUI 3.5.0 æ–°ç‰¹æ€§ï¼‰
# æ”¯æŒ handler + js_handler åŒæ—¶ä½¿ç”¨
table.on(
    "rowClick",
    on_row_click,                          # Python å¤„ç†å‡½æ•°
    js_handler="(evt, row) => emit(row))"  # JavaScript å¤„ç†
)

# 3. å“åº”å¼å¸ƒå±€
with ui.row():  # æ¨ªå‘æ’åˆ—
    ui.button("A")
    ui.button("B")

with ui.column():  # çºµå‘æ’åˆ—
    ui.button("C")
    ui.button("D")
```

**NiceGUI 3.5.0 å‡çº§äº®ç‚¹**ï¼š

| ç‰¹æ€§ | 2.7.0 | 3.5.0 | ä¼˜åŠ¿ |
|------|-------|-------|------|
| handler + js_handler | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ | å¯åŒæ—¶å¤„ç† Python å’Œ JavaScript |
| è¡¨æ ¼è¡Œç‚¹å‡»äº‹ä»¶ | âš ï¸ å·¥ä½œä¸ç¨³å®š | âœ… å®Œå…¨æ”¯æŒ | å¯é çš„è¡Œç‚¹å‡»è”åŠ¨ |
| æ€§èƒ½ | è‰¯å¥½ | ä¼˜ç§€ | æ›´å¿«çš„å“åº”é€Ÿåº¦ |
| æ–‡æ¡£å®Œæ•´æ€§ | åŸºç¡€ | å®Œå–„ | æ›´å¥½çš„å¼€å‘ä½“éªŒ |

**ä¸ºä»€ä¹ˆè¦å‡çº§åˆ° 3.5.0**ï¼š

```python
# âŒ NiceGUI 2.7.0 æ— æ³•å®ç°çš„ä»£ç 
table.on("rowClick", js_handler="emit(row)")  # æ— æ³•è·å–è¡Œæ•°æ®
table.on("rowClick", on_row_click)            # äº‹ä»¶ä¸è§¦å‘

# âœ… NiceGUI 3.5.0 å®Œç¾æ”¯æŒ
table.on(
    "rowClick",
    on_row_click,                          # Python å¤„ç†
    js_handler="(evt, row) => emit(row)"   # JavaScript å¤„ç†å¹¶ä¼ é€’æ•°æ®
)
```

### 2. httpx - å¼‚æ­¥ HTTP å®¢æˆ·ç«¯

**ä½œç”¨**ï¼šä¸åç«¯ API è¿›è¡Œé€šä¿¡

**é€šä¿—ç†è§£**ï¼šå°±åƒ**ç”µè¯**

```
httpx æä¾›ï¼š
â”œâ”€â”€ å¼‚æ­¥è¯·æ±‚ï¼šä¸é˜»å¡ UI
â”œâ”€â”€ è‡ªåŠ¨åºåˆ—åŒ–ï¼šPython å¯¹è±¡ â†” JSON
â”œâ”€â”€ é”™è¯¯å¤„ç†ï¼šç½‘ç»œå¼‚å¸¸ã€è¶…æ—¶é‡è¯•
â””â”€â”€ ç±»å‹æç¤ºï¼šIDE è‡ªåŠ¨è¡¥å…¨
```

**ä»£ç ç¤ºä¾‹**ï¼š

```python
import httpx

async def get_projects():
    async with httpx.AsyncClient() as client:
        response = await client.get(
            "http://localhost:8000/api/v1/projects/",
            timeout=30.0
        )
        response.raise_for_status()
        return response.json()
```

---

## æ¶æ„è®¾è®¡

### 1. BackendClient ç»Ÿä¸€å°è£…

**è®¾è®¡ç›®çš„**ï¼šç»Ÿä¸€æ‰€æœ‰åç«¯ API è°ƒç”¨ï¼Œé¿å…ä»£ç é‡å¤

**ä½ç½®**ï¼š`desktop/nicegui_app/api/backend_client.py`

**æ ¸å¿ƒå®ç°**ï¼š

```python
import httpx
from typing import List, Dict, Any, Optional

class BackendClient:
    """åç«¯ API å®¢æˆ·ç«¯ - ç»Ÿä¸€å°è£…æ‰€æœ‰ API è°ƒç”¨"""

    def __init__(self, base_url: str = "http://localhost:8000/api/v1", timeout: float = 30.0):
        self.base_url = base_url
        self.timeout = timeout

    async def _request(self, method: str, path: str, **kwargs) -> Any:
        """ç»Ÿä¸€è¯·æ±‚æ–¹æ³•"""
        url = f"{self.base_url}/{path.lstrip('/')}"
        async with httpx.AsyncClient(timeout=self.timeout) as client:
            response = await client.request(method, url, **kwargs)
            response.raise_for_status()
            return response.json()

    # ===== é¡¹ç›® API (5 ä¸ªæ–¹æ³•) =====
    async def list_projects(self) -> List[Dict]:
        """è·å–é¡¹ç›®åˆ—è¡¨"""
        return await self._request("GET", "projects/")

    async def get_project(self, project_id: str) -> Optional[Dict]:
        """è·å–å•ä¸ªé¡¹ç›®"""
        projects = await self.list_projects()
        for project in projects:
            if str(project.get("id")) == str(project_id):
                return project
        return None

    async def create_project(self, data: Dict) -> Dict:
        """åˆ›å»ºé¡¹ç›®"""
        return await self._request("POST", "projects/", json=data)

    async def update_project(self, project_id: str, data: Dict) -> Dict:
        """æ›´æ–°é¡¹ç›®"""
        return await self._request("PATCH", f"projects/{project_id}", json=data)

    async def delete_project(self, project_id: str, reason: str) -> None:
        """åˆ é™¤é¡¹ç›®"""
        await self._request("DELETE", f"projects/{project_id}", params={"reason": reason})

    # ===== å·¥ç¨‹ç»“æ„ API (4 ä¸ªæ–¹æ³•) =====
    async def get_structure_tree(self, project_id: str) -> Dict:
        """è·å–å·¥ç¨‹ç»“æ„æ ‘"""
        return await self._request("GET", f"projects/{project_id}/structure_tree")

    async def create_building(self, project_id: str, name: str) -> Dict:
        """åˆ›å»ºæ¥¼æ ‹"""
        return await self._request("POST", f"projects/{project_id}/buildings", json={"name": name})

    async def update_node(self, node_type: str, node_id: str, data: Dict) -> Dict:
        """æ›´æ–°å·¥ç¨‹èŠ‚ç‚¹"""
        return await self._request("PATCH", f"{node_type}/{node_id}", json=data)

    async def delete_node(self, node_type: str, node_id: str, reason: str) -> None:
        """åˆ é™¤å·¥ç¨‹èŠ‚ç‚¹"""
        await self._request("DELETE", f"{node_type}/{node_id}", params={"reason": reason})

    # ===== èµ„äº§ API (4 ä¸ªæ–¹æ³•) =====
    async def list_assets(self, device_id: str = None, **filters) -> List[Dict]:
        """è·å–èµ„äº§åˆ—è¡¨"""
        params = {"device_id": device_id, **filters}
        return await self._request("GET", "assets/", params=params)

    async def get_asset(self, asset_id: str) -> Dict:
        """è·å–èµ„äº§è¯¦æƒ…"""
        return await self._request("GET", f"assets/{asset_id}")

    async def upload_image(
        self,
        file_path: str,
        project_id: str,
        device_id: str = None,
        note: str = ""
    ) -> Dict:
        """ä¸Šä¼ å›¾ç‰‡"""
        with open(file_path, "rb") as f:
            files = {"file": f}
            data = {
                "project_id": project_id,
                "note": note,
                "modality": "image",
                "content_role": "scene_issue"
            }
            if device_id:
                data["device_id"] = device_id
            return await self._request("POST", "assets/upload_image_with_note", files=files, data=data)

    async def delete_asset(self, asset_id: str) -> None:
        """åˆ é™¤èµ„äº§"""
        await self._request("DELETE", f"assets/{asset_id}")

    # ===== AI åˆ†æ API (2 ä¸ªæ–¹æ³•) =====
    async def run_ocr(self, asset_id: str) -> Dict:
        """è¿è¡Œ OCR è¯†åˆ«"""
        return await self._request("POST", f"assets/{asset_id}/run_ocr")

    async def run_scene_llm(self, asset_id: str) -> Dict:
        """è¿è¡Œåœºæ™¯é—®é¢˜åˆ†æ"""
        return await self._request("POST", f"assets/{asset_id}/run_scene_llm")
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```python
# åˆå§‹åŒ–å®¢æˆ·ç«¯
client = BackendClient(base_url="http://localhost:8000/api/v1")

# è°ƒç”¨ API
projects = await client.list_projects()
tree = await client.get_structure_tree(project_id)
assets = await client.list_assets(device_id="device-uuid")
```

### 2. çŠ¶æ€ç®¡ç†æ¨¡å¼

**è®¾è®¡ç›®çš„**ï¼šé›†ä¸­ç®¡ç†åº”ç”¨çŠ¶æ€ï¼Œé¿å…é—­åŒ…å˜é‡æ··ä¹±

**ä½ç½®**ï¼š`desktop/nicegui_app/state/`

**æ ¸å¿ƒå®ç°**ï¼š

```python
from dataclasses import dataclass, field
from typing import Optional, List, Dict, Any

@dataclass
class AssetStateRef:
    """èµ„äº§çŠ¶æ€å¼•ç”¨ - ç”¨äºäº‹ä»¶å¤„ç†çš„è½»é‡çº§çŠ¶æ€å¼•ç”¨"""
    selected_asset: Optional[Dict[str, Any]] = None
    all_assets_for_device: Optional[List[Dict[str, Any]]] = None

@dataclass
class ProjectState:
    """é¡¹ç›®çŠ¶æ€"""
    current_project: Optional[Dict[str, Any]] = None
    all_projects: List[Dict[str, Any]] = field(default_factory=list)

@dataclass
class TreeState:
    """æ ‘çŠ¶æ€"""
    expanded_nodes: List[str] = field(default_factory=list)
    selected_node: Optional[Dict[str, Any]] = None

@dataclass
class AssetState:
    """èµ„äº§çŠ¶æ€"""
    asset_list: List[Dict[str, Any]] = field(default_factory=list)
    selected_asset_id: Optional[str] = None
    detail_title: Optional[str] = None
    detail_panel_visible: bool = False

@dataclass
class AppState:
    """å…¨å±€åº”ç”¨çŠ¶æ€ - èšåˆæ‰€æœ‰å­çŠ¶æ€"""
    project: ProjectState = field(default_factory=ProjectState)
    tree: TreeState = field(default_factory=TreeState)
    asset: AssetState = field(default_factory=AssetState)
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```python
# åˆå§‹åŒ–çŠ¶æ€
app_state = AppState()

# æ›´æ–°çŠ¶æ€
app_state.project.current_project = project_data
app_state.asset.asset_list = assets_data

# è®¿é—®çŠ¶æ€
current_project = app_state.project.current_project
asset_list = app_state.asset.asset_list
```

### 3. Context-based äº‹ä»¶å¤„ç†

**è®¾è®¡ç›®çš„**ï¼šè§£è€¦ UI ç»„ä»¶å’Œä¸šåŠ¡é€»è¾‘

**ä½ç½®**ï¼š`desktop/nicegui_app/events/asset_events.py`

**æ ¸å¿ƒå®ç°**ï¼š

```python
from dataclasses import dataclass
from typing import Any, Optional
from nicegui import ui

@dataclass
class AssetUIContext:
    """èµ„äº§ UI ä¸Šä¸‹æ–‡ - åŒ…å«æ‰€æœ‰ UI ç»„ä»¶å¼•ç”¨"""
    asset_state: AssetStateRef
    asset_table: Any  # ui.table
    detail_title: Any  # ui.label
    detail_image: Any  # ui.image
    detail_ocr: Any  # ui.label
    detail_scene_issue: Any  # ui.markdown
    upload_btn: Any  # ui.button
    delete_btn: Any  # ui.button
    run_ocr_btn: Any  # ui.button
    run_llm_btn: Any  # ui.button
    refresh_btn: Any  # ui.button
    # ... æ›´å¤š UI å…ƒç´ 

def on_asset_row_click(
    context: AssetUIContext,
    asset_id: str
) -> None:
    """è¡¨æ ¼è¡Œç‚¹å‡»äº‹ä»¶å¤„ç†å™¨"""
    # æŸ¥æ‰¾é€‰ä¸­çš„èµ„äº§
    selected = None
    for asset in context.asset_state.all_assets_for_device:
        if str(asset.get("id")) == str(asset_id):
            selected = asset
            break

    if selected:
        # æ›´æ–°çŠ¶æ€
        context.asset_state.selected_asset = selected

        # æ›´æ–° UIï¼ˆé€šè¿‡ Context è®¿é—® UI å…ƒç´ ï¼‰
        context.detail_title.text = f"èµ„äº§è¯¦æƒ…: {selected.get('title', 'N/A')}"
        context.detail_image.source = selected.get("download_url", "")
        # ... æ›´æ–°å…¶ä»– UI å…ƒç´ 
```

**ä¼˜åŠ¿**ï¼š

```python
# âŒ ä¼ ç»Ÿæ–¹å¼ï¼šé—­åŒ…å˜é‡æ··ä¹±
def create_asset_table():
    title_label = ui.label()
    detail_image = ui.image()

    def on_click(e):
        # éœ€è¦ä»å¤–éƒ¨ä½œç”¨åŸŸè®¿é—® title_label, detail_image
        title_label.text = "..."
        detail_image.source = "..."

    table = ui.table(columns=[...], rows=[...])
    table.on("rowClick", on_click)

# âœ… Context æ–¹å¼ï¼šæ¸…æ™°è§£è€¦
context = AssetUIContext(
    asset_state=AssetStateRef(),
    detail_title=title_label,
    detail_image=detail_image,
    # ... æ‰€æœ‰ UI å…ƒç´ 
)

table.on("rowClick", lambda e: on_asset_row_click(context, e.args))
```

### 4. UI ç»„ä»¶æ¨¡å—åŒ–

**è®¾è®¡ç›®çš„**ï¼šå°†å¤§å‹ UI æ‹†åˆ†ä¸ºå¯å¤ç”¨çš„ç»„ä»¶

**ä½ç½®**ï¼š`desktop/nicegui_app/ui/`

**æ ¸å¿ƒå®ç°**ï¼š

```python
class ProjectDialog:
    """é¡¹ç›®å¯¹è¯æ¡†ç»„ä»¶ - é™æ€æ–¹æ³•ç±»"""

    @staticmethod
    def create_project_dialog(on_confirm):
        """åˆ›å»ºé¡¹ç›®å¯¹è¯æ¡†"""
        with ui.dialog() as dialog:
            with ui.card():
                ui.label("åˆ›å»ºæ–°é¡¹ç›®").classes("text-h6")

                name_input = ui.input("é¡¹ç›®åç§°")
                location_input = ui.input("é¡¹ç›®ä½ç½®")

                async def confirm():
                    project_data = {
                        "name": name_input.value,
                        "location": location_input.value
                    }
                    await on_confirm(project_data)
                    dialog.close()

                with ui.row():
                    ui.button("ç¡®å®š", on_click=confirm)
                    ui.button("å–æ¶ˆ", on_click=dialog.close)

        return dialog

class AssetDetailHelper:
    """èµ„äº§è¯¦æƒ…è¾…åŠ©ç±» - é™æ€æ–¹æ³•ç±»"""

    @staticmethod
    def update_detail_panel(context: AssetUIContext, asset: Dict):
        """æ›´æ–°è¯¦æƒ…é¢æ¿"""
        context.detail_title.text = f"èµ„äº§è¯¦æƒ…: {asset.get('title', 'N/A')}"
        context.detail_image.source = asset.get("download_url", "")

        # OCR ç»“æœ
        ocr_result = asset.get("structured_payloads", [{}])[0].get("payload", {}).get("annotations", {})
        ocr_text = "\n".join([line.get("text", "") for line in ocr_result.get("ocr_lines", [])])
        context.detail_ocr.text = f"OCR è¯†åˆ«ç»“æœ:\n{ocr_text}"

        # GLM åˆ†æç»“æœ
        scene_issue = asset.get("structured_payloads", [{}])[0].get("payload", {})
        if scene_issue.get("title"):
            context.detail_scene_issue.content = f"""
## {scene_issue.get('title')}

**é—®é¢˜ç±»åˆ«**: {scene_issue.get('issue_category')}
**ä¸¥é‡ç¨‹åº¦**: {scene_issue.get('severity')}

### æ‘˜è¦
{scene_issue.get('summary')}

### å¯èƒ½åŸå› 
{chr(10).join(f"- {c}" for c in scene_issue.get('suspected_causes', []))}

### å»ºè®®æªæ–½
{chr(10).join(f"- {a}" for a in scene_issue.get('recommended_actions', []))}
            """

class AssetTableHelper:
    """èµ„äº§è¡¨æ ¼è¾…åŠ©ç±» - é™æ€æ–¹æ³•ç±»"""

    @staticmethod
    def create_asset_table(columns: List[Dict], on_row_click):
        """åˆ›å»ºèµ„äº§è¡¨æ ¼"""
        table = ui.table(columns=columns, rows=[])

        # NiceGUI 3.5.0 ç‰¹æ€§ï¼šåŒæ—¶ä½¿ç”¨ handler å’Œ js_handler
        table.on(
            "rowClick",
            on_row_click,
            js_handler="(evt, row, index) => emit(row)"
        )

        return table
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```python
# åˆ›å»ºé¡¹ç›®å¯¹è¯æ¡†
dialog = ProjectDialog.create_project_dialog(on_confirm=create_project_handler)
dialog.open()

# æ›´æ–°è¯¦æƒ…é¢æ¿
AssetDetailHelper.update_detail_panel(context, selected_asset)

# åˆ›å»ºèµ„äº§è¡¨æ ¼
table = AssetTableHelper.create_asset_table(
    columns=[
        {"name": "title", "label": "æ ‡é¢˜", "field": "title"},
        {"name": "modality", "label": "ç±»å‹", "field": "modality"},
    ],
    on_row_click=lambda e: on_asset_row_click(context, e.args)
)
```

---

## å·¥ä½œæµç¨‹

### å®Œæ•´è¯·æ±‚å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·æ“ä½œï¼ˆPC UIï¼‰                          â”‚
â”‚              ç‚¹å‡»è¡¨æ ¼è¡Œ â†’ æŸ¥çœ‹èµ„äº§è¯¦æƒ…                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 1. äº‹ä»¶è§¦å‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              NiceGUI 3.5.0 äº‹ä»¶ç³»ç»Ÿ                           â”‚
â”‚  table.on("rowClick", handler, js_handler)                   â”‚
â”‚  - js_handler åœ¨æµè§ˆå™¨ç«¯æ‰§è¡Œï¼Œæå–è¡Œæ•°æ®                       â”‚
â”‚  - handler åœ¨ Python ç«¯æ‰§è¡Œï¼Œæ›´æ–° UI                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 2. è°ƒç”¨äº‹ä»¶å¤„ç†å™¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              events/asset_events.py                           â”‚
â”‚  on_asset_row_click(context, asset_id):                      â”‚
â”‚  - ä» context.asset_state æŸ¥æ‰¾èµ„äº§                           â”‚
â”‚  - æ›´æ–° context.asset_state.selected_asset                   â”‚
â”‚  - è°ƒç”¨ AssetDetailHelper.update_detail_panel()              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 3. æ›´æ–° UI
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              UI ç»„ä»¶æ›´æ–°                                       â”‚
â”‚  - detail_title.text = "èµ„äº§è¯¦æƒ…: ..."                       â”‚
â”‚  - detail_image.source = "http://..."                        â”‚
â”‚  - detail_ocr.text = "OCR è¯†åˆ«ç»“æœ: ..."                      â”‚
â”‚  - detail_scene_issue.content = "## GLM åˆ†æç»“æœ..."         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 4. è°ƒç”¨åç«¯ APIï¼ˆå¦‚éœ€è¦ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BackendClient.list_assets()                      â”‚
â”‚  - å‘é€ HTTP GET è¯·æ±‚åˆ°åç«¯                                   â”‚
â”‚  - è§£æ JSON å“åº”                                             â”‚
â”‚  - è¿”å›èµ„äº§åˆ—è¡¨                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 5. æ›´æ–°çŠ¶æ€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AppState æ›´æ–°                                     â”‚
â”‚  app_state.asset.asset_list = [...]                          â”‚
â”‚  app_state.asset.selected_asset_id = "uuid"                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 6. UI åˆ·æ–°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·çœ‹åˆ°æ›´æ–°åçš„ç•Œé¢                        â”‚
â”‚  - è¯¦æƒ…é¢æ¿æ˜¾ç¤ºèµ„äº§ä¿¡æ¯                                        â”‚
â”‚  - OCR ç»“æœå±•ç¤º                                               â”‚
â”‚  - GLM åˆ†ææŠ¥å‘Šæ˜¾ç¤º                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä»£ç å±‚é¢è§£æ

### 1. backend_client.py - API å°è£…

**ä½ç½®**ï¼š`desktop/nicegui_app/api/backend_client.py`

**å®Œæ•´ä»£ç ç»“æ„**ï¼š

```python
import httpx
from typing import List, Dict, Any, Optional
import logging

logger = logging.getLogger(__name__)

class BackendClient:
    """åç«¯ API å®¢æˆ·ç«¯ - ç»Ÿä¸€å°è£…æ‰€æœ‰ API è°ƒç”¨

    è®¾è®¡åŸåˆ™:
    - å•ä¸€èŒè´£: åªè´Ÿè´£ API è°ƒç”¨ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
    - å¼‚æ­¥ä¼˜å…ˆ: æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸é˜»å¡ UI
    - é”™è¯¯å¤„ç†: ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
    - ç±»å‹æç¤º: å®Œæ•´çš„ç±»å‹æ³¨è§£ï¼Œæ”¯æŒ IDE è‡ªåŠ¨è¡¥å…¨
    """

    def __init__(self, base_url: str = "http://localhost:8000/api/v1", timeout: float = 30.0):
        """åˆå§‹åŒ–å®¢æˆ·ç«¯

        Args:
            base_url: åç«¯ API åŸºç¡€ URL
            timeout: è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
        """
        self.base_url = base_url.rstrip("/")
        self.timeout = timeout

    async def _request(self, method: str, path: str, **kwargs) -> Any:
        """ç»Ÿä¸€è¯·æ±‚æ–¹æ³•

        Args:
            method: HTTP æ–¹æ³•ï¼ˆGET, POST, PATCH, DELETEï¼‰
            path: API è·¯å¾„
            **kwargs: ä¼ é€’ç»™ httpx çš„å…¶ä»–å‚æ•°

        Returns:
            è§£æåçš„ JSON å“åº”

        Raises:
            httpx.HTTPError: è¯·æ±‚å¤±è´¥
        """
        url = f"{self.base_url}/{path.lstrip('/')}"
        try:
            async with httpx.AsyncClient(timeout=self.timeout) as client:
                response = await client.request(method, url, **kwargs)
                response.raise_for_status()
                return response.json()
        except httpx.HTTPError as e:
            logger.error(f"API è¯·æ±‚å¤±è´¥: {method} {url} - {e}")
            raise

    # ===== é¡¹ç›® API =====
    async def list_projects(self) -> List[Dict]:
        """è·å–é¡¹ç›®åˆ—è¡¨"""
        return await self._request("GET", "projects/")

    async def get_project(self, project_id: str) -> Optional[Dict]:
        """è·å–å•ä¸ªé¡¹ç›®ï¼ˆä»åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼‰"""
        projects = await self.list_projects()
        for project in projects:
            if str(project.get("id")) == str(project_id):
                return project
        return None

    # ... å…¶ä»–æ–¹æ³•çœç•¥ï¼Œå®Œæ•´å®ç°è§æºæ–‡ä»¶
```

### 2. asset_events.py - äº‹ä»¶å¤„ç†

**ä½ç½®**ï¼š`desktop/nicegui_app/events/asset_events.py`

**å®Œæ•´ä»£ç ç»“æ„**ï¼š

```python
from dataclasses import dataclass
from typing import Dict, Any
from nicegui import ui
import logging

logger = logging.getLogger(__name__)

@dataclass
class AssetUIContext:
    """èµ„äº§ UI ä¸Šä¸‹æ–‡ - åŒ…å«æ‰€æœ‰ UI ç»„ä»¶å¼•ç”¨

    è®¾è®¡åŸåˆ™:
    - å•å‘æ•°æ®æµ: UI â†’ äº‹ä»¶å¤„ç†å™¨ â†’ çŠ¶æ€æ›´æ–° â†’ UI æ›´æ–°
    - ä¾èµ–æ³¨å…¥: é€šè¿‡ Context æ³¨å…¥æ‰€æœ‰ä¾èµ–
    - è§£è€¦: UI ç»„ä»¶ä¸ç›´æ¥è®¿é—®å…¨å±€çŠ¶æ€
    """
    asset_state: AssetStateRef
    asset_table: ui.table
    detail_title: ui.label
    detail_image: ui.image
    detail_ocr: ui.label
    detail_scene_issue: ui.markdown
    upload_btn: ui.button
    delete_btn: ui.button
    run_ocr_btn: ui.button
    run_llm_btn: ui.button
    refresh_btn: ui.button
    file_upload: ui.file_upload

def on_asset_row_click(context: AssetUIContext, asset_id: str) -> None:
    """è¡¨æ ¼è¡Œç‚¹å‡»äº‹ä»¶å¤„ç†å™¨

    Args:
        context: UI ä¸Šä¸‹æ–‡å¯¹è±¡
        asset_id: é€‰ä¸­çš„èµ„äº§ ID
    """
    logger.info(f"Asset row clicked: {asset_id}")

    # æŸ¥æ‰¾é€‰ä¸­çš„èµ„äº§
    selected = None
    for asset in context.asset_state.all_assets_for_device:
        if str(asset.get("id")) == str(asset_id):
            selected = asset
            break

    if selected:
        # æ›´æ–°çŠ¶æ€
        context.asset_state.selected_asset = selected

        # æ›´æ–° UI
        AssetDetailHelper.update_detail_panel(context, selected)

        # æ›´æ–°æŒ‰é’®çŠ¶æ€
        context.delete_btn.enabled = True
        context.run_ocr_btn.enabled = True
        context.run_llm_btn.enabled = True
    else:
        logger.warning(f"Asset not found: {asset_id}")

async def on_upload_image(context: AssetUIContext, client: BackendClient) -> None:
    """ä¸Šä¼ å›¾ç‰‡äº‹ä»¶å¤„ç†å™¨

    Args:
        context: UI ä¸Šä¸‹æ–‡å¯¹è±¡
        client: BackendClient å®ä¾‹
    """
    if not context.file_upload.value:
        ui.notify("è¯·å…ˆé€‰æ‹©æ–‡ä»¶", type="warning")
        return

    try:
        # è°ƒç”¨ BackendClient ä¸Šä¼ 
        result = await client.upload_image(
            file_path=context.file_upload.value[0],
            project_id=app_state.project.current_project["id"],
            device_id=app_state.tree.selected_node["id"] if app_state.tree.selected_node else None,
            note="ç°åœºé—®é¢˜ç…§ç‰‡"
        )

        ui.notify("ä¸Šä¼ æˆåŠŸ", type="positive")

        # åˆ·æ–°èµ„äº§åˆ—è¡¨
        await refresh_asset_list(context, client)

    except Exception as e:
        logger.error(f"Upload failed: {e}")
        ui.notify(f"ä¸Šä¼ å¤±è´¥: {e}", type="negative")
```

### 3. dialogs.py - UI ç»„ä»¶

**ä½ç½®**ï¼š`desktop/nicegui_app/ui/dialogs.py`

**å®Œæ•´ä»£ç ç»“æ„**ï¼š

```python
from nicegui import ui
from typing import Callable, Awaitable
import logging

logger = logging.getLogger(__name__)

class ProjectDialog:
    """é¡¹ç›®å¯¹è¯æ¡†ç»„ä»¶ - é™æ€æ–¹æ³•ç±»

    è®¾è®¡åŸåˆ™:
    - é™æ€æ–¹æ³•: æ— éœ€å®ä¾‹åŒ–ï¼Œç›´æ¥è°ƒç”¨
    - é—­åŒ…éš”ç¦»: æ¯ä¸ªå¯¹è¯æ¡†ç‹¬ç«‹çš„å˜é‡ä½œç”¨åŸŸ
    - å›è°ƒæ³¨å…¥: é€šè¿‡å‚æ•°æ³¨å…¥ä¸šåŠ¡é€»è¾‘
    """

    @staticmethod
    def create_project_dialog(on_confirm: Callable[[Dict], Awaitable[None]]) -> ui.dialog:
        """åˆ›å»ºé¡¹ç›®å¯¹è¯æ¡†

        Args:
            on_confirm: ç¡®è®¤å›è°ƒå‡½æ•°ï¼Œæ¥æ”¶é¡¹ç›®æ•°æ®

        Returns:
            dialog å¯¹è±¡
        """
        with ui.dialog() as dialog:
            with ui.card().classes("w-96"):
                ui.label("åˆ›å»ºæ–°é¡¹ç›®").classes("text-h6 mb-4")

                # è¾“å…¥å­—æ®µ
                name_input = ui.input("é¡¹ç›®åç§°", placeholder="ä¾‹å¦‚ï¼šAåº§åŠå…¬æ¥¼")
                location_input = ui.input("é¡¹ç›®ä½ç½®", placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬å¸‚æœé˜³åŒº")

                async def confirm():
                    """ç¡®è®¤æŒ‰é’®å¤„ç†å™¨"""
                    project_data = {
                        "name": name_input.value or "æœªå‘½åé¡¹ç›®",
                        "location": location_input.value or ""
                    }

                    try:
                        await on_confirm(project_data)
                        dialog.close()
                    except Exception as e:
                        logger.error(f"åˆ›å»ºé¡¹ç›®å¤±è´¥: {e}")
                        ui.notify(f"åˆ›å»ºå¤±è´¥: {e}", type="negative")

                with ui.row().classes("mt-4"):
                    ui.button("ç¡®å®š", on_click=confirm).props("unelevated")
                    ui.button("å–æ¶ˆ", on_click=dialog.close)

        return dialog

class AssetDialog:
    """èµ„äº§å¯¹è¯æ¡†ç»„ä»¶"""

    @staticmethod
    def image_preview_dialog(image_url: str, title: str = "å›¾ç‰‡é¢„è§ˆ") -> ui.dialog:
        """åˆ›å»ºå›¾ç‰‡é¢„è§ˆå¯¹è¯æ¡†

        Args:
            image_url: å›¾ç‰‡ URL
            title: å¯¹è¯æ¡†æ ‡é¢˜

        Returns:
            dialog å¯¹è±¡
        """
        with ui.dialog() as dialog:
            with ui.card().classes("max-w-4xl"):
                ui.label(title).classes("text-h6 mb-4")
                ui.image(image_url).classes("w-full h-auto")
                ui.button("å…³é—­", on_click=dialog.close).classes("mt-4")

        return dialog
```

---

## å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯ 1: å·¥ç¨‹ç»“æ„æ ‘æµè§ˆ + èµ„äº§åˆ—è¡¨

**ç›®æ ‡**ï¼šç”¨æˆ·é€‰æ‹©æ ‘èŠ‚ç‚¹ï¼ŒæŸ¥çœ‹è¯¥èŠ‚ç‚¹çš„èµ„äº§åˆ—è¡¨

**å®ç°**ï¼š

```python
from nicegui import ui
from desktop.nicegui_app.api.backend_client import BackendClient
from desktop.nicegui_app.state.app_state import AppState
from desktop.nicegui_app.ui.tables import AssetTableHelper

# åˆå§‹åŒ–
client = BackendClient()
app_state = AppState()

@ui.page("/")
async def main_page():
    """ä¸»é¡µé¢"""
    with ui.row().style("height: 100vh; width: 100vw"):
        # å·¦ä¾§ï¼šå·¥ç¨‹ç»“æ„æ ‘
        with ui.card().style("width: 300px"):
            ui.label("å·¥ç¨‹ç»“æ„").classes("text-h6")
            tree = ui.tree([], on_select=lambda e: on_tree_select(e))

        # å³ä¾§ï¼šèµ„äº§åˆ—è¡¨
        with ui.column().style("flex-grow: 1"):
            ui.label("èµ„äº§åˆ—è¡¨").classes("text-h6")

            # åˆ›å»ºèµ„äº§è¡¨æ ¼
            table = AssetTableHelper.create_asset_table(
                columns=[
                    {"name": "title", "label": "æ ‡é¢˜", "field": "title"},
                    {"name": "modality", "label": "ç±»å‹", "field": "modality"},
                    {"name": "capture_time", "label": "æ—¶é—´", "field": "capture_time"}
                ],
                on_row_click=lambda e: on_asset_row_click(context, e.args)
            )

async def on_tree_select(event):
    """æ ‘èŠ‚ç‚¹é€‰æ‹©äº‹ä»¶"""
    node = event.value
    app_state.tree.selected_node = node

    # æŸ¥è¯¢èµ„äº§
    if node.get("type") == "device":
        assets = await client.list_assets(device_id=node["id"])
        app_state.asset.asset_list = assets

        # æ›´æ–°è¡¨æ ¼
        table.props("rows", assets)

async def on_asset_row_click(context, asset_id):
    """èµ„äº§è¡Œç‚¹å‡»äº‹ä»¶"""
    from desktop.nicegui_app.events.asset_events import on_asset_row_click as row_click_handler
    await row_click_handler(context, asset_id)
```

### åœºæ™¯ 2: å›¾ç‰‡ä¸Šä¼  + OCR è¯†åˆ«

**ç›®æ ‡**ï¼šç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ï¼Œç³»ç»Ÿè‡ªåŠ¨è¿›è¡Œ OCR è¯†åˆ«

**å®ç°**ï¼š

```python
async def on_upload_image(context, client):
    """ä¸Šä¼ å›¾ç‰‡äº‹ä»¶"""
    if not context.file_upload.value:
        ui.notify("è¯·å…ˆé€‰æ‹©æ–‡ä»¶", type="warning")
        return

    try:
        # 1. ä¸Šä¼ å›¾ç‰‡
        result = await client.upload_image(
            file_path=context.file_upload.value[0],
            project_id=app_state.project.current_project["id"],
            device_id=app_state.tree.selected_node["id"],
            note="ç°åœºé—®é¢˜ç…§ç‰‡"
        )

        asset_id = result["id"]
        ui.notify("ä¸Šä¼ æˆåŠŸ", type="positive")

        # 2. è‡ªåŠ¨è¿è¡Œ OCR
        ocr_result = await client.run_ocr(asset_id)
        ui.notify("OCR è¯†åˆ«å®Œæˆ", type="positive")

        # 3. åˆ·æ–°èµ„äº§åˆ—è¡¨
        await refresh_asset_list(context, client)

    except Exception as e:
        logger.error(f"Upload failed: {e}")
        ui.notify(f"ä¸Šä¼ å¤±è´¥: {e}", type="negative")

async def refresh_asset_list(context, client):
    """åˆ·æ–°èµ„äº§åˆ—è¡¨"""
    if app_state.tree.selected_node and app_state.tree.selected_node.get("type") == "device":
        assets = await client.list_assets(device_id=app_state.tree.selected_node["id"])
        app_state.asset.asset_list = assets
        context.asset_table.props("rows", assets)
```

### åœºæ™¯ 3: GLM-4V åœºæ™¯é—®é¢˜åˆ†æ

**ç›®æ ‡**ï¼šç”¨æˆ·ç‚¹å‡»æŒ‰é’®ï¼Œç³»ç»Ÿè°ƒç”¨ GLM-4V è¿›è¡Œæ™ºèƒ½åˆ†æ

**å®ç°**ï¼š

```python
async def on_run_scene_llm(context, client):
    """è¿è¡Œ GLM-4V åˆ†æ"""
    if not context.asset_state.selected_asset:
        ui.notify("è¯·å…ˆé€‰æ‹©èµ„äº§", type="warning")
        return

    asset_id = context.asset_state.selected_asset["id"]

    try:
        # æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        context.run_llm_btn.props("loading", True)

        # è°ƒç”¨ GLM-4V API
        result = await client.run_scene_llm(asset_id)

        ui.notify("åˆ†æå®Œæˆ", type="positive")

        # åˆ·æ–°èµ„äº§åˆ—è¡¨ï¼ˆæ˜¾ç¤ºåˆ†æç»“æœï¼‰
        await refresh_asset_list(context, client)

        # æ›´æ–°è¯¦æƒ…é¢æ¿
        AssetDetailHelper.update_detail_panel(context, context.asset_state.selected_asset)

    except Exception as e:
        logger.error(f"GLM analysis failed: {e}")
        ui.notify(f"åˆ†æå¤±è´¥: {e}", type="negative")
    finally:
        context.run_llm_btn.props("loading", False)
```

---

## å¸¸è§é—®é¢˜ä¸è§£å†³

### âŒ é—®é¢˜ 1: è¡¨æ ¼è¡Œç‚¹å‡»äº‹ä»¶ä¸è§¦å‘

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ç‚¹å‡»è¡¨æ ¼è¡Œåï¼Œè¯¦æƒ…é¢æ¿ä¸æ›´æ–°ï¼Œæ— é”™è¯¯æç¤º
```

**åŸå› **ï¼šNiceGUI 2.7.0 ä¸æ”¯æŒ `handler` + `js_handler` åŒæ—¶ä½¿ç”¨

**è§£å†³**ï¼šå‡çº§åˆ° NiceGUI 3.5.0

```bash
pip install nicegui==3.5.0
```

```python
# âœ… NiceGUI 3.5.0 æ­£ç¡®å†™æ³•
table.on(
    "rowClick",
    on_row_click,                          # Python å¤„ç†å‡½æ•°
    js_handler="(evt, row) => emit(row)"   # JavaScript å¤„ç†å¹¶ä¼ é€’æ•°æ®
)
```

### âŒ é—®é¢˜ 2: çŠ¶æ€æ›´æ–°å UI ä¸åˆ·æ–°

**ç°è±¡**ï¼šä¿®æ”¹äº† AppStateï¼Œä½† UI æ²¡æœ‰å˜åŒ–

**åŸå› **ï¼šNiceGUI éœ€è¦æ˜¾å¼æ›´æ–° UI ç»„ä»¶å±æ€§

**è§£å†³**ï¼š

```python
# âŒ é”™è¯¯ï¼šåªæ›´æ–°çŠ¶æ€
app_state.asset.selected_asset = new_asset

# âœ… æ­£ç¡®ï¼šæ›´æ–°çŠ¶æ€ + UI
app_state.asset.selected_asset = new_asset
context.detail_title.text = f"èµ„äº§è¯¦æƒ…: {new_asset['title']}"
context.detail_image.source = new_asset['download_url']
```

### âŒ é—®é¢˜ 3: å¼‚æ­¥å‡½æ•°é˜»å¡ UI

**ç°è±¡**ï¼šè°ƒç”¨ BackendClient åï¼ŒUI å¡ä½ä¸åŠ¨

**åŸå› **ï¼šåœ¨åŒæ­¥ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨å¼‚æ­¥å‡½æ•°

**è§£å†³**ï¼š

```python
# âŒ é”™è¯¯ï¼šåœ¨åŒæ­¥ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨å¼‚æ­¥å‡½æ•°
def on_button_click():
    result = await client.list_projects()  # è¯­æ³•é”™è¯¯

# âœ… æ­£ç¡®ï¼šä½¿ç”¨ async å‡½æ•°
async def on_button_click():
    result = await client.list_projects()
    # æ›´æ–° UI
```

---

## æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ BackendClient ç»Ÿä¸€ API è°ƒç”¨

```python
# âœ“ æ¨èï¼šä½¿ç”¨ BackendClient
client = BackendClient()
projects = await client.list_projects()

# âœ— ä¸æ¨èï¼šç›´æ¥ä½¿ç”¨ httpx
import httpx
async with httpx.AsyncClient() as client:
    response = await client.get("http://localhost:8000/api/v1/projects/")
    projects = response.json()
```

### 2. ä½¿ç”¨ Context è§£è€¦ UI å’Œä¸šåŠ¡é€»è¾‘

```python
# âœ“ æ¨èï¼šContext-based
context = AssetUIContext(
    asset_state=AssetStateRef(),
    detail_title=title_label,
    detail_image=detail_image
)

def on_row_click(asset_id):
    on_asset_row_click(context, asset_id)

# âœ— ä¸æ¨èï¼šé—­åŒ…å˜é‡æ··ä¹±
def create_table():
    title_label = ui.label()
    detail_image = ui.image()

    def on_click(e):
        # ä»å¤–éƒ¨ä½œç”¨åŸŸè®¿é—®å˜é‡
        title_label.text = "..."
        detail_image.source = "..."
```

### 3. ä½¿ç”¨é™æ€æ–¹æ³•ç±»ç»„ç»‡ UI ç»„ä»¶

```python
# âœ“ æ¨èï¼šé™æ€æ–¹æ³•ç±»
dialog = ProjectDialog.create_project_dialog(on_confirm)
table = AssetTableHelper.create_asset_table(columns, on_click)

# âœ— ä¸æ¨èï¼šæ¯æ¬¡éƒ½é‡æ–°å®ç°
def create_dialog():
    with ui.dialog() as dialog:
        # ... é‡å¤ä»£ç 
```

---

## æ€»ç»“

PC UI æŠ€æœ¯æ¶æ„æä¾›ï¼š

| èƒ½åŠ› | å®ç°æ–¹å¼ | ä¼˜åŠ¿ |
|------|----------|------|
| Web UI æ¡†æ¶ | NiceGUI 3.5.0 | çº¯ Pythonã€ç°ä»£åŒ– UI |
| API å°è£… | BackendClient | ç»Ÿä¸€è°ƒç”¨ã€å¼‚æ­¥æ”¯æŒ |
| çŠ¶æ€ç®¡ç† | AppState + dataclass | ç±»å‹å®‰å…¨ã€é›†ä¸­ç®¡ç† |
| äº‹ä»¶å¤„ç† | Context-based | è§£è€¦ã€å¯æµ‹è¯• |
| UI ç»„ä»¶ | é™æ€æ–¹æ³•ç±» | å¯å¤ç”¨ã€æ¨¡å—åŒ– |
| ä»£ç è§„æ¨¡ | 1044 è¡Œï¼ˆä¸»æ–‡ä»¶ï¼‰ | -46% vs é‡æ„å‰ |

**ç®€å•è¯´**ï¼šPC UI æ¨¡å—åŒ–æ¶æ„è®©"1939 è¡Œå•ä½“ä»£ç "ï¼Œå˜æˆäº†"èŒè´£æ¸…æ™°ã€å¯ç»´æŠ¤ã€å¯æ‰©å±•"çš„ç°ä»£åŒ–åº”ç”¨ï¼

---

## ç›¸å…³æ–‡æ¡£

- [PC UI é‡æ„å®Œæ•´è®°å½•](../03-ä¼˜åŒ–è®°å½•/PC UIé‡æ„å®Œæ•´è®°å½•.md) - é‡æ„è¿‡ç¨‹è¯¦ç»†è®°å½•
- [NiceGUI æŠ€æœ¯æ–¹æ¡ˆé›†](../03-ä¼˜åŒ–è®°å½•/NiceGUIæŠ€æœ¯æ–¹æ¡ˆé›†.md) - NiceGUI ä¸‰å¤§é—®é¢˜è§£å†³æ–¹æ¡ˆ
- [å¤šç«¯äº’é€šæŠ€æœ¯æ–¹æ¡ˆ](./å¤šç«¯äº’é€šæŠ€æœ¯æ–¹æ¡ˆ.md) - PC ç«¯å’Œç§»åŠ¨ç«¯æŠ€æœ¯æ–¹æ¡ˆ
- [Backend éª¨æ¶è¯¦è§£](#backend-éª¨æ¶è¯¦è§£) - åç«¯æ¡†æ¶è¯¦è§£

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.2
**æœ€åæ›´æ–°**: 2026-01-23
**ç»´æŠ¤è€…**: BDC-AI å¼€å‘å›¢é˜Ÿ
