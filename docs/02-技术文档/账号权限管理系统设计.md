# BDC-AI 账号权限管理系统实施指南

## 概述

本文档描述了 BDC-AI 项目的账号权限管理系统的完整实施方案，包括数据库模型、API 端点、移动端集成和实施步骤。

## 架构设计

### 核心模型

```
用户 (User) ←→ 角色 (Role) ←→ 权限 (Permission)
     ↓
项目成员 (ProjectMember) - 项目级权限
     ↓
审计日志 (AuditLog) - 操作追溯
```

### 用户角色定义

| 角色名称 | 级别 | 说明 | 典型权限 |
|---------|------|------|---------|
| superuser | 100 | 超级管理员 | 所有权限 |
| admin | 80 | 管理员 | 项目管理、资产管理、用户管理 |
| project_manager | 60 | 项目经理 | 项目 CRUD、资产查看/上传、报告生成 |
| analyst | 50 | 数据分析师 | 数据查看、报告生成/导出 |
| engineer | 40 | 现场工程师 | 资产上传、项目查看 |
| viewer | 20 | 访客 | 只读权限 |

## 数据库模型

### User（用户表）

```python
{
    "id": "UUID",
    "username": "String(50) - 唯一",
    "email": "String(100) - 唯一",
    "hashed_password": "String(200)",
    "full_name": "String(100)",
    "phone": "String(20)",
    "is_active": "Boolean",
    "is_superuser": "Boolean",
    "created_at": "DateTime",
    "updated_at": "DateTime",
    "last_login_at": "DateTime"
}
```

### Role（角色表）

```python
{
    "id": "UUID",
    "name": "String(50) - 唯一",
    "display_name": "String(100)",
    "description": "Text",
    "level": "Integer",
    "created_at": "DateTime",
    "updated_at": "DateTime"
}
```

### Permission（权限表）

```python
{
    "id": "UUID",
    "code": "String(100) - 唯一",
    "name": "String(100)",
    "description": "Text",
    "resource": "String(50)",
    "action": "String(50)",
    "created_at": "DateTime"
}
```

### ProjectMember（项目成员表）

```python
{
    "id": "UUID",
    "project_id": "UUID - 外键",
    "user_id": "UUID - 外键",
    "role_in_project": "String(50) - owner/admin/member/viewer",
    "created_at": "DateTime",
    "created_by": "UUID"
}
```

### AuditLog（审计日志表）

```python
{
    "id": "UUID",
    "user_id": "UUID - 外键",
    "action": "String(100)",
    "resource_type": "String(50)",
    "resource_id": "String(100)",
    "details": "JSONB",
    "ip_address": "String(50)",
    "user_agent": "String(500)",
    "created_at": "DateTime"
}
```

## API 端点

### 认证端点

#### POST /api/v1/auth/login
用户登录

**请求：**
```json
{
    "username": "admin",
    "password": "admin123"
}
```

**响应：**
```json
{
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
    "token_type": "bearer",
    "expires_in": 1800
}
```

#### POST /api/v1/auth/refresh
刷新访问令牌

**请求：**
```json
{
    "refresh_token": "eyJhbGciOiJIUzI1NiIs..."
}
```

**响应：** 同登录

#### POST /api/v1/auth/logout
用户注销（可选实现）

#### GET /api/v1/auth/me
获取当前用户信息

**响应：**
```json
{
    "id": "uuid",
    "username": "admin",
    "email": "admin@example.com",
    "full_name": "管理员",
    "is_active": true,
    "is_superuser": true,
    "roles": [
        {
            "id": "uuid",
            "name": "superuser",
            "display_name": "超级管理员",
            "level": 100
        }
    ]
}
```

#### POST /api/v1/auth/me/change-password
修改当前用户密码

**请求：**
```json
{
    "old_password": "oldpass",
    "new_password": "newpass123"
}
```

### 用户管理（管理员）

#### GET /api/v1/auth/users
获取用户列表

**参数：**
- skip: 跳过记录数（默认 0）
- limit: 返回记录数（默认 100）

#### GET /api/v1/auth/users/{user_id}
获取用户详情

#### POST /api/v1/auth/users
创建用户

**请求：**
```json
{
    "username": "newuser",
    "password": "password123",
    "email": "user@example.com",
    "full_name": "新用户",
    "phone": "13800138000",
    "role_ids": ["uuid-role-1", "uuid-role-2"],
    "is_active": true
}
```

#### PUT /api/v1/auth/users/{user_id}
更新用户（所有字段可选）

#### DELETE /api/v1/auth/users/{user_id}
删除用户

### 角色和权限（管理员）

#### GET /api/v1/auth/roles
获取角色列表

#### GET /api/v1/auth/roles/{role_id}
获取角色详情（包含权限列表）

#### GET /api/v1/auth/permissions
获取权限列表

### 审计日志（管理员）

#### GET /api/v1/auth/audit-logs
获取审计日志

**参数：**
- skip: 跳过记录数（默认 0）
- limit: 返回记录数（默认 100）

## 权限控制使用

### 在 FastAPI 路由中使用

#### 1. 要求用户登录

```python
from fastapi import Depends
from shared.security.dependencies import get_current_user
from shared.db.models_auth import User

@router.get("/api/v1/projects")
def get_projects(
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    # 只有登录用户才能访问
    projects = db.query(Project).all()
    return projects
```

#### 2. 要求超级用户

```python
from shared.security.dependencies import get_current_superuser

@router.delete("/api/v1/projects/{project_id}")
def delete_project(
    project_id: str,
    current_user: User = Depends(get_current_superuser),
    db: Session = Depends(get_db)
):
    # 只有管理员才能删除
    ...
```

#### 3. 要求特定权限

```python
from shared.security.dependencies import PermissionChecker

@router.post("/api/v1/projects")
def create_project(
    _: bool = Depends(PermissionChecker("projects.create")),
    db: Session = Depends(get_db)
):
    # 只有拥有 projects.create 权限的用户才能访问
    ...
```

#### 4. 要求多个权限中的任意一个

```python
from shared.security.dependencies import require_permissions

@router.put("/api/v1/projects/{project_id}")
def update_project(
    _: bool = Depends(require_permissions("projects.update", "projects.admin")),
    db: Session = Depends(get_db)
):
    # 拥有 projects.update 或 projects.admin 权限即可
    ...
```

## 实施步骤

### 第一步：安装依赖

```bash
cd services/backend
pip install -r requirements.txt
```

新增的依赖：
- python-jose[cryptography]==3.3.0 - JWT 处理
- passlib[bcrypt]==1.7.4 - 密码加密
- bcrypt==4.1.1 - bcrypt 算法

### 第二步：配置环境变量

在项目根目录的 `.env` 文件中添加：

```bash
# JWT 配置
BDC_JWT_SECRET_KEY=your-secret-key-change-in-production
BDC_ACCESS_TOKEN_EXPIRE_MINUTES=30
BDC_REFRESH_TOKEN_EXPIRE_DAYS=7
```

**生产环境建议：使用 openssl 生成安全的密钥**
```bash
openssl rand -hex 32
```

### 第三步：初始化数据库

运行初始化脚本，创建表和初始数据：

```bash
cd scripts
python init_auth_db.py
```

这将创建：
- 所有数据库表
- 27 个权限（projects.read, assets.create, users.admin 等）
- 6 个角色（superuser, admin, project_manager, analyst, engineer, viewer）
- 1 个管理员账号：admin / admin123
- 3 个测试账号

**⚠️ 重要：登录后立即修改默认密码！**

### 第四步：启动后端服务

```bash
cd services/backend
python -m uvicorn app.main:app --host localhost --port 8000 --reload
```

### 第五步：测试 API

使用 Swagger UI 测试：http://localhost:8000/docs

1. 测试登录：POST /api/v1/auth/login
2. 测试获取用户信息：GET /api/v1/auth/me
3. 测试用户管理：GET /api/v1/auth/users

### 第六步：移动端集成

详见 `mobile/` 目录下的示例代码：
- `mobile/lib/models/auth.dart` - 数据模型
- `mobile/lib/services/auth_service.dart` - 认证服务
- `mobile/lib/screens/login_screen.dart` - 登录页面

移动端需要的依赖（pubspec.yaml）：

```yaml
dependencies:
  flutter_secure_storage: ^8.0.0  # 安全存储 Token
  shared_preferences: ^2.2.0      # 缓存用户信息
  dio: ^5.3.0                     # HTTP 客户端
```

### 第七步：PC 端集成

在 NiceGUI 应用中添加登录页面：

```python
from nicegui import ui
from requests import post

def login_page():
    with ui.card().classes('w-96'):
        ui.label('BDC-AI 登录').classes('text-xl font-bold mb-4')

        username = ui.input('用户名')
        password = ui.input('密码', password=True)
        message = ui.label().classes('text-red-500')

        async def do_login():
            response = post(
                'http://localhost:8000/api/v1/auth/login',
                json={
                    'username': username.value,
                    'password': password.value
                }
            )

            if response.status_code == 200:
                data = response.json()
                # 存储 Token
                app.storage.user['access_token'] = data['access_token']
                app.storage.user['refresh_token'] = data['refresh_token']
                # 跳转到主页面
                ui.navigate('/main')
            else:
                message.text = '登录失败，请检查用户名和密码'

        ui.button('登录', on_click=do_login)
```

### 第八步：逐步添加权限到现有 API

示例：为项目列表 API 添加登录要求

**之前：**
```python
@router.get("/", response_model=List[Project])
def list_projects(db: Session = Depends(get_db)):
    projects = db.query(Project).all()
    return projects
```

**之后：**
```python
from shared.security.dependencies import get_current_user, PermissionChecker

@router.get("/", response_model=List[Project])
def list_projects(
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    # 现在只有登录用户才能访问
    projects = db.query(Project).all()
    return projects
```

## 权限设计清单

### 项目管理权限（projects.*）
- `projects.read` - 查看项目
- `projects.create` - 创建项目
- `projects.update` - 更新项目
- `projects.delete` - 删除项目
- `projects.admin` - 项目管理（全部）

### 资产管理权限（assets.*）
- `assets.read` - 查看资产
- `assets.create` - 创建资产
- `assets.update` - 更新资产
- `assets.delete` - 删除资产
- `assets.upload` - 上传资产

### 用户管理权限（users.*）
- `users.read` - 查看用户
- `users.create` - 创建用户
- `users.update` - 更新用户
- `users.delete` - 删除用户
- `users.admin` - 用户管理（全部）

### 报告权限（reports.*）
- `reports.read` - 查看报告
- `reports.create` - 生成报告
- `reports.export` - 导出报告

### 系统权限（system.*）
- `system.config` - 系统配置
- `system.monitor` - 系统监控

## 测试

### 运行单元测试

```bash
cd services/backend
pytest tests/test_auth_api.py -v
```

### 测试覆盖范围

- ✓ 登录成功/失败
- ✓ Token 刷新
- ✓ 用户管理 CRUD
- ✓ 权限检查
- ✓ 审计日志

## 安全建议

1. **生产环境必须修改的配置：**
   - JWT_SECRET_KEY：使用 openssl 生成强密钥
   - 默认管理员密码：登录后立即修改
   - Token 过期时间：根据安全需求调整

2. **网络安全：**
   - 使用 HTTPS（生产环境）
   - 配置防火墙规则
   - 限制 API 访问频率

3. **密码策略：**
   - 最少 6 位字符
   - 建议包含大小写字母、数字、特殊字符
   - 定期修改密码

4. **审计日志：**
   - 定期检查异常操作
   - 保留日志至少 90 天
   - 监控失败登录尝试

## 故障排查

### 问题：Token 刷新失败

**原因：** 刷新令牌过期

**解决：**
- 检查 REFRESH_TOKEN_EXPIRE_DAYS 配置
- 重新登录获取新令牌

### 问题：权限不足 403

**原因：** 用户角色没有所需权限

**解决：**
- 检查用户角色：GET /api/v1/auth/me
- 检查角色权限：GET /api/v1/auth/roles/{role_id}
- 由管理员分配正确角色

### 问题：数据库表不存在

**原因：** 没有运行初始化脚本

**解决：**
```bash
python scripts/init_auth_db.py
```

## 扩展功能（可选实现）

### 1. 项目级权限过滤

在查询项目时，只返回用户有权访问的项目：

```python
@router.get("/")
def list_projects(
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    # 超级用户看到所有项目
    if current_user.is_superuser:
        return db.query(Project).all()

    # 其他用户只能看到作为成员的项目
    project_ids = db.query(ProjectMember.project_id).filter(
        ProjectMember.user_id == current_user.id
    ).all()

    return db.query(Project).filter(Project.id.in_(project_ids)).all()
```

### 2. Token 黑名单

实现登出时将 Token 加入黑名单（使用 Redis）：

```python
import redis

redis_client = redis.Redis(host='localhost', port=6379, db=0)

@router.post("/logout")
def logout(current_user: User = Depends(get_current_user)):
    # 将当前 Token 加入黑名单
    token = get_token_from_request()
    redis_client.setex(f"blacklist:{token}", 3600, "1")
    return {"message": "Logged out"}
```

### 3. 多因素认证（MFA）

集成 TOTP（基于时间的一次性密码）：

```python
import pyotp

@router.post("/mfa/enable")
def enable_mfa(current_user: User = Depends(get_current_user)):
    secret = pyotp.random_base32()
    # 保存到用户配置
    return {"secret": secret}

@router.post("/mfa/verify")
def verify_mfa(code: str, current_user: User = Depends(get_current_user)):
    # 验证 TOTP 代码
    ...
```

### 4. 密码重置功能

通过邮件或短信发送重置链接：

```python
@router.post("/forgot-password")
def forgot_password(email: str):
    # 发送重置邮件
    reset_token = generate_reset_token()
    send_email(email, reset_token)
    return {"message": "Reset email sent"}
```

## 文件清单

### 后端文件

```
shared/
├── db/
│   └── models_auth.py              # 认证相关数据库模型
├── security/
│   ├── password.py                 # 密码加密工具
│   ├── jwt.py                      # JWT Token 工具
│   └── dependencies.py             # FastAPI 依赖注入
└── config/
    └── settings.py                 # 配置文件（已更新）

services/backend/
├── app/
│   ├── api/v1/
│   │   └── auth.py                 # 认证 API 路由
│   ├── schemas/
│   │   └── auth.py                 # Pydantic 模型
│   ├── services/
│   │   └── auth_service.py         # 认证业务逻辑
│   └── main.py                     # 应用入口（已更新）
└── requirements.txt                # 依赖文件（已更新）

scripts/
└── init_auth_db.py                 # 数据库初始化脚本

tests/
└── test_auth_api.py                # API 测试用例
```

### 移动端文件

```
mobile/lib/
├── models/
│   └── auth.dart                   # 认证数据模型
├── services/
│   └── auth_service.dart           # 认证服务
└── screens/
    └── login_screen.dart           # 登录页面
```

## 下一步

1. ✅ 数据库模型设计完成
2. ✅ 认证 API 实现完成
3. ✅ 移动端集成代码完成
4. ✅ 测试用例编写完成
5. ⏳ 运行初始化脚本
6. ⏳ 测试所有 API 端点
7. ⏳ 逐步为现有 API 添加权限控制
8. ⏳ 集成到移动端和 PC 端

## 参考资料

- [FastAPI Security Tutorial](https://fastapi.tiangolo.com/tutorial/security/)
- [JWT.io](https://jwt.io/)
- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
- [Passlib Documentation](https://passlib.readthedocs.io/)
