# 账号权限管理系统 - 快速开始指南

## 5 分钟快速部署

### 1. 安装依赖（2 分钟）

```bash
cd services/backend
pip install -r requirements.txt
```

新增的认证相关依赖会自动安装：
- python-jose - JWT 处理
- passlib - 密码加密
- bcrypt - 加密算法

### 2. 配置环境变量（1 分钟）

在项目根目录创建或编辑 `.env` 文件：

```bash
# JWT 配置（生产环境请使用 openssl rand -hex 32 生成）
BDC_JWT_SECRET_KEY=your-secret-key-change-in-production
BDC_ACCESS_TOKEN_EXPIRE_MINUTES=30
BDC_REFRESH_TOKEN_EXPIRE_DAYS=7
```

### 3. 初始化数据库（1 分钟）

```bash
python scripts/init_auth_db.py
```

输出示例：
```
============================================================
BDC-AI 认证和权限数据库初始化
============================================================

创建数据库表...
✓ 数据库表创建完成
初始化权限...
✓ 创建了 27 个权限

初始化角色...
✓ 创建了 6 个角色

初始化用户...
✓ 创建了默认管理员账号:
  用户名: admin
  密码: admin123
  ⚠ 请登录后立即修改密码！
✓ 创建了 3 个测试用户:
  - manager1 / manager123
  - engineer1 / engineer123
  - analyst1 / analyst123

============================================================
初始化完成！
============================================================
```

### 4. 启动服务并测试（1 分钟）

```bash
# 启动后端
cd services/backend
python -m uvicorn app.main:app --host localhost --port 8000 --reload
```

打开浏览器访问：http://localhost:8000/docs

## 测试登录

### 1. 管理员登录

在 Swagger UI 中：

1. 找到 `POST /api/v1/auth/login` 端点
2. 点击 "Try it out"
3. 输入：
   ```json
   {
     "username": "admin",
     "password": "admin123"
   }
   ```
4. 点击 "Execute"

返回示例：
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "expires_in": 1800
}
```

### 2. 获取当前用户信息

1. 复制上面的 `access_token`
2. 找到 `GET /api/v1/auth/me` 端点
3. 点击 "Authorize" 按钮
4. 输入 `Bearer <your_access_token>`（注意空格）
5. 点击 "Execute"

你将看到管理员用户的详细信息。

## 默认账号列表

| 用户名 | 密码 | 角色 | 说明 |
|--------|------|------|------|
| admin | admin123 | 超级管理员 | 拥有所有权限 |
| manager1 | manager123 | 项目经理 | 项目管理、资产上传 |
| engineer1 | engineer123 | 现场工程师 | 资产上传、查看 |
| analyst1 | analyst123 | 数据分析师 | 数据查看、报告生成 |

## 权限列表

### 项目管理（projects.*）
- `projects.read` - 查看项目
- `projects.create` - 创建项目
- `projects.update` - 更新项目
- `projects.delete` - 删除项目
- `projects.admin` - 项目管理（全部）

### 资产管理（assets.*）
- `assets.read` - 查看资产
- `assets.create` - 创建资产
- `assets.update` - 更新资产
- `assets.delete` - 删除资产
- `assets.upload` - 上传资产

### 用户管理（users.*）
- `users.read` - 查看用户
- `users.create` - 创建用户
- `users.update` - 更新用户
- `users.delete` - 删除用户
- `users.admin` - 用户管理（全部）

### 报告（reports.*）
- `reports.read` - 查看报告
- `reports.create` - 生成报告
- `reports.export` - 导出报告

### 系统（system.*）
- `system.config` - 系统配置
- `system.monitor` - 系统监控

## 为现有 API 添加认证

### 示例 1：要求用户登录

**之前（无认证）：**
```python
@router.get("/")
def list_projects(db: Session = Depends(get_db)):
    return db.query(Project).all()
```

**之后（需要登录）：**
```python
from shared.security.dependencies import get_current_user
from shared.db.models_auth import User

@router.get("/")
def list_projects(
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    return db.query(Project).all()
```

### 示例 2：要求管理员权限

```python
from shared.security.dependencies import get_current_superuser

@router.delete("/{project_id}")
def delete_project(
    project_id: str,
    current_user: User = Depends(get_current_superuser),
    db: Session = Depends(get_db)
):
    # 只有管理员能执行
    ...
```

### 示例 3：要求特定权限

```python
from shared.security.dependencies import PermissionChecker

@router.post("/")
def create_project(
    _: bool = Depends(PermissionChecker("projects.create")),
    db: Session = Depends(get_db)
):
    # 只有拥有 projects.create 权限的用户能执行
    ...
```

## 移动端集成

### 1. 添加依赖

在 `mobile/pubspec.yaml` 中添加：

```yaml
dependencies:
  flutter_secure_storage: ^8.0.0
  shared_preferences: ^2.2.0
  dio: ^5.3.0
```

### 2. 使用认证服务

```dart
import 'package:your_app/services/auth_service.dart';

// 初始化
final authService = AuthService();
await authService.initialize();

// 登录
try {
  final user = await authService.login('admin', 'admin123');
  print('登录成功：${user.displayName}');
} catch (e) {
  print('登录失败：$e');
}

// 获取当前用户
final currentUser = authService.currentUser;

// 登出
await authService.logout();
```

### 3. 在 Dio 请求中自动添加 Token

认证服务已经配置了拦截器，会自动：
- 在请求头添加 `Authorization: Bearer <token>`
- 在 Token 过期前自动刷新
- 在 401 错误时自动重试

```dart
final response = await dio.get('/api/v1/projects');
// Token 会自动添加，无需手动处理
```

## PC 端集成（NiceGUI）

### 登录页面示例

```python
from nicegui import ui
import requests

def show_login():
    ui.label('BDC-AI 登录').classes('text-2xl font-bold')

    username = ui.input('用户名')
    password = ui.input('密码', password=True)
    message = ui.label().classes('text-red-500 mt-2')

    def do_login():
        try:
            response = requests.post(
                'http://localhost:8000/api/v1/auth/login',
                json={
                    'username': username.value,
                    'password': password.value
                }
            )

            if response.status_code == 200:
                data = response.json()
                # 存储 Token
                app.storage.user['access_token'] = data['access_token']
                app.storage.user['refresh_token'] = data['refresh_token']
                # 跳转到主页面
                ui.navigate('/main')
            else:
                message.text = '用户名或密码错误'
        except Exception as e:
            message.text = f'登录失败：{str(e)}'

    ui.button('登录', on_click=do_login).classes('mt-4')

@ui.page('/login')
def login_page():
    show_login()

@ui.page('/main')
def main_page():
    # 检查是否已登录
    if 'access_token' not in app.storage.user:
        ui.navigate('/login')
        return

    ui.label(f'欢迎，{app.storage.user.get("username")}').classes('text-2xl')
    ui.button('退出', on_click=lambda: (
        app.storage.user.clear(),
        ui.navigate('/login')
    ))

ui.run(port=8080)
```

## 常见问题

### Q: 如何修改管理员密码？

**方法 1：通过 API**
```bash
# 1. 登录获取 Token
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 2. 修改密码（替换 YOUR_TOKEN）
curl -X POST http://localhost:8000/api/v1/auth/me/change-password \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"old_password":"admin123","new_password":"newpass123"}'
```

**方法 2：重新运行初始化脚本**
```bash
python scripts/init_auth_db.py
```

### Q: Token 多久过期？

- 访问令牌：30 分钟（可配置 BDC_ACCESS_TOKEN_EXPIRE_MINUTES）
- 刷新令牌：7 天（可配置 BDC_REFRESH_TOKEN_EXPIRE_DAYS）

移动端会自动在过期前 5 分钟刷新。

### Q: 如何创建新用户？

使用管理员账号登录后，通过 API 创建：

```bash
curl -X POST http://localhost:8000/api/v1/auth/users \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "newuser",
    "password": "password123",
    "full_name": "新用户",
    "email": "newuser@example.com",
    "role_ids": []
  }'
```

### Q: 如何给用户分配角色？

创建用户时指定 `role_ids`，或更新用户：

```bash
# 先获取角色列表
curl http://localhost:8000/api/v1/auth/roles \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"

# 更新用户角色
curl -X PUT http://localhost:8000/api/v1/auth/users/USER_ID \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "role_ids": ["ROLE_UUID_1", "ROLE_UUID_2"]
  }'
```

### Q: 如何重置用户密码？

只有管理员可以重置其他用户密码（通过创建新用户或更新）。用户忘记密码需要联系管理员。

## 安全建议

### 生产环境必做

1. **修改 JWT 密钥**
   ```bash
   openssl rand -hex 32
   ```
   将生成的密钥设置到 `BDC_JWT_SECRET_KEY`

2. **修改默认密码**
   - 登录后立即修改 admin 密码
   - 删除或禁用测试账号

3. **使用 HTTPS**
   - 配置反向代理（Nginx）
   - 启用 SSL/TLS

4. **定期备份**
   - 数据库备份
   - 审计日志归档

5. **监控异常**
   - 检查审计日志
   - 监控失败登录尝试

## 下一步

- [ ] 修改默认管理员密码
- [ ] 为现有 API 添加认证
- [ ] 集成移动端登录页面
- [ ] 集成 PC 端登录页面
- [ ] 配置生产环境安全设置
- [ ] 编写用户使用文档

## 获取帮助

- 技术文档：`docs/02-技术文档/账号权限管理系统设计.md`
- API 文档：http://localhost:8000/docs
- ReDoc 文档：http://localhost:8000/redoc
