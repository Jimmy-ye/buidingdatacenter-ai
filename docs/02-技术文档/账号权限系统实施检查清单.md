# 账号权限管理系统 - 实施检查清单

## 阶段一：基础实施（必须完成 - MVP）

### 后端设置

- [ ] **安装依赖**
  - [ ] 更新 `services/backend/requirements.txt`
  - [ ] 运行 `pip install -r requirements.txt`
  - [ ] 验证安装：`python -c "import jose; import passlib"`

- [ ] **配置环境变量**
  - [ ] 生成安全的 JWT 密钥：`openssl rand -hex 32`
  - [ ] 在 `.env` 文件中添加以下配置：
    ```bash
    BDC_JWT_SECRET_KEY=<生成的密钥>
    BDC_ACCESS_TOKEN_EXPIRE_MINUTES=30
    BDC_REFRESH_TOKEN_EXPIRE_DAYS=7
    ```

- [ ] **初始化数据库**
  - [ ] 运行 `python scripts/init_auth_db.py`
  - [ ] 验证表创建：连接数据库检查 `users`, `roles`, `permissions` 等表
  - [ ] 记录默认管理员账号：admin / admin123

- [ ] **启动后端服务**
  - [ ] 运行 `uvicorn app.main:app --host localhost --port 8000 --reload`
  - [ ] 访问 http://localhost:8000/docs 确认 API 文档加载
  - [ ] 验证认证端点可见：`/api/v1/auth/login`, `/api/v1/auth/me`

### 功能测试

- [ ] **测试登录功能**
  - [ ] 使用 admin/admin123 登录
  - [ ] 验证返回 access_token 和 refresh_token
  - [ ] 测试错误密码（应返回 401）
  - [ ] 测试不存在的用户（应返回 401）

- [ ] **测试获取用户信息**
  - [ ] 使用 token 调用 GET /api/v1/auth/me
  - [ ] 验证返回正确的用户信息
  - [ ] 验证返回角色列表

- [ ] **测试用户管理（管理员）**
  - [ ] 获取用户列表：GET /api/v1/auth/users
  - [ ] 创建新用户：POST /api/v1/auth/users
  - [ ] 更新用户信息：PUT /api/v1/auth/users/{id}
  - [ ] 删除用户：DELETE /api/v1/auth/users/{id}

- [ ] **测试修改密码**
  - [ ] 修改当前用户密码
  - [ ] 使用新密码登录验证

### 安全验证

- [ ] **密码加密**
  - [ ] 检查数据库中密码已哈希加密
  - [ ] 验证无法从数据库直接读取明文密码

- [ ] **Token 验证**
  - [ ] 测试无效 token（应返回 401）
  - [ ] 测试过期 token（应返回 401）
  - [ ] 测试刷新令牌功能

- [ ] **权限控制**
  - [ ] 测试普通用户无法访问用户管理（应返回 403）
  - [ ] 测试管理员可以访问所有端点

## 阶段二：集成现有 API（必须完成）

### 为现有 API 添加认证

- [ ] **项目管理 API**
  - [ ] GET /api/v1/projects - 添加 `get_current_user` 依赖
  - [ ] POST /api/v1/projects - 添加 `PermissionChecker("projects.create")`
  - [ ] PUT /api/v1/projects/{id} - 添加权限检查
  - [ ] DELETE /api/v1/projects/{id} - 添加管理员权限

- [ ] **资产管理 API**
  - [ ] GET /api/v1/assets - 添加登录要求
  - [ ] POST /api/v1/assets - 添加 `PermissionChecker("assets.upload")`
  - [ ] PUT /api/v1/assets/{id} - 添加权限检查
  - [ ] DELETE /api/v1/assets/{id} - 添加权限检查

- [ ] **工程结构 API**
  - [ ] 为所有端点添加适当的权限检查

### 测试权限控制

- [ ] **使用不同角色测试**
  - [ ] 以 superuser 登录，验证所有功能可用
  - [ ] 以 engineer 登录，验证只能上传资产
  - [ ] 以 viewer 登录，验证只有只读权限
  - [ ] 未登录用户，验证所有 API 返回 401

## 阶段三：移动端集成（必须完成）

### 移动端依赖

- [ ] **添加 Flutter 依赖**
  - [ ] 在 `mobile/pubspec.yaml` 添加：
    ```yaml
    flutter_secure_storage: ^8.0.0
    shared_preferences: ^2.2.0
    dio: ^5.3.0
    ```
  - [ ] 运行 `flutter pub get`

### 移动端实现

- [ ] **集成认证服务**
  - [ ] 复制 `mobile/lib/models/auth.dart` 到项目
  - [ ] 复制 `mobile/lib/services/auth_service.dart` 到项目
  - [ ] 复制 `mobile/lib/screens/login_screen.dart` 到项目

- [ ] **配置 API 地址**
  - [ ] 在 AuthService 中配置正确的后端地址
  - [ ] 测试开发环境和生产环境切换

- [ ] **实现登录流程**
  - [ ] 应用启动时调用 `AuthService.initialize()`
  - [ ] 显示登录页面（未登录时）
  - [ ] 登录成功后存储 Token
  - [ ] 自动刷新 Token

- [ ] **测试移动端登录**
  - [ ] 输入 admin/admin123 登录
  - [ ] 验证登录成功后跳转到主页
  - [ ] 验证 Token 自动刷新
  - [ ] 验证退出登录清除 Token

### 移动端错误处理

- [ ] **处理网络错误**
  - [ ] 显示友好的错误提示
  - [ ] 提供重试功能

- [ ] **处理 Token 过期**
  - [ ] 401 错误时自动刷新 Token
  - [ ] 刷新失败时跳转到登录页

## 阶段四：PC 端集成（推荐完成）

### NiceGUI 登录页面

- [ ] **创建登录页面**
  - [ ] 设计登录界面（用户名、密码输入框）
  - [ ] 实现登录逻辑
  - [ ] 存储 Token 到 app.storage.user

- [ ] **会话管理**
  - [ ] 检查登录状态
  - [ ] 未登录时重定向到登录页
  - [ ] 提供"退出登录"功能

- [ ] **权限 UI 控制**
  - [ ] 根据用户角色显示/隐藏功能按钮
  - [ ] 显示用户信息（用户名、角色）
  - [ ] 权限不足时显示提示

### 测试 PC 端

- [ ] 测试登录功能
- [ ] 测试会话保持
- [ ] 测试权限控制
- [ ] 测试退出登录

## 阶段五：增强功能（可选实现）

### 项目级权限

- [ ] **实现项目成员管理**
  - [ ] 添加项目成员 API
  - [ ] 过滤用户只能看到授权的项目
  - [ ] 项目管理员管理成员角色

- [ ] **前端项目过滤**
  - [ ] 移动端只显示用户有权访问的项目
  - [ ] PC 端项目列表添加权限标记

### 审计和监控

- [ ] **审计日志查看**
  - [ ] 在 PC 端添加审计日志查看页面
  - [ ] 支持按时间、用户、操作类型过滤
  - [ ] 导出审计日志

- [ ] **操作审计**
  - [ ] 为关键操作添加审计日志记录
  - [ ] 记录 IP 地址和用户代理
  - [ ] 定期分析异常操作

### 高级功能

- [ ] **密码重置**
  - [ ] 实现忘记密码功能
  - [ ] 邮件/短信发送重置链接
  - [ ] 密码重置 Token 验证

- [ ] **多因素认证（MFA）**
  - [ ] 集成 TOTP（Google Authenticator）
  - [ ] 扫描二维码绑定
  - [ ] 登录时验证二次认证

- [ ] **Token 黑名单**
  - [ ] 使用 Redis 实现登出黑名单
  - [ ] 强制登出指定用户
  - [ ] 黑名单过期清理

- [ ] **登录限流**
  - [ ] 防止暴力破解
  - [ ] 同一 IP 失败次数限制
  - [ ] 账户临时锁定

## 阶段六：生产环境部署（必须完成）

### 安全配置

- [ ] **修改所有默认密码**
  - [ ] 修改 admin 密码
  - [ ] 删除或禁用测试账号
  - [ ] 通知所有首次登录用户修改密码

- [ ] **HTTPS 配置**
  - [ ] 配置 SSL 证书
  - [ ] 强制 HTTPS 重定向
  - [ ] 更新 CORS 配置

- [ ] **JWT 密钥**
  - [ ] 使用环境变量配置
  - [ ] 定期轮换密钥
  - [ ] 密钥备份

### 备份和恢复

- [ ] **数据库备份**
  - [ ] 设置自动备份
  - [ ] 测试备份恢复
  - [ ] 备份保留策略

- [ ] **审计日志归档**
  - [ ] 定期归档日志
  - [ ] 日志保留策略（至少 90 天）
  - [ ] 日志查询工具

### 监控和告警

- [ ] **设置监控**
  - [ ] 服务可用性监控
  - [ ] 异常登录告警
  - [ ] API 错误率监控

- [ ] **日志管理**
  - [ ] 集中日志收集
  - [ ] 日志分析工具
  - [ ] 异常检测

## 验收标准

### 功能验收

- [ ] 所有用户可以正常登录和登出
- [ ] Token 自动刷新正常工作
- [ ] 权限控制正确生效
- [ ] 移动端集成完整
- [ ] PC 端集成完整

### 性能验收

- [ ] 登录响应时间 < 500ms
- [ ] API 响应时间 < 200ms（不含业务逻辑）
- [ ] Token 刷新对用户无感

### 安全验收

- [ ] 密码加密存储
- [ ] Token 过期自动失效
- [ ] 权限控制无漏洞
- [ ] 审计日志完整

### 文档验收

- [ ] API 文档完整
- [ ] 用户使用手册
- [ ] 运维部署文档
- [ ] 故障排查指南

## 常见问题处理

### 问题：无法连接数据库

**检查项：**
- [ ] 数据库服务是否运行
- [ ] DATABASE_URL 配置是否正确
- [ ] 数据库用户权限是否足够

### 问题：Token 验证失败

**检查项：**
- [ ] JWT_SECRET_KEY 是否一致
- [ ] Token 是否过期
- [ ] 时钟是否同步

### 问题：权限不足 403

**检查项：**
- [ ] 用户角色是否正确
- [ ] 角色权限是否分配
- [ ] 权限代码是否匹配

### 问题：移动端无法登录

**检查项：**
- [ ] 后端服务地址是否正确
- [ ] 网络连接是否正常
- [ ] CORS 是否配置

## 实施时间估算

| 阶段 | 预计时间 | 负责人 | 状态 |
|-----|---------|--------|------|
| 阶段一：基础实施 | 2 小时 | 后端开发 | ⏳ |
| 阶段二：集成现有 API | 4 小时 | 后端开发 | ⏳ |
| 阶段三：移动端集成 | 4 小时 | 移动端开发 | ⏳ |
| 阶段四：PC 端集成 | 2 小时 | 前端开发 | ⏳ |
| 阶段五：增强功能 | 16 小时 | 全栈 | ⏳ |
| 阶段六：生产部署 | 4 小时 | 运维 | ⏳ |

**总计（不含增强功能）：16 小时（2 个工作日）**

## 完成标志

当以下所有项目都完成后，账号权限管理系统即部署完成：

1. ✅ 默认管理员账号成功登录
2. ✅ 可以创建和管理用户
3. ✅ 现有 API 都已添加认证
4. ✅ 移动端可以正常登录和使用
5. ✅ PC 端可以正常登录和使用
6. ✅ 权限控制正确生效
7. ✅ 审计日志正常记录
8. ✅ 生产环境安全配置完成
