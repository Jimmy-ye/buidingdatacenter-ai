# ç§»åŠ¨ç«¯è®¤è¯æ•´åˆæŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜ BDC-AI ç§»åŠ¨ç«¯ï¼ˆFlutterï¼‰çš„è®¤è¯æ•´åˆåŠŸèƒ½ï¼ŒåŒ…æ‹¬ç™»å½•ã€Token ç®¡ç†ã€æƒé™æ§åˆ¶ç­‰ã€‚

---

## ğŸ—ï¸ æ¶æ„

### æ ¸å¿ƒç»„ä»¶

1. **AuthService** (`services/auth_service.dart`)
   - å•ä¾‹æ¨¡å¼çš„è®¤è¯æœåŠ¡
   - è´Ÿè´£ API è°ƒç”¨ã€Token ç®¡ç†ã€è‡ªåŠ¨åˆ·æ–°
   - ä½¿ç”¨ Dio å®ç°è¯·æ±‚æ‹¦æˆªå’Œ 401 å¤„ç†

2. **AuthProvider** (`providers/auth_provider.dart`)
   - ä½¿ç”¨ Provider æ¨¡å¼ç®¡ç†è®¤è¯çŠ¶æ€
   - æš´éœ²ç™»å½•ã€ç™»å‡ºã€æƒé™æ£€æŸ¥ç­‰æ–¹æ³•ç»™ UI

3. **LoginPage** (`pages/login_page.dart`)
   - ç”¨æˆ·ç™»å½•ç•Œé¢
   - è¡¨å•éªŒè¯ã€é”™è¯¯å¤„ç†ã€åŠ è½½çŠ¶æ€

4. **æ•°æ®æ¨¡å‹** (`models/auth.dart`)
   - `TokenResponse` - Token å“åº”
   - `UserInfo` - ç”¨æˆ·ä¿¡æ¯
   - `RoleInfo` - è§’è‰²ä¿¡æ¯
   - å„ç§å¼‚å¸¸ç±»

5. **åº”ç”¨é…ç½®** (`config/app_config.dart`)
   - API åœ°å€é…ç½®ï¼ˆæ”¯æŒç¼–è¯‘æ—¶å¸¸é‡ï¼‰
   - Token è¿‡æœŸæ—¶é—´é…ç½®

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤ 1ï¼šå®‰è£…ä¾èµ–

åœ¨ç§»åŠ¨ç«¯é¡¹ç›®ç›®å½•ä¸‹ï¼š

```bash
cd mobile/bdc_ai_app
flutter pub get
```

**æ–°å¢ä¾èµ–**ï¼š
- `dio: ^5.4.0` - HTTP å®¢æˆ·ç«¯
- `flutter_secure_storage: ^9.0.0` - å®‰å…¨å­˜å‚¨

---

### æ­¥éª¤ 2ï¼šé…ç½® API åœ°å€

#### æ–¹æ³• Aï¼šä½¿ç”¨ç¼–è¯‘æ—¶å¸¸é‡ï¼ˆæ¨èï¼‰

è¿è¡Œæ—¶æŒ‡å®š API åœ°å€ï¼š

```bash
# é»˜è®¤åœ°å€ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
flutter run

# æŒ‡å®šè¿œç¨‹åç«¯åœ°å€
flutter run --dart-define=API_BASE_URL=http://100.93.101.76:8000

# æŒ‡å®šæœ¬åœ°åç«¯åœ°å€
flutter run --dart-define=API_BASE_URL=http://127.0.0.1:8000
```

#### æ–¹æ³• Bï¼šä¿®æ”¹é…ç½®æ–‡ä»¶

ç¼–è¾‘ `mobile/bdc_ai_app/lib/config/app_config.dart`ï¼š

```dart
static String get apiBaseUrl {
  const apiBaseUrl = String.fromEnvironment('API_BASE_URL',
    defaultValue: 'http://100.93.101.76:8000'  // ä¿®æ”¹é»˜è®¤å€¼
  );
  return apiBaseUrl;
}
```

---

### æ­¥éª¤ 3ï¼šè¿è¡Œåº”ç”¨

```bash
# ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œä¸­
python -m uvicorn services.backend.app.main:app --host 0.0.0.0 --port 8000 --reload

# å¯åŠ¨ Flutter åº”ç”¨
flutter run
```

---

## ğŸ“± åŠŸèƒ½è¯´æ˜

### 1. å¯åŠ¨æµç¨‹

```
åº”ç”¨å¯åŠ¨
  â†“
åˆå§‹åŒ– AuthService
  â†“
æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„ Token
  â†“
  â”œâ”€ Token æœ‰æ•ˆ â†’ è‡ªåŠ¨ç™»å½•ï¼Œè¿›å…¥ä¸»é¡µ
  â”œâ”€ Token å³å°†è¿‡æœŸ â†’ è‡ªåŠ¨åˆ·æ–°ï¼Œè¿›å…¥ä¸»é¡µ
  â”œâ”€ Token å·²è¿‡æœŸ â†’ æ¸…é™¤æ•°æ®ï¼Œæ˜¾ç¤ºç™»å½•é¡µ
  â””â”€ æ—  Token â†’ æ˜¾ç¤ºç™»å½•é¡µ
```

### 2. ç™»å½•æµç¨‹

```
ç”¨æˆ·è¾“å…¥ç”¨æˆ·å/å¯†ç 
  â†“
è°ƒç”¨ /api/v1/auth/login
  â†“
  â”œâ”€ æˆåŠŸ â†’ å­˜å‚¨ Token å’Œç”¨æˆ·ä¿¡æ¯ï¼Œè·³è½¬ä¸»é¡µ
  â””â”€ å¤±è´¥ â†’ æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
```

### 3. Token è‡ªåŠ¨åˆ·æ–°

```
API è¯·æ±‚è¿”å› 401
  â†“
æ£€æŸ¥æ˜¯å¦æœ‰ refresh_token
  â†“
  â”œâ”€ æœ‰ â†’ è°ƒç”¨ /api/v1/auth/refresh
  â”‚    â”œâ”€ æˆåŠŸ â†’ æ›´æ–° Tokenï¼Œé‡è¯•åŸè¯·æ±‚
  â”‚    â””â”€ å¤±è´¥ â†’ ç™»å‡ºï¼Œè·³è½¬ç™»å½•é¡µ
  â””â”€ æ—  â†’ ç™»å‡ºï¼Œè·³è½¬ç™»å½•é¡µ
```

### 4. æƒé™æ£€æŸ¥

```dart
// åœ¨ä»£ç ä¸­æ£€æŸ¥æƒé™
final authProvider = context.read<AuthProvider>();

// æ£€æŸ¥å•ä¸ªæƒé™
if (authProvider.hasPermission('projects:create')) {
  // æ˜¾ç¤ºåˆ›å»ºé¡¹ç›®æŒ‰é’®
}

// æ£€æŸ¥è§’è‰²
if (authProvider.hasRole('admin')) {
  // æ˜¾ç¤ºç®¡ç†å‘˜åŠŸèƒ½
}

// æ£€æŸ¥æ˜¯å¦æ˜¯è¶…çº§ç®¡ç†å‘˜
if (authProvider.isAdmin) {
  // æ˜¾ç¤ºæ‰€æœ‰åŠŸèƒ½
}
```

---

## ğŸ¨ UI åŠŸèƒ½

### ç™»å½•é¡µé¢ (`LoginPage`)

**åŠŸèƒ½**ï¼š
- âœ… ç”¨æˆ·å/å¯†ç è¾“å…¥
- âœ… è¡¨å•éªŒè¯
- âœ… å¯†ç å¯è§æ€§åˆ‡æ¢
- âœ… é”™è¯¯æ¶ˆæ¯æ˜¾ç¤º
- âœ… åŠ è½½çŠ¶æ€æ˜¾ç¤º

**éªŒè¯è§„åˆ™**ï¼š
- ç”¨æˆ·åï¼šè‡³å°‘ 3 ä¸ªå­—ç¬¦
- å¯†ç ï¼šä¸èƒ½ä¸ºç©º

### é¡¹ç›®åˆ—è¡¨é¡µ (`ProjectsPage`)

**æ–°å¢åŠŸèƒ½**ï¼š
- âœ… å³ä¸Šè§’æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
- âœ… ç‚¹å‡»ç”¨æˆ·åå¼¹å‡ºèœå•
- âœ… æ˜¾ç¤ºç”¨æˆ·è§’è‰²
- âœ… ç™»å‡ºåŠŸèƒ½ï¼ˆå¸¦ç¡®è®¤å¯¹è¯æ¡†ï¼‰

---

## ğŸ”§ é…ç½®è¯´æ˜

### Token é…ç½®

åœ¨ `config/app_config.dart` ä¸­ï¼š

```dart
/// Token é»˜è®¤è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
/// åç«¯è®¾ç½®ä¸º 15 åˆ†é’Ÿï¼ˆ900ç§’ï¼‰
static const int defaultTokenExpiresIn = 900;

/// Refresh Token é»˜è®¤è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
/// åç«¯è®¾ç½®ä¸º 7 å¤©ï¼ˆ604800ç§’ï¼‰
static const int defaultRefreshTokenExpiresIn = 604800;

/// Token è‡ªåŠ¨åˆ·æ–°æå‰æ—¶é—´ï¼ˆç§’ï¼‰
/// æå‰ 5 åˆ†é’Ÿåˆ·æ–°
static const int tokenRefreshBuffer = 300;
```

### å®‰å…¨å­˜å‚¨

Token ä½¿ç”¨ `flutter_secure_storage` å­˜å‚¨ï¼š

- **iOS**ï¼šKeychain
- **Android**ï¼šEncryptedSharedPreferences
- **å®‰å…¨æ€§**ï¼šToken åŠ å¯†å­˜å‚¨ï¼Œä¸ä¼šæ³„éœ²

---

## âœ… æµ‹è¯•æ¸…å•

### åŸºç¡€åŠŸèƒ½æµ‹è¯•

| æµ‹è¯•é¡¹ | æ“ä½œ | é¢„æœŸç»“æœ | çŠ¶æ€ |
|--------|------|---------|------|
| åº”ç”¨å¯åŠ¨ | å¯åŠ¨åº”ç”¨ | æ˜¾ç¤ºåŠ è½½é¡µï¼Œç„¶åè·³è½¬åˆ°ç™»å½•é¡µæˆ–ä¸»é¡µ | â¬œ |
| ç™»å½•åŠŸèƒ½ | ä½¿ç”¨ admin/admin123 ç™»å½• | ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°ä¸»é¡µ | â¬œ |
| ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º | æŸ¥çœ‹å³ä¸Šè§’ | æ˜¾ç¤ºç”¨æˆ·åå’Œè§’è‰² | â¬œ |
| ç™»å‡ºåŠŸèƒ½ | ç‚¹å‡»ç™»å‡º | ç¡®è®¤å¯¹è¯æ¡† â†’ è·³è½¬ç™»å½•é¡µ | â¬œ |
| é”™è¯¯å‡­è¯ | ä½¿ç”¨é”™è¯¯å¯†ç ç™»å½• | æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼Œä¸è·³è½¬ | â¬œ |

### Token ç®¡ç†æµ‹è¯•

| æµ‹è¯•é¡¹ | æ“ä½œ | é¢„æœŸç»“æœ | çŠ¶æ€ |
|--------|------|---------|------|
| Token æŒä¹…åŒ– | ç™»å½•åå…³é—­åº”ç”¨ï¼Œé‡æ–°æ‰“å¼€ | è‡ªåŠ¨ç™»å½•ï¼Œä¸éœ€è¦é‡æ–°è¾“å…¥å¯†ç  | â¬œ |
| Token è‡ªåŠ¨åˆ·æ–° | ç­‰å¾… 15 åˆ†é’Ÿåæ“ä½œ | è‡ªåŠ¨åˆ·æ–° Tokenï¼Œç”¨æˆ·æ— æ„ŸçŸ¥ | â¬œ |
| Token è¿‡æœŸå¤„ç† | æ‰‹åŠ¨åˆ é™¤ Token åæ“ä½œ | è‡ªåŠ¨ç™»å‡ºï¼Œè·³è½¬åˆ°ç™»å½•é¡µ | â¬œ |
| 401 å¤„ç† | API è¿”å› 401 æ—¶ | è‡ªåŠ¨åˆ·æ–° Token å¹¶é‡è¯• | â¬œ |

### æƒé™æ§åˆ¶æµ‹è¯•

| æµ‹è¯•é¡¹ | æ“ä½œ | é¢„æœŸç»“æœ | çŠ¶æ€ |
|--------|------|---------|------|
| è¶…çº§ç®¡ç†å‘˜æƒé™ | ä½¿ç”¨ admin è´¦æˆ·ç™»å½• | æ‹¥æœ‰æ‰€æœ‰æƒé™ | â¬œ |
| è§’è‰²ä¿¡æ¯æ˜¾ç¤º | æŸ¥çœ‹ç”¨æˆ·èœå• | æ˜¾ç¤ºæ‰€æœ‰è§’è‰²ï¼ˆç®¡ç†å‘˜ | å·¥ç¨‹å¸ˆï¼‰ | â¬œ |
| æƒé™æ£€æŸ¥ | ä»£ç è°ƒç”¨ `hasPermission()` | æ­£ç¡®è¿”å›æƒé™çŠ¶æ€ | â¬œ |

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šåº”ç”¨å¯åŠ¨åç«‹å³å´©æºƒ

**å¯èƒ½åŸå› **ï¼š
- ä¾èµ–æœªæ­£ç¡®å®‰è£…
- `main()` å‡½æ•°ä¸­çš„ `async` å¯¼è‡´é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# é‡æ–°å®‰è£…ä¾èµ–
flutter clean
flutter pub get

# æ£€æŸ¥ main.dart
# ç¡®ä¿æœ‰ WidgetsFlutterBinding.ensureInitialized();
```

---

### é—®é¢˜ 2ï¼šç™»å½•åç«‹å³è·³è½¬å›ç™»å½•é¡µ

**å¯èƒ½åŸå› **ï¼š
- Token å­˜å‚¨å¤±è´¥
- ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥

**è°ƒè¯•æ­¥éª¤**ï¼š
1. æ£€æŸ¥ `AuthService.login()` æ˜¯å¦æˆåŠŸ
2. æ£€æŸ¥ `UserInfo.fromJson()` æ˜¯å¦æ­£ç¡®è§£æ
3. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—

```dart
// åœ¨ AuthService ä¸­æ·»åŠ æ—¥å¿—
print('[DEBUG] Login response: $response');
print('[DEBUG] User: $_currentUser');
```

---

### é—®é¢˜ 3ï¼šAPI è¯·æ±‚å¤±è´¥ï¼ˆè¿æ¥é”™è¯¯ï¼‰

**å¯èƒ½åŸå› **ï¼š
- API åœ°å€é…ç½®é”™è¯¯
- åç«¯æœåŠ¡æœªè¿è¡Œ
- ç½‘ç»œè¿æ¥é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ API åœ°å€é…ç½®ï¼š
```bash
# è¿è¡Œæ—¶æŒ‡å®šåœ°å€
flutter run --dart-define=API_BASE_URL=http://100.93.101.76:8000
```

2. æ£€æŸ¥åç«¯æœåŠ¡ï¼š
```bash
curl http://100.93.101.76:8000/api/v1/health/
```

3. æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼ˆå¦‚æœæ˜¯è¿œç¨‹è®¿é—®ï¼‰ï¼š
```bash
tailscale ping 100.93.101.76
```

---

### é—®é¢˜ 4ï¼šToken è‡ªåŠ¨åˆ·æ–°ä¸å·¥ä½œ

**å¯èƒ½åŸå› **ï¼š
- `refresh_token` æœªæ­£ç¡®å­˜å‚¨
- Dio æ‹¦æˆªå™¨é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ `flutter_secure_storage` æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–
2. åœ¨ `AuthService._initDio()` ä¸­æ·»åŠ æ—¥å¿—
3. ç¡®è®¤åç«¯ `/api/v1/auth/refresh` æ¥å£æ­£å¸¸

---

## ğŸ“¦ ä»£ç ç»“æ„

```
mobile/bdc_ai_app/lib/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ app_config.dart          # åº”ç”¨é…ç½®
â”‚   â””â”€â”€ constants.dart            # å¸¸é‡å®šä¹‰
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ auth.dart                 # è®¤è¯æ¨¡å‹ âœ¨ æ–°å¢
â”‚   â”œâ”€â”€ project.dart
â”‚   â”œâ”€â”€ asset.dart
â”‚   â””â”€â”€ structure.dart
â”œâ”€â”€ providers/
â”‚   â”œâ”€â”€ auth_provider.dart        # è®¤è¯çŠ¶æ€ç®¡ç† âœ¨ æ–°å¢
â”‚   â”œâ”€â”€ app_provider.dart
â”‚   â”œâ”€â”€ project_provider.dart
â”‚   â”œâ”€â”€ structure_provider.dart
â”‚   â””â”€â”€ asset_provider.dart
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ auth_service.dart         # è®¤è¯æœåŠ¡ âœ¨ æ–°å¢
â”‚   â”œâ”€â”€ api_service.dart
â”‚   â”œâ”€â”€ project_service.dart
â”‚   â””â”€â”€ asset_service.dart
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ login_page.dart           # ç™»å½•é¡µé¢ âœ¨ æ–°å¢
â”‚   â”œâ”€â”€ projects_page.dart        # å·²æ›´æ–°ï¼ˆæ·»åŠ ç”¨æˆ·èœå•ï¼‰
â”‚   â”œâ”€â”€ structure_tree_page.dart
â”‚   â””â”€â”€ assets_page.dart
â””â”€â”€ main.dart                     # ä¸»åº”ç”¨ï¼ˆå·²æ›´æ–°ï¼‰
```

---

## ğŸ” å®‰å…¨æ³¨æ„äº‹é¡¹

### Token å­˜å‚¨

- âœ… ä½¿ç”¨ `flutter_secure_storage` åŠ å¯†å­˜å‚¨
- âœ… Access Token å’Œ Refresh Token åˆ†å¼€å­˜å‚¨
- âŒ ä¸è¦å°† Token å­˜å‚¨åœ¨ `shared_preferences`ï¼ˆæ˜æ–‡ï¼‰

### ç½‘ç»œä¼ è¾“

- âœ… ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
- âœ… ä½¿ç”¨ `Bearer` æ–¹å¼ä¼ é€’ Token
- âŒ ä¸è¦åœ¨ URL ä¸­ä¼ é€’ Token

### Token åˆ·æ–°

- âœ… è‡ªåŠ¨åœ¨è¿‡æœŸå‰ 5 åˆ†é’Ÿåˆ·æ–°
- âœ… 401 é”™è¯¯æ—¶è‡ªåŠ¨å°è¯•åˆ·æ–°
- âœ… åˆ·æ–°å¤±è´¥è‡ªåŠ¨ç™»å‡º
- âŒ ä¸è¦åœ¨ UI ä¸­æš´éœ² Token

---

## ğŸ¯ ä¸‹ä¸€æ­¥å·¥ä½œ

- [ ] æ·»åŠ ç”Ÿç‰©è¯†åˆ«ç™»å½•ï¼ˆæŒ‡çº¹/Face IDï¼‰
- [ ] å®ç°"è®°ä½å¯†ç "åŠŸèƒ½
- [ ] æ·»åŠ ä¿®æ”¹å¯†ç åŠŸèƒ½
- [ ] å®ç°æƒé™æ§åˆ¶çš„ UI ç»„ä»¶ï¼ˆæ ¹æ®æƒé™æ˜¾ç¤º/éšè—æŒ‰é’®ï¼‰
- [ ] æ·»åŠ  Token è¿‡æœŸæé†’é€šçŸ¥
- [ ] å®ç°ç¦»çº¿æ¨¡å¼

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **åç«¯ API æ–‡æ¡£**ï¼š`http://100.93.101.76:8000/docs`
- **PC-UI è®¤è¯æ•´åˆ**ï¼š`docs/02-æŠ€æœ¯æ–‡æ¡£/pc-ui/PC-UIå’Œç§»åŠ¨ç«¯è®¤è¯æ•´åˆå®æ–½æ–¹æ¡ˆ.md`
- **Tailscale è¿œç¨‹è®¿é—®**ï¼š`docs/03-ä¼˜åŒ–è®°å½•/2026-01-26-Tailscaleè¿œç¨‹è®¿é—®æ’éšœè®°å½•.md`

---

**æ–‡æ¡£ç»´æŠ¤**ï¼šBDC-AI å¼€å‘å›¢é˜Ÿ
**åˆ›å»ºæ—¶é—´**ï¼š2026-01-26
**é€‚ç”¨ç‰ˆæœ¬**ï¼šv1.0.0+
