# BDC-AI 账号权限系统完整指南

**版本**: 1.0.0
**更新时间**: 2026-01-25
**维护者**: BDC-AI 开发团队

---

## 目录

1. [系统概述](#1-系统概述)
2. [快速开始](#2-快速开始)
3. [系统架构](#3-系统架构)
4. [系统设计](#4-系统设计)
5. [API 端点](#5-api-端点)
6. [权限控制使用](#6-权限控制使用)
7. [实施指南](#7-实施指南)
8. [测试与验证](#8-测试与验证)
9. [安全建议](#9-安全建议)
10. [故障排查](#10-故障排查)
11. [扩展功能](#11-扩展功能)
12. [附录](#12-附录)

---

## 1. 系统概述

### 1.1 方案概述

BDC-AI 账号权限管理系统是一套完整的用户认证与授权解决方案，支持：

- ✅ **JWT 认证** - 无状态认证，支持访问令牌和刷新令牌
- ✅ **RBAC 权限模型** - 基于角色的访问控制，6 种预定义角色
- ✅ **27 个预定义权限** - 覆盖项目、资产、用户、报告、系统管理
- ✅ **项目级权限** - 支持项目成员管理和细粒度权限控制
- ✅ **操作审计** - 完整记录用户操作，便于追溯
- ✅ **移动端集成** - Flutter 认证服务，自动 Token 刷新
- ✅ **PC 端集成** - NiceGUI 登录页面和会话管理
- ✅ **密码安全** - bcrypt 加密，强度验证
- ✅ **测试覆盖** - 完整的 API 测试用例

### 1.2 核心特性

#### 认证机制

- **JWT Token 认证**
  - 访问令牌：30 分钟过期
  - 刷新令牌：7 天过期
  - 自动 Token 刷新（移动端）
  - bcrypt 密码加密

#### 权限模型（RBAC）

**6 个预定义角色：**

| 角色名称 | 级别 | 说明 | 典型权限 |
|---------|------|------|---------|
| superuser | 100 | 超级管理员 | 所有权限 |
| admin | 80 | 管理员 | 项目管理、资产管理、用户管理 |
| project_manager | 60 | 项目经理 | 项目 CRUD、资产查看/上传、报告生成 |
| analyst | 50 | 数据分析师 | 数据查看、报告生成/导出 |
| engineer | 40 | 现场工程师 | 资产上传、项目查看 |
| viewer | 20 | 访客 | 只读权限 |

**27 个预定义权限：**

- **项目管理（projects.*）**：read, create, update, delete, admin
- **资产管理（assets.*）**：read, create, update, delete, upload
- **用户管理（users.*）**：read, create, update, delete, admin
- **报告（reports.*）**：read, create, export
- **系统（system.*）**：config, monitor

#### 操作审计

- 记录所有敏感操作
- IP 地址和用户代理
- JSON 格式存储详情
- 时间索引便于查询

### 1.3 技术栈

- **后端框架**: FastAPI 0.104.1
- **数据库 ORM**: SQLAlchemy 2.0.23
- **数据库**: PostgreSQL + UUID + JSONB
- **认证**: JWT (python-jose)
- **密码**: bcrypt (passlib)
- **移动端**: Flutter + Dio
- **PC 端**: NiceGUI

---

## 2. 快速开始

### 2.1 5 分钟快速部署

#### 步骤 1：安装依赖（2 分钟）

```bash
cd services/backend
pip install -r requirements.txt
```

新增的认证相关依赖会自动安装：
- python-jose - JWT 处理
- passlib - 密码加密
- bcrypt - 加密算法

#### 步骤 2：配置环境变量（1 分钟）

在项目根目录创建或编辑 `.env` 文件：

```bash
# JWT 配置（生产环境请使用 openssl rand -hex 32 生成）
BDC_JWT_SECRET_KEY=your-secret-key-change-in-production
BDC_ACCESS_TOKEN_EXPIRE_MINUTES=30
BDC_REFRESH_TOKEN_EXPIRE_DAYS=7
```

**生产环境建议：使用 openssl 生成安全的密钥**
```bash
openssl rand -hex 32
```

#### 步骤 3：初始化数据库（1 分钟）

```bash
python scripts/init_auth_db.py
```

输出示例：
```
============================================================
BDC-AI 认证和权限数据库初始化
============================================================

创建数据库表...
✓ 数据库表创建完成
初始化权限...
✓ 创建了 27 个权限

初始化角色...
✓ 创建了 6 个角色

初始化用户...
✓ 创建了默认管理员账号:
  用户名: admin
  密码: admin123
  ⚠ 请登录后立即修改密码！
✓ 创建了 3 个测试用户:
  - manager1 / manager123
  - engineer1 / engineer123
  - analyst1 / analyst123

============================================================
初始化完成！
============================================================
```

#### 步骤 4：启动服务并测试（1 分钟）

```bash
# 启动后端
cd services/backend
python -m uvicorn app.main:app --host localhost --port 8000 --reload
```

打开浏览器访问：http://localhost:8000/docs

### 2.2 默认账号

| 用户名 | 密码 | 角色 | 说明 |
|--------|------|------|------|
| admin | admin123 | 超级管理员 | 拥有所有权限 |
| manager1 | manager123 | 项目经理 | 项目管理、资产上传 |
| engineer1 | engineer123 | 现场工程师 | 资产上传、查看 |
| analyst1 | analyst123 | 数据分析师 | 数据查看、报告生成 |

⚠️ **登录后立即修改默认密码！**

### 2.3 测试登录

#### 管理员登录

在 Swagger UI 中：

1. 找到 `POST /api/v1/auth/login` 端点
2. 点击 "Try it out"
3. 输入：
   ```json
   {
     "username": "admin",
     "password": "admin123"
   }
   ```
4. 点击 "Execute"

返回示例：
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "expires_in": 1800
}
```

#### 获取当前用户信息

1. 复制上面的 `access_token`
2. 找到 `GET /api/v1/auth/me` 端点
3. 点击 "Authorize" 按钮
4. 输入 `Bearer <your_access_token>`（注意空格）
5. 点击 "Execute"

你将看到管理员用户的详细信息。

---

## 3. 系统架构

### 3.1 架构设计

#### 核心模型关系

```
用户 (User) ←→ 角色 (Role) ←→ 权限 (Permission)
     ↓
项目成员 (ProjectMember) - 项目级权限
     ↓
审计日志 (AuditLog) - 操作追溯
```

#### 系统分层

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端层                                  │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐              ┌──────────────┐                │
│  │   移动端     │              │   PC 端      │                │
│  │   (Flutter)  │              │  (NiceGUI)   │                │
│  │ - 登录页面   │              │ - 登录页面   │                │
│  │ - Token 存储 │              │ - 会话管理   │                │
│  │ - 自动刷新   │              │ - 权限控制   │                │
│  └──────────────┘              └──────────────┘                │
└─────────────────────────────────────────────────────────────────┘
                         │ HTTP/HTTPS
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                         API 层                                    │
├─────────────────────────────────────────────────────────────────┤
│  FastAPI 路由 + 安全中间件（JWT 验证、权限检查、审计日志）      │
└─────────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                       业务逻辑层                                  │
├─────────────────────────────────────────────────────────────────┤
│  AuthService + 安全工具（password.py, jwt.py, dependencies.py） │
└─────────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                      数据层（SQLAlchemy ORM）                    │
├─────────────────────────────────────────────────────────────────┤
│  User, Role, Permission, UserRole, RolePermission,              │
│  ProjectMember, AuditLog                                         │
└─────────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    PostgreSQL 数据库                             │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 认证流程

```
┌─────────┐                 ┌─────────┐                 ┌──────────┐
│  客户端  │                 │ API层   │                 │ 数据库   │
└────┬────┘                 └────┬────┘                 └────┬─────┘
     │                           │                           │
     │ POST /login               │                           │
     │ {username, password}      │                           │
     ├──────────────────────────>│                           │
     │                           │ 查询用户                   │
     │                           ├──────────────────────────>│
     │                           │                           │
     │                           │ 返回用户信息               │
     │                           │<──────────────────────────┤
     │                           │                           │
     │                           │ 验证密码                   │
     │                           │ (bcrypt.compare)          │
     │                           │                           │
     │                           │ 生成 JWT Token            │
     │                           │ - access_token (30min)    │
     │                           │ - refresh_token (7days)   │
     │                           │                           │
     │                           │ 记录审计日志               │
     │                           ├──────────────────────────>│
     │                           │                           │
     │ {access_token,            │                           │
     │  refresh_token}           │                           │
     │<──────────────────────────┤                           │
     │                           │                           │
     │ 存储 Token                │                           │
     │                           │                           │
     ▼                           ▼                           ▼
```

### 3.3 权限检查流程

```
┌─────────┐                 ┌─────────┐                 ┌──────────┐
│  客户端  │                 │ API层   │                 │ 数据库   │
└────┬────┘                 └────┬────┘                 └────┬─────┘
     │                           │                           │
     │ GET /api/v1/projects       │                           │
     │ Authorization: Bearer xxx  │                           │
     ├──────────────────────────>│                           │
     │                           │                           │
     │                           │ 验证 JWT Token             │
     │                           │ - 解码 Token               │
     │                           │ - 检查过期时间             │
     │                           │ - 提取 user_id             │
     │                           │                           │
     │                           │ 查询用户                   │
     │                           ├──────────────────────────>│
     │                           │                           │
     │                           │ 返回用户+角色              │
     │                           │<──────────────────────────┤
     │                           │                           │
     │                           │ 检查权限                   │
     │                           │ - is_superuser?           │
     │                           │ - 角色权限匹配?           │
     │                           │                           │
     │                           │ 记录审计日志               │
     │                           ├──────────────────────────>│
     │                           │                           │
     │ 权限允许/拒绝               │                           │
     │<──────────────────────────┤                           │
     │                           │                           │
     │ 200 OK / 403 Forbidden     │                           │
     │                           │                           │
     ▼                           ▼                           ▼
```

### 3.4 Token 刷新流程（移动端自动）

```
┌─────────┐                 ┌─────────┐                 ┌──────────┐
│  客户端  │                 │ API层   │                 │ 数据库   │
└────┬────┘                 └────┬────┘                 └────┬─────┘
     │                           │                           │
     │ GET /api/v1/projects       │                           │
     │ Authorization: Bearer xxx  │                           │
     ├──────────────────────────>│                           │
     │                           │                           │
     │ 401 Unauthorized           │                           │
     │<──────────────────────────┤                           │
     │                           │                           │
     │ 检测到 401 错误            │                           │
     │ 触发 Token 刷新            │                           │
     │                           │                           │
     │ POST /auth/refresh         │                           │
     │ {refresh_token}            │                           │
     ├──────────────────────────>│                           │
     │                           │ 验证 refresh_token         │
     │                           │                           │
     │                           │ 生成新 Token               │
     │                           │                           │
     │ {access_token,            │                           │
     │  refresh_token}           │                           │
     │<──────────────────────────┤                           │
     │                           │                           │
     │ 更新存储的 Token           │                           │
     │ 重试原请求                 │                           │
     │                           │                           │
     │ GET /api/v1/projects       │                           │
     │ Authorization: Bearer new  │                           │
     ├──────────────────────────>│                           │
     │                           │                           │
     │ 200 OK                    │                           │
     │<──────────────────────────┤                           │
     │                           │                           │
     ▼                           ▼                           ▼
```

### 3.5 安全架构

```
┌────────────────────────────────────────────────────────────┐
│                    安全层次结构                             │
├────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────┐        │
│  │  1. 传输层安全                                 │        │
│  │  - HTTPS/TLS (生产环境)                       │        │
│  │  - 证书验证                                   │        │
│  └──────────────────────────────────────────────┘        │
│                      ▼                                    │
│  ┌──────────────────────────────────────────────┐        │
│  │  2. 认证层                                     │        │
│  │  - JWT Token 签名验证                          │        │
│  │  - Token 过期检查                              │        │
│  │  - 刷新令牌机制                                │        │
│  └──────────────────────────────────────────────┘        │
│                      ▼                                    │
│  ┌──────────────────────────────────────────────┐        │
│  │  3. 授权层                                     │        │
│  │  - RBAC 权限模型                              │        │
│  │  - API 端点权限检查                            │        │
│  │  - 项目级权限过滤                              │        │
│  └──────────────────────────────────────────────┘        │
│                      ▼                                    │
│  ┌──────────────────────────────────────────────┐        │
│  │  4. 数据层安全                                 │        │
│  │  - 密码 bcrypt 加密                            │        │
│  │  - SQL 注入防护 (ORM)                         │        │
│  │  - 敏感字段不可读取                            │        │
│  └──────────────────────────────────────────────┘        │
│                      ▼                                    │
│  ┌──────────────────────────────────────────────┐        │
│  │  5. 审计层                                     │        │
│  │  - 操作日志记录                                │        │
│  │  - IP 地址追踪                                 │        │
│  │  - 异常行为检测                                │        │
│  └──────────────────────────────────────────────┘        │
└────────────────────────────────────────────────────────────┘
```

---

## 4. 系统设计

### 4.1 数据库模型

#### User（用户表）

```python
{
    "id": "UUID",
    "username": "String(50) - 唯一",
    "email": "String(100) - 唯一",
    "hashed_password": "String(200)",
    "full_name": "String(100)",
    "phone": "String(20)",
    "is_active": "Boolean",
    "is_superuser": "Boolean",
    "created_at": "DateTime",
    "updated_at": "DateTime",
    "last_login_at": "DateTime"
}
```

#### Role（角色表）

```python
{
    "id": "UUID",
    "name": "String(50) - 唯一",
    "display_name": "String(100)",
    "description": "Text",
    "level": "Integer",
    "created_at": "DateTime",
    "updated_at": "DateTime"
}
```

#### Permission（权限表）

```python
{
    "id": "UUID",
    "code": "String(100) - 唯一",
    "name": "String(100)",
    "description": "Text",
    "resource": "String(50)",
    "action": "String(50)",
    "created_at": "DateTime"
}
```

#### UserRole（用户-角色关联表）

```python
{
    "user_id": "UUID - 外键",
    "role_id": "UUID - 外键"
}
```

#### RolePermission（角色-权限关联表）

```python
{
    "role_id": "UUID - 外键",
    "permission_id": "UUID - 外键"
}
```

#### ProjectMember（项目成员表）

```python
{
    "id": "UUID",
    "project_id": "UUID - 外键",
    "user_id": "UUID - 外键",
    "role_in_project": "String(50) - owner/admin/member/viewer",
    "created_at": "DateTime",
    "created_by": "UUID"
}
```

#### AuditLog（审计日志表）

```python
{
    "id": "UUID",
    "user_id": "UUID - 外键",
    "action": "String(100)",
    "resource_type": "String(50)",
    "resource_id": "String(100)",
    "details": "JSONB",
    "ip_address": "String(50)",
    "user_agent": "String(500)",
    "created_at": "DateTime"
}
```

### 4.2 数据库关系图

```
┌─────────────────┐
│     User        │
├─────────────────┤
│ id (PK)         │───┐
│ username        │   │
│ email           │   │
│ hashed_password │   │
│ is_active       │   │
│ is_superuser    │   │
└─────────────────┘   │
                      │
                      │    ┌─────────────────┐
                      │    │    UserRole     │
                      │    ├─────────────────┤
                      ├───│ user_id (FK)    │
                      │    │ role_id (FK)    │
                      │    └─────────────────┘
                      │             │
                      │             │
                      │    ┌────────▼────────┐
                      │    │     Role        │
                      │    ├─────────────────┤
                      │    │ id (PK)         │───┐
                      │    │ name            │   │
                      │    │ display_name    │   │
                      │    │ level           │   │
                      │    └─────────────────┘   │
                      │                          │
                      │    ┌─────────────────┐   │
                      │    │ RolePermission  │   │
                      │    ├─────────────────┤   │
                      │    │ role_id (FK)    │───┘
                      │    │ permission_id   │───┐
                      │    └─────────────────┘   │
                      │                          │
                      │    ┌─────────────────┐   │
                      │    │  Permission     │   │
                      │    ├─────────────────┤   │
                      │    │ id (PK)         │◄──┘
                      │    │ code            │
                      │    │ resource        │
                      │    │ action          │
                      │    └─────────────────┘
                      │
                      │    ┌─────────────────┐
                      │    │  AuditLog       │
                      │    ├─────────────────┤
                      └────│ user_id (FK)    │
                           │ action          │
                           │ resource_type   │
                           │ details (JSONB) │
                           │ ip_address      │
                           │ created_at      │
                           └─────────────────┘

┌─────────────────┐
│   Project       │
├─────────────────┤
│ id (PK)         │───┐
│ name            │   │
│ ...             │   │
└─────────────────┘   │
                      │
                      │    ┌─────────────────┐
                      │    │ ProjectMember   │
                      │    ├─────────────────┤
                      └────│ project_id (FK) │
                           │ user_id (FK)    │
                           │ role_in_project │
                           └─────────────────┘
```

### 4.3 文件结构

#### 后端文件

```
shared/
├── db/
│   └── models_auth.py              # 认证相关数据库模型
├── security/
│   ├── password.py                 # 密码加密工具
│   ├── jwt.py                      # JWT Token 工具
│   └── dependencies.py             # FastAPI 依赖注入
└── config/
    └── settings.py                 # 配置文件（已更新）

services/backend/
├── app/
│   ├── api/v1/
│   │   └── auth.py                 # 认证 API 路由
│   ├── schemas/
│   │   └── auth.py                 # Pydantic 模型
│   ├── services/
│   │   └── auth_service.py         # 认证业务逻辑
│   └── main.py                     # 应用入口（已更新）
└── requirements.txt                # 依赖文件（已更新）

scripts/
└── init_auth_db.py                 # 数据库初始化脚本

tests/
└── test_auth_api.py                # API 测试用例
```

#### 移动端文件

```
mobile/lib/
├── models/
│   └── auth.dart                   # 认证数据模型
├── services/
│   └── auth_service.dart           # 认证服务
└── screens/
    └── login_screen.dart           # 登录页面
```

---

## 5. API 端点

### 5.1 认证端点

#### POST /api/v1/auth/login
用户登录

**请求：**
```json
{
    "username": "admin",
    "password": "admin123"
}
```

**响应：**
```json
{
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
    "token_type": "bearer",
    "expires_in": 1800
}
```

#### POST /api/v1/auth/refresh
刷新访问令牌

**请求：**
```json
{
    "refresh_token": "eyJhbGciOiJIUzI1NiIs..."
}
```

**响应：** 同登录

#### POST /api/v1/auth/logout
用户注销（可选实现）

#### GET /api/v1/auth/me
获取当前用户信息

**响应：**
```json
{
    "id": "uuid",
    "username": "admin",
    "email": "admin@example.com",
    "full_name": "管理员",
    "is_active": true,
    "is_superuser": true,
    "roles": [
        {
            "id": "uuid",
            "name": "superuser",
            "display_name": "超级管理员",
            "level": 100
        }
    ]
}
```

#### POST /api/v1/auth/me/change-password
修改当前用户密码

**请求：**
```json
{
    "old_password": "oldpass",
    "new_password": "newpass123"
}
```

### 5.2 用户管理（管理员）

#### GET /api/v1/auth/users
获取用户列表

**参数：**
- skip: 跳过记录数（默认 0）
- limit: 返回记录数（默认 100）

#### GET /api/v1/auth/users/{user_id}
获取用户详情

#### POST /api/v1/auth/users
创建用户

**请求：**
```json
{
    "username": "newuser",
    "password": "password123",
    "email": "user@example.com",
    "full_name": "新用户",
    "phone": "13800138000",
    "role_ids": ["uuid-role-1", "uuid-role-2"],
    "is_active": true
}
```

#### PUT /api/v1/auth/users/{user_id}
更新用户（所有字段可选）

#### DELETE /api/v1/auth/users/{user_id}
删除用户

### 5.3 角色和权限（管理员）

#### GET /api/v1/auth/roles
获取角色列表

#### GET /api/v1/auth/roles/{role_id}
获取角色详情（包含权限列表）

#### GET /api/v1/auth/permissions
获取权限列表

### 5.4 审计日志（管理员）

#### GET /api/v1/auth/audit-logs
获取审计日志

**参数：**
- skip: 跳过记录数（默认 0）
- limit: 返回记录数（默认 100）

---

## 6. 权限控制使用

### 6.1 在 FastAPI 路由中使用

#### 要求用户登录

```python
from fastapi import Depends
from shared.security.dependencies import get_current_user
from shared.db.models_auth import User

@router.get("/api/v1/projects")
def get_projects(
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    # 只有登录用户才能访问
    projects = db.query(Project).all()
    return projects
```

#### 要求超级用户

```python
from shared.security.dependencies import get_current_superuser

@router.delete("/api/v1/projects/{project_id}")
def delete_project(
    project_id: str,
    current_user: User = Depends(get_current_superuser),
    db: Session = Depends(get_db)
):
    # 只有管理员才能删除
    ...
```

#### 要求特定权限

```python
from shared.security.dependencies import PermissionChecker

@router.post("/api/v1/projects")
def create_project(
    _: bool = Depends(PermissionChecker("projects.create")),
    db: Session = Depends(get_db)
):
    # 只有拥有 projects.create 权限的用户才能访问
    ...
```

#### 要求多个权限中的任意一个

```python
from shared.security.dependencies import require_permissions

@router.put("/api/v1/projects/{project_id}")
def update_project(
    _: bool = Depends(require_permissions("projects.update", "projects.admin")),
    db: Session = Depends(get_db)
):
    # 拥有 projects.update 或 projects.admin 权限即可
    ...
```

### 6.2 权限列表

#### 项目管理权限（projects.*）
- `projects.read` - 查看项目
- `projects.create` - 创建项目
- `projects.update` - 更新项目
- `projects.delete` - 删除项目
- `projects.admin` - 项目管理（全部）

#### 资产管理权限（assets.*）
- `assets.read` - 查看资产
- `assets.create` - 创建资产
- `assets.update` - 更新资产
- `assets.delete` - 删除资产
- `assets.upload` - 上传资产

#### 用户管理权限（users.*）
- `users.read` - 查看用户
- `users.create` - 创建用户
- `users.update` - 更新用户
- `users.delete` - 删除用户
- `users.admin` - 用户管理（全部）

#### 报告权限（reports.*）
- `reports.read` - 查看报告
- `reports.create` - 生成报告
- `reports.export` - 导出报告

#### 系统权限（system.*）
- `system.config` - 系统配置
- `system.monitor` - 系统监控

---

## 7. 实施指南

### 7.1 实施检查清单

#### 阶段一：基础实施（必须完成 - MVP）

##### 后端设置

- [ ] **安装依赖**
  - [ ] 更新 `services/backend/requirements.txt`
  - [ ] 运行 `pip install -r requirements.txt`
  - [ ] 验证安装：`python -c "import jose; import passlib"`

- [ ] **配置环境变量**
  - [ ] 生成安全的 JWT 密钥：`openssl rand -hex 32`
  - [ ] 在 `.env` 文件中添加配置：
    ```bash
    BDC_JWT_SECRET_KEY=<生成的密钥>
    BDC_ACCESS_TOKEN_EXPIRE_MINUTES=30
    BDC_REFRESH_TOKEN_EXPIRE_DAYS=7
    ```

- [ ] **初始化数据库**
  - [ ] 运行 `python scripts/init_auth_db.py`
  - [ ] 验证表创建：连接数据库检查 `users`, `roles`, `permissions` 等表
  - [ ] 记录默认管理员账号：admin / admin123

- [ ] **启动后端服务**
  - [ ] 运行 `uvicorn app.main:app --host localhost --port 8000 --reload`
  - [ ] 访问 http://localhost:8000/docs 确认 API 文档加载
  - [ ] 验证认证端点可见

##### 功能测试

- [ ] **测试登录功能**
  - [ ] 使用 admin/admin123 登录
  - [ ] 验证返回 access_token 和 refresh_token
  - [ ] 测试错误密码（应返回 401）
  - [ ] 测试不存在的用户（应返回 401）

- [ ] **测试获取用户信息**
  - [ ] 使用 token 调用 GET /api/v1/auth/me
  - [ ] 验证返回正确的用户信息
  - [ ] 验证返回角色列表

- [ ] **测试用户管理（管理员）**
  - [ ] 获取用户列表：GET /api/v1/auth/users
  - [ ] 创建新用户：POST /api/v1/auth/users
  - [ ] 更新用户信息：PUT /api/v1/auth/users/{id}
  - [ ] 删除用户：DELETE /api/v1/auth/users/{id}

- [ ] **测试修改密码**
  - [ ] 修改当前用户密码
  - [ ] 使用新密码登录验证

##### 安全验证

- [ ] **密码加密**
  - [ ] 检查数据库中密码已哈希加密
  - [ ] 验证无法从数据库直接读取明文密码

- [ ] **Token 验证**
  - [ ] 测试无效 token（应返回 401）
  - [ ] 测试过期 token（应返回 401）
  - [ ] 测试刷新令牌功能

- [ ] **权限控制**
  - [ ] 测试普通用户无法访问用户管理（应返回 403）
  - [ ] 测试管理员可以访问所有端点

#### 阶段二：集成现有 API（必须完成）

##### 为现有 API 添加认证

- [ ] **项目管理 API**
  - [ ] GET /api/v1/projects - 添加 `get_current_user` 依赖
  - [ ] POST /api/v1/projects - 添加 `PermissionChecker("projects.create")`
  - [ ] PUT /api/v1/projects/{id} - 添加权限检查
  - [ ] DELETE /api/v1/projects/{id} - 添加管理员权限

- [ ] **资产管理 API**
  - [ ] GET /api/v1/assets - 添加登录要求
  - [ ] POST /api/v1/assets - 添加 `PermissionChecker("assets.upload")`
  - [ ] PUT /api/v1/assets/{id} - 添加权限检查
  - [ ] DELETE /api/v1/assets/{id} - 添加权限检查

- [ ] **工程结构 API**
  - [ ] 为所有端点添加适当的权限检查

##### 测试权限控制

- [ ] **使用不同角色测试**
  - [ ] 以 superuser 登录，验证所有功能可用
  - [ ] 以 engineer 登录，验证只能上传资产
  - [ ] 以 viewer 登录，验证只有只读权限
  - [ ] 未登录用户，验证所有 API 返回 401

#### 阶段三：移动端集成（必须完成）

##### 移动端依赖

- [ ] **添加 Flutter 依赖**
  - [ ] 在 `mobile/pubspec.yaml` 添加：
    ```yaml
    flutter_secure_storage: ^8.0.0
    shared_preferences: ^2.2.0
    dio: ^5.3.0
    ```
  - [ ] 运行 `flutter pub get`

##### 移动端实现

- [ ] **集成认证服务**
  - [ ] 复制 `mobile/lib/models/auth.dart` 到项目
  - [ ] 复制 `mobile/lib/services/auth_service.dart` 到项目
  - [ ] 复制 `mobile/lib/screens/login_screen.dart` 到项目

- [ ] **配置 API 地址**
  - [ ] 在 AuthService 中配置正确的后端地址
  - [ ] 测试开发环境和生产环境切换

- [ ] **实现登录流程**
  - [ ] 应用启动时调用 `AuthService.initialize()`
  - [ ] 显示登录页面（未登录时）
  - [ ] 登录成功后存储 Token
  - [ ] 自动刷新 Token

- [ ] **测试移动端登录**
  - [ ] 输入 admin/admin123 登录
  - [ ] 验证登录成功后跳转到主页
  - [ ] 验证 Token 自动刷新
  - [ ] 验证退出登录清除 Token

##### 移动端错误处理

- [ ] **处理网络错误**
  - [ ] 显示友好的错误提示
  - [ ] 提供重试功能

- [ ] **处理 Token 过期**
  - [ ] 401 错误时自动刷新 Token
  - [ ] 刷新失败时跳转到登录页

#### 阶段四：PC 端集成（推荐完成）

##### NiceGUI 登录页面

- [ ] **创建登录页面**
  - [ ] 设计登录界面（用户名、密码输入框）
  - [ ] 实现登录逻辑
  - [ ] 存储 Token 到 app.storage.user

- [ ] **会话管理**
  - [ ] 检查登录状态
  - [ ] 未登录时重定向到登录页
  - [ ] 提供"退出登录"功能

- [ ] **权限 UI 控制**
  - [ ] 根据用户角色显示/隐藏功能按钮
  - [ ] 显示用户信息（用户名、角色）
  - [ ] 权限不足时显示提示

##### 测试 PC 端

- [ ] 测试登录功能
- [ ] 测试会话保持
- [ ] 测试权限控制
- [ ] 测试退出登录

#### 阶段五：增强功能（可选实现）

##### 项目级权限

- [ ] **实现项目成员管理**
  - [ ] 添加项目成员 API
  - [ ] 过滤用户只能看到授权的项目
  - [ ] 项目管理员管理成员角色

- [ ] **前端项目过滤**
  - [ ] 移动端只显示用户有权访问的项目
  - [ ] PC 端项目列表添加权限标记

##### 审计和监控

- [ ] **审计日志查看**
  - [ ] 在 PC 端添加审计日志查看页面
  - [ ] 支持按时间、用户、操作类型过滤
  - [ ] 导出审计日志

- [ ] **操作审计**
  - [ ] 为关键操作添加审计日志记录
  - [ ] 记录 IP 地址和用户代理
  - [ ] 定期分析异常操作

##### 高级功能

- [ ] **密码重置**
  - [ ] 实现忘记密码功能
  - [ ] 邮件/短信发送重置链接
  - [ ] 密码重置 Token 验证

- [ ] **多因素认证（MFA）**
  - [ ] 集成 TOTP（Google Authenticator）
  - [ ] 扫描二维码绑定
  - [ ] 登录时验证二次认证

- [ ] **Token 黑名单**
  - [ ] 使用 Redis 实现登出黑名单
  - [ ] 强制登出指定用户
  - [ ] 黑名单过期清理

- [ ] **登录限流**
  - [ ] 防止暴力破解
  - [ ] 同一 IP 失败次数限制
  - [ ] 账户临时锁定

#### 阶段六：生产环境部署（必须完成）

##### 安全配置

- [ ] **修改所有默认密码**
  - [ ] 修改 admin 密码
  - [ ] 删除或禁用测试账号
  - [ ] 通知所有首次登录用户修改密码

- [ ] **HTTPS 配置**
  - [ ] 配置 SSL 证书
  - [ ] 强制 HTTPS 重定向
  - [ ] 更新 CORS 配置

- [ ] **JWT 密钥**
  - [ ] 使用环境变量配置
  - [ ] 定期轮换密钥
  - [ ] 密钥备份

##### 备份和恢复

- [ ] **数据库备份**
  - [ ] 设置自动备份
  - [ ] 测试备份恢复
  - [ ] 备份保留策略

- [ ] **审计日志归档**
  - [ ] 定期归档日志
  - [ ] 日志保留策略（至少 90 天）
  - [ ] 日志查询工具

##### 监控和告警

- [ ] **设置监控**
  - [ ] 服务可用性监控
  - [ ] 异常登录告警
  - [ ] API 错误率监控

- [ ] **日志管理**
  - [ ] 集中日志收集
  - [ ] 日志分析工具
  - [ ] 异常检测

### 7.2 验收标准

##### 功能验收

- [ ] 所有用户可以正常登录和登出
- [ ] Token 自动刷新正常工作
- [ ] 权限控制正确生效
- [ ] 移动端集成完整
- [ ] PC 端集成完整

##### 性能验收

- [ ] 登录响应时间 < 500ms
- [ ] API 响应时间 < 200ms（不含业务逻辑）
- [ ] Token 刷新对用户无感

##### 安全验收

- [ ] 密码加密存储
- [ ] Token 过期自动失效
- [ ] 权限控制无漏洞
- [ ] 审计日志完整

##### 文档验收

- [ ] API 文档完整
- [ ] 用户使用手册
- [ ] 运维部署文档
- [ ] 故障排查指南

### 7.3 实施时间估算

| 阶段 | 预计时间 | 负责人 | 状态 |
|-----|---------|--------|------|
| 阶段一：基础实施 | 2 小时 | 后端开发 | ⏳ |
| 阶段二：集成现有 API | 4 小时 | 后端开发 | ⏳ |
| 阶段三：移动端集成 | 4 小时 | 移动端开发 | ⏳ |
| 阶段四：PC 端集成 | 2 小时 | 前端开发 | ⏳ |
| 阶段五：增强功能 | 16 小时 | 全栈 | ⏳ |
| 阶段六：生产部署 | 4 小时 | 运维 | ⏳ |

**总计（不含增强功能）：16 小时（2 个工作日）**

---

## 8. 测试与验证

### 8.1 运行单元测试

```bash
cd services/backend
pytest tests/test_auth_api.py -v
```

### 8.2 测试覆盖范围

- ✓ 登录成功/失败
- ✓ Token 刷新
- ✓ 用户管理 CRUD
- ✓ 权限检查
- ✓ 审计日志

### 8.3 性能指标

- 登录响应时间：< 500ms
- API 验证时间：< 10ms
- Token 刷新时间：< 100ms
- 支持并发用户：100+

---

## 9. 安全建议

### 9.1 生产环境必须修改的配置

1. **JWT_SECRET_KEY**：使用 openssl 生成强密钥
2. **默认管理员密码**：登录后立即修改
3. **Token 过期时间**：根据安全需求调整

### 9.2 网络安全

- 使用 HTTPS（生产环境）
- 配置防火墙规则
- 限制 API 访问频率

### 9.3 密码策略

- 最少 6 位字符
- 建议包含大小写字母、数字、特殊字符
- 定期修改密码

### 9.4 审计日志

- 定期检查异常操作
- 保留日志至少 90 天
- 监控失败登录尝试

---

## 10. 故障排查

### 10.1 问题：Token 刷新失败

**原因：** 刷新令牌过期

**解决：**
- 检查 REFRESH_TOKEN_EXPIRE_DAYS 配置
- 重新登录获取新令牌

### 10.2 问题：权限不足 403

**原因：** 用户角色没有所需权限

**解决：**
- 检查用户角色：GET /api/v1/auth/me
- 检查角色权限：GET /api/v1/auth/roles/{role_id}
- 由管理员分配正确角色

### 10.3 问题：数据库表不存在

**原因：** 没有运行初始化脚本

**解决：**
```bash
python scripts/init_auth_db.py
```

### 10.4 常见问题

#### Q: 如何重置管理员密码？

```bash
# 方法 1：API
curl -X POST http://localhost:8000/api/v1/auth/me/change-password \
  -H "Authorization: Bearer <token>" \
  -d '{"old_password":"admin123","new_password":"newpass"}'

# 方法 2：重新初始化
python scripts/init_auth_db.py
```

#### Q: Token 过期怎么办？

移动端会自动刷新。如果刷新失败，重新登录即可。

#### Q: 如何创建新用户？

使用管理员账号通过 API 创建，或通过初始化脚本批量创建。

#### Q: 如何给用户分配权限？

通过角色分配权限。用户可以有多个角色，权限会自动合并。

---

## 11. 扩展功能

### 11.1 项目级权限过滤

在查询项目时，只返回用户有权访问的项目：

```python
@router.get("/")
def list_projects(
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    # 超级用户看到所有项目
    if current_user.is_superuser:
        return db.query(Project).all()

    # 其他用户只能看到作为成员的项目
    project_ids = db.query(ProjectMember.project_id).filter(
        ProjectMember.user_id == current_user.id
    ).all()

    return db.query(Project).filter(Project.id.in_(project_ids)).all()
```

### 11.2 Token 黑名单

实现登出时将 Token 加入黑名单（使用 Redis）：

```python
import redis

redis_client = redis.Redis(host='localhost', port=6379, db=0)

@router.post("/logout")
def logout(current_user: User = Depends(get_current_user)):
    # 将当前 Token 加入黑名单
    token = get_token_from_request()
    redis_client.setex(f"blacklist:{token}", 3600, "1")
    return {"message": "Logged out"}
```

### 11.3 多因素认证（MFA）

集成 TOTP（基于时间的一次性密码）：

```python
import pyotp

@router.post("/mfa/enable")
def enable_mfa(current_user: User = Depends(get_current_user)):
    secret = pyotp.random_base32()
    # 保存到用户配置
    return {"secret": secret}

@router.post("/mfa/verify")
def verify_mfa(code: str, current_user: User = Depends(get_current_user)):
    # 验证 TOTP 代码
    ...
```

### 11.4 密码重置功能

通过邮件或短信发送重置链接：

```python
@router.post("/forgot-password")
def forgot_password(email: str):
    # 发送重置邮件
    reset_token = generate_reset_token()
    send_email(email, reset_token)
    return {"message": "Reset email sent"}
```

---

## 12. 附录

### 12.1 完整文件清单

#### 后端（11 个文件）

```
shared/db/models_auth.py
shared/security/password.py
shared/security/jwt.py
shared/security/dependencies.py
shared/config/settings.py (已更新)
services/backend/app/api/v1/auth.py
services/backend/app/schemas/auth.py
services/backend/app/services/auth_service.py
services/backend/app/main.py (已更新)
services/backend/requirements.txt (已更新)
scripts/init_auth_db.py
tests/test_auth_api.py
```

#### 移动端（3 个文件）

```
mobile/lib/models/auth.dart
mobile/lib/services/auth_service.dart
mobile/lib/screens/login_screen.dart
```

### 12.2 参考文档

- [FastAPI Security Tutorial](https://fastapi.tiangolo.com/tutorial/security/)
- [JWT.io](https://jwt.io/)
- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
- [Passlib Documentation](https://passlib.readthedocs.io/)

### 12.3 完成标志

当以下所有项目都完成后，账号权限管理系统即部署完成：

1. ✅ 默认管理员账号成功登录
2. ✅ 可以创建和管理用户
3. ✅ 现有 API 都已添加认证
4. ✅ 移动端可以正常登录和使用
5. ✅ PC 端可以正常登录和使用
6. ✅ 权限控制正确生效
7. ✅ 审计日志正常记录
8. ✅ 生产环境安全配置完成

---

## 下一步计划

### 短期（MVP）

- [x] 基础认证和授权
- [x] RBAC 权限模型
- [x] 移动端集成
- [x] PC 端集成
- [ ] 为现有 API 添加认证
- [ ] 项目级权限过滤

### 中期

- [ ] 密码重置功能
- [ ] Token 黑名单
- [ ] 登录限流
- [ ] 审计日志查看界面

### 长期

- [ ] 多因素认证（MFA）
- [ ] SSO 单点登录
- [ ] OAuth 2.0 / OpenID Connect
- [ ] 细粒度权限控制

---

**文档维护**: BDC-AI 开发团队
**最后更新**: 2026-01-25
**版本**: 1.0.0
