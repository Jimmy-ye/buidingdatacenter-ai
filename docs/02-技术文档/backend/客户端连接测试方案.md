# 客户端连接测试方案

**文档版本**: v1.0
**创建日期**: 2026-01-26
**后端地址**: http://100.93.101.76:8000 (Tailscale)
**本地地址**: http://localhost:8000
**测试分支**: backend-health-check

---

## 测试目标

验证后端服务与各种客户端的连接可用性和稳定性，确保：
1. ✅ 后端服务正常运行
2. ✅ 客户端能够成功连接
3. ✅ 认证系统正常工作
4. ✅ API 调用正常响应
5. ✅ 数据交互正确无误

---

## 测试环境

### 后端服务器

- **主机**: Windows 开发机
- **IP 地址**:
  - 本地: 127.0.0.1 / 0.0.0.0
  - Tailscale: 100.93.101.76
- **端口**: 8000
- **框架**: FastAPI 0.104.1
- **数据库**: PostgreSQL 18.1

### 测试客户端类型

1. **命令行客户端** (curl/Python)
2. **Web 浏览器** (Chrome/Firefox)
3. **PC-UI** (NiceGUI)
4. **移动端** (Flutter - 待测试)
5. **其他机器** (通过 Tailscale VPN)

---

## 测试方案 1: 命令行测试

### 1.1 基础连接测试

**目的**: 验证后端服务是否响应

```bash
# 测试根路径
curl http://localhost:8000/

# 预期输出: {"status":"ok"}

# 测试健康检查
curl http://localhost:8000/api/v1/health/

# 预期输出: {"status":"ok"}
```

**判断标准**:
- ✅ HTTP 状态码 200
- ✅ 返回 JSON 格式数据
- ✅ 响应时间 < 1秒

---

### 1.2 认证登录测试

**目的**: 验证用户登录和 Token 生成

```bash
# 登录获取 Token
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 预期输出:
# {
#   "access_token": "eyJ...",
#   "refresh_token": "eyJ...",
#   "token_type": "bearer",
#   "expires_in": 1800
# }
```

**判断标准**:
- ✅ 成功返回 access_token
- ✅ 成功返回 refresh_token
- ✅ Token 类型为 bearer
- ✅ expires_in = 1800 秒

---

### 1.3 用户信息查询测试

**目的**: 验证 Token 认证和用户信息获取

```bash
# 获取 Token
TOKEN=$(curl -s -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  | grep -o '"access_token":"[^"]*"' \
  | cut -d'"' -f4)

# 查询用户信息
curl -X GET http://localhost:8000/api/v1/auth/me \
  -H "Authorization: Bearer $TOKEN"

# 预期输出:
# {
#   "id": "...",
#   "username": "admin",
#   "email": "admin@bdc-ai.com",
#   "full_name": "系统管理员",
#   "roles": [...]
# }
```

**判断标准**:
- ✅ 返回完整的用户信息
- ✅ 用户名为 admin
- ✅ 包含角色信息

---

### 1.4 项目 API 测试

**目的**: 验证业务 API 的正常工作

```bash
# 获取 Token (使用上面的方法)
TOKEN="..."

# 获取项目列表
curl -X GET http://localhost:8000/api/v1/projects/ \
  -H "Authorization: Bearer $TOKEN"

# 创建新项目
curl -X POST http://localhost:8000/api/v1/projects/ \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "测试项目",
    "customer": "测试客户",
    "location": "测试地点",
    "description": "这是一个测试项目"
  }'
```

**判断标准**:
- ✅ 能够获取项目列表
- ✅ 能够创建新项目
- ✅ 数据格式正确

---

## 测试方案 2: Web 浏览器测试

### 2.1 API 文档访问

**步骤**:
1. 打开浏览器
2. 访问: http://localhost:8000/docs
3. 检查 Swagger UI 是否正常显示

**验证点**:
- ✅ 页面正常加载
- ✅ API 列表完整显示
- ✅ 可以展开查看详情
- ✅ Try it out 按钮可用

---

### 2.2 在线 API 测试

**步骤**:
1. 在 Swagger UI 中找到 `/api/v1/auth/login` 端点
2. 点击 "Try it out"
3. 输入测试账号:
   ```json
   {
     "username": "admin",
     "password": "admin123"
   }
   ```
4. 点击 "Execute"
5. 查看响应结果

**验证点**:
- ✅ 请求成功发送
- ✅ 返回 200 状态码
- ✅ 响应体包含 Token

---

### 2.3 ReDoc 文档测试

**步骤**:
1. 打开浏览器
2. 访问: http://localhost:8000/redoc
3. 检查文档布局和内容

**验证点**:
- ✅ 文档正常显示
- ✅ 所有端点都有说明
- ✅ 请求/响应示例完整

---

## 测试方案 3: PC-UI 连接测试

### 3.1 PC-UI 启动测试

**步骤**:
```bash
# 启动 PC-UI
cd desktop/nicegui_app
../启动PC-UI.bat

# 或手动启动
D:\BDC-AI\venv311\Scripts\python.exe pc_app.py
```

**验证点**:
- ✅ NiceGUI 成功启动
- ✅ 浏览器自动打开
- ✅ 页面正常显示

---

### 3.2 PC-UI 后端连接测试

**步骤**:
1. 打开 PC-UI 界面 (http://localhost:8080)
2. 尝试加载项目数据
3. 检查网络请求 (浏览器开发者工具)

**验证点**:
- ✅ 能够连接到后端 API (http://127.0.0.1:8000)
- ✅ 认证请求正常
- ✅ 数据加载成功
- ✅ 无控制台错误

---

### 3.3 PC-UI 认证集成测试

**测试内容**:
1. 检查 PC-UI 是否需要登录
2. 如果需要，输入测试账号登录
3. 验证登录后的功能可用性

**验证点**:
- ✅ 登录流程正常
- ✅ Token 正确存储
- ✅ API 请求携带 Token
- ✅ 页面功能正常

---

## 测试方案 4: Tailscale 远程连接测试

### 4.1 Tailscale 连接验证

**步骤**:
1. 确认两台设备都已加入 Tailscale 网络
2. 查看后端主机的 Tailscale IP: `100.93.101.76`
3. 确认 Tailscale 状态: `tailscale status`

**验证点**:
- ✅ Tailscale 服务运行中
- ✅ 两台设备可以互相 ping 通
- ✅ 后端 IP 可访问

---

### 4.2 远程 API 测试

**从另一台机器执行**:

```bash
# 测试基础连接
curl http://100.93.101.76:8000/

# 预期输出: {"status":"ok"}

# 测试健康检查
curl http://100.93.101.76:8000/api/v1/health/

# 预期输出: {"status":"ok"}

# 测试登录
curl -X POST http://100.93.101.76:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 预期输出: 包含 access_token
```

**验证点**:
- ✅ 能够 ping 通后端 IP
- ✅ HTTP 请求正常响应
- ✅ 认证系统工作正常
- ✅ 响应延迟可接受 (< 200ms)

---

### 4.3 防火墙规则验证

**检查 Windows 防火墙**:

```bash
# 查看防火墙规则
netsh advfirewall firewall show rule name="BDC-AI Backend"

# 或检查端口 8000 是否开放
netstat -an | find ":8000"
```

**验证点**:
- ✅ 端口 8000 处于 LISTENING 状态
- ✅ 防火墙允许入站连接
- ✅ Tailscale 虚拟网卡可以访问

---

## 测试方案 5: Python 客户端测试

### 5.1 创建测试脚本

创建文件 `test_client_connection.py`:

```python
import requests
import json

BACKEND_URL = "http://localhost:8000"  # 或 "http://100.93.101.76:8000"

def test_connection():
    """测试基础连接"""
    try:
        response = requests.get(f"{BACKEND_URL}/", timeout=5)
        print(f"[PASS] 基础连接: {response.status_code}")
        return True
    except Exception as e:
        print(f"[FAIL] 基础连接: {e}")
        return False

def test_login():
    """测试登录"""
    try:
        response = requests.post(
            f"{BACKEND_URL}/api/v1/auth/login",
            json={"username": "admin", "password": "admin123"},
            timeout=5
        )
        data = response.json()
        if "access_token" in data:
            print(f"[PASS] 登录成功")
            return data["access_token"]
        else:
            print(f"[FAIL] 登录失败: {data}")
            return None
    except Exception as e:
        print(f"[FAIL] 登录异常: {e}")
        return None

def test_api(token):
    """测试 API 调用"""
    try:
        response = requests.get(
            f"{BACKEND_URL}/api/v1/projects/",
            headers={"Authorization": f"Bearer {token}"},
            timeout=5
        )
        print(f"[PASS] API 调用: {response.status_code}")
        print(f"       项目数: {len(response.json())}")
        return True
    except Exception as e:
        print(f"[FAIL] API 调用: {e}")
        return False

if __name__ == "__main__":
    print("=" * 60)
    print("客户端连接测试")
    print("=" * 60)
    print(f"后端地址: {BACKEND_URL}")
    print()

    # 1. 基础连接
    if not test_connection():
        print("\n[ERROR] 无法连接到后端")
        exit(1)

    # 2. 登录
    token = test_login()
    if not token:
        print("\n[ERROR] 登录失败")
        exit(1)

    # 3. API 调用
    test_api(token)

    print("\n" + "=" * 60)
    print("测试完成")
    print("=" * 60)
```

**运行测试**:
```bash
python test_client_connection.py
```

---

## 测试方案 6: 综合压力测试

### 6.1 并发请求测试

**目的**: 测试后端在高并发下的稳定性

```bash
# 使用 Apache Bench 进行压力测试
# 需要先安装: apt-get install apache2-utils (Linux)

# 测试健康检查端点 (1000 个请求, 10 个并发)
ab -n 1000 -c 10 http://localhost:8000/api/v1/health/

# 查看结果中的关键指标:
# - Requests per second (每秒请求数)
# - Time per request (平均响应时间)
# - Failed requests (失败请求数)
```

**判断标准**:
- ✅ 失败率 < 1%
- ✅ 平均响应时间 < 100ms
- ✅ 无服务崩溃

---

### 6.2 持续连接测试

**目的**: 测试长时间运行的稳定性

```python
import requests
import time
import random

BACKEND_URL = "http://localhost:8000"

def continuous_test(duration_minutes=10):
    """持续测试指定时间"""
    start_time = time.time()
    end_time = start_time + duration_minutes * 60

    success_count = 0
    fail_count = 0

    print(f"开始持续测试 ({duration_minutes} 分钟)...")

    while time.time() < end_time:
        try:
            # 随机选择测试端点
            endpoint = random.choice([
                "/",
                "/api/v1/health/",
                "/api/v1/auth/me"  # 需要携带 Token
            ])

            response = requests.get(f"{BACKEND_URL}{endpoint}", timeout=5)

            if response.status_code == 200:
                success_count += 1
            else:
                fail_count += 1

            # 打印进度
            if success_count % 10 == 0:
                print(f"[{time.time() - start_time:.0f}s] "
                      f"成功: {success_count}, 失败: {fail_count}")

            # 等待 1-5 秒
            time.sleep(random.uniform(1, 5))

        except Exception as e:
            fail_count += 1
            print(f"[ERROR] {e}")

    total = success_count + fail_count
    success_rate = (success_count / total * 100) if total > 0 else 0

    print(f"\n测试完成:")
    print(f"总计请求: {total}")
    print(f"成功: {success_count}")
    print(f"失败: {fail_count}")
    print(f"成功率: {success_rate:.1f}%")

if __name__ == "__main__":
    continuous_test(duration_minutes=5)
```

---

## 测试检查清单

### 后端服务器准备

- [ ] 后端服务已启动
- [ ] 监听地址为 0.0.0.0:8000
- [ ] PostgreSQL 数据库运行中
- [ ] 防火墙允许 8000 端口
- [ ] Tailscale 服务运行中
- [ ] 默认管理员账号可用

### 本地连接测试

- [ ] curl 基础连接测试通过
- [ ] 健康检查端点正常
- [ ] 登录获取 Token 成功
- [ ] 用户信息查询正常
- [ ] 项目 API 调用成功

### 浏览器测试

- [ ] Swagger UI 可访问
- [ ] ReDoc 文档可访问
- [ ] 在线 API 测试成功
- [ ] 控制台无错误

### PC-UI 测试

- [ ] PC-UI 成功启动
- [ ] 界面正常显示
- [ ] 后端连接正常
- [ ] 数据加载成功

### 远程连接测试

- [ ] Tailscale 网络连接
- [ ] ping 后端 IP 成功
- [ ] 远程 API 调用成功
- [ ] 响应延迟可接受

### 稳定性测试

- [ ] 并发测试通过
- [ ] 持续测试通过
- [ ] 无内存泄漏
- [ ] 无服务崩溃

---

## 问题排查指南

### 问题 1: 无法连接到后端

**症状**: curl 返回 "Connection refused"

**排查步骤**:
1. 检查后端服务是否启动: `ps aux | grep uvicorn`
2. 检查端口是否监听: `netstat -an | grep 8000`
3. 检查防火墙规则
4. 确认 IP 地址正确

**解决方案**:
```bash
# 启动后端
python -m uvicorn services.backend.app.main:app --host 0.0.0.0 --port 8000
```

---

### 问题 2: 认证失败

**症状**: API 返回 401 Unauthorized

**排查步骤**:
1. 检查用户名密码是否正确
2. 检查 Token 是否过期
3. 检查 Authorization 头格式

**解决方案**:
```bash
# 重新登录获取新 Token
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

---

### 问题 3: CORS 错误

**症状**: 浏览器控制台报跨域错误

**排查步骤**:
1. 检查后端 CORS 配置
2. 检查请求 Origin 头

**解决方案**:
- 后端已配置 CORS: `Access-Control-Allow-Origin: *`
- 确保后端正常运行

---

### 问题 4: Tailscale 无法连接

**症状**: 无法通过 Tailscale IP 访问

**排查步骤**:
1. 检查 Tailscale 状态: `tailscale status`
2. 检查两台设备是否在同一网络
3. ping 测试: `ping 100.93.101.76`

**解决方案**:
```bash
# 重启 Tailscale
tailscale down
tailscale up
```

---

## 测试报告模板

### 测试基本信息

- **测试日期**: YYYY-MM-DD
- **测试人员**: XXX
- **后端版本**: v1.0.0
- **测试环境**: 开发/测试/生产

### 测试结果

| 测试项 | 结果 | 备注 |
|--------|------|------|
| 基础连接 | ✅/❌ | |
| 健康检查 | ✅/❌ | |
| 用户登录 | ✅/❌ | |
| API 调用 | ✅/❌ | |
| PC-UI 连接 | ✅/❌ | |
| 远程连接 | ✅/❌ | |
| 并发测试 | ✅/❌ | |

### 性能数据

- **平均响应时间**: XX ms
- **成功率**: XX%
- **并发能力**: XX req/s
- **错误率**: XX%

### 问题和建议

1. **问题描述**
   - 重现步骤
   - 错误信息
   - 严重程度

2. **改进建议**
   - 优化方向
   - 实施计划

---

## 下一步行动

1. ✅ **立即执行**: 基础连接测试
2. ⏳ **短期计划**: PC-UI 和远程连接测试
3. 📋 **中期计划**: 移动端集成测试
4. 🎯 **长期目标**: 完整的自动化测试套件

---

**测试方案准备完成！** 🎯

现在可以开始执行客户端连接测试。
