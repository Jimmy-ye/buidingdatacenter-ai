# è¿œç¨‹æœåŠ¡å™¨éƒ¨ç½²æŒ‡å— - è®¤è¯ä¸æƒé™æ§åˆ¶

## ğŸ“‹ éƒ¨ç½²ç›®æ ‡

å°†æœ€æ–°çš„è®¤è¯å’Œæƒé™æ§åˆ¶åŠŸèƒ½éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨ `desktop-bfpk00r` (100.93.101.76:8000)

---

## ğŸš€ å¿«é€Ÿéƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1ï¼šåœ¨æœåŠ¡å™¨ä¸Šæ‹‰å–æœ€æ–°ä»£ç 

åœ¨æœåŠ¡å™¨ `desktop-bfpk00r` ä¸Šæ‰“å¼€ PowerShellï¼Œè¿›å…¥é¡¹ç›®ç›®å½•ï¼š

```powershell
# è¿›å…¥é¡¹ç›®ç›®å½•
cd D:\Huawei Files\åä¸ºå®¶åº­å­˜å‚¨\Programs\program-bdc-ai

# æŸ¥çœ‹å½“å‰åˆ†æ”¯
git branch

# åˆ‡æ¢åˆ° master åˆ†æ”¯ï¼ˆå¦‚æœä¸åœ¨ï¼‰
git checkout master

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin master
```

**é¢„æœŸè¾“å‡º**ï¼š
```text
Updating be7e3fb..a847c3a
Fast-forward
 desktop/nicegui_app/auth_manager.py                | 166 +++++++++-
 desktop/nicegui_app/pc_app.py                      | 145 ++++++--
 ...
```

---

### æ­¥éª¤ 2ï¼šæ£€æŸ¥å¹¶å®‰è£…ä¾èµ–

```powershell
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
D:\BDC-AI\venv311\Scripts\Activate.ps1

# æ£€æŸ¥æ˜¯å¦æœ‰æ–°å¢ä¾èµ–
# å¦‚æœæœ‰ requirements.txt æ›´æ–°ï¼Œè¿è¡Œï¼š
pip install -r services/backend/requirements.txt
```

**æœ¬æ¬¡æ›´æ–°æ²¡æœ‰æ–°å¢ Python ä¾èµ–**ï¼Œä½†å¦‚æœåç«¯æœ‰ä¾èµ–æ›´æ–°ï¼Œå»ºè®®é‡æ–°å®‰è£…ã€‚

---

### æ­¥éª¤ 3ï¼šéªŒè¯æ•°æ®åº“åˆå§‹åŒ–

ç¡®ä¿æ•°æ®åº“å·²æ­£ç¡®åˆå§‹åŒ–ï¼ŒåŒ…å«ç”¨æˆ·ã€è§’è‰²ã€æƒé™è¡¨ï¼š

```powershell
# è¿è¡Œæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ï¼ˆå¦‚æœéœ€è¦ï¼‰
python scripts/init_database.py
```

**æ£€æŸ¥é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·**ï¼š
- ç”¨æˆ·åï¼š`admin`
- å¯†ç ï¼š`admin123`
- è§’è‰²ï¼š`admin` (ç®¡ç†å‘˜), `engineer` (å·¥ç¨‹å¸ˆ)

---

### æ­¥éª¤ 4ï¼šé‡å¯åç«¯æœåŠ¡

#### æ–¹æ³• Aï¼šæ‰‹åŠ¨é‡å¯ï¼ˆæ¨èç”¨äºæµ‹è¯•ï¼‰

```powershell
# åœæ­¢æ—§çš„åç«¯è¿›ç¨‹ï¼ˆå¦‚æœæ­£åœ¨è¿è¡Œï¼‰
# Ctrl+C æˆ–å…³é—­è¿è¡Œåç«¯çš„ç»ˆç«¯çª—å£

# å¯åŠ¨æ–°çš„åç«¯æœåŠ¡
cd D:\Huawei Files\åä¸ºå®¶åº­å­˜å‚¨\Programs\program-bdc-ai
python -m uvicorn services.backend.app.main:app --host 0.0.0.0 --port 8000 --reload
```

#### æ–¹æ³• Bï¼šä½¿ç”¨æœåŠ¡ç®¡ç†è„šæœ¬ï¼ˆå¦‚æœæœ‰ï¼‰

```powershell
# å¦‚æœæœ‰æœåŠ¡ç®¡ç†è„šæœ¬
Restart-BdcBackendService
```

---

### æ­¥éª¤ 5ï¼šéªŒè¯åç«¯æœåŠ¡

#### 5.1 æœ¬åœ°æµ‹è¯•

åœ¨æœåŠ¡å™¨ä¸Šæ‰“å¼€æ–°çš„ PowerShell çª—å£ï¼š

```powershell
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/api/v1/health/

# é¢„æœŸè¾“å‡ºï¼š{"status":"ok"}
```

#### 5.2 é€šè¿‡ Tailscale IP æµ‹è¯•

```powershell
# é€šè¿‡ Tailscale IP è®¿é—®
curl http://100.93.101.76:8000/api/v1/health/

# é¢„æœŸè¾“å‡ºï¼š{"status":"ok"}
```

#### 5.3 æµ‹è¯•ç™»å½•æ¥å£

```powershell
# æµ‹è¯•ç™»å½•
curl -X POST http://100.93.101.76:8000/api/v1/auth/login `
  -H "Content-Type: application/json" `
  -d '{"username":"admin","password":"admin123"}'
```

**é¢„æœŸè¾“å‡º**ï¼š
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "token_type": "bearer",
  "user": {
    "id": 1,
    "username": "admin",
    "email": "admin@bdc-ai.com",
    "is_superuser": true
  }
}
```

---

### æ­¥éª¤ 6ï¼šä»å®¢æˆ·ç«¯æµ‹è¯•è¿œç¨‹è®¿é—®

åœ¨å®¢æˆ·ç«¯ `laptop-0fcpukmh` ä¸Šï¼š

#### 6.1 æµ‹è¯• Tailscale è¿æ¥

```powershell
# æµ‹è¯• Tailscale çŠ¶æ€
tailscale ping 100.93.101.76

# æµ‹è¯• TCP ç«¯å£
Test-NetConnection 100.93.101.76 -Port 8000

# é¢„æœŸï¼šTcpTestSucceeded = True
```

#### 6.2 æµ‹è¯•åç«¯ API

```powershell
# å¥åº·æ£€æŸ¥
curl http://100.93.101.76:8000/api/v1/health/

# æµ‹è¯•ç™»å½•
curl -X POST http://100.93.101.76:8000/api/v1/auth/login `
  -H "Content-Type: application/json" `
  -d '{"username":"admin","password":"admin123"}'
```

#### 6.3 æµ‹è¯•ç”¨æˆ·ä¿¡æ¯æ¥å£ï¼ˆéœ€è¦ Tokenï¼‰

```powershell
# å…ˆç™»å½•è·å– token
$response = Invoke-RestMethod `
  -Uri "http://100.93.101.76:8000/api/v1/auth/login" `
  -Method POST `
  -ContentType "application/json" `
  -Body '{"username":"admin","password":"admin123"}'

# ä½¿ç”¨ token è·å–ç”¨æˆ·ä¿¡æ¯
$token = $response.access_token
Invoke-RestMethod `
  -Uri "http://100.93.101.76:8000/api/v1/auth/me" `
  -Headers @{Authorization = "Bearer $token"}
```

**é¢„æœŸè¾“å‡º**ï¼ˆåº”åŒ…å«è§’è‰²å’Œæƒé™ï¼‰ï¼š
```json
{
  "id": 1,
  "username": "admin",
  "email": "admin@bdc-ai.com",
  "is_superuser": true,
  "roles": [
    {
      "id": 1,
      "name": "admin",
      "display_name": "ç®¡ç†å‘˜",
      "permissions": ["projects:create", "projects:update", ...]
    },
    {
      "id": 2,
      "name": "engineer",
      "display_name": "å·¥ç¨‹å¸ˆ",
      "permissions": ["assets:upload", "ocr:run", ...]
    }
  ]
}
```

---

## ğŸ–¥ï¸ éƒ¨ç½² PC-UIï¼ˆå®¢æˆ·ç«¯ï¼‰

### æ­¥éª¤ 1ï¼šåœ¨å®¢æˆ·ç«¯æ‹‰å–æœ€æ–°ä»£ç 

åœ¨å®¢æˆ·ç«¯ `laptop-0fcpukmh` ä¸Šï¼š

```powershell
cd D:\Huawei Files\åä¸ºå®¶åº­å­˜å‚¨\Programs\program-bdc-ai
git pull origin master
```

---

### æ­¥éª¤ 2ï¼šé…ç½®ç¯å¢ƒå˜é‡

```powershell
# è®¾ç½®åç«¯ API åœ°å€ä¸º Tailscale IP
$env:BDC_API_URL="http://100.93.101.76:8000/api/v1"
```

**æ°¸ä¹…è®¾ç½®**ï¼ˆæ·»åŠ åˆ°ç³»ç»Ÿç¯å¢ƒå˜é‡æˆ–é¡¹ç›® `.env` æ–‡ä»¶ï¼‰ï¼š

```powershell
# æ–¹æ³• Aï¼šç³»ç»Ÿç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰
[System.Environment]::SetEnvironmentVariable('BDC_API_URL', 'http://100.93.101.76:8000/api/v1', 'User')

# æ–¹æ³• Bï¼šåˆ›å»º .env æ–‡ä»¶
# åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º .env æ–‡ä»¶ï¼š
# ENVIRONMENT=development
# BDC_API_URL=http://100.93.101.76:8000/api/v1
```

---

### æ­¥éª¤ 3ï¼šå®‰è£… PC-UI ä¾èµ–

```powershell
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼ˆå¦‚æœæœ‰ï¼‰
D:\BDC-AI\venv311\Scripts\Activate.ps1

# å®‰è£… NiceGUI ç­‰ä¾èµ–
pip install nicegui requests python-dotenv
```

---

### æ­¥éª¤ 4ï¼šå¯åŠ¨ PC-UI

```powershell
cd D:\Huawei Files\åä¸ºå®¶åº­å­˜å‚¨\Programs\program-bdc-ai
python -m desktop.nicegui_app.pc_app
```

**é¢„æœŸè¾“å‡º**ï¼š
```text
INFO:     Started server process
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8080
[INFO] å¼€å‘å·¥å…·å·²å¯ç”¨:
       - http://localhost:8080/test-401 (401 åœºæ™¯æµ‹è¯•)
       - http://localhost:8080/test-401-direct (401 è°ƒè¯•æµ‹è¯•)
       - http://localhost:8080/test-refresh (Refresh Token æµ‹è¯•)
```

---

### æ­¥éª¤ 5ï¼šæµ‹è¯• PC-UI è®¤è¯åŠŸèƒ½

1. **æ‰“å¼€æµè§ˆå™¨**è®¿é—® http://localhost:8080

2. **è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ**ï¼ˆhttp://localhost:8080/loginï¼‰

3. **ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·ç™»å½•**ï¼š
   - ç”¨æˆ·åï¼š`admin`
   - å¯†ç ï¼š`admin123`

4. **éªŒè¯åŠŸèƒ½**ï¼š
   - âœ… ç™»å½•æˆåŠŸåè·³è½¬åˆ°ä¸»é¡µ
   - âœ… å³ä¸Šè§’æ˜¾ç¤ºï¼š`ç”¨æˆ·: admin | ç®¡ç†å‘˜ | å·¥ç¨‹å¸ˆ`
   - âœ… å¯ä»¥çœ‹åˆ°æ‰€æœ‰æŒ‰é’®ï¼ˆé¡¹ç›®ã€ç»“æ„ã€èµ„äº§ã€OCR/LLMï¼‰
   - âœ… å¯ä»¥åŠ è½½é¡¹ç›®åˆ—è¡¨
   - âœ… Token è‡ªåŠ¨åˆ·æ–°æ­£å¸¸å·¥ä½œ
   - âœ… ç™»å‡ºåŠŸèƒ½æ­£å¸¸

---

## âœ… éƒ¨ç½²éªŒè¯æ¸…å•

### åç«¯éªŒè¯

| æ£€æŸ¥é¡¹ | é¢„æœŸç»“æœ | å®é™…ç»“æœ | çŠ¶æ€ |
|--------|---------|---------|------|
| åç«¯è¿›ç¨‹è¿è¡Œ | Uvicorn è¿›ç¨‹å­˜åœ¨ | | â¬œ |
| å¥åº·æ£€æŸ¥ | `{"status":"ok"}` | | â¬œ |
| ç™»å½•æ¥å£ | è¿”å› access_token å’Œ refresh_token | | â¬œ |
| /auth/me æ¥å£ | è¿”å›ç”¨æˆ·ä¿¡æ¯å’Œè§’è‰²æƒé™ | | â¬œ |
| Tailscale è®¿é—® | å®¢æˆ·ç«¯å¯è®¿é—® http://100.93.101.76:8000 | | â¬œ |

### PC-UI éªŒè¯

| æ£€æŸ¥é¡¹ | é¢„æœŸç»“æœ | å®é™…ç»“æœ | çŠ¶æ€ |
|--------|---------|---------|------|
| PC-UI å¯åŠ¨ | è®¿é—® http://localhost:8080 æˆåŠŸ | | â¬œ |
| è‡ªåŠ¨è·³è½¬ç™»å½• | æœªç™»å½•æ—¶è‡ªåŠ¨è·³è½¬ /login | | â¬œ |
| ç™»å½•åŠŸèƒ½ | admin/admin123 ç™»å½•æˆåŠŸ | | â¬œ |
| ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º | æ˜¾ç¤º"ç”¨æˆ·: admin | ç®¡ç†å‘˜ | å·¥ç¨‹å¸ˆ" | | â¬œ |
| æŒ‰é’®æƒé™æ§åˆ¶ | ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°æ‰€æœ‰æŒ‰é’® | | â¬œ |
| Token åˆ·æ–° | 15åˆ†é’Ÿåè‡ªåŠ¨åˆ·æ–°ï¼Œæ— éœ€é‡æ–°ç™»å½• | | â¬œ |
| ç™»å‡ºåŠŸèƒ½ | ç‚¹å‡»ç™»å‡ºè·³è½¬å› /login | | â¬œ |

---

## ğŸ”§ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1ï¼šåç«¯å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶**ï¼š
```text
ModuleNotFoundError: No module named 'xxx'
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```powershell
# é‡æ–°å®‰è£…ä¾èµ–
pip install -r services/backend/requirements.txt

# æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒ
# ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ Python è§£é‡Šå™¨
```

---

### é—®é¢˜ 2ï¼šå®¢æˆ·ç«¯æ— æ³•è¿æ¥åˆ°åç«¯

**ç—‡çŠ¶**ï¼š
```text
curl : æ— æ³•è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨
```

**æ’æŸ¥æ­¥éª¤**ï¼š

1. **æ£€æŸ¥ Tailscale çŠ¶æ€**ï¼š
```powershell
tailscale status
tailscale ping 100.93.101.76
```

2. **æ£€æŸ¥ TCP ç«¯å£**ï¼š
```powershell
Test-NetConnection 100.93.101.76 -Port 8000
```

3. **æ£€æŸ¥æœåŠ¡å™¨é˜²ç«å¢™**ï¼š
```powershell
# åœ¨æœåŠ¡å™¨ä¸Š
Get-NetFirewallRule -DisplayName "BDC-AI API 8000"
```

4. **æ£€æŸ¥ç¬¬ä¸‰æ–¹é˜²æŠ¤è½¯ä»¶**ï¼š
   - ç¡®ä¿å·²ä¸º `python.exe`/`uvicorn.exe` æ·»åŠ ç™½åå•

---

### é—®é¢˜ 3ï¼šç™»å½•å¤±è´¥

**ç—‡çŠ¶**ï¼š
```text
401 Unauthorized
{"detail": "Incorrect username or password"}
```

**æ’æŸ¥æ­¥éª¤**ï¼š

1. **ç¡®è®¤ç”¨æˆ·å­˜åœ¨**ï¼š
```powershell
# åœ¨æœåŠ¡å™¨ä¸Šè¿æ¥æ•°æ®åº“
python -c "from shared.db.session import get_db; from services.backend.app.models.user import User; db = next(get_db()); print(db.query(User).filter_by(username='admin').first())"
```

2. **é‡ç½®ç®¡ç†å‘˜å¯†ç **ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š
```powershell
python scripts/reset_admin_password.py
```

3. **æ£€æŸ¥æ•°æ®åº“è¿æ¥**ï¼š
```powershell
# æ£€æŸ¥æ•°æ®åº“ URL é…ç½®
$env:BDC_DATABASE_URL
```

---

### é—®é¢˜ 4ï¼šPC-UI æ˜¾ç¤º"æ— è§’è‰²"

**ç—‡çŠ¶**ï¼šç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º"ç”¨æˆ·: admin | æ— è§’è‰²"

**åŸå› **ï¼šæ•°æ®åº“ä¸­æœªä¸ºç”¨æˆ·åˆ†é…è§’è‰²

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œè„šæœ¬
python scripts/assign_admin_roles.py
```

---

## ğŸ“Š æœ¬æ¬¡éƒ¨ç½²æ›´æ–°å†…å®¹

### æ–°å¢åŠŸèƒ½

1. **å‰ç«¯æƒé™æ§åˆ¶**
   - æ˜¾ç¤ºç”¨æˆ·åå’Œè§’è‰²ä¿¡æ¯
   - æ ¹æ®æƒé™æ˜¾ç¤º/éšè—æŒ‰é’®
   - æ”¯æŒè¶…çº§ç®¡ç†å‘˜ã€è§’è‰²ã€æƒé™ä¸‰çº§æ§åˆ¶

2. **å¢å¼ºçš„è®¤è¯ç®¡ç†**
   - ç”¨æˆ·è¯¦ç»†ä¿¡æ¯è·å–ï¼ˆ`/auth/me`ï¼‰
   - æƒé™æ£€æŸ¥æ–¹æ³•
   - è§’è‰²æ£€æŸ¥æ–¹æ³•

3. **æµ‹è¯•å·¥å…·**
   - æƒé™æ£€æŸ¥æµ‹è¯•è„šæœ¬
   - è¯¦ç»†çš„æµ‹è¯•æ–‡æ¡£

### ä¿®æ”¹çš„æ–‡ä»¶

- `desktop/nicegui_app/auth_manager.py` - å¢å¼ºæƒé™æ£€æŸ¥åŠŸèƒ½
- `desktop/nicegui_app/pc_app.py` - æ·»åŠ æƒé™æ§åˆ¶ UI
- `scripts/æµ‹è¯•/test_permission_check.py` - æ–°å¢
- `scripts/æµ‹è¯•/test_permission_control.md` - æ–°å¢

### é…ç½®å˜æ›´

- **ç¯å¢ƒå˜é‡**ï¼š`BDC_API_URL`ï¼ˆå¯é€‰ï¼Œé»˜è®¤ `http://127.0.0.1:8000/api/v1`ï¼‰
- **ä¾èµ–**ï¼šæ— æ–°å¢ä¾èµ–

---

## ğŸ¯ éƒ¨ç½²åä¸‹ä¸€æ­¥

### ç«‹å³æµ‹è¯•

1. åœ¨å®¢æˆ·ç«¯è¿è¡Œæƒé™æµ‹è¯•è„šæœ¬ï¼š
```powershell
python scripts/æµ‹è¯•/test_permission_check.py
```

2. åœ¨æµè§ˆå™¨ä¸­æµ‹è¯• UIï¼š
- è®¿é—® http://localhost:8080
- ç™»å½• admin/admin123
- æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯å’ŒæŒ‰é’®æ˜¾ç¤º

### åç»­å·¥ä½œ

- [ ] ä»»åŠ¡ #5ï¼šç§»åŠ¨ç«¯è®¤è¯æ•´åˆï¼ˆFlutterï¼‰
- [ ] åˆ›å»ºä¸åŒæƒé™çš„æµ‹è¯•ç”¨æˆ·
- [ ] ç¼–å†™ç”¨æˆ·ä½¿ç”¨æ–‡æ¡£
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–

---

**æ–‡æ¡£ç»´æŠ¤**ï¼šBDC-AI å¼€å‘å›¢é˜Ÿ
**åˆ›å»ºæ—¶é—´**ï¼š2026-01-26
**é€‚ç”¨ç‰ˆæœ¬**ï¼šv0.3.8+
