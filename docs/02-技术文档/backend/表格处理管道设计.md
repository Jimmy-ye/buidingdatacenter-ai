# 表格流水线设计（V1）

## 1. 目标与范围

本设计文档定义 **表格类 Asset（能耗表 / 运行表）** 的 V1 处理流水线。总体原则：

- 以 **规则 + 配置 + 代码** 为主，可测试、可回放
- 将 **大模型能力封装为可选“解释器/助手”层**，不直接改动底层数据
- 所有表格最终都标准化为 **时序数据**，与工程结构（Building/System/Zone/Device）打通

V1 重点实现：

- 能耗表流水线：`数据规范 → 数据清洗 → 电表功能分项匹配 → 分项能耗统计分析 → 绘图输出`  
- 运行表：只做基础设计占位，后续单独细化（特别是“稳定运行时间段”识别）

---

## 2. 基础数据模型假设

### 2.1 现有资产层

- `assets` 表：存储文件级别 Asset（包括表格文件）
  - 关键字段：`id, project_id, building_id, zone_id, system_id, device_id, modality="table", source, content_role, file_id, capture_time`
- `asset_structured_payloads` 表：结构化结果
  - 用于记录表格解析配置、质量报告、统计摘要等

V1 中新增/约定：

- `schema_type`：
  - `energy_table_v1`：能耗表（电表、热表、水表等）
  - `runtime_table_v1`：设备运行/工况记录表

### 2.2 时序数据层（建议 TimescaleDB）

统一将表格行写入时序表：

```sql
-- 原始读数明细
CREATE TABLE energy_readings (
    id              uuid PRIMARY KEY,
    project_id      uuid NOT NULL,
    meter_id        uuid NOT NULL,        -- 关联电表主数据
    ts              timestamptz NOT NULL, -- 读数时间
    value           double precision NOT NULL,
    value_type      text NOT NULL,        -- 'cumulative' | 'interval'
    unit            text NOT NULL,        -- kWh, kW, m3 等
    source_asset_id uuid NOT NULL,        -- 溯源到哪份表格
    quality_flag    text NULL             -- 'ok' | 'missing' | 'estimated' | 'outlier'
);

-- 功能/分项维度聚合表（可按需预聚合）
CREATE TABLE energy_agg_daily (
    project_id      uuid NOT NULL,
    meter_function  text NOT NULL,        -- 如 'hvac', 'lighting', 'it_room'
    day             date NOT NULL,
    energy_kwh      double precision NOT NULL,
    PRIMARY KEY (project_id, meter_function, day)
);
```

> 实际实现时可用 TimescaleDB hypertable + continuous aggregates 优化。

### 2.3 电表主数据与功能分项

新增或约定：

```sql
CREATE TABLE meters (
    id              uuid PRIMARY KEY,
    project_id      uuid NOT NULL,
    meter_code      text NOT NULL,    -- 与表格中列/行的标识对应
    name            text,
    level           text,             -- main / sub / tenant / virtual
    energy_type     text,             -- electricity / chilled_water / hot_water
    function_tags   text[]            -- ['hvac', 'lighting', 'it_room']
);
```

- 通过 `function_tags` 实现 **电表功能分项匹配**
- 后续可支持一表多标签（如一个电表既供 HVAC 又供通风），按权重分摊

---

## 3. 能耗表流水线（V1 详细）

### 3.1 总体流程

以 `upload_table_asset` 为入口，能耗表的处理链路：

1. **资产入库**：
   - 用户上传表格文件 → 创建 `Asset(modality="table", content_role="energy_table")`
2. **数据规范（标准化）**：
   - 解析 Excel/CSV → pandas DataFrame
   - 识别时间列、读数列、电表标识列 → 转成统一中间结构
3. **数据清洗**：
   - 时间规范化（时区、格式）
   - 去重、缺失值处理、异常值检测
4. **电表功能分项匹配**：
   - 将每条读数关联到 `meter_id`，并通过 `meters.function_tags` 得到功能分项
5. **分项能耗统计分析**：
   - 按天/周/月 & 分项聚合能耗
   - 写入 `energy_agg_daily` 或等价视图
6. **绘图输出（接口层）**：
   - 提供 API 返回适合前端绘图的序列数据
   - 可选：在 Notebook / 报表中用 matplotlib/seaborn 渲染图像

### 3.2 数据规范（标准化）

#### 3.2.1 列角色识别

- 时间列（必选）：通过列名/样例匹配：
  - 关键词：`time, timestamp, datetime, 日期, 时间`
- 电表列：
  - 可能在：
    - 行：一行一个电表，多列为不同时间
    - 列：一列一个电表
  - V1 限制：
    - **优先支持“每行一个时间点，多列为不同电表读数”的纵向表结构**
- 数值列：
  - 列名中包含 `kWh, active_energy, 电量` 等

#### 3.2.2 项目级映射配置（必需）

每个项目维护一份 JSON 配置，示例：

```json
{
  "schema_type": "energy_table_v1",
  "time_column": "记录时间",
  "value_columns": [
    {"column": "CH-01_kWh", "meter_code": "CH-01", "unit": "kWh", "value_type": "cumulative"},
    {"column": "LGT-1_kWh", "meter_code": "LGT-1", "unit": "kWh", "value_type": "interval"}
  ],
  "timezone": "Asia/Shanghai"
}
```

流程：

1. 先尝试自动推断 → 提示工程师确认 / 编辑配置
2. 确认后的配置写入 `AssetStructuredPayload(schema_type="energy_table_v1")`
3. 后续同类表格可直接复用该配置

### 3.3 数据清洗

典型规则：

- **时间轴**：
  - 统一转换为 `UTC` 存库，保留原始时区信息
  - 去除明显错误时间（如未来时间、过旧时间）
- **缺失值**：
  - 缺行：按项目策略标记 `quality_flag='missing'`，不强行插值
  - 多个读数重叠：保留最新或平均（配置驱动）
- **异常值检测**：
  - 规则 1：相邻累计读数差为负 → 标记为 `outlier`
  - 规则 2：单时段增量超出正常上限（例如 > 合理最大负荷 × 时长）
  - 规则 3：连续零值但设备被标记为“常开” → 告警

所有清洗操作要可追踪：

- 在 `energy_readings.quality_flag` 标记
- 在 `AssetStructuredPayload` 中追加“质量报告”摘要

### 3.4 电表功能分项匹配

核心目标：**把电表读数映射到“功能分项”维度**，如：

- `hvac`（暖通空调）
- `lighting`（照明）
- `it_room`（机房 IT 设备）
- `lift`（电梯）等

流程：

1. 基于配置/主数据将 `meter_code` → `meter_id`
2. 从 `meters.function_tags` 拿到一个或多个功能标签
3. 写入 `energy_readings` 时附带 `meter_id`，功能分项在聚合阶段使用

> V1 可先支持“一表一分项”，V2 再扩展为“多分项+权重分摊”。

### 3.5 分项能耗统计分析

以日维度为例：

1. 根据 `value_type` 统一转换为区间能耗：
   - `cumulative`：按同一电表 `ts` 排序，使用差分获得每个区间的 kWh
   - `interval`：直接按时段汇总
2. 按需聚合：
   - 维度：`project_id, meter_function, day`
   - 指标：`sum(energy_kwh)`
3. 将结果写入 `energy_agg_daily` 或使用视图/连续聚合

### 3.6 绘图接口设计

后端主要提供**数据接口**，前端负责可视化。典型 API：

```http
GET /api/v1/projects/{project_id}/energy/agg
  ?group_by=function&bucket=day
  &start=2025-01-01&end=2025-01-31
```

返回：

```json
{
  "bucket": "day",
  "series": [
    {
      "name": "hvac",
      "points": [
        {"ts": "2025-01-01", "value": 1234.5},
        {"ts": "2025-01-02", "value": 1100.2}
      ]
    },
    {
      "name": "lighting",
      "points": [ ... ]
    }
  ]
}
```

前端自由选择折线图、堆叠柱状图等展示。

---

## 4. 运行表流水线（预留设计）

运行表同样是时序数据，但关注点是：

- 设备开/关状态、负荷水平
- 故障/告警事件
- **稳定运行时间段的识别**（后续分析 COP、效率等）

V1 先约定：

- `runtime_table_v1` 中，将原始行标准化为：

```sql
CREATE TABLE runtime_events (
    id              uuid PRIMARY KEY,
    project_id      uuid NOT NULL,
    device_id       uuid NOT NULL,
    ts              timestamptz NOT NULL,
    state           text NOT NULL,  -- on/off/fault/standby 等
    load_ratio      double precision NULL, -- 0~1
    source_asset_id uuid NOT NULL
);
```

- “稳定运行时间段”的识别规则（暂定）：
  - `state='on'` 且连续时间 ≥ N 分钟
  - `load_ratio` 在某个区间内波动较小（例如 0.6~0.9 且方差较低）

后续针对运行表再写一份专门的设计文档，细化：

- 稳定段抽取算法
- 与能耗数据联动（如：在稳定段内计算 COP）

---

## 5. 实施优先级（V1）

1. **数据模型落地**：
   - `energy_readings` / `energy_agg_daily` / `meters` 表
   - `schema_type=energy_table_v1` 的 `AssetStructuredPayload` 结构
2. **能耗表解析服务**：
   - pandas 解析 + 项目级配置
   - 写入 `energy_readings`
3. **清洗与分项聚合**：
   - 质量标记 + 日/周/月分项能耗聚合
4. **查询与绘图接口**：
   - 提供 `project_id` 维度的分项能耗 API
5. **运行表占位实现**：
   - `runtime_events` 基础表结构 + 简单入库逻辑

在 V1 稳定后，再引入大模型做：

- 自动推断/推荐表格列映射配置
- 生成数据质量报告、诊断提示
- 对话式能耗分析（调已有 API 作为“Tools/Skills”）

## 6. ELE 技术经验整合与集成方案（V2 草案）

### 6.1 与 ELE Skills 的功能对照

- **ele-data-processor**
  - 阶段 1：规范化（编码识别、时间/电表列识别、宽表转长表、累计读数差分并删除差分负值、基础质检），对应本方案中的 `3.2 数据规范（标准化）+ 部分 3.3 清洗`。
  - 阶段 2：设备特征识别（季节性、变频、活跃时段），补充了本 V1 文档尚未展开的“设备用能画像”层，可作为后续清洗与诊断的上下文。
  - 阶段 3：智能清洗（IQR 方法、按设备特征分组清洗 + 激进/保守策略 + 质量校验），可替代当前 `3.3 数据清洗` 中“规则 1~3”的部分实现细节，统一为更稳健的异常检测与修复框架。
  - 产物：
    - 清洗后的规范长表：`meter_name, timestamp, reading`，可直接映射为 `energy_readings` 的源数据；
    - `equipment_features.csv`：每个电表的季节性/变频/活跃时段标签，可扩展为 `meters` 的特征字段或独立特征表；
    - `processing_report.md`：完整处理报告，可记入 `asset_structured_payloads` 作为质量报告与审计日志。

- **ele-zone-usage**
  - 入口假设：已存在 `meter_name, timestamp, reading` 的规范长表（可由 ele-data-processor 或等价服务提供）。
  - 引入一张“电表名 ↔ 功能分区”的原始表（来自设计说明/字典表），并通过 `subitem_zone_mapper.py + subitem_zone_rules.csv` 将自由文本标准化为一套**统一的分区/分项分类体系**（参考 `.claude/reference/ele_zone_mapping_rules.md`）。
  - 在“电表 → 标准功能分区”映射完成后，按多层分区模型与不同时间粒度汇总用电量，并生成长表/宽表报表与 UNMAPPED 清单，用于后续补齐映射。
  - 对应本方案中的 `3.4 电表功能分项匹配 + 3.5 分项能耗统计分析`，同时提供了：
    - 一套可版本管理的**分项/分区标准词表**；
    - 一套“原始分项文本 → 标准标签”的规则化映射流程；
    - 一套“时间粒度 × 分区（× 细分）”的长/宽表输出规范，便于前端和离线分析直接复用。

### 6.2 集大成且闭环较短的实施方案

在保持本文件第 2 章数据模型不变的前提下，推荐采用以下“短路径闭环”作为 V2 集成方案：

1. **入口与资产入库（保持不变）**  
   - 仍以 `upload_table_asset` 为入口，创建 `Asset(modality="table", schema_type="energy_table_v1")`，并在 `asset_structured_payloads` 中预留：
     - `table_process_plan`：表类型、读数语义（累计/区间）、推荐清洗策略等；
     - `table_processing_report`：后续由数据处理服务与大模型共同写入的处理报告。

2. **规范化 + 清洗：落地 ele-data-processor 思路**  
   - 在后端实现一个统一的电表数据处理服务（概念等价于 `process_electricity_data`）：
     - 阶段 1：按 `3.2 数据规范` + ele-data-processor 的规范化规则，将原始表格解析为标准长表；
     - 阶段 2：按 ele-data-processor 识别季节性/变频/活跃时段等设备特征，并输出特征表；
     - 阶段 3：按设备特征选择合适的清洗策略（激进/保守），使用 IQR 等方法标记/修正异常，并进行质量断言（无负值、总量区间等）。
   - 输出：
     - 清洗后的长表 → 写入 `energy_readings`（同时填充 `quality_flag`）；
     - 设备特征表 → 写入 `meters` 扩展字段或独立 `meter_features` 表；
     - 处理报告 → 写入 `asset_structured_payloads(table_processing_report)`。

3. **电表功能分项与分区标准化：借鉴 ele-zone-usage 的规则表模式**  
   - 增加两层结构：
     - 原始分项表：记录从设计说明/字典表导入的“电表名 ↔ 功能分区文本”；
     - 标准化映射表：通过规则表（类似 `subitem_zone_rules.csv`）和脚本/服务将原始文本映射到项目统一的“分项/分区标准词表”。
   - 结合第 2.3 节 `meters.function_tags`：
     - 经规则 + 人工确认后的标准化结果，写入 `meters.function_tags` 或独立 `meter_zone_mapping` 表；
     - 保留 UNMAPPED/低置信度记录列表，支持后续人工或大模型辅助补全.

4. **分项/分区能耗汇总与报表输出**  
   - 在 `energy_readings` 与标准化后的电表分项映射 join 之后：
     - 按 `project_id, meter_function(or zone_code), day` 等维度聚合，写入 `energy_agg_daily`；
     - 参考 ele-zone-usage 的长表/宽表设计，对外提供：
       - “时间粒度 × 分区”长表（便于进一步聚合/联表）；
       - 日/周/月 × 分区宽表（便于前端绘图与导出 Excel）。

5. **大模型的角色（保持为“决策 + 解释层”）**  
   - 不直接改动 `energy_readings`/`energy_agg_daily` 等底层数据，只参与：
     - 推断表格类型、读数语义与推荐清洗策略（生成 `table_process_plan`）；
     - 基于处理报告与聚合结果，生成自然语言解释与诊断建议；
     - 为未映射电表给出候选分项/分区（标记为建议，需人工确认后才写入规则/映射表）。

整体上，这条方案将 ele-data-processor 的“规范化+特征+智能清洗”和 ele-zone-usage 的“规则驱动分项标准化+分区汇总”完整嫁接到本项目既有的数据模型上，形成从“原始能耗表 → 标准时序 → 功能分项 → 分区报表”的闭环。

### 6.3 分阶段实施计划（建议）

为兼顾落地风险与收益，建议按以下阶段推进：

- **P0：最小闭环（以单项目能耗表为主）**  
  - 落地第 2 章的数据模型（`energy_readings`/`energy_agg_daily`/`meters`）与 `schema_type=energy_table_v1` 的 `asset_structured_payloads` 结构；
  - 在后端实现“规范化 + 基础清洗”的最小版服务：
    - 支持编码识别、列识别、宽表转长表、累计读数差分 + 删除差分负值、重复键处理；
    - 暂不实现设备特征识别，只做基础异常标记；
  - 从现有 ele-zone-usage 经验中抽一版简化的分项/分区规则表，完成一个试点项目的分项报表与 API 输出。

- **P1：引入设备特征与规则化分项标准化**  
  - 将 ele-data-processor 的阶段 2/3 引入后端：
    - 对主要电表实现季节性/变频/活跃时段特征识别；
    - 按设备特征分组应用 IQR 等稳健方法进行智能清洗，支持激进/保守策略；
  - 设计并实现“原始分项表 + 标准化规则表 + meter_zone_mapping 草稿/补丁”的处理流程：
    - 规则表可持续迭代；
    - 未匹配/低置信度记录形成 TODO 列表，用于人工/大模型辅助补齐；
  - 将 `energy_agg_daily` 与前端分项报表对齐，支持日/周/月及多层分区维度查询.

- **P2：大模型辅助与对话式分析（可选）**  
  - 增加大模型辅助接口，用于：
    - 自动推断 `table_process_plan`（表类型、读数语义、推荐清洗策略）；
    - 对处理报告与分项报表生成面向运维/节能分析的自然语言解读；
    - 对未映射电表提供 `suggest_zone`/`suggest_function_tags` 作为规则表迭代依据；
  - 视整体工程成熟度，再评估是否需要对外抽象为统一的工具/协议层（如 MCP/内部 Agent），本方案本身不依赖该层即可运行.
