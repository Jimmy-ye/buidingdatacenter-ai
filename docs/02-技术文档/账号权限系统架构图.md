# BDC-AI 账号权限管理系统 - 架构图

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端层                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐              ┌──────────────┐                │
│  │   移动端     │              │   PC 端      │                │
│  │   (Flutter)  │              │  (NiceGUI)   │                │
│  │              │              │              │                │
│  │ - 登录页面   │              │ - 登录页面   │                │
│  │ - Token 存储 │              │ - 会话管理   │                │
│  │ - 自动刷新   │              │ - 权限控制   │                │
│  └──────────────┘              └──────────────┘                │
│         │                              │                        │
│         │ HTTP/HTTPS                  │                        │
│         └──────────────┬───────────────┘                        │
│                        │                                        │
└────────────────────────┼────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                         API 层                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────┐            │
│  │          FastAPI 路由                           │            │
│  ├────────────────────────────────────────────────┤            │
│  │  POST   /api/v1/auth/login      (登录)         │            │
│  │  POST   /api/v1/auth/refresh    (刷新令牌)     │            │
│  │  GET    /api/v1/auth/me         (当前用户)     │            │
│  │  POST   /api/v1/auth/logout     (注销)         │            │
│  │  GET    /api/v1/auth/users      (用户列表)     │            │
│  │  POST   /api/v1/auth/users      (创建用户)     │            │
│  │  PUT    /api/v1/auth/users/{id} (更新用户)     │            │
│  │  DELETE /api/v1/auth/users/{id} (删除用户)     │            │
│  │  GET    /api/v1/auth/roles      (角色列表)     │            │
│  │  GET    /api/v1/auth/permissions (权限列表)    │            │
│  │  GET    /api/v1/auth/audit-logs (审计日志)     │            │
│  └────────────────────────────────────────────────┘            │
│                        │                                        │
│                        ▼                                        │
│  ┌────────────────────────────────────────────────┐            │
│  │         安全中间件                              │            │
│  ├────────────────────────────────────────────────┤            │
│  │  - JWT Token 验证                              │            │
│  │  - 权限检查                                    │            │
│  │  - 用户认证                                    │            │
│  │  - 审计日志记录                                │            │
│  └────────────────────────────────────────────────┘            │
│                        │                                        │
└────────────────────────┼────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                       业务逻辑层                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────┐            │
│  │        AuthService                             │            │
│  ├────────────────────────────────────────────────┤            │
│  │  - authenticate_user()    (验证用户)           │            │
│  │  - login()                (登录)               │            │
│  │  - refresh_token()        (刷新令牌)           │            │
│  │  - create_user()          (创建用户)           │            │
│  │  - update_user()          (更新用户)           │            │
│  │  - delete_user()          (删除用户)           │            │
│  │  - change_password()      (修改密码)           │            │
│  │  - get_user_permissions() (获取权限)           │            │
│  │  - create_audit_log()     (审计日志)           │            │
│  └────────────────────────────────────────────────┘            │
│                        │                                        │
│                        ▼                                        │
│  ┌────────────────────────────────────────────────┐            │
│  │      安全工具                                   │            │
│  ├────────────────────────────────────────────────┤            │
│  │  - password.py    (密码加密/验证)               │            │
│  │  - jwt.py         (JWT 生成/验证)               │            │
│  │  - dependencies.py (FastAPI 依赖注入)           │            │
│  └────────────────────────────────────────────────┘            │
│                        │                                        │
└────────────────────────┼────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                      数据层（SQLAlchemy ORM）                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌──────────────┐           │
│  │    User     │──│ UserRole    │──│    Role      │           │
│  │   (用户)    │  │ (用户-角色) │  │   (角色)     │           │
│  └─────────────┘  └─────────────┘  └──────────────┘           │
│         │                                  │                    │
│         │                                  │                    │
│         ▼                                  ▼                    │
│  ┌─────────────┐                  ┌──────────────┐            │
│  │ProjectMember│                  │RolePermission│            │
│  │(项目成员)   │                  │ (角色-权限)  │            │
│  └─────────────┘                  └──────────────┘            │
│         │                                  │                    │
│         │                                  │                    │
│         ▼                                  ▼                    │
│  ┌─────────────┐                  ┌──────────────┐            │
│  │  Project    │                  │  Permission  │            │
│  │  (项目)     │                  │   (权限)     │            │
│  └─────────────┘                  └──────────────┘            │
│                                                                 │
│  ┌─────────────┐                                             │
│  │  AuditLog   │                                             │
│  │ (审计日志)  │                                             │
│  └─────────────┘                                             │
└─────────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    PostgreSQL 数据库                             │
└─────────────────────────────────────────────────────────────────┘
```

## 认证流程图

```
┌─────────┐                 ┌─────────┐                 ┌──────────┐
│  客户端  │                 │ API层   │                 │ 数据库   │
└────┬────┘                 └────┬────┘                 └────┬─────┘
     │                           │                           │
     │ POST /login               │                           │
     │ {username, password}      │                           │
     ├──────────────────────────>│                           │
     │                           │                           │
     │                           │ 查询用户                   │
     │                           ├──────────────────────────>│
     │                           │                           │
     │                           │ 返回用户信息               │
     │                           │<──────────────────────────┤
     │                           │                           │
     │                           │ 验证密码                   │
     │                           │ (bcrypt.compare)          │
     │                           │                           │
     │                           │ 生成 JWT Token            │
     │                           │ - access_token (30min)    │
     │                           │ - refresh_token (7days)   │
     │                           │                           │
     │                           │ 记录审计日志               │
     │                           ├──────────────────────────>│
     │                           │                           │
     │ {access_token,            │                           │
     │  refresh_token}           │                           │
     │<──────────────────────────┤                           │
     │                           │                           │
     │ 存储 Token                │                           │
     │                           │                           │
     ▼                           ▼                           ▼
```

## 权限检查流程图

```
┌─────────┐                 ┌─────────┐                 ┌──────────┐
│  客户端  │                 │ API层   │                 │ 数据库   │
└────┬────┘                 └────┬────┘                 └────┬─────┘
     │                           │                           │
     │ GET /api/v1/projects       │                           │
     │ Authorization: Bearer xxx  │                           │
     ├──────────────────────────>│                           │
     │                           │                           │
     │                           │ 验证 JWT Token             │
     │                           │ - 解码 Token               │
     │                           │ - 检查过期时间             │
     │                           │ - 提取 user_id             │
     │                           │                           │
     │                           │ 查询用户                   │
     │                           ├──────────────────────────>│
     │                           │                           │
     │                           │ 返回用户+角色              │
     │                           │<──────────────────────────┤
     │                           │                           │
     │                           │ 检查权限                   │
     │                           │ - is_superuser?           │
     │                           │ - 角色权限匹配?           │
     │                           │                           │
     │                           │ 记录审计日志               │
     │                           ├──────────────────────────>│
     │                           │                           │
     │ 权限允许/拒绝               │                           │
     │<──────────────────────────┤                           │
     │                           │                           │
     │ 200 OK / 403 Forbidden     │                           │
     │                           │                           │
     ▼                           ▼                           ▼
```

## Token 刷新流程（移动端自动）

```
┌─────────┐                 ┌─────────┐                 ┌──────────┐
│  客户端  │                 │ API层   │                 │ 数据库   │
└────┬────┘                 └────┬────┘                 └────┬─────┘
     │                           │                           │
     │ GET /api/v1/projects       │                           │
     │ Authorization: Bearer xxx  │                           │
     ├──────────────────────────>│                           │
     │                           │                           │
     │ 401 Unauthorized           │                           │
     │<──────────────────────────┤                           │
     │                           │                           │
     │ 检测到 401 错误            │                           │
     │ 触发 Token 刷新            │                           │
     │                           │                           │
     │ POST /auth/refresh         │                           │
     │ {refresh_token}            │                           │
     ├──────────────────────────>│                           │
     │                           │ 验证 refresh_token         │
     │                           │                           │
     │                           │ 生成新 Token               │
     │                           │                           │
     │ {access_token,            │                           │
     │  refresh_token}           │                           │
     │<──────────────────────────┤                           │
     │                           │                           │
     │ 更新存储的 Token           │                           │
     │ 重试原请求                 │                           │
     │                           │                           │
     │ GET /api/v1/projects       │                           │
     │ Authorization: Bearer new  │                           │
     ├──────────────────────────>│                           │
     │                           │                           │
     │ 200 OK                    │                           │
     │<──────────────────────────┤                           │
     │                           │                           │
     ▼                           ▼                           ▼
```

## RBAC 权限模型

```
┌─────────────────────────────────────────────────────────────┐
│                        角色 (Role)                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐           │
│  │ superuser  │  │   admin    │  │   manager  │           │
│  │ (100级)    │  │  (80级)    │  │  (60级)    │           │
│  └────────────┘  └────────────┘  └────────────┘           │
│         │                │                │                 │
│         └────────────────┼────────────────┘                 │
│                          │                                  │
│                          ▼                                  │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐           │
│  │  analyst   │  │  engineer  │  │  viewer    │           │
│  │  (50级)    │  │  (40级)    │  │  (20级)    │           │
│  └────────────┘  └────────────┘  └────────────┘           │
│                          │                                  │
│                          ▼                                  │
│  ┌───────────────────────────────────────┐                 │
│  │           权限 (Permission)            │                 │
│  ├───────────────────────────────────────┤                 │
│  │  projects.read, projects.create       │                 │
│  │  assets.read, assets.upload           │                 │
│  │  users.read, users.admin              │                 │
│  │  reports.read, reports.export         │                 │
│  │  system.config, system.monitor        │                 │
│  └───────────────────────────────────────┘                 │
│                          │                                  │
│                          ▼                                  │
│  ┌───────────────────────────────────────┐                 │
│  │           用户 (User)                 │                 │
│  ├───────────────────────────────────────┤                 │
│  │  User ──> UserRole ──> Role           │                 │
│  │                    │                  │                 │
│  │                    └──> Permission     │                 │
│  └───────────────────────────────────────┘                 │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## 数据库关系图

```
┌─────────────────┐
│     User        │
├─────────────────┤
│ id (PK)         │───┐
│ username        │   │
│ email           │   │
│ hashed_password │   │
│ is_active       │   │
│ is_superuser    │   │
└─────────────────┘   │
                      │
                      │    ┌─────────────────┐
                      │    │    UserRole     │
                      │    ├─────────────────┤
                      ├───│ user_id (FK)    │
                      │    │ role_id (FK)    │
                      │    └─────────────────┘
                      │             │
                      │             │
                      │    ┌────────▼────────┐
                      │    │     Role        │
                      │    ├─────────────────┤
                      │    │ id (PK)         │───┐
                      │    │ name            │   │
                      │    │ display_name    │   │
                      │    │ level           │   │
                      │    └─────────────────┘   │
                      │                          │
                      │    ┌─────────────────┐   │
                      │    │ RolePermission  │   │
                      │    ├─────────────────┤   │
                      │    │ role_id (FK)    │───┘
                      │    │ permission_id   │───┐
                      │    └─────────────────┘   │
                      │                          │
                      │    ┌─────────────────┐   │
                      │    │  Permission     │   │
                      │    ├─────────────────┤   │
                      │    │ id (PK)         │◄──┘
                      │    │ code            │
                      │    │ resource        │
                      │    │ action          │
                      │    └─────────────────┘
                      │
                      │    ┌─────────────────┐
                      │    │  AuditLog       │
                      │    ├─────────────────┤
                      └────│ user_id (FK)    │
                           │ action          │
                           │ resource_type   │
                           │ details (JSONB) │
                           │ ip_address      │
                           │ created_at      │
                           └─────────────────┘

┌─────────────────┐
│   Project       │
├─────────────────┤
│ id (PK)         │───┐
│ name            │   │
│ ...             │   │
└─────────────────┘   │
                      │
                      │    ┌─────────────────┐
                      │    │ ProjectMember   │
                      │    ├─────────────────┤
                      └────│ project_id (FK) │
                           │ user_id (FK)    │
                           │ role_in_project │
                           └─────────────────┘
```

## 安全架构

```
┌────────────────────────────────────────────────────────────┐
│                    安全层次结构                             │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌──────────────────────────────────────────────┐        │
│  │  1. 传输层安全                                 │        │
│  │  - HTTPS/TLS (生产环境)                       │        │
│  │  - 证书验证                                   │        │
│  └──────────────────────────────────────────────┘        │
│                      ▼                                    │
│  ┌──────────────────────────────────────────────┐        │
│  │  2. 认证层                                     │        │
│  │  - JWT Token 签名验证                          │        │
│  │  - Token 过期检查                              │        │
│  │  - 刷新令牌机制                                │        │
│  └──────────────────────────────────────────────┘        │
│                      ▼                                    │
│  ┌──────────────────────────────────────────────┐        │
│  │  3. 授权层                                     │        │
│  │  - RBAC 权限模型                              │        │
│  │  - API 端点权限检查                            │        │
│  │  - 项目级权限过滤                              │        │
│  └──────────────────────────────────────────────┘        │
│                      ▼                                    │
│  ┌──────────────────────────────────────────────┐        │
│  │  4. 数据层安全                                 │        │
│  │  - 密码 bcrypt 加密                            │        │
│  │  - SQL 注入防护 (ORM)                         │        │
│  │  - 敏感字段不可读取                            │        │
│  └──────────────────────────────────────────────┘        │
│                      ▼                                    │
│  ┌──────────────────────────────────────────────┐        │
│  │  5. 审计层                                     │        │
│  │  - 操作日志记录                                │        │
│  │  - IP 地址追踪                                 │        │
│  │  - 异常行为检测                                │        │
│  └──────────────────────────────────────────────┘        │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

## 部署架构

```
┌────────────────────────────────────────────────────────────┐
│                       生产环境                              │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌──────────────┐         ┌──────────────┐              │
│  │   Nginx      │         │   移动端      │              │
│  │  (反向代理)  │         │   (Flutter)   │              │
│  │  - HTTPS     │         │   - 内网穿透  │              │
│  │  - SSL 证书  │         │   - ZeroTier  │              │
│  └──────┬───────┘         └──────────────┘              │
│         │                                                    │
│         │ HTTP                                             │
│         ▼                                                   │
│  ┌──────────────┐         ┌──────────────┐              │
│  │   FastAPI    │         │   PC 端       │              │
│  │  (后端服务)  │◄────────┤  (NiceGUI)   │              │
│  │  - 认证     │         │   - 本地访问  │              │
│  │  - API      │         └──────────────┘              │
│  └──────┬───────┘                                        │
│         │                                                  │
│         ▼                                                  │
│  ┌──────────────┐         ┌──────────────┐              │
│  │ PostgreSQL   │         │    Redis     │              │
│  │  (主数据库)  │         │ (可选-缓存)  │              │
│  │  - 用户数据  │         │  - Token黑名单│              │
│  │  - 审计日志  │         └──────────────┘              │
│  └──────────────┘                                        │
│         │                                                  │
│         ▼                                                  │
│  ┌──────────────┐                                        │
│  │   MinIO      │                                        │
│  │ (文件存储)   │                                        │
│  └──────────────┘                                        │
│                                                            │
└────────────────────────────────────────────────────────────┘
```
