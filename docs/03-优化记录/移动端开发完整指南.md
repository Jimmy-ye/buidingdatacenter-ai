# ç§»åŠ¨ç«¯å¼€å‘å®Œæ•´æŒ‡å—

**åˆ›å»ºæ—¶é—´**ï¼š2026-01-23
**Flutter ç‰ˆæœ¬**ï¼š3.38.7
**é¡¹ç›®è¿›åº¦**ï¼š98%
**ç»´æŠ¤è€…**ï¼šBDC-AI å¼€å‘å›¢é˜Ÿ

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [å·¥ç¨‹ç»“æ„](#å·¥ç¨‹ç»“æ„)
3. [æ¥å£å¯¹é½ä¸ä¿®å¤](#æ¥å£å¯¹é½ä¸ä¿®å¤)
4. [åŠŸèƒ½å®ç°è®°å½•](#åŠŸèƒ½å®ç°è®°å½•)
5. [é—®é¢˜æ’æŸ¥æŒ‡å—](#é—®é¢˜æ’æŸ¥æŒ‡å—)
6. [ç¦»çº¿ç¼“å­˜ä¸ç½‘ç»œä¼ è¾“](#ç¦»çº¿ç¼“å­˜ä¸ç½‘ç»œä¼ è¾“)
7. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

### æ•´ä½“å®Œæˆåº¦ï¼š**98%**

| ç±»åˆ« | å®Œæˆåº¦ | è¯´æ˜ |
|------|--------|------|
| **åŸºç¡€æ¶æ„** | 100% | âœ… é¡¹ç›®ç»“æ„ã€æ¨¡å‹ã€æœåŠ¡ã€Providerã€é¡µé¢ |
| **API æœåŠ¡å±‚** | 100% | âœ… é¡¹ç›®ã€å·¥ç¨‹ç»“æ„ã€èµ„äº§ API |
| **çŠ¶æ€ç®¡ç†** | 100% | âœ… Provider æ¨¡å¼ï¼Œå®Œæ•´çš„çŠ¶æ€ç®¡ç† |
| **UI é¡µé¢å±‚** | 100% | âœ… é¡¹ç›®åˆ—è¡¨ã€å·¥ç¨‹ç»“æ„æ ‘ã€èµ„äº§è§†å›¾ |
| **åŠŸèƒ½æµ‹è¯•** | 95% | â³ çœŸæœºæµ‹è¯•å¾…å®Œæˆ |

### ä»£ç ç»Ÿè®¡

- **æ€»ä»£ç è¡Œæ•°**ï¼š4,131 è¡Œï¼ˆå«æ³¨é‡Šå’Œç©ºè¡Œï¼‰
- **æœåŠ¡å±‚**ï¼š~1,181 è¡Œï¼ˆapi service 200 + project service 638 + asset service 243ï¼‰
- **çŠ¶æ€ç®¡ç†**ï¼š~822 è¡Œï¼ˆapp provider 150 + project provider 120 + structure provider 200+ + asset provider 352ï¼‰
- **UI é¡µé¢**ï¼š~2,102 è¡Œï¼ˆprojects page 286 + structure_tree page 639 + assets page 1,177ï¼‰
- **æ•°æ®æ¨¡å‹**ï¼š~500+ è¡Œ

### æ ¸å¿ƒç‰¹æ€§

âœ… **ç³»ç»Ÿçº§èµ„äº§è§†å›¾** - æ”¯æŒæŒ‰ system_id æŸ¥çœ‹èµ„äº§
âœ… **æ‰¹é‡åˆ é™¤åŠŸèƒ½** - åªèƒ½åˆ é™¤ç§»åŠ¨ç«¯ä¸Šä¼ çš„èµ„äº§
âœ… **èµ„äº§ç±»å‹é€‰æ‹©** - ç°åœºé—®é¢˜/é“­ç‰Œ/ä»ªè¡¨ä¸‰ç§ç±»å‹
âœ… **è‡ªåŠ¨è§£æé€‰é¡¹** - ä¸Šä¼ æ—¶å¯é€‰æ‹©æ˜¯å¦è‡ªåŠ¨è§£æ
âœ… **æ‹ç…§æŒ‰é’®ä¼˜åŒ–** - æ”¾å¤§è‡³ 64pxï¼Œç§»åˆ°é¡µé¢ä¸Šæ–¹
âœ… **çº¯å‰ç«¯åˆ†é¡µ** - åœ¨ AssetProvider ä¸­å®ç°æœ¬åœ°åˆ†é¡µ

---

## ğŸ—ï¸ å·¥ç¨‹ç»“æ„

### ç›®å½•ç»“æ„

```
mobile/bdc_ai_app/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ main.dart                 # åº”ç”¨å…¥å£ï¼Œè·¯ç”±é…ç½®
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ constants.dart        # API é…ç½®ï¼ŒbaseUrlï¼ˆAndroid: 10.0.2.2ï¼‰
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ project.dart          # é¡¹ç›®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ structure.dart        # Building/System/Zone/Device
â”‚   â”‚   â””â”€â”€ asset.dart            # èµ„äº§æ¨¡å‹ï¼ˆå­—æ®µå…¼å®¹ï¼‰
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ api_service.dart      # HTTP å®¢æˆ·ç«¯å°è£…
â”‚   â”‚   â”œâ”€â”€ project_service.dart  # é¡¹ç›®ä¸å·¥ç¨‹ç»“æ„ API
â”‚   â”‚   â””â”€â”€ asset_service.dart    # èµ„äº§ APIï¼ˆä¸Šä¼ /åˆ é™¤ï¼‰
â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â”œâ”€â”€ app_provider.dart     # å…¨å±€çŠ¶æ€ï¼ˆå½“å‰é¡¹ç›®ï¼‰
â”‚   â”‚   â”œâ”€â”€ project_provider.dart # é¡¹ç›®åˆ—è¡¨çŠ¶æ€
â”‚   â”‚   â”œâ”€â”€ structure_provider.dart # å·¥ç¨‹ç»“æ„æ ‘çŠ¶æ€
â”‚   â”‚   â””â”€â”€ asset_provider.dart   # èµ„äº§åˆ—è¡¨çŠ¶æ€ï¼ˆæ”¯æŒåˆ†é¡µï¼‰
â”‚   â””â”€â”€ pages/
â”‚       â”œâ”€â”€ projects_page.dart    # é¡¹ç›®åˆ—è¡¨é¡µ
â”‚       â”œâ”€â”€ structure_tree_page.dart # å·¥ç¨‹ç»“æ„æ ‘é¡µ
â”‚       â””â”€â”€ assets_page.dart      # èµ„äº§å¿«æ·è§†å›¾é¡µï¼ˆå«æ‰¹é‡åˆ é™¤ï¼‰
â””â”€â”€ pubspec.yaml                  # ä¾èµ–é…ç½®
```

### å·¥ç¨‹å±‚çº§å…³ç³»ï¼ˆé‡è¦ï¼‰

**æ­£ç¡®çš„å±‚çº§å…³ç³»**ï¼š
```
Buildingï¼ˆæ¥¼æ ‹ï¼‰
  â”œâ”€ Systemï¼ˆç³»ç»Ÿï¼‰â­ ä¸»æ ‘
  â”‚   â””â”€ Deviceï¼ˆè®¾å¤‡ï¼‰
  â””â”€ ZoneInfoï¼ˆåŒºåŸŸï¼‰â­ ä½ç½®å±æ€§
```

**æ ¸å¿ƒåŸåˆ™**ï¼š
- âœ… **System æ˜¯èµ„äº§çš„ä¸»æŒ‚æ¥ç‚¹**ï¼šé€šè¿‡ `system_id` ä¸Šä¼ /æŸ¥çœ‹èµ„äº§
- âœ… **Device æ˜¯å¯é€‰çš„ç»†åŒ–æŒ‚æ¥ç‚¹**ï¼šé€šè¿‡ `device_id` æŸ¥çœ‹å•å°è®¾å¤‡èµ„äº§
- âœ… **Zone æ˜¯ç‰©ç†ä½ç½®å±æ€§**ï¼š`device.zone` è¡¨ç¤ºè®¾å¤‡æ‰€åœ¨åŒºåŸŸ
- âŒ **Zone ä¸å†æ˜¯ System çš„çˆ¶èŠ‚ç‚¹**ï¼šZone å’Œ System æ˜¯åŒçº§å…³ç³»

**ç§»åŠ¨ç«¯æ”¯æŒ**ï¼š
- è®¾å¤‡çº§èµ„äº§è§†å›¾ï¼š`GET /api/v1/assets/?device_id={id}`
- ç³»ç»Ÿçº§èµ„äº§è§†å›¾ï¼š`GET /api/v1/assets/?system_id={id}` â­
- ä¸Šä¼ æ—¶æ”¯æŒ `device_id` æˆ– `system_id`ï¼ˆäºŒé€‰ä¸€ï¼‰

---

## ğŸ”Œ æ¥å£å¯¹é½ä¸ä¿®å¤

### é—®é¢˜ 1ï¼šå·¥ç¨‹ç»“æ„æ ‘è¿”å›æ ¼å¼ï¼ˆP0 - å·²ä¿®å¤ âœ…ï¼‰

**é—®é¢˜æè¿°**ï¼š
- åç«¯è¿”å›ï¼š`{"project_id": "...", "tree": {...}}`ï¼ˆåŒ…è£…å¯¹è±¡ï¼‰
- ç§»åŠ¨ç«¯æœŸæœ›ï¼š`List<Building>`ï¼ˆç›´æ¥åˆ—è¡¨ï¼‰

**ä¿®å¤ä»£ç **ï¼š

**æ–‡ä»¶**ï¼š`lib/services/project_service.dart`

```dart
Future<List<Building>> getStructureTree(String projectId) async {
  try {
    final response = await _api.get(ApiEndpoints.structureTree(projectId));
    final Map<String, dynamic> data = jsonDecode(response.body);

    // â­ ä» tree.children ä¸­æå– Building åˆ—è¡¨
    final Map<String, dynamic>? tree = data['tree'];
    if (tree == null) {
      debugPrint('é”™è¯¯ï¼šå“åº”ä¸­ç¼ºå°‘ tree å­—æ®µ');
      return [];
    }

    final List<dynamic> children = tree['children'] ?? [];
    debugPrint('æˆåŠŸè§£æå·¥ç¨‹ç»“æ„æ ‘ï¼š${children.length} ä¸ªæ¥¼æ ‹');

    return children
        .map((json) => Building.fromJson(json as Map<String, dynamic>))
        .toList();
  } catch (e) {
    debugPrint('è·å–å·¥ç¨‹ç»“æ„æ ‘å¤±è´¥: $e');
    rethrow;
  }
}
```

---

### é—®é¢˜ 2ï¼šAsset æ¨¡å‹å­—æ®µå¯¹é½ï¼ˆP1 - å·²ä¿®å¤ âœ…ï¼‰

**é—®é¢˜æè¿°**ï¼š
- æ—¶é—´å­—æ®µï¼šåç«¯ä½¿ç”¨ `capture_time`ï¼Œç§»åŠ¨ç«¯åªæ”¯æŒ `created_at`
- å›¾ç‰‡ URLï¼šåç«¯å¯èƒ½è¿”å› `file_path` æˆ– `download_url`

**ä¿®å¤ä»£ç **ï¼š

**æ–‡ä»¶**ï¼š`lib/models/asset.dart`

```dart
factory Asset.fromJson(Map<String, dynamic> json) {
  return Asset(
    id: json['id']?.toString() ?? '',
    title: json['title']?.toString() ?? 'æœªå‘½åèµ„äº§',
    modality: json['modality']?.toString() ?? 'unknown',
    source: json['source']?.toString() ?? 'unknown',
    contentRole: json['content_role']?.toString(),

    // â­ ä¼˜å…ˆä½¿ç”¨ capture_timeï¼Œå…¼å®¹ created_at
    createdAt: _parseDateTime(json['capture_time'] ?? json['created_at']),

    note: json['note']?.toString(),

    // â­ æ”¯æŒ raw_urlã€download_urlã€file_pathï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
    rawUrl: json['raw_url']?.toString() ??
            json['download_url']?.toString() ??
            json['file_path']?.toString(),

    deviceId: json['device_id']?.toString(),
    systemId: json['system_id']?.toString(),
    zoneId: json['zone_id']?.toString(),
    buildingId: json['building_id']?.toString(),
  );
}

/// å®‰å…¨è§£æ DateTime
static DateTime _parseDateTime(dynamic value) {
  if (value == null) {
    debugPrint('è­¦å‘Šï¼šAsset æ—¶é—´å­—æ®µä¸ºç©ºï¼Œä½¿ç”¨å½“å‰æ—¶é—´');
    return DateTime.now();
  }
  if (value is DateTime) {
    return value;
  }
  try {
    return DateTime.parse(value.toString());
  } catch (e) {
    debugPrint('è­¦å‘Šï¼šæ— æ³•è§£ææ—¶é—´ "$value"ï¼Œä½¿ç”¨å½“å‰æ—¶é—´: $e');
    return DateTime.now();
  }
}
```

---

### é—®é¢˜ 3ï¼šåˆ†é¡µå‚æ•°åï¼ˆP1 - å·²è§£å†³ âœ…ï¼‰

**é—®é¢˜æè¿°**ï¼š
- ç§»åŠ¨ç«¯ä½¿ç”¨ï¼š`limit` å’Œ `offset`
- åç«¯å¯èƒ½ä½¿ç”¨ï¼š`limit` å’Œ `skip`

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å®ç°çº¯å‰ç«¯åˆ†é¡µ
- åç«¯ `/assets/` è¿”å›å®Œæ•´åˆ—è¡¨
- åœ¨ `AssetProvider` ä¸­å®ç°æœ¬åœ°åˆ†é¡µï¼š
  - å­˜å‚¨å®Œæ•´åˆ—è¡¨åœ¨ `_allAssets`
  - é»˜è®¤åªæ˜¾ç¤ºå‰ 5 æ¡åœ¨ `_assets`
  - "æŸ¥çœ‹æ›´å¤š"æŒ‰é’®æ‰©å±•æ˜¾ç¤ºçª—å£

**å‚è€ƒå®ç°**ï¼š

**æ–‡ä»¶**ï¼š`lib/providers/asset_provider.dart`

```dart
List<Asset> _allAssets = []; // å®Œæ•´åˆ—è¡¨

Future<void> loadAssets({...}) async {
  _allAssets = result; // å­˜å‚¨å®Œæ•´åˆ—è¡¨
  _assets = _allAssets.take(limit).toList(); // åªæ˜¾ç¤ºå‰ 5 æ¡
  _hasMore = _assets.length < _allAssets.length;
}

Future<void> loadMoreAssets() async {
  final nextPage = _currentPage + 1;
  final nextEnd = min(_allAssets.length, (nextPage + 1) * _pageSize);
  _assets = _allAssets.sublist(0, nextEnd); // æœ¬åœ°æ‰©å±•
}
```

---

### é—®é¢˜ 4ï¼šä¸Šä¼ æ¥å£ç¼ºå°‘å­—æ®µï¼ˆP2 - å·²ä¿®å¤ âœ…ï¼‰

**é—®é¢˜æè¿°**ï¼š
- ç¼ºå°‘ `source='mobile'` å­—æ®µ
- æœªè€ƒè™‘ `content_role` å­—æ®µ

**ä¿®å¤ä»£ç **ï¼š

**æ–‡ä»¶**ï¼š`lib/services/asset_service.dart`

```dart
// â­ æ„å»ºç«¯ç‚¹ URLï¼ˆQuery å‚æ•°åœ¨ URLä¸­ï¼‰
var endpoint = '${ApiEndpoints.uploadImage}?project_id=$projectId&source=mobile';
if (deviceId != null && deviceId.isNotEmpty) {
  endpoint += '&device_id=$deviceId';
}
if (systemId != null && systemId.isNotEmpty) {
  endpoint += '&system_id=$systemId';
}
if (contentRole != null && contentRole.isNotEmpty) {
  endpoint += '&content_role=$contentRole';
}
endpoint += '&auto_route=${autoRoute ? "true" : "false"}';

// â­ è¡¨å•å­—æ®µåªä¿ç•™ noteï¼ˆForm å‚æ•°ï¼‰
final fields = <String, String>{
  if (note != null && note.isNotEmpty) 'note': note,
};
```

---

### é—®é¢˜ 5ï¼šå‚æ•°ä½ç½®é”™è¯¯å¯¼è‡´ HTTP 422ï¼ˆP0 - å·²ä¿®å¤ âœ…ï¼‰

**é—®é¢˜æè¿°**ï¼š
- åç«¯æœŸæœ›ï¼š`project_id`, `source`, `device_id`, `system_id`, `content_role`, `auto_route` ä½œä¸º **Query å‚æ•°**
- ç§»åŠ¨ç«¯å‘é€ï¼šæ‰€æœ‰å‚æ•°ä½œä¸º **Form å­—æ®µ**
- å¯¼è‡´ 422 Unprocessable Entity é”™è¯¯

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- Query å‚æ•°æ‹¼æ¥åˆ° URL ä¸­
- Form å­—æ®µåªä¿ç•™ `note` å’Œ `title`
- å‚è€ƒ PC å®¢æˆ·ç«¯å®ç°æ–¹å¼

**ç”¨æˆ·åé¦ˆ**ï¼šâœ… "ä¸Šä¼ æˆåŠŸäº†ï¼"

---

## âœ¨ åŠŸèƒ½å®ç°è®°å½•

### 1. æ‰¹é‡åˆ é™¤åŠŸèƒ½ â­

**åŠŸèƒ½æè¿°**ï¼š
- æ”¯æŒé€‰æ‹©æ¨¡å¼ï¼ˆå•é€‰/å¤šé€‰ï¼‰
- åªèƒ½åˆ é™¤ç§»åŠ¨ç«¯ä¸Šä¼ çš„èµ„äº§ï¼ˆ`source='mobile'`ï¼‰
- é mobile æ¥æºæ˜¾ç¤º"ä¸å¯åˆ é™¤"æ ‡è®°
- åˆ é™¤å‰å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
- æ˜¾ç¤ºåˆ é™¤ç»“æœï¼ˆæˆåŠŸæ•°é‡ã€å¤±è´¥åˆ—è¡¨ï¼‰

**å®ç°æ–‡ä»¶**ï¼š
- `lib/pages/assets_page.dart` - UI å±‚
- `lib/providers/asset_provider.dart` - ä¸šåŠ¡é€»è¾‘
- `lib/services/asset_service.dart` - API è°ƒç”¨

**æ ¸å¿ƒä»£ç **ï¼š

**é€‰æ‹©æ¨¡å¼çŠ¶æ€**ï¼š
```dart
bool _selectionMode = false; // â­ é€‰æ‹©æ¨¡å¼
final Set<String> _selectedAssetIds = {}; // â­ å·²é€‰æ‹©çš„èµ„äº§ID
```

**æ‰¹é‡åˆ é™¤**ï¼š
```dart
Future<void> _deleteSelectedAssets() async {
  if (_selectedAssetIds.isEmpty) return;

  // ç¡®è®¤å¯¹è¯æ¡†
  final confirmed = await showDialog<bool>(...);
  if (confirmed != true) return;

  // æ‰§è¡Œåˆ é™¤
  final provider = context.read<AssetProvider>();
  final selectedAssets = provider.assets
      .where((a) => _selectedAssetIds.contains(a.id))
      .toList();

  final result = await provider.deleteAssets(selectedAssets);

  // æ˜¾ç¤ºç»“æœ
  if (mounted) {
    ScaffoldMessenger.of(context).showSnackBar(SnackBar(
      content: Text('åˆ é™¤æˆåŠŸï¼š${result['successCount']} ä¸ª'
          '${result['failedIds'].isNotEmpty ? 'ï¼Œå¤±è´¥ï¼š${result['failedIds'].length} ä¸ª' : ''}'),
    ));
  }

  _exitSelectionMode();
}
```

---

### 2. èµ„äº§ç±»å‹é€‰æ‹©åŠŸèƒ½ â­

**åŠŸèƒ½æè¿°**ï¼š
- ä¸Šä¼ æ—¶é€‰æ‹©èµ„äº§ç±»å‹ï¼ˆå¯¹åº”ä¸åŒ AI å¤„ç†ç®¡çº¿ï¼‰
- ä¸‰ç§ç±»å‹ï¼šç°åœºé—®é¢˜ï¼ˆscene_issueï¼‰/ é“­ç‰Œï¼ˆnameplateï¼‰/ ä»ªè¡¨ï¼ˆmeterï¼‰
- æ¯ç§ç±»å‹æœ‰ç‹¬ç‰¹çš„å›¾æ ‡å’Œé¢œè‰²æ ‡è¯†
- é»˜è®¤å¯ç”¨è‡ªåŠ¨è§£æï¼ˆå¯åœ¨å¯¹è¯æ¡†ä¸­å–æ¶ˆå‹¾é€‰ï¼‰

**UI è®¾è®¡**ï¼š
```dart
class ContentTypeSelection {
  final String type;
  final bool autoRoute;
  ContentTypeSelection({required this.type, required this.autoRoute});
}

Future<ContentTypeSelection?> _showContentTypeDialog() async {
  bool autoRoute = true; // é»˜è®¤å¯ç”¨è‡ªåŠ¨è§£æ

  return showDialog<ContentTypeSelection>(
    context: context,
    builder: (context) {
      return StatefulBuilder(
        builder: (context, setDialogState) {
          return AlertDialog(
            title: const Text('é€‰æ‹©èµ„äº§ç±»å‹'),
            content: Column(
              children: [
                // ç°åœºé—®é¢˜ï¼ˆæ©™è‰²ï¼‰
                ListTile(
                  leading: const Icon(Icons.report_problem, color: Colors.orange),
                  title: const Text('ç°åœºé—®é¢˜'),
                  onTap: () => Navigator.of(context).pop(
                    ContentTypeSelection(type: 'scene_issue', autoRoute: autoRoute),
                  ),
                ),
                // é“­ç‰Œï¼ˆè“è‰²ï¼‰
                ListTile(
                  leading: const Icon(Icons.badge, color: Colors.blue),
                  title: const Text('é“­ç‰Œ'),
                  onTap: () => Navigator.of(context).pop(
                    ContentTypeSelection(type: 'nameplate', autoRoute: autoRoute),
                  ),
                ),
                // ä»ªè¡¨ï¼ˆç»¿è‰²ï¼‰
                ListTile(
                  leading: const Icon(Icons.speed, color: Colors.green),
                  title: const Text('ä»ªè¡¨'),
                  onTap: () => Navigator.of(context).pop(
                    ContentTypeSelection(type: 'meter', autoRoute: autoRoute),
                  ),
                ),
                const Divider(),
                // è‡ªåŠ¨è§£æå‹¾é€‰æ¡†
                CheckboxListTile(
                  title: const Text('è‡ªåŠ¨è§£æ'),
                  value: autoRoute,
                  onChanged: (value) {
                    setDialogState(() { autoRoute = value ?? true; });
                  },
                ),
              ],
            ),
          );
        },
      );
    },
  );
}
```

---

### 3. æ‹ç…§æŒ‰é’® UI ä¼˜åŒ– â­

**ä¼˜åŒ–å†…å®¹**ï¼š
1. **å°ºå¯¸æ”¾å¤§**ï¼šé«˜åº¦ä»è‡ªåŠ¨è°ƒæ•´ä¸ºå›ºå®š 64px
2. **å›¾æ ‡æ”¾å¤§**ï¼šä» 20px å¢åŠ åˆ° 28px
3. **å­—ä½“æ”¾å¤§**ï¼šä»é»˜è®¤å¢åŠ åˆ° 18px
4. **è§†è§‰æ•ˆæœ**ï¼šæ·»åŠ  elevation: 4ï¼ˆé˜´å½±æ•ˆæœï¼‰
5. **åœ†è§’ä¼˜åŒ–**ï¼šborderRadius: 12ï¼ˆæ›´åœ†æ¶¦ï¼‰
6. **ä½ç½®è°ƒæ•´**ï¼šç§»åˆ°é¡µé¢ä¸ŠåŠéƒ¨åˆ†ï¼ˆæ›´é†’ç›®ï¼‰

**å®ç°ä»£ç **ï¼š

```dart
SizedBox(
  height: 64, // â­ å¢åŠ æŒ‰é’®é«˜åº¦ï¼ˆåŸè‡ªåŠ¨é«˜åº¦ï¼‰
  child: ElevatedButton.icon(
    icon: const Icon(Icons.camera_alt, size: 28), // â­ å›¾æ ‡æ”¾å¤§ï¼ˆåŸ 20pxï¼‰
    label: const Text(
      'æ‹ç…§ä¸Šä¼ ',
      style: TextStyle(fontSize: 18), // â­ å­—ä½“æ”¾å¤§ï¼ˆåŸé»˜è®¤ï¼‰
    ),
    style: ElevatedButton.styleFrom(
      elevation: 4, // â­ æ·»åŠ é˜´å½±ï¼ˆåŸ 0ï¼‰
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12), // â­ åœ†è§’ä¼˜åŒ–ï¼ˆåŸ 8ï¼‰
      ),
    ),
    onPressed: _startUploadFlow,
  ),
)
```

---

## ğŸ”§ é—®é¢˜æ’æŸ¥æŒ‡å—

### é—®é¢˜ 1ï¼šAndroid æ¨¡æ‹Ÿå™¨ç½‘ç»œè¿æ¥å¤±è´¥

**é”™è¯¯ç°è±¡**ï¼š
```
SocketException: Connection refused (OS Error: Connection refused), address = localhost, port = 8000
```

**åŸå› **ï¼šAndroid æ¨¡æ‹Ÿå™¨çš„ `localhost` æŒ‡å‘æ¨¡æ‹Ÿå™¨æœ¬èº«ï¼Œè€Œéä¸»æœº

**è§£å†³æ–¹æ¡ˆ**ï¼š

**æ–‡ä»¶**ï¼š`lib/config/constants.dart`

```dart
// â­ Android æ¨¡æ‹Ÿå™¨ä½¿ç”¨ 10.0.2.2 è®¿é—®ä¸»æœº
static const String baseUrl = 'http://10.0.2.2:8000';
```

**éªŒè¯**ï¼š
- åç«¯å¯åŠ¨ï¼š`python -m uvicorn services.backend.app.main:app --reload`
- ç§»åŠ¨ç«¯åŠ è½½é¡¹ç›®åˆ—è¡¨æˆåŠŸ
- å›¾ç‰‡ä¸Šä¼ æˆåŠŸ

---

### é—®é¢˜ 2ï¼šHTTP 422 ä¸Šä¼ é”™è¯¯

**é”™è¯¯ç°è±¡**ï¼š
```json
HTTP 422 Unprocessable Entity
{
  "detail": [
    {
      "loc": ["query", "project_id"],
      "msg": "field required"
    }
  ]
}
```

**åŸå› **ï¼šå‚æ•°ä½ç½®é”™è¯¯ - Query å‚æ•°æ”¾åœ¨ Form å­—æ®µä¸­

**è§£å†³æ–¹æ¡ˆ**ï¼š

**æ–‡ä»¶**ï¼š`lib/services/asset_service.dart`

```dart
// âŒ é”™è¯¯ï¼šæ‰€æœ‰å‚æ•°éƒ½æ”¾åœ¨ Form å­—æ®µä¸­
final fields = <String, String>{
  'project_id': projectId,
  'device_id': deviceId,
  'note': note,
  'source': 'mobile',
};

// âœ… æ­£ç¡®ï¼šQuery å‚æ•°åœ¨ URLï¼ŒForm å‚æ•°åœ¨ body
var endpoint = '${ApiEndpoints.uploadImage}?project_id=$projectId&source=mobile';
if (deviceId != null) endpoint += '&device_id=$deviceId';
if (systemId != null) endpoint += '&system_id=$systemId';
if (contentRole != null) endpoint += '&content_role=$contentRole';
endpoint += '&auto_route=${autoRoute ? "true" : "false"}';

final fields = <String, String>{
  if (note != null) 'note': note,
};
```

---

### é—®é¢˜ 3ï¼šçœŸæœºæ— æ³•è¿æ¥åç«¯

**é”™è¯¯ç°è±¡**ï¼š
```
NetworkException: ç½‘ç»œè¿æ¥å¤±è´¥: Connection refused
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **è·å–ç”µè„‘ IP åœ°å€**ï¼š
```bash
# Windows
ipconfig
# æ‰¾åˆ° "æ— çº¿å±€åŸŸç½‘é€‚é…å™¨ WLAN" çš„ IPv4 åœ°å€
# ä¾‹å¦‚ï¼š192.168.1.100
```

2. **é…ç½®ç§»åŠ¨ç«¯ baseUrl**ï¼š

**æ–‡ä»¶**ï¼š`lib/config/constants.dart`

```dart
static const String baseUrl = 'http://192.168.1.100:8000';
```

3. **ç¡®ä¿é˜²ç«å¢™å…è®¸ 8000 ç«¯å£**ï¼š

```bash
# Windows é˜²ç«å¢™ - å…è®¸ç«¯å£
netsh advfirewall firewall add rule name="Allow 8000" dir=in action=allow protocol=TCP localport=8000
```

4. **ç¡®ä¿åç«¯ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£**ï¼š

```bash
# ä¸è¦ä½¿ç”¨ localhostï¼Œä½¿ç”¨ 0.0.0.0
python -m uvicorn services.backend.app.main:app --host 0.0.0.0 --port 8000
```

---

## ğŸ’¾ ç¦»çº¿ç¼“å­˜ä¸ç½‘ç»œä¼ è¾“

### SharedPreferences ç¼“å­˜æœºåˆ¶

**å·²æ·»åŠ ä¾èµ–**ï¼š`pubspec.yaml`

```yaml
dependencies:
  shared_preferences: ^2.2.2
```

**ç¼“å­˜é…ç½®**ï¼š`lib/config/constants.dart`

```dart
class AppConfig {
  /// API åŸºç¡€ URL
  static const String baseUrl = 'http://10.0.2.2:8000';

  /// API è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  static const int apiTimeout = 30000;

  /// èµ„äº§åˆ—è¡¨é»˜è®¤åŠ è½½æ•°é‡
  static const int defaultAssetLimit = 5;

  /// â­ ç¦»çº¿ç¼“å­˜æ—¶é•¿ï¼ˆå°æ—¶ï¼‰
  static const int cacheDurationHours = 24;
}
```

### ç¼“å­˜é”®åè§„èŒƒ

```dart
/// ç¼“å­˜é”®åå¸¸é‡
class CacheKeys {
  // é¡¹ç›®ç›¸å…³
  static const String projectList = 'cache_project_list';
  static const String projectListTimestamp = 'cache_project_list_timestamp';

  // å·¥ç¨‹ç»“æ„æ ‘
  static const String structureTree = 'cache_structure_tree_'; // + projectId
  static const String structureTreeTimestamp = 'cache_structure_tree_timestamp_'; // + projectId
}
```

### ç¼“å­˜ç­–ç•¥

**æ¨èæ–¹æ¡ˆ**ï¼šCache-Firstï¼ˆä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼‰

```dart
Future<List<Building>> loadStructureTree(String projectId) async {
  // 1. å°è¯•åŠ è½½ç¼“å­˜ â†’ å¿«é€Ÿæ˜¾ç¤º
  final cached = await _loadFromCache(projectId);
  if (cached != null) {
    buildings = cached;
    notifyListeners(); // ç«‹å³æ˜¾ç¤ºç¼“å­˜æ•°æ®

    // åå°åˆ·æ–°
    _refreshInBackground(projectId);
  } else {
    // æ— ç¼“å­˜ï¼Œç›´æ¥åŠ è½½
    final data = await _service.getStructureTree(projectId);
    buildings = data;
    notifyListeners();
  }

  return buildings;
}
```

### ç½‘ç»œå±‚å®ç°

**ApiService å®Œæ•´å®ç°**ï¼š

**æ–‡ä»¶**ï¼š`lib/services/api_service.dart`

```dart
import 'dart:async';
import 'dart:convert';
import 'dart:io';
import 'package:flutter/foundation.dart';
import 'package:http/http.dart' as http;
import '../config/constants.dart';

class ApiService {
  final String baseUrl;
  final int timeoutMs;

  ApiService({
    String? baseUrl,
    this.timeoutMs = AppConfig.apiTimeout,
  }) : baseUrl = baseUrl ?? AppConfig.baseUrl;

  /// GET è¯·æ±‚
  Future<http.Response> get(String endpoint) async {
    try {
      final uri = Uri.parse('$baseUrl$endpoint');
      debugPrint('GET: $uri');

      final response = await http
          .get(uri)
          .timeout(Duration(milliseconds: timeoutMs));

      _checkResponse(response);
      return response;
    } on SocketException catch (e) {
      throw NetworkException('ç½‘ç»œè¿æ¥å¤±è´¥: $e');
    } on TimeoutException catch (e) {
      throw NetworkException('è¯·æ±‚è¶…æ—¶: $e');
    }
  }

  /// POST è¯·æ±‚ï¼ˆMultipart è¡¨å•ï¼‰
  Future<http.Response> postMultipart(
    String endpoint, {
    Map<String, String> fields = const {},
    List<http.MultipartFile> files = const [],
  }) async {
    try {
      final uri = Uri.parse('$baseUrl$endpoint');
      debugPrint('POST (Multipart): $uri');
      debugPrint('Fields: $fields');
      debugPrint('Files: ${files.length} ä¸ª');

      final request = http.MultipartRequest('POST', uri);
      request.fields.addAll(fields);
      request.files.addAll(files);

      final streamedResponse = await request.send().timeout(
        Duration(milliseconds: timeoutMs),
      );

      final response = await http.Response.fromStream(streamedResponse);
      _checkResponse(response);
      return response;
    } on SocketException catch (e) {
      throw NetworkException('ç½‘ç»œè¿æ¥å¤±è´¥: $e');
    } on TimeoutException catch (e) {
      throw NetworkException('è¯·æ±‚è¶…æ—¶: $e');
    }
  }

  /// æ£€æŸ¥å“åº”çŠ¶æ€
  void _checkResponse(http.Response response) {
    if (response.statusCode >= 200 && response.statusCode < 300) {
      return;
    }

    String errorMessage;
    try {
      final data = jsonDecode(response.body);
      errorMessage = data['detail'] ?? 'Unknown error';
    } catch (e) {
      errorMessage = response.body;
    }

    throw ApiException(
      'HTTP ${response.statusCode}: $errorMessage',
      statusCode: response.statusCode,
    );
  }
}

class ApiException implements Exception {
  final String message;
  final int? statusCode;
  ApiException(this.message, {this.statusCode});
}

class NetworkException implements Exception {
  final String message;
  NetworkException(this.message);
}
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### å¼€å‘è§„åˆ™

**âœ… å¿…é¡»ä½¿ç”¨**ï¼š
- å·²é…ç½®çš„ä¾èµ–åŒ…ï¼ˆhttp/provider/cached_network_image ç­‰ï¼‰
- å·²å®ç°çš„åç«¯ API
- Provider çŠ¶æ€ç®¡ç†
- Material Design 3 é£æ ¼

**âŒ ç¦æ­¢æ“ä½œ**ï¼š
- âŒ ä¿®æ”¹åç«¯ä»£ç æˆ– API
- âŒ æ·»åŠ æ–°çš„ pub.dev ä¾èµ–åŒ…ï¼ˆé™¤éç»å¯¹å¿…è¦ï¼‰
- âŒ ä½¿ç”¨æœ¬åœ°æ•°æ®åº“ï¼ˆSQLite/Hiveï¼‰
- âŒ å®ç°å¤æ‚çš„è·¯ç”±åŠ¨ç”»
- âŒ è¿‡åº¦è®¾è®¡å’ŒæŠ½è±¡ï¼ˆKISS åŸåˆ™ï¼‰

### ä»£ç è§„èŒƒ

**å‘½åè§„èŒƒ**ï¼š
- âœ… æ–‡ä»¶åï¼šå°å†™ä¸‹åˆ’çº¿ï¼ˆå¦‚ `project_service.dart`ï¼‰
- âœ… ç±»åï¼šå¤§é©¼å³°ï¼ˆå¦‚ `ProjectService`ï¼‰
- âœ… å˜é‡/æ–¹æ³•ï¼šå°é©¼å³°ï¼ˆå¦‚ `getProjects`ï¼‰
- âœ… å¸¸é‡ï¼šå°å†™ä¸‹åˆ’çº¿ï¼ˆå¦‚ `api_timeout`ï¼‰

**ä»£ç é£æ ¼**ï¼š
- âœ… éµå¾ª Flutter å®˜æ–¹ lint è§„åˆ™
- âœ… ä½¿ç”¨ `const` æ„é€ å‡½æ•°ä¼˜åŒ–æ€§èƒ½
- âœ… å¼‚æ­¥å‡½æ•°ä½¿ç”¨ `async/await`
- âŒ ç¦æ­¢ä½¿ç”¨ `print` è°ƒè¯•ï¼ˆä½¿ç”¨ `debugPrint`ï¼‰

### æ³¨é‡Šä¸æ–‡æ¡£

- âœ… æ‰€æœ‰æ³¨é‡Šä½¿ç”¨**ç®€ä½“ä¸­æ–‡**
- âœ… å…¬å…± API å¿…é¡»æ·»åŠ æ–‡æ¡£æ³¨é‡Š
- âœ… å¤æ‚é€»è¾‘æ·»åŠ è¡Œå†…æ³¨é‡Š

### æµ‹è¯•é™åˆ¶

**âœ… æœ¬æœŸæµ‹è¯•**ï¼š
- âœ… Chrome æµè§ˆå™¨æµ‹è¯•
- âœ… æ‰‹åŠ¨åŠŸèƒ½éªŒè¯
- âœ… çœŸå® API è”è°ƒ

**âŒ æœ¬æœŸä¸æµ‹è¯•**ï¼š
- âŒ å•å…ƒæµ‹è¯•
- âŒ Widget æµ‹è¯•
- âŒ é›†æˆæµ‹è¯•
- âŒ æ€§èƒ½æµ‹è¯•
- âŒ çœŸæœºæµ‹è¯•ï¼ˆè®¡åˆ’ä¸­ï¼‰

---

## ğŸ“‹ éªŒæ”¶æ ‡å‡†

### P0ï¼ˆå¿…é¡»å®Œæˆï¼‰
- [x] å¯ä»¥æ˜¾ç¤ºé¡¹ç›®åˆ—è¡¨
- [x] å¯ä»¥æŸ¥çœ‹å·¥ç¨‹ç»“æ„æ ‘
- [x] å¯ä»¥å±•å¼€/æŠ˜å æ ‘èŠ‚ç‚¹
- [x] å¯ä»¥ç‚¹å‡»è®¾å¤‡æŸ¥çœ‹èµ„äº§å¿«æ·è§†å›¾
- [x] å¯ä»¥ç‚¹å‡»ç³»ç»ŸæŸ¥çœ‹ç³»ç»Ÿèµ„äº§å¿«æ·è§†å›¾ â­
- [x] é»˜è®¤åªæ˜¾ç¤ºæœ€è¿‘ 5 å¼ èµ„äº§å›¾ç‰‡
- [x] æŒ‰ä¸Šä¼ æ—¶é—´å€’åºæ’åˆ—
- [x] å¯ä»¥ç‚¹å‡»èµ„äº§æŸ¥çœ‹å¤§å›¾
- [x] æ˜¾ç¤ºèµ„äº§æ€»æ•°æç¤º
- [x] æ”¯æŒ"æŸ¥çœ‹æ›´å¤š"åŠŸèƒ½
- [x] æ”¯æŒä¸‹æ‹‰åˆ·æ–°
- [x] å¿«é€Ÿæ‹ç…§ä¸Šä¼ æŒ‰é’®å¯ç”¨
- [x] ä¸Šä¼ åè‡ªåŠ¨åˆ·æ–°åˆ—è¡¨

### P1ï¼ˆé‡è¦ï¼‰
- [x] é¡¹ç›®æœç´¢åŠŸèƒ½ï¼ˆUI å ä½ï¼‰
- [x] èµ„äº§å¤§å›¾æŸ¥çœ‹ï¼ˆå¯¹è¯æ¡†å®ç°ï¼‰
- [x] æ‰¹é‡åˆ é™¤åŠŸèƒ½ â­
- [x] èµ„äº§ç±»å‹é€‰æ‹© â­
- [x] è‡ªåŠ¨è§£æé€‰é¡¹ â­

### P2ï¼ˆå¯é€‰ï¼‰
- [ ] ç¦»çº¿ç¼“å­˜ï¼ˆshared_preferencesï¼‰â³
- [ ] çœŸæœºæµ‹è¯•
- [ ] è¯­éŸ³è½¬æ–‡å­—å¤‡æ³¨ï¼ˆTODOï¼‰

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

### é¡¹ç›®æ–‡æ¡£
- [ç§»åŠ¨ç«¯é¡¹ç›®è®¡åˆ’](../../mobile/PROJECT_PLAN.md)
- [ç§»åŠ¨ç«¯å¼€å‘æ¸…å•](../../mobile/DEV_CHECKLIST.md)
- [ç§»åŠ¨ç«¯ API æ¸…å•](../../mobile/API_CHECKLIST.md)

### æŠ€æœ¯æ–‡æ¡£
- [å·¥ç¨‹ç»“æ„ API è®¾è®¡](../02-æŠ€æœ¯æ–‡æ¡£/å·¥ç¨‹ç»“æ„APIè®¾è®¡.md)

### ä¼˜åŒ–è®°å½•
- [ç¦»çº¿ç¼“å­˜ä¸ç½‘ç»œä¼ è¾“è¯¦è§£](./ç¦»çº¿ç¼“å­˜åŠŸèƒ½ä¸å‰åç«¯ä¼ è¾“æ¡ä»¶è¯¦è§£.md)
- [èµ„äº§æ–‡ä»¶è®¿é—®æ–¹æ¡ˆ](./èµ„äº§æ–‡ä»¶è®¿é—®æ–¹æ¡ˆä¸è¿ç§»è®¡åˆ’.md)

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**ï¼š2026-01-23
**æœ€åæ›´æ–°æ—¶é—´**ï¼š2026-01-23
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**ç»´æŠ¤è€…**ï¼šBDC-AI å¼€å‘å›¢é˜Ÿ
