# 2026-01-27 移动端上传队列设计

**适用项目**：BDC-AI 移动端

---

## 1. 背景与目标

当前移动端已有：

- 项目列表、工程结构树的离线缓存（只读）
- 拍照上传接口（立即调用后端）

缺失的是：

- 无网络 / 弱网场景下的**上传任务排队与自动重试**能力
- 用户可见的“待上传队列”和“同步”操作

本设计文档只定义：

- 上传任务的数据结构
- 队列的状态机与行为规则

不直接改代码，作为后续实现的蓝本。

---

## 2. 上传任务数据结构

### 2.1 UploadTask 模型

```dart
class UploadTask {
  final String id;                // 本地任务ID（UUID）
  final String filePath;          // 本地图片路径

  final String projectId;         // 所属项目
  final String? systemId;         // 系统视图上传可选
  final String? deviceId;         // 设备视图上传可选

  final String contentRole;       // scene_issue / nameplate / meter
  final String? note;             // 备注

  final DateTime createdAt;       // 任务创建时间
  final int retryCount;           // 已重试次数

  final UploadTaskStatus status;  // 见 3. 状态机
  final String? lastError;        // 最近一次错误信息（仅日志用）
}
```

序列化建议：

- 按 JSON 存储到本地（建议 Hive/SQLite；最低限度可用 SharedPreferences 存 List<JSON>）。
- `status` 用字符串持久化：`pending`、`waiting_network` 等。

### 2.2 UploadTaskStatus 枚举

```dart
enum UploadTaskStatus {
  pending,          // 刚入队，等待上传
  waitingNetwork,   // 检测到无网络，等待网络恢复
  waitingAuth,      // 遇到 401/403，等待用户重新登录
  uploading,        // 正在上传
  succeeded,        // 上传成功，已同步到后端
  failedPermanent,  // 永久失败（参数错误等），需人工处理或删除
}
```

---

## 3. 队列状态机设计

### 3.1 高层行为

- 队列由一个 `UploadQueue` / `AssetUploadProvider` 管理：
  - 维护本地 `List<UploadTask>`，并与持久化同步。
  - 提供 `enqueue()`、`start()`、`pause()`、`retry(taskId)` 等接口。
- 队列**单线程串行**执行：一次只上传一个任务，避免并发复杂度。

### 3.2 状态机节点

**节点：**

- `pending`
  - 初始状态，任务刚入队。
- `uploading`
  - 队列当前正在处理的任务。
- `waitingNetwork`
  - 最近一次失败是网络异常（`NetworkException` 等）。
- `waitingAuth`
  - 最近一次失败是 401 / 403，依赖全局认证恢复。
- `succeeded`
  - 成功上传，任务可以从队列中删除，也可短期保留做历史记录。
- `failedPermanent`
  - 参数错误 / 后端 4xx 非权限错误（如 422），多次重试仍失败，认为无法自动恢复。

### 3.3 状态转移（文字版）

**1. 创建任务**

- 触发：用户在系统视图 / 设备视图中拍照并点击“上传”。
- 流程：
  - 构造 `UploadTask`，`status = pending`，`retryCount = 0`。
  - 写入本地持久化，并加入内存队列末尾。
  - 如果队列未在运行，可自动 `start()`。

**2. pending → uploading**

- 队列选择首个 `status == pending` 的任务，进入 `uploading`。

**3. uploading → succeeded**

- 条件：调用上传 API 成功（200/201）。
- 操作：
  - 标记 `status = succeeded`。
  - 从队列中移除（或移入“最近上传历史”结构）。
  - 继续处理下一个 `pending` 任务。

**4. uploading → waitingNetwork**

- 条件：捕获到 `NetworkException` / 超时等网络异常。
- 操作：
  - `retryCount += 1`。
  - 若 `retryCount < MAX_RETRY`（例如 3）：
    - 标记 `status = waitingNetwork`。
    - 队列进入短暂停顿（例如 30 秒后重试）。
  - 若超过最大重试次数：可以直接进入 `failedPermanent`。

**5. uploading → waitingAuth**

- 条件：上传 API 返回 401 或 403，被 `ApiService` 统一封装为 `ApiException(statusCode: 401/403)`。
- 操作：
  - 标记 `status = waitingAuth`。
  - 队列整体暂停，直到全局 `AuthProvider` 检测到重新登录成功后再恢复。

**6. uploading → failedPermanent**

- 条件：
  - 4xx 且非 401/403，典型如 422 参数错误；
  - 或已重试多次仍失败。
- 操作：
  - 标记 `status = failedPermanent`，记录 `lastError`。
  - 队列继续处理下一个任务。
  - UI 上可提供“删除任务”或“编辑后重试”的入口（后续再设计）。

**7. waitingNetwork → pending**

- 条件：检测到网络恢复（可用 `connectivity_plus` 或简单按时间间隔重试）。
- 操作：
  - 将任务状态重新设为 `pending`，重新进入正常上传流转。

**8. waitingAuth → pending**

- 条件：
  - 全局认证状态从未登录/过期 → 已登录。
- 操作：
  - 队列收到“认证恢复”的信号（例如监听 `AuthProvider.authStatus`）。
  - 将所有 `waitingAuth` 任务重置为 `pending`，按顺序继续上传。

---

## 4. 队列与全局状态协作

### 4.1 与 AuthProvider 的关系

- 401/403 由统一的 `ApiService` 触发 `AuthService.markTokenExpired()` → `AuthProvider` 变为 `tokenExpired`。
- 上传队列监听 `AuthProvider`：
  - 当 `authStatus == tokenExpired` 时，暂停处理，将当前任务标记为 `waitingAuth`。
  - 当用户重新登录成功（`isAuthenticated == true`）时，
    - 将所有 `waitingAuth` 任务重置为 `pending`，队列自动恢复。

### 4.2 与网络状态的关系

两种实现思路：

- 简单版：完全依赖请求失败重试 + `retryCount` 和时间间隔，不额外监听网络。
- 完善版：
  - 使用 `connectivity_plus` 检测网络是否可用；
  - 无网时不进入 `uploading`，只把任务标记为 `waitingNetwork`；
  - 网络恢复事件触发批量 `waitingNetwork → pending`。

---

## 5. UI 与交互草案（简要）

- 顶部小提示栏：
  - 文案示例：`有 3 条照片等待上传`，点击进入“上传队列”页面。
- 上传队列页面（未来）：
  - 按任务状态分组展示：正在上传 / 待上传 / 等待网络 / 等待登录 / 失败。
  - 支持：
    - 单条任务“删除”
    - 单条任务“重试”（`failedPermanent` → `pending`）
    - 全部任务“一键同步”（强制 `start()`）。

---

## 6. 实施建议（后续开发参考）

- **阶段 1（MVP）**
  - 仅支持：
    - pending → uploading → succeeded
    - uploading → waitingNetwork / waitingAuth → pending
  - 失败只记录日志，不做 `failedPermanent` 分类。

- **阶段 2（增强）**
  - 引入 `failedPermanent` 状态与 UI 管理界面。
  - 加入重试策略（指数退避等）。

- **阶段 3（体验优化）**
  - 完整 UI 队列列表。
  - 离线模式提示整合（与现有只读缓存配合）。

本设计文档仅作为后续实现的结构蓝本，具体字段和状态细节可在实现阶段根据后端接口调整。
