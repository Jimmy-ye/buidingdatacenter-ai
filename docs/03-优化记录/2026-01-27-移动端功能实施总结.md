# ç§»åŠ¨ç«¯åŠŸèƒ½å®æ–½æ€»ç»“ - æ·»åŠ è®¾å¤‡ä¸åˆ é™¤æƒé™æ§åˆ¶

> **æ—¥æœŸ**: 2026-01-27
> **åˆ†æ”¯**: feature/mobile-auth-integration
> **çŠ¶æ€**: âœ… å®Œæˆ

---

## ğŸ“‹ å®æ–½æ¦‚è¿°

æœ¬æ¬¡å®æ–½å®Œæˆäº†ä¸¤ä¸ªé‡è¦çš„ç§»åŠ¨ç«¯åŠŸèƒ½:
1. **æ·»åŠ è®¾å¤‡åŠŸèƒ½ï¼ˆP0ï¼‰** - å…è®¸ç”¨æˆ·åœ¨ç³»ç»ŸèŠ‚ç‚¹å¿«é€Ÿåˆ›å»ºè®¾å¤‡
2. **åˆ é™¤æƒé™æ§åˆ¶ï¼ˆP1ï¼‰** - ä¸ºæ‰¹é‡åˆ é™¤åŠŸèƒ½æ·»åŠ æƒé™æ£€æŸ¥

---

## ğŸ¯ åŠŸèƒ½1: æ·»åŠ è®¾å¤‡ï¼ˆP0ï¼‰

### ç”¨æˆ·åœºæ™¯
å·¥ç¨‹å¸ˆåœ¨ç°åœºæ£€æŸ¥ç³»ç»Ÿï¼ˆå¦‚ HVACï¼‰æ—¶ï¼Œå‘ç°è®¾å¤‡æœªå½•å…¥ç³»ç»Ÿï¼Œä½¿ç”¨ç§»åŠ¨ç«¯å¿«é€Ÿæ·»åŠ è®¾å¤‡ä¿¡æ¯ï¼Œå¹¶å¯ç«‹å³å…³è”èµ„äº§ï¼ˆæ‹ç…§ä¸Šä¼ ï¼‰ã€‚

### å®æ–½ç»†èŠ‚

#### 1. æ•°æ®æ¨¡å‹å±‚

**æ–‡ä»¶**: `mobile/bdc_ai_app/lib/models/structure.dart`

æ–°å¢ `DeviceCreate` ç±»:
```dart
class DeviceCreate {
  final String? zoneId;          // å¯é€‰: åŒºåŸŸID
  final String? deviceType;      // å¯é€‰: è®¾å¤‡ç±»å‹
  final String model;            // å¿…å¡«: è®¾å¤‡å‹å·ï¼ˆä½œä¸ºåç§°ï¼‰
  final double? ratedPower;      // å¯é€‰: é¢å®šåŠŸç‡
  final String? serialNo;        // å¯é€‰: åºåˆ—å·
  final List<String>? tags;      // å¯é€‰: æ ‡ç­¾
}
```

**è®¾è®¡è¦ç‚¹**:
- åªæœ‰ `model` ä¸ºå¿…å¡«å­—æ®µï¼Œé™ä½ç°åœºå½•å…¥é—¨æ§›
- å…¶ä»–å­—æ®µå…¨éƒ¨å¯é€‰ï¼Œç¬¦åˆå®é™…ä½¿ç”¨åœºæ™¯

#### 2. API é…ç½®å±‚

**æ–‡ä»¶**: `mobile/bdc_ai_app/lib/config/constants.dart`

æ–°å¢ API ç«¯ç‚¹:
```dart
static String createDevice(String systemId) =>
    '/api/v1/systems/$systemId/devices';
```

#### 3. æœåŠ¡å±‚

**æ–‡ä»¶**: `mobile/bdc_ai_app/lib/services/project_service.dart`

å®ç° `createDevice` æ–¹æ³•:
```dart
Future<Device> createDevice(String systemId, DeviceCreate device) async {
  final response = await _api.post(
    ApiEndpoints.createDevice(systemId),
    headers: _buildAuthHeaders(),
    body: device.toJson(),
  );
  final data = jsonDecode(response.body);
  return Device.fromJson(data);
}
```

**ç‰¹æ€§**:
- è‡ªåŠ¨æ·»åŠ è®¤è¯å¤´
- JSON åºåˆ—åŒ–
- é”™è¯¯å¤„ç†

#### 4. çŠ¶æ€ç®¡ç†å±‚

**æ–‡ä»¶**: `mobile/bdc_ai_app/lib/providers/structure_provider.dart`

å®ç° `createDevice` æ–¹æ³•:
```dart
Future<Device> createDevice(
  String systemId,
  DeviceCreate device,
  String projectId,
) async {
  _setLoading(true);
  try {
    final newDevice = await _service.createDevice(systemId, device);

    // è‡ªåŠ¨åˆ·æ–°å·¥ç¨‹ç»“æ„æ ‘
    await refreshStructureTree(projectId);

    return newDevice;
  } finally {
    _setLoading(false);
  }
}
```

**å…³é”®ç‰¹æ€§**:
- åˆ›å»ºæˆåŠŸåè‡ªåŠ¨åˆ·æ–°æ ‘ï¼Œç¡®ä¿ UI åŒæ­¥
- åŠ è½½çŠ¶æ€ç®¡ç†
- é”™è¯¯å¤„ç†

#### 5. UI å±‚

**æ–‡ä»¶**: `mobile/bdc_ai_app/lib/pages/structure_tree_page.dart`

##### 5.1 æƒé™æ£€æŸ¥æ–¹æ³•
```dart
void _showAddDeviceDialog(System system) {
  final authService = AuthService();

  // æ£€æŸ¥ structures:create æƒé™
  if (!authService.hasPermission('structures:create')) {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(
        content: Text('æƒé™ä¸è¶³ï¼šéœ€è¦ structures:create æƒé™'),
        backgroundColor: Colors.orange,
      ),
    );
    return;
  }

  showDialog(
    context: context,
    builder: (context) => AddDeviceDialog(system: system),
  );
}
```

##### 5.2 æ·»åŠ è®¾å¤‡æŒ‰é’®

åœ¨ `SystemNode` æ ‡é¢˜è¡Œæ·»åŠ :
```dart
if (onAddDevice != null)
  IconButton(
    icon: const Icon(Icons.add_circle_outline),
    onPressed: () => onAddDevice?.call(system),
    tooltip: 'æ·»åŠ è®¾å¤‡',
    padding: EdgeInsets.zero,
    constraints: const BoxConstraints(),
    iconSize: 20,
  ),
```

**ä½ç½®**: è®¾å¤‡æ•°é‡æ ‡ç­¾ä¹‹å‰

##### 5.3 æ·»åŠ è®¾å¤‡å¯¹è¯æ¡†ï¼ˆAddDeviceDialogï¼‰

å®Œæ•´å®ç° `StatefulWidget`,åŒ…å«:

**è¡¨å•å­—æ®µ**:
1. å‹å·ï¼ˆå¿…å¡«ï¼‰- TextFormField with validator
2. è®¾å¤‡ç±»å‹ï¼ˆå¯é€‰ï¼‰- ä¾‹å¦‚: fcu, chiller, pump
3. é¢å®šåŠŸç‡ï¼ˆå¯é€‰ï¼‰- æ•°å­—è¾“å…¥ï¼ˆkWï¼‰
4. åºåˆ—å·ï¼ˆå¯é€‰ï¼‰- æ–‡æœ¬è¾“å…¥
5. æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰- é€—å·åˆ†éš”

**äº¤äº’ç‰¹æ€§**:
- è¡¨å•éªŒè¯ï¼ˆå‹å·å¿…å¡«ï¼‰
- åŠ è½½çŠ¶æ€æ˜¾ç¤º
- æˆåŠŸ/å¤±è´¥æç¤º
- è‡ªåŠ¨å…³é—­å¯¹è¯æ¡†

**æäº¤é€»è¾‘**:
```dart
Future<void> _submit() async {
  if (!_formKey.currentState!.validate()) return;

  setState(() => _isLoading = true);

  try {
    // è§£ææ ‡ç­¾
    final tags = _tagsController.text.isNotEmpty
        ? _tagsController.text.split(',').map((e) => e.trim()).toList()
        : null;

    // åˆ›å»ºè®¾å¤‡è¯·æ±‚
    final deviceCreate = DeviceCreate(
      model: _modelController.text.trim(),
      deviceType: _deviceTypeController.text.trim().isEmpty
          ? null : _deviceTypeController.text.trim(),
      ratedPower: _ratedPowerController.text.trim().isEmpty
          ? null : double.tryParse(_ratedPowerController.text.trim()),
      serialNo: _serialNoController.text.trim().isEmpty
          ? null : _serialNoController.text.trim(),
      tags: tags,
    );

    // è°ƒç”¨ Provider åˆ›å»ºè®¾å¤‡
    await structureProvider.createDevice(
      widget.system.id,
      deviceCreate,
      projectId,
    );

    // æˆåŠŸæç¤º
    Navigator.of(context).pop();
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('è®¾å¤‡åˆ›å»ºæˆåŠŸ'), backgroundColor: Colors.green),
    );
  } catch (e) {
    // é”™è¯¯å¤„ç†
    setState(() => _isLoading = false);
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('åˆ›å»ºå¤±è´¥: $e'), backgroundColor: Colors.red),
    );
  }
}
```

### åŠŸèƒ½ç‰¹æ€§

âœ… **æƒé™æ£€æŸ¥**:
- åªæœ‰ `structures:create` æƒé™çš„ç”¨æˆ·å¯è§æŒ‰é’®
- æ— æƒé™ç”¨æˆ·ç‚¹å‡»æ˜¾ç¤ºå‹å¥½æç¤º

âœ… **è¡¨å•éªŒè¯**:
- å‹å·å¿…å¡«ï¼Œå…¶ä»–å­—æ®µå¯é€‰
- å®æ—¶éªŒè¯åé¦ˆ

âœ… **è‡ªåŠ¨åˆ·æ–°**:
- åˆ›å»ºæˆåŠŸåè‡ªåŠ¨åˆ·æ–°å·¥ç¨‹ç»“æ„æ ‘
- æ–°è®¾å¤‡ç«‹å³å¯è§

âœ… **ç”¨æˆ·å‹å¥½**:
- åŠ è½½çŠ¶æ€æŒ‡ç¤º
- æˆåŠŸ/å¤±è´¥æ¸…æ™°æç¤º
- å¯¹è¯æ¡†è‡ªåŠ¨å…³é—­

### ä¿®æ”¹çš„æ–‡ä»¶

1. `lib/models/structure.dart` - DeviceCreate æ¨¡å‹
2. `lib/config/constants.dart` - API ç«¯ç‚¹
3. `lib/services/project_service.dart` - API æ–¹æ³•
4. `lib/providers/structure_provider.dart` - Provider æ–¹æ³•
5. `lib/pages/structure_tree_page.dart` - UI å®ç°

---

## ğŸ›¡ï¸ åŠŸèƒ½2: åˆ é™¤æƒé™æ§åˆ¶ï¼ˆP1ï¼‰

### å®‰å…¨ç›®æ ‡

ä¸ºæ‰¹é‡åˆ é™¤åŠŸèƒ½æ·»åŠ æƒé™æ£€æŸ¥ï¼Œç¡®ä¿åªæœ‰ `assets:delete` æƒé™çš„ç”¨æˆ·æ‰èƒ½åˆ é™¤èµ„äº§ï¼Œé˜²æ­¢æ— æƒé™ç”¨æˆ·è¯¯åˆ ã€‚

### å®æ–½ç»†èŠ‚

**æ–‡ä»¶**: `mobile/bdc_ai_app/lib/pages/assets_page.dart`

#### 1. æƒé™æ£€æŸ¥è¾…åŠ©æ–¹æ³•

```dart
/// æƒé™æ£€æŸ¥ï¼šæ˜¯å¦æœ‰åˆ é™¤èµ„äº§æƒé™
bool get _canDeleteAssets {
  final authService = AuthService();
  return authService.hasPermission('assets:delete');
}
```

#### 2. è¿›å…¥é€‰æ‹©æ¨¡å¼æ—¶çš„æƒé™æ£€æŸ¥

```dart
void _enterSelectionMode() {
  // æ£€æŸ¥æƒé™
  if (!_canDeleteAssets) {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(
        content: Text('æƒé™ä¸è¶³ï¼šéœ€è¦ assets:delete æƒé™'),
        backgroundColor: Colors.orange,
      ),
    );
    return;
  }

  setState(() {
    _selectionMode = true;
    _selectedAssetIds.clear();
  });
}
```

**ä½ç½®**: ç¬¬451è¡Œ

#### 3. åˆ é™¤èµ„äº§æ—¶çš„æƒé™æ£€æŸ¥

```dart
Future<void> _deleteSelectedAssets() async {
  if (_selectedAssetIds.isEmpty) return;

  // æ£€æŸ¥æƒé™
  if (!_canDeleteAssets) {
    _exitSelectionMode();
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(
        content: Text('æƒé™ä¸è¶³ï¼šéœ€è¦ assets:delete æƒé™'),
        backgroundColor: Colors.orange,
      ),
    );
    return;
  }

  // ... ç¡®è®¤å¯¹è¯æ¡†å’Œåˆ é™¤é€»è¾‘
}
```

**ä½ç½®**: ç¬¬477è¡Œ

#### 4. AppBar æŒ‰é’®æ§åˆ¶

```dart
// åªå¯¹æœ‰æƒé™ç”¨æˆ·æ˜¾ç¤º"é€‰æ‹©åˆ é™¤"æŒ‰é’®
if (_canDeleteAssets)
  IconButton(
    icon: const Icon(Icons.check_circle_outline),
    onPressed: _enterSelectionMode,
    tooltip: 'æ‰¹é‡ç®¡ç†',
  ),
```

**ä½ç½®**: ç¬¬749-779è¡Œ

### åŠŸèƒ½ç‰¹æ€§

âœ… **UI å±‚æ§åˆ¶**:
- æ— æƒé™ç”¨æˆ·çœ‹ä¸åˆ°"é€‰æ‹©åˆ é™¤"æŒ‰é’®
- ä»æºå¤´é˜²æ­¢è¯¯æ“ä½œ

âœ… **æ–¹æ³•å±‚æ£€æŸ¥**:
- å³ä½¿ç»•è¿‡ UIï¼Œæ–¹æ³•ä¹Ÿä¼šéªŒè¯æƒé™
- åŒé‡ä¿é™©

âœ… **å‹å¥½æç¤º**:
- æƒé™ä¸è¶³æ—¶æ˜¾ç¤ºæ¸…æ™°çš„æç¤ºä¿¡æ¯
- æ©™è‰²è­¦å‘Šæç¤º

### ä¿®æ”¹çš„æ–‡ä»¶

1. `lib/pages/assets_page.dart` - æƒé™æ£€æŸ¥é€»è¾‘

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æ·»åŠ è®¾å¤‡åŠŸèƒ½æµ‹è¯•

#### 1. æƒé™æµ‹è¯•
- âœ… æœ‰ `structures:create` æƒé™: æŒ‰é’®å¯è§ï¼Œå¯åˆ›å»º
- âœ… æ— æƒé™: æŒ‰é’®éšè—æˆ–ç‚¹å‡»æç¤ºæƒé™ä¸è¶³

#### 2. è¡¨å•éªŒè¯æµ‹è¯•
- âœ… ä¸å¡«å‹å·: æ˜¾ç¤ºéªŒè¯é”™è¯¯
- âœ… åªå¡«å‹å·: æˆåŠŸåˆ›å»º
- âœ… å¡«å†™å…¨éƒ¨å­—æ®µ: æˆåŠŸåˆ›å»º

#### 3. åŠŸèƒ½æµ‹è¯•
- âœ… åˆ›å»ºåè®¾å¤‡å‡ºç°åœ¨ç³»ç»Ÿä¸‹
- âœ… è®¾å¤‡åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°
- âœ… å¯ä»¥ç«‹å³ä¸ºæ–°è®¾å¤‡æ·»åŠ èµ„äº§

### åˆ é™¤æƒé™æ§åˆ¶æµ‹è¯•

#### 1. æœ‰æƒé™ç”¨æˆ·
- âœ… çœ‹åˆ°"é€‰æ‹©åˆ é™¤"æŒ‰é’®
- âœ… å¯ä»¥è¿›å…¥é€‰æ‹©æ¨¡å¼
- âœ… å¯ä»¥æ‰¹é‡åˆ é™¤ mobile æ¥æºçš„èµ„äº§

#### 2. æ— æƒé™ç”¨æˆ·
- âœ… çœ‹ä¸åˆ°"é€‰æ‹©åˆ é™¤"æŒ‰é’®
- âœ… æ— æ³•è¿›å…¥é€‰æ‹©æ¨¡å¼
- âœ… åˆ é™¤æŒ‰é’®ä¸æ˜¾ç¤º

---

## ğŸ“Š æŠ€æœ¯äº®ç‚¹

### 1. ä¸‰å±‚æƒé™æ£€æŸ¥
- **UI å±‚**: æŒ‰é’®å¯è§æ€§æ§åˆ¶
- **æ–¹æ³•å±‚**: æ“ä½œå‰æƒé™éªŒè¯
- **åç«¯å±‚**: API æƒé™å¼ºåˆ¶éªŒè¯

### 2. ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- æœ€å°åŒ–å¿…å¡«å­—æ®µ
- å®æ—¶è¡¨å•éªŒè¯
- æ¸…æ™°çš„é”™è¯¯æç¤º
- è‡ªåŠ¨åˆ·æ–°çŠ¶æ€

### 3. ä»£ç è´¨é‡
- éµå¾ª Flutter æœ€ä½³å®è·µ
- ä½¿ç”¨ StatefulWidget ç®¡ç†å¯¹è¯æ¡†çŠ¶æ€
- Provider æ¨¡å¼ç»Ÿä¸€çŠ¶æ€ç®¡ç†
- å®Œå–„çš„é”™è¯¯å¤„ç†

---

## ğŸ“ˆ è¿›åº¦æ›´æ–°

### å·²å®Œæˆ âœ…
- [x] P0: æ·»åŠ è®¾å¤‡åŠŸèƒ½ï¼ˆå®Œæ•´å®æ–½ï¼‰
- [x] P1: åˆ é™¤æƒé™æ§åˆ¶ï¼ˆå®Œæ•´å®æ–½ï¼‰

### å¾…å®Œæˆ â³
- [ ] P0: é¡¹ç›®åˆ›å»º/åˆ é™¤æŒ‰é’®ï¼ˆ`projects:create/delete`ï¼‰
- [ ] P2: OCR/LLM æŒ‰é’®æƒé™ï¼ˆ`assets:run_ocr/run_llm`ï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç§»åŠ¨ç«¯åŠŸèƒ½éœ€æ±‚æ˜ç¡®ä¸å®ç°è®¡åˆ’](./ç§»åŠ¨ç«¯åŠŸèƒ½éœ€æ±‚æ˜ç¡®ä¸å®ç°è®¡åˆ’.md)
- [ç§»åŠ¨ç«¯æƒé™æ§åˆ¶å®ç°çŠ¶æ€åˆ†æ](./ç§»åŠ¨ç«¯æƒé™æ§åˆ¶å®ç°çŠ¶æ€åˆ†æ.md)
- [2026-01-26-ç§»åŠ¨ç«¯è®¤è¯æ•´åˆä¸æµ‹è¯•æ€»ç»“](./2026-01-26-ç§»åŠ¨ç«¯è®¤è¯æ•´åˆä¸æµ‹è¯•æ€»ç»“.md)
- [å¼€å‘æ—¥å¿—](./å¼€å‘æ—¥å¿—.md)

---

## ğŸ”„ åç»­è®¡åˆ’

### çŸ­æœŸï¼ˆæœ¬å‘¨ï¼‰
1. å®Œæˆä¸Šè¿°åŠŸèƒ½çš„çœŸæœºæµ‹è¯•
2. æ”¶é›†ç”¨æˆ·åé¦ˆ
3. ä¼˜åŒ–è¡¨å•äº¤äº’

### ä¸­æœŸï¼ˆæœ¬æœˆï¼‰
1. å®Œæˆé¡¹ç›®åˆ›å»º/åˆ é™¤æƒé™æ§åˆ¶
2. æ·»åŠ æ›´å¤šè®¾å¤‡å­—æ®µï¼ˆå¦‚åˆ¶é€ å•†ã€å®‰è£…æ—¥æœŸï¼‰
3. å®ç°è®¾å¤‡ç¼–è¾‘åŠŸèƒ½

### é•¿æœŸï¼ˆä¸‹æœˆï¼‰
1. æ·»åŠ è®¾å¤‡æ‰«ç åŠŸèƒ½ï¼ˆäºŒç»´ç /æ¡å½¢ç ï¼‰
2. æ‰¹é‡å¯¼å…¥è®¾å¤‡ï¼ˆExcel/CSVï¼‰
3. è®¾å¤‡æ¨¡æ¿ç³»ç»Ÿ

---

**æ–‡æ¡£ç»´æŠ¤**: BDC-AI å¼€å‘å›¢é˜Ÿ
**æœ€åæ›´æ–°**: 2026-01-27
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
