# 2026-01-27 图像 LLM 解析管线：设计与实现 + 待办

**适用范围**：后台服务（FastAPI + worker）、PC 前端、移动端
**文档状态**：部分已实现，持续迭代中

---

## 1. 目标与原则

- 所有 `modality = image` 的资产统一走 **LLM 视觉管线**，OCR 仅保留给后续 **PDF → 图片 → OCR** 场景。
- 按 `content_role` 区分 3 类输出结构：
  - `scene_issue`：场景问题评估（继续使用 `SceneIssueReportPayload`）。
  - `nameplate`：铭牌信息表格结构（`NameplateTablePayload`）。
  - `meter`：仪表读数结构，支持“预读数”与“实际读数”对比（`MeterReadingPayload`）。
- 所有结构化结果统一落在 `AssetStructuredPayload` 中，通过 `schema_type` 区分版本与类型。
- PC 端和移动端前端都只消费结构化结果，不直接解析 LLM 原始文本。

---

## 2. 后端结构设计

### 2.1 现有结构回顾

- `SceneIssueReportPayload`（已有）：
  - 用于场景问题评估，字段：`title, issue_category, severity, summary, suspected_causes, recommended_actions, confidence, tags`。
  - 存储为 `AssetStructuredPayload(schema_type="scene_issue_report_v1")`。
- `AssetStructuredPayload`：
  - `asset_id, schema_type: str, payload: dict, version: float, created_by: str`。

### 2.2 新增名称与 schema_type 约定

- `scene_issue`：
  - 继续使用 `SceneIssueReportPayload`，`schema_type = "scene_issue_report_v1"`。
- `nameplate`：
  - 新增 `NameplateTablePayload`：
    - `equipment_type: Optional[str]`
    - `fields: List[NameplateField]`
  - `NameplateField`：
    - `key: str`（英文/内部字段名，如 `model`, `power_kw`）
    - `label: str`（前端展示名称，如“型号”、“额定功率”）
    - `value: str | float | None`
    - `unit: Optional[str]`（如 `kW`, `V`, `A`, `Hz`）
    - `confidence: Optional[float]`
  - 存储为 `schema_type = "nameplate_table_v1"`。
- `meter`：
  - 新增 `MeterReadingPayload`：
    - `pre_reading: Optional[float]`（上传时工程师预估读数）
    - `reading: Optional[float]`（LLM 基于图片识别的读数；可等于 `pre_reading`）
    - `unit: Optional[str]`（如 `℃`, `kW`, `m3/h`）
    - `status: Literal["confirmed_from_image", "fallback_to_pre_reading", "inconsistent_require_manual"]`
    - `summary: str`
    - `confidence: Optional[float]`
    - `tags: List[str]`
  - 存储为 `schema_type = "meter_reading_v1"`。

---

## 3. 路由与 worker 管线

### 3.1 上传与路由（后端 API）

- 上传接口 `POST /api/v1/assets/upload_image_with_note`：
  - 新增可选参数：
    - `meter_pre_reading: Optional[float] = Query(None, ...)`（仅在 `content_role = "meter"` 时有意义）。
  - 仍然根据工程结构参数（project / building / zone / system / device）写入 `Asset`。
  - `auto_route = true` 时，统一调用 `route_image_asset(db, asset)`。

- `route_image_asset` 调整方案：
  - 不再调用 `process_image_with_ocr`。
  - 对所有 `modality = "image"` 的资产：
    - 写入一条 `AssetStructuredPayload`：
      - `schema_type = "image_route_decision_v1"`
      - `payload = {"route": "scene_llm_pipeline", "content_role": asset.content_role}`
    - 将 `asset.status = "pending_scene_llm"`。
  - 后续由 worker 统一处理。

### 3.2 worker 角色与调度

- 脚本：`services/worker/scene_issue_glm_worker.py`。
- 调整 `get_pending_scene_assets()`：
  - 当前：只拉取 `content_role in ["scene_issue", "meter"]` 且 `status = pending_scene_llm` 的 image。
  - 设计：扩展为 `roles = ["scene_issue", "meter", "nameplate"]`。
- `process_once()` 中，根据 `detail.content_role` 选择不同的 Prompt 与 schema：
  - `role == "scene_issue"`：
    - `prompt = build_scene_prompt(note)`
    - 结果经 `normalise_scene_payload`，写入 `schema_type = "scene_issue_report_v1"`。
  - `role == "nameplate"`：
    - `prompt = build_nameplate_prompt(note)`
    - 返回结构直接校验/规整为 `NameplateTablePayload`，写入 `schema_type = "nameplate_table_v1"`。
  - `role == "meter"`：
    - 从 detail 中读取 `pre_reading`（字段来源见 4.2）。
    - `prompt = build_meter_prompt(pre_reading, note)`
    - 返回结构规整为 `MeterReadingPayload`，写入 `schema_type = "meter_reading_v1"`。
- 资产状态更新：
  - worker 完成后，将 `asset.status` 更新为：
    - `parsed_scene_issue_llm` / `parsed_nameplate_llm` / `parsed_meter_llm`（可选，便于筛选）。

---

## 4. Prompt 设计要点

### 4.1 场景问题（scene_issue）

- 继续沿用现有 `build_scene_prompt`，强调：
  - 正常使用痕迹不算问题；
  - 严格输出 `SceneIssueReportPayload` JSON；
  - summary 不得抄工程师备注。

### 4.2 铭牌（nameplate）

- 新增 `build_nameplate_prompt(note)`：
  - 角色："设备铭牌信息抽取助手"。
  - 明确说明：
    - 需要从图片里识别出铭牌上的关键信息，输出为 **表格行数组**：`fields: [{key, label, value, unit, confidence}]`。
    - 可建议的常见字段：型号、额定制冷量、额定功率、电压、电流、频率、出厂日期、厂家等。
  - 严格要求输出：

    ```json
    {
      "equipment_type": "...",
      "fields": [
        {"key": "model", "label": "型号", "value": "XXX-123", "unit": null, "confidence": 0.9},
        {"key": "power_kw", "label": "额定功率", "value": 1200, "unit": "kW", "confidence": 0.9}
      ]
    }
    ```

  - 若看不清某些字段：
    - 不要胡乱猜测，可省略该行，或 `value = null` 并在 summary / tags 中提示“铭牌不清晰，建议人工补录”。

### 4.3 仪表（meter）

- 新增 `build_meter_prompt(pre_reading, note)`：
  - 角色："仪表读数识别助手"。
  - 明确输入：
    - 有一个工程师预读数 `pre_reading`，但你必须优先基于图片独立判断。
  - 要求输出：

    ```json
    {
      "pre_reading": 65.0,
      "reading": 64.8,
      "unit": "℃",
      "status": "confirmed_from_image",
      "summary": "...",
      "confidence": 0.85,
      "tags": ["仪表", "温度"]
    }
    ```

  - `status` 语义：
    - `confirmed_from_image`：图片清晰，可给出读数；若与预读数接近，可在 summary 中说明“一致/接近”。
    - `fallback_to_pre_reading`：图片不清楚，无法给出可靠读数 → `reading = pre_reading`，summary 必须写明“基于人工预读，需人工确认”。
    - `inconsistent_require_manual`：图片读数与预读数明显不一致 → 推荐人工核实。

---

## 5. PC 前端展示设计

### 5.1 通用展示位置

- 在 PC 端资产详情页面增加 "AI 解析" 区块或 Tab，统一展示各类结构化结果：
  - 若存在 `scene_issue_report_v1`：显示为“状态评估卡片”。
  - 若存在 `nameplate_table_v1`：显示为“铭牌信息表格”。
  - 若存在 `meter_reading_v1`：显示为“仪表读数卡片 + 时间序列入口”。

### 5.2 场景问题（scene_issue_report_v1）

- 已有设计可沿用：
  - 标题 + 严重程度 Badge（low/medium/high）。
  - summary、suspected_causes、recommended_actions 列表。
  - 置信度与“依赖备注”的风险提示。

### 5.3 铭牌（nameplate_table_v1）

- PC 端重点支持“表格+同步到设备属性”：
  - 表格列：
    - "字段"（label）
    - "值"（value + 单位）
    - "置信度"（可用进度条或小数字显示）
  - 行点击交互：
    - 可在行右侧提供“设为设备属性”按钮（后续迭代），将某些字段同步写入设备模型（如 model、power_kw）。
  - 处理多版本：
    - 若同一 asset 有多个 `nameplate_table_v1` 版本，可按 `version` 或 `created_at` 展示最新一条，并提供“历史版本”折叠。

### 5.4 仪表（meter_reading_v1）

- 单资产详情页：
  - 顶部展示一个大号读数：
    - 主显示：`reading` + `unit`；若为 `fallback_to_pre_reading`，标注“基于预读数，待人工确认”。
  - 下方展示：
    - 预读数 vs LLM 读数：`pre_reading` / `reading` 对比。
    - `status` + `confidence` + summary。
- 多资产聚合（数据串联）：
  - 在设备详情页提供“仪表读数曲线”入口：
    - 聚合同一设备 + 同一测点（通过 content_role + tags 或 key 来识别）下的所有 `meter_reading_v1`：
      - x 轴：`asset.capture_time`
      - y 轴：`reading`
    - 若 status 为 `fallback_to_pre_reading` 或 `inconsistent_require_manual`，在点上标记特殊颜色/形状，提示需要人工复核。

---

## 6. 移动端展示设计

### 6.1 总体原则

- 移动端以“轻量查看 + 快速感知”为主，不做复杂报表编辑。
- 同样在资产详情页增加 "AI 解析" 区块，按类型展示简化版：
  - `scene_issue_report_v1`：简要标题 + 严重程度 + 2–3 行 summary。
  - `nameplate_table_v1`：纵向 Key-Value 列表（接近设置页面样式）。
  - `meter_reading_v1`：大号读数 + 简短状态标签（正常 / 待确认 / 需人工核实）。

### 6.2 铭牌表格（移动端）

- 使用类似 “表单详情” 的样式：
  - 每行：
    - 左侧：字段名（label），灰色小字显示英文 key（可选）。
    - 右侧：`value + unit`。
  - 置信度低的行可在右侧角标“小点状提示”（例如“AI 置信度低，建议核对”），不强制显示具体数值。
- 不在移动端做“同步到设备属性”的修改操作，避免复杂交互，留给 PC 完成。

### 6.3 仪表读数（移动端）

- 单条读数卡片：
  - 大字体显示 `reading` + `unit`。
  - 次要文本显示：
    - `status` 中文解释：
      - `confirmed_from_image` → "读数已由 AI 从图片识别"。
      - `fallback_to_pre_reading` → "基于人工预读，需人工确认"。
      - `inconsistent_require_manual` → "AI 结果与预读不一致，建议人工复核"。
    - 若有预读数，显示 `预读数: XX`，用于现场对比。

---

## 7. 与后续 PDF/OCR 的关系

- OCR 模块 `process_image_with_ocr` 保留，主要面向：
  - PDF 文档拆页生成的图片；
  - 图纸、长文本截图等需要全文 OCR 的场景。
- 与当前图像 LLM 管线解耦：
  - 路由不再直接调用 OCR；
  - 可在未来增加独立的 `pdf_ocr_worker`，产出新的 `schema_type`（如 `pdf_page_ocr_v1`），由 PC 端做全文检索和高亮展示。

---

## 8. 实施优先级建议

1. 后端 schema 与 worker 调整：
   - 定义 `NameplateTablePayload`、`MeterReadingPayload`。
   - 扩展 worker 路由逻辑与 Prompt。
2. PC 端：
   - 资产详情页新增 "AI 解析" 区块。
   - 实现铭牌表格与仪表读数卡片展示。
3. 移动端：
   - 资产详情页新增简化版 "AI 解析" 展示。

---

## 9. 实施进度与待办（更新于 2026-01-28）

### 9.1 已完成的实现

- **后端 / Worker**
  - 已在 `services/worker/scene_issue_glm_worker.py` 中实现：
    - `build_nameplate_prompt()` 与 `build_meter_prompt(pre_reading, note)`，并按 `content_role` 路由到不同的 schema（`scene_issue_report_v1` / `nameplate_table_v1` / `meter_reading_v1`）。
    - `get_pending_scene_assets()` 支持 `scene_issue` / `meter` / `nameplate` 三种角色。
  - `services/backend/app/api/v1/assets.py`：
    - `upload_image_with_note` 已接入 `meter_pre_reading`、`meter_location`，并写入 `asset.location_meta`。
    - 新增 `zone_label` 文本标签参数，用于资产的区域分区过滤（`location_meta["zone_label"]`）。

- **PC-UI**
  - `desktop/nicegui_app/pc_app.py`：
    - 右侧详情卡片已统一为“AI 识别结果”区块，仅保留一个“运行 AI 识别”按钮，调用 `/assets/{asset_id}/route_image`，不再单独暴露“运行 OCR”按钮。
    - 图片预览改为：选中图片资产时自动从后端下载并展示，不再依赖本地磁盘路径和手动预览按钮。
    - 资产详情面板通过 `structured_payloads` 文本化展示 `scene_issue_report_v1`、`nameplate_table_v1`、`meter_reading_v1` 的关键信息。

### 9.2 仍在设计 / 待办事项

- **PC-UI 展示细化**
  - 将当前“文本汇总”形式的 AI 结果，升级为文档中设想的：
    - 场景问题：独立卡片 + 严重程度 Badge + 建议列表。
    - 铭牌：真正的表格组件（字段 / 值 / 单位 / 置信度），并预留“同步到设备属性”的交互入口。
    - 仪表：大号读数卡片 + 预读数对比 + 状态枚举的中文解释。

- **移动端实现**
  - 按本设计中第 6 章的方案，在 Flutter 端资产详情页增加简化版 "AI 解析" 展示（目前仅完成后端与 PC-UI 验证）。

- **PDF/OCR 独立管线**
  - 保留 `process_image_with_ocr` 作为 PDF/图纸场景的基础能力，但尚未拆分为独立的 `pdf_ocr_worker` 与对应 schema（`pdf_page_ocr_v1`）。

本文件最初作为设计草案，现在已部分落地并持续迭代；后续字段命名和 UI 细节仍可根据实际使用反馈做小幅调整，但不再视为“仅草案”。
