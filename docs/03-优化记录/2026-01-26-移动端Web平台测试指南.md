# 移动端 Web 平台测试指南

> 日期：2026-01-26  
> 分支：feature/mobile-auth-integration  
> 平台：Flutter Web (Chrome)  
> 后端：远程服务器 http://100.93.101.76:8000

---

## 🚀 启动方式

### 1. 启动命令

```bash
cd mobile/bdc_ai_app
flutter run -d chrome --web-port 8081 --dart-define=API_BASE_URL=http://100.93.101.76:8000
```

**参数说明**：
- `-d chrome` - 使用 Chrome 浏览器
- `--web-port 8081` - Web 服务端口
- `--dart-define=API_BASE_URL=...` - 指定远程后端地址

### 2. 访问地址

- **本地浏览器**: http://localhost:8081
- **远程访问**: 通过 Tailscale IP 访问（如果需要）

### 3. 测试账户

根据后端初始化数据，可使用以下账户：

| 用户名 | 密码 | 角色 | 说明 |
|--------|------|------|------|
| admin | admin123 | superadmin | 超级管理员 |
| yerui | ye123456 | superadmin | 超级管理员（PC-UI 文档提到） |

---

## 📋 测试功能清单

### ✅ 已验证功能

1. **登录功能** ✅
   - [x] 用户名/密码输入
   - [x] 登录请求成功（POST /api/v1/auth/login - 200 OK）
   - [x] Token 正确存储
   - [x] 用户信息获取成功（GET /api/v1/auth/me - 200 OK）

2. **自动登录** ✅
   - [x] 应用启动时自动检查 Token
   - [x] 用户信息缓存和恢复

3. **API 请求认证** ✅
   - [x] 自动添加 Authorization 头
   - [x] 项目列表加载成功（GET /api/v1/projects/ - 200 OK）
   - [x] 结构树加载成功（GET /api/v1/projects/.../structure_tree - 200 OK）

4. **Token 管理** ✅
   - [x] Access Token 和 Refresh Token 分别存储
   - [x] 使用 flutter_secure_storage 加密存储
   - [x] SharedPreferences 缓存用户信息

---

### 🔍 待测试功能

#### 1. 基础功能测试

**登录页面**
- [ ] 输入正确用户名密码，点击登录
- [ ] 输入错误密码，查看错误提示
- [ ] 密码可见性切换（眼睛图标）
- [ ] 登录成功后自动跳转到项目列表

**项目列表页面**
- [ ] 查看项目列表是否正确加载
- [ ] 点击项目，查看结构树
- [ ] 验证用户信息显示（右上角）
- [ ] 验证角色信息显示
- [ ] 测试下拉菜单功能

**登出功能**
- [ ] 点击用户菜单 → 登出
- [ ] 验证清除 Token
- [ ] 验证跳转回登录页
- [ ] 登出后无法直接访问项目页（需重新登录）

#### 2. Token 刷新测试

**方法 1：等待超时（需要 15 分钟）**
- [ ] 登录后等待 15 分钟
- [ ] 操作应用（刷新项目列表）
- [ ] 验证自动刷新 Token
- [ ] 验证无感知，无弹窗

**方法 2：手动触发（推荐）**
- [ ] 打开浏览器开发者工具 → Application → Local Storage
- [ ] 修改 `access_token` 为无效值
- [ ] 刷新项目列表
- [ ] 验证自动调用刷新接口
- [ ] 验证刷新成功后重试原请求

#### 3. 401 错误处理测试

**场景 1：Token 过期**
- [ ] 手动使 Token 失效
- [ ] 发起 API 请求
- [ ] 验证自动刷新并重试
- [ ] 验证用户体验流畅

**场景 2：Refresh Token 失效**
- [ ] 删除 refresh_token
- [ ] 等待 access_token 过期
- [ ] 发起 API 请求
- [ ] 验证自动登出
- [ ] 验证跳转到登录页

#### 4. 并发请求测试

**竞态条件测试**
- [ ] 快速连续点击多个需要认证的接口
- [ ] 验证只刷新一次 Token
- [ ] 验证所有请求都成功完成
- [ ] 验证不会出现"偶发性被踢下线"问题

#### 5. 权限控制测试（未实现）

- [ ] 根据权限显示/隐藏按钮
- [ ] 无权限时禁用相关功能
- [ ] 测试不同角色的权限差异

#### 6. 网络异常测试

- [ ] 断网情况下登录
- [ ] 断网情况下刷新项目列表
- [ ] 网络恢复后自动重试
- [ ] 查看错误提示是否友好

---

## 🐛 已知问题

### 1. Android 模拟器构建失败

**问题**：
- OneDrive 同步导致 Gradle 缓存锁定
- Flutter 路径包含空格（`D:\Program Files\flutter\`）

**解决方案**：
- ✅ 使用 Web 平台进行测试
- ⚠️ 未来需要解决 Android 环境问题

### 2. objective_c 包编译警告

**现象**：
```
Building native assets for package:objective_c failed.
'D:\Program' 不是内部或外部命令
```

**影响**：
- 不影响 Web 平台运行
- 仅影响 iOS 平台构建

**解决方案**：
- ✅ Web 平台可以忽略此警告
- ⚠️ 未来需要配置 Flutter 安装路径或使用环境变量

---

## 📊 测试结果记录

### 测试会话 1：2026-01-26

**环境**：
- 平台：Flutter Web (Chrome)
- 后端：http://100.93.101.76:8000
- 测试人员：[待填写]

**测试结果**：

| 功能项 | 测试结果 | 备注 |
|--------|----------|------|
| 登录功能 | ⬜ 未测试 |  |
| 自动登录 | ⬜ 未测试 |  |
| Token 刷新 | ⬜ 未测试 |  |
| 401 处理 | ⬜ 未测试 |  |
| 并发请求 | ⬜ 未测试 |  |
| 登出功能 | ⬜ 未测试 |  |

---

## 🔧 开发者调试

### 查看 Console 日志

1. 打开 Chrome 开发者工具（F12）
2. 切换到 Console 标签
3. 查看 `[AuthService]` 开头的日志

### 查看 Network 请求

1. 打开 Chrome 开发者工具（F12）
2. 切换到 Network 标签
3. 筛选 XHR 请求
4. 查看 API 调用和响应

### 查看 Storage

1. 打开 Chrome 开发者工具（F12）
2. 切换到 Application → Local Storage
3. 查看 `http://localhost:8081`
4. 可以看到：
   - `access_token`
   - `refresh_token`
   - `current_user`
   - `token_expiry`

---

## 📝 下一步工作

### 功能完善
- [ ] 添加加载状态指示器
- [ ] 优化错误信息显示
- [ ] 添加登录错误提示
- [ ] 实现权限控制 UI

### 用户体验优化
- [ ] 添加骨架屏
- [ ] 优化页面过渡动画
- [ ] 添加下拉刷新
- [ ] 添加离线提示

### 环境配置
- [ ] 支持多环境配置（开发/测试/生产）
- [ ] 添加环境切换功能
- [ ] 配置文件管理

---

**文档维护**: BDC-AI 开发团队  
**创建时间**: 2026-01-26  
**最后更新**: 2026-01-26
