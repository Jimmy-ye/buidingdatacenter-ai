# BDC-AI 开发日志

> 覆盖范围：MVP 启动 → 2026-01-28
> 信息来源：`docs/00-项目总览/*`、`docs/03-优化记录/*`

---

## 2025-01-01 ~ 2025-01-21：MVP 搭建阶段

### ✅ 完成的功能
- **后端核心搭建**
  - FastAPI + PostgreSQL（从 SQLite 迁移）
  - 基础模型：Project / Building / System / Device / Asset / SensorData
  - API 网关 / 配置管理 / 基础测试

- **多模态 AI 能力**
  - 集成 PaddleOCR、GLM-4V
  - 场景问题、仪表读数识别
  - Prompt 设计与 JSON 结果结构化

- **工程结构与 PC UI MVP**
  - 工程结构树（Building/Zone/System/Device）
  - PC UI 初版（NiceGUI）：项目浏览、资产列表、AI 结果展示

### ⏳ 当时正在进行的工作
- 完善工程结构 API 与查询性能
- 梳理多模态数据中心表结构与索引

### 📋 未完成 / 计划中
- 正式版 Agent 编排（LangGraph 等）
- 时序数据与能耗仿真对接

---

## 2026-01-23：PC UI 架构升级 & 系统为主挂点方案

### ✅ 完成的功能 / 工作
- **PC UI 架构重构收尾**（见《项目进度总结》《PC UI重构完整记录》）
  - pc_app 从 1939 行精简到 1044 行，UI 拆分为 `ui/*`、状态拆分为 `state/*`、事件拆分为 `events/*`
  - 测试用例与文档更新，整体版本号到 0.4.0，MVP 完成度提升到 95%

### ⏳ 正在进行的工作
- **系统视角资产挂载设计**  
  - 文档：《2026-01-23-系统为主设备可选改造清单.md》
  - 明确：`system_id` 为主挂点，`device_id/zone_id` 可选，API 过滤规则已设计

### 📋 未完成 / 计划中
- 按文档实施数据库迁移（`assets.system_id` 等）
- 后端 `/assets` 查询与系统视角接口改造
- PC UI 与移动端按系统视角的资产视图与上传流程落地

---

## 2026-01-24：账号权限系统安全审查

### ✅ 完成的功能 / 工作
- **安全审查报告**（《2026-01-24-账号权限系统安全审查.md》）
  - 系统级认证、密码哈希、JWT 使用符合设计
  - 角色/权限模型、审计日志结构验证无重大偏差

### ⏳ 正在进行的工作（基于审查结论）
- 梳理业务 API（项目 / 资产 / 工程结构）与权限依赖差异
- 计划为 `UserRole`/`ProjectMember` 增加数据库唯一约束

### 📋 未完成 / 计划中
- 对所有业务 API 全面接入 `get_current_user` + `PermissionChecker`
- 修复 ORM 关系定义与唯一约束（报告中已列出具体字段）
- 强化生产环境 JWT 密钥、默认账号策略

---

## 2026-01-25：认证系统落地 + 后端部署完成

### ✅ 完成的功能 / 工作
- **认证系统实施与验证**（《2026-01-25-认证系统完整记录.md》）
  - 修复 `/api/v1/projects/` 未受保护问题
  - 完整测试 9/9 用例通过，认证系统达到生产级安全
  - 文档与测试记录更新完备

- **后端部署完成**（《后端部署完成总结.md》）
  - PostgreSQL、FastAPI、GLM-4V Worker 部署并联通
  - 本地访问与 Tailscale 远程访问（100.93.101.76）配置完成
  - 启动脚本与故障排查文档整理完毕

- **优化记录文档中心更新**（《03-优化记录/README.md》）
  - 建立优化文档索引与状态标记（✅ 最新 / ⏳ 待实施 / 📋 计划中）

### ⏳ 正在进行的工作
- 基于安全审查结果，对剩余业务端点逐步补充权限控制
- 完善部署脚本与监控/日志方案

### 📋 未完成 / 计划中
- MinIO 对象存储接入
- 更多 AI 分析模型扩展
- 部分前端界面（尤其移动端）与高级权限管理功能

---

## 2026-01-26：移动端认证与权限、缓存与环境联调、PC UI 联调

### ✅ 完成的功能 / 工作
- **移动端认证整合与测试通过**
  - 文档：《2026-01-26-移动端测试总结与问题修复.md》《2026-01-26-移动端认证测试结果.md》
  - 已实现：
    - 登录 / Token 管理（access + refresh，`flutter_secure_storage` 存储）
    - 自动登录（SharedPreferences 缓存用户信息）
    - `AuthService` + `AuthProvider` + `UserInfo/RoleInfo` 模型完整
    - Web 端测试验证：登录、`/auth/me`、项目列表、结构树请求均携带 `Authorization` 头成功

- **移动端核心功能与需求状态整理**
  - 文档：《移动端功能需求明确与实现计划.md》
  - 已完成功能（移动端视角）：
    - 项目列表、工程结构树、系统/设备资产视图
    - 拍照上传、批量删除（source=mobile）
    - 用户认证、权限模型（底层）

- **移动端权限控制底层能力完成**
  - 文档：《移动端权限控制实现状态分析.md》
  - `UserInfo.hasPermission` / `AuthService.hasPermission` / `AuthProvider.hasPermission` 已实现
  - 超级管理员拥有全部权限语义在移动端与 PC-UI 对齐

- **离线缓存与网络行为梳理**
  - 文档：《离线缓存功能与前后端传输条件详解.md》
  - 已实现：
    - 工程结构树缓存（SharedPreferences，24h 过期）
    - 图片缓存（`cached_network_image`）
  - 确认：项目列表缓存与"离线上传任务队列"尚未实现

- **PC-UI 远程后端联调与权限修复**
  - 文档：《PC-UI远程后端联调与权限修复记录.md》
  - 关键修复：
    - Windows 中文环境下 requirements 安装编码问题（`PYTHONUTF8=1`）
    - 结构树按钮、资产详情面板按钮的 None 判空
    - PC-UI 项目创建/更新补充 `Authorization: Bearer`，修复 403
    - PC-UI UI 版本号更新，便于验证前端是否为最新

- **移动端"添加设备"功能完成（P0）** ✨
  - 实施文档：`feature/mobile-auth-integration` 分支
  - 代码实现：
    - `lib/models/structure.dart`: 新增 `DeviceCreate` 模型（型号必填，其他可选）
    - `lib/config/constants.dart`: 新增 `createDevice(String systemId)` API 端点
    - `lib/services/project_service.dart`: 实现 `createDevice` API 方法
    - `lib/providers/structure_provider.dart`: 实现 `createDevice` 方法，支持自动刷新树
    - `lib/pages/structure_tree_page.dart`:
      - `SystemNode` 标题行添加"添加设备"按钮（`add_circle_outline` 图标）
      - 新增 `AddDeviceDialog` 对话框（StatefulWidget）
      - `_showAddDeviceDialog` 方法集成 `structures:create` 权限检查
  - 功能特性：
    - ✅ 权限检查：只有 `structures:create` 权限的用户可见按钮
    - ✅ 表单验证：型号必填，设备类型/额定功率/序列号/标签可选
    - ✅ 自动刷新：创建成功后自动刷新工程结构树
    - ✅ 用户友好：包含加载状态、成功/失败提示

- **移动端删除权限控制完成（P1）** ✨
  - 实施文档：`feature/mobile-auth-integration` 分支
  - 代码实现（`lib/pages/assets_page.dart`）：
    - 新增 `_canDeleteAssets` getter（检查 `assets:delete` 权限）
    - `_enterSelectionMode()` 方法添加权限检查
    - `_deleteSelectedAssets()` 方法添加权限检查
    - AppBar"选择删除"按钮根据权限条件显示（`if (_canDeleteAssets)`）
  - 功能特性：
    - ✅ UI 层控制：无权限用户看不到"选择删除"按钮
    - ✅ 方法层检查：即使绕过 UI，方法也会验证权限
    - ✅ 友好提示：权限不足时显示清晰的提示信息

### ⏳ 正在进行的工作
- **移动端权限在 UI 层的继续落地**
  - 按《移动端权限控制实现状态分析》：
    - ~~结构树新增节点按钮（`structures:create`）– P1~~ ✅ 已完成
    - ~~资产删除权限检查（`assets:delete`）– P1~~ ✅ 已完成
    - 项目创建/删除按钮（`projects:create/delete`）– P0
    - OCR/LLM 按钮权限（`assets:run_ocr/run_llm`）– P2

- **移动端 Token 自动刷新与并发场景进一步测试**
  - 刷新逻辑已按方案 A 实现（防止 401 并发导致误登出）
  - 测试清单中仍有：长时间空闲、并发请求、401 模拟等待补充验证

- **移动端功能测试与验证**
  - 添加设备功能：权限测试、表单验证测试、功能测试
  - 删除权限控制：有权限/无权限用户按钮显示、选择模式、删除操作测试

- **Android 真机/模拟器环境问题**
  - 目前主要依赖 Flutter Web（Chrome）进行登录与权限验证
  - Android 构建受 OneDrive/安装路径影响，仍待彻底解决

### 📋 未完成 / 计划中
- **离线上传与一键同步功能**
  - 需求：地下机房无信号连续拍照，回到有网环境后一键同步
  - 状态：仅完成离线“查看”缓存（结构树 + 图片），**未实现离线上传任务队列与自动重传**
  - 计划：在 `AssetProvider` 增加“待上传队列”与本地持久化（Hive/SharedPreferences），并提供“同步”入口

- **资产文件访问方案与迁移**
  - 文档：《资产文件访问方案与迁移计划.md》
  - 状态：方案与迁移步骤已明确，标记为“⏳ 待实施”

- **系统为主设备可选资产视角的端到端落地**
  - 后端迁移脚本、API 查询、PC UI 与移动端联动尚在规划/未实施阶段

---

## 2026-01-27：移动端离线缓存实现与版本更新

### ✅ 完成的功能 / 工作
- **移动端离线缓存能力落地（项目列表 + 工程结构树）**
  - 文档：《2026-01-27-移动端离线缓存实现记录.md》《离线缓存功能与前后端传输条件详解.md》
  - `lib/config/constants.dart`
    - 新增 `CacheKeys` 常量类，统一管理项目列表 / 工程结构树 / 离线模式等缓存键名
  - `lib/providers/structure_provider.dart`
    - 为工程结构树接入 SharedPreferences 缓存，实现 Cache-First + 24h 过期检查
    - 有缓存时先秒级展示上次数据，未过期则跳过网络请求
    - 网络异常时若有缓存则自动降级到缓存，不再直接白屏
    - 保持 401/403 仍由全局认证处理，不在结构页显示 403 错误 UI
  - `lib/providers/project_provider.dart`
    - 为项目列表接入 SharedPreferences 缓存，仅在无过滤条件时启用
    - 启动后首次从网络加载并写入缓存，24h 内再次访问直接用缓存
    - 网络异常时若有缓存则继续显示缓存数据，减少空白/报错页面

- **移动端登录页与 App 版本号更新**
  - `pubspec.yaml`：版本号从 `1.0.0+1` 升级为 `1.0.1+2`
  - `lib/pages/login_page.dart`：登录页底部文案更新为 `Version 1.0.1`

- **PC-UI 远程后端联调补完 & 资产交互修复**
  - 文档：《PC-UI远程后端联调与权限修复记录.md》
  - 在原有权限与项目创建修复基础上，进一步完成：
    - 资产表行点击事件适配新版 NiceGUI `rowClick` 事件结构（`[mouse_event, row_dict, row_index]`），确保始终能解析资产 `id` 并刷新右侧详情面板与预览
    - 上传图片资产对话框中补充 `inspect` 导入，修复 `name 'inspect' is not defined` 导致的文件字节丢失问题
    - 将 PC-UI 版本号更新为 `PC UI v0.3.10-permission-fix2`，用于区分“仅修到 0.3.9”与“包含资产点击/上传修复”的版本
  - 经验沉淀：强调以 Git 仓库为“真源”，避免在远程服务器上用旧版 `pc_app.py` / `auth_manager.py` 覆盖已修复版本，并通过右上角 UI 版本号快速校验真实运行代码

### ⏳ 正在进行的工作
- Android 真机 / 模拟器环境下对离线缓存行为的实际验证（含断网、弱网场景）
- 规划资产列表缓存与离线上传队列的实现路径（依赖现有缓存基础设施）

### 📋 未完成 / 计划中
- 资产列表离线缓存（按项目 / 系统 / 设备分层）
- 离线上传任务队列与一键同步入口
- UI 层“离线模式”提示条（基于缓存命中 / 网络状态的统一 Provider）

---

## 2026-01-28：LLM/OCR 图片管线测试套件与铭牌识别优化

### ✅ 完成的功能 / 工作

- **LLM/OCR 图片管线测试套件创建**
  - 文档：本节内容 + 测试文件 `tests/test_image_llm_pipeline.py`（18个测试用例）
  - 配置文件：`tests/conftest.py`（pytest 配置与共享 fixtures）
  - 测试覆盖：
    - 图片上传与路由（4个测试）：scene_issue、nameplate、meter 三种类型的上传与自动路由
    - Worker 处理模拟（4个测试）：验证三种 payload 的提交接口
    - Payload 结构验证（4个测试）：验证 schema 定义与字段类型
    - 端到端工作流（2个测试）：完整流程验证
    - 错误场景（4个测试）：异常处理与边界条件
  - 测试结果：**18/18 测试用例全部通过** ✅
  - 技术要点：
    - SQLite UUID/JSONB 类型兼容性处理（自定义 `StringUUID` 类型适配器）
    - 使用临时文件数据库（避免内存数据库在多连接间不共享的问题）
    - Mock LLM 响应数据，独立测试 API 端点与 Worker 处理逻辑

- **铭牌识别提示词优化** ⭐
  - 问题识别：原始提示词只有 2 个字段示例，GLM-4V 实际只识别出 2 个字段
  - 优化策略：
    1. **扩展示例字段**：从 2 个增加到 7 个（model、cooling_rated_capacity、power_kw、refrigerant、voltage_v、current_a、frequency_hz）
    2. **详细字段清单**：列出 15 种常见字段类型（model, power_kw, refrigerant, voltage_v, current_a, frequency_hz, flow_rate_m3h, head_m, pressure_kpa, rpm, weight_kg, noise_level_db 等）
    3. **强调完整性要求**：多次明确要求"尽可能完整地提取"、"不要遗漏"
    4. **针对性指导**：按设备类型说明应包含字段（冷水机组：型号、制冷量、额定功率、制冷剂、电压、电流、频率等）
  - 优化效果验证：字段识别数量从 **2 个 → 7 个**，提升 **250%** ✅
  - Worker 代码文件：`services/worker/scene_issue_glm_worker.py`
    - 新增 `build_nameplate_prompt()` 函数（第 218-283 行）
    - 新增 `post_nameplate_table()` 函数（第 376-387 行）
    - 新增 `post_meter_reading()` 函数（第 390-401 行）
    - 更新 `build_meter_prompt()` 函数（支持预读数，第 164-215 行）
    - 更新 `process_once()` 主处理函数（支持 3 种 content_role 路由，第 429-458 行）

- **Worker 支持 nameplate 和 meter 类型**
  - `get_pending_scene_assets()` 现在处理 3 种类型：scene_issue、meter、nameplate
  - 完整的 content_type 路由逻辑：
    - `nameplate` → `build_nameplate_prompt()` → `post_nameplate_table()`
    - `meter` → `build_meter_prompt(pre_reading, note)` → `post_meter_reading()`
    - `scene_issue` → `build_scene_prompt(note)` → `normalise_scene_payload()` → `post_scene_issue_report()`

- **仪表位置信息采集功能** ✨
  - 问题背景：现场仪表读数需要记录位置信息（如楼层、机房、回路号），便于后续追溯与管理
  - 后端实现（`services/backend/app/api/v1/assets.py`）：
    - 第 504-507 行：新增 `meter_location` Query 参数（可选字符串）
    - 第 548-558 行：将 `meter_location` 写入 `asset.location_meta["meter_location"]`
    - 与 `meter_pre_reading` 一并存入 location_meta，支持仪表图片的完整上下文记录
  - 前端实现（`desktop/nicegui_app/ui/dialogs.py`）：
    - 第 943 行：创建 `meter_location_input` 输入框（提示："仪表位置（可选，例如楼层/机房/回路号）"）
    - 第 945 行：默认隐藏输入框
    - 第 956-963 行：实现 `_update_meter_fields_visibility()` 函数，当 `content_role=meter` 时自动显示预读数和位置输入框
    - 第 1074-1076 行：上传时将 `meter_location` 参数发送给后端 API
  - 功能特性：
    - ✅ UI 条件显示：仅当选择"仪表(meter)"角色时显示"预读数"和"仪表位置"输入框
    - ✅ 可选输入：两个字段均为可选，不影响其他类型图片的上传
    - ✅ 数据持久化：位置信息与预读数一同存储在 `location_meta` JSON 字段
    - ✅ 用户友好：输入框提示包含常见位置示例（楼层/机房/回路号）

- **移动端 AI 解析与拍照上传体验优化**
  - `mobile/bdc_ai_app/lib/models/asset.dart`
    - `Asset.fromJson` 现在会遍历 `structured_payloads`，按 `schema_type` + `version` 折叠出每种 schema 的最新一条（`scene_issue_report_v1` / `nameplate_table_v1` / `meter_reading_v1`），并生成统一的 AI 文本摘要 `llmSummary`（场景问题 / 铭牌 / 仪表三种结果按固定顺序拼接）。
    - 移动端资产详情对话框中，原来的 "LLM 结果" 标题改为 "AI 解析"，与 PC-UI 术语保持一致。
  - `mobile/bdc_ai_app/lib/pages/assets_page.dart`
    - 系统/设备资产页在【无资产时】也会在空状态下方展示与【有资产时】相同的大号“拍照上传”按钮；提示文案更新为“点击右上角相机图标或下方按钮上传照片”，确保用户在任何状态下一眼能找到上传入口。

### 📊 关键成果数据

| 指标 | 优化前 | 优化后 | 提升 |
|------|--------|--------|------|
| **示例字段数** | 2 | 7 | +250% |
| **识别字段数** | 2 | 7 | +250% |
| **字段类型覆盖** | 简单列举 | 15种详细类型 | 大幅扩展 |
| **完整性要求** | 未强调 | 多次明确强调 | 显著提升 |
| **设备类型指导** | 无 | 按设备类型针对性说明 | 新增 |

### 🧪 测试验证

```bash
# 运行完整测试套件
pytest tests/test_image_llm_pipeline.py -v

# 结果：18 passed in 4.14s
```

测试用例分布：
- TestImageUploadAndRouting: 4 passed
- TestWorkerProcessing: 4 passed
- TestPayloadValidation: 4 passed
- TestEndToEndWorkflow: 2 passed
- TestErrorScenarios: 4 passed

### 📁 创建/修改的文件

**新增文件：**
1. `tests/conftest.py` - pytest 配置与共享 fixtures
2. `tests/test_image_llm_pipeline.py` - 主测试文件（18个测试用例）
3. `test_glm_nameplate_simple.py` - GLM 铭牌解析测试脚本
4. `test_worker_nameplate_full.py` - 完整 Worker 流程测试脚本
5. `nameplate_glm_output.json` - GLM 原始输出结果

**修改文件：**
1. `services/worker/scene_issue_glm_worker.py` - Worker 核心逻辑更新
   - 新增 `build_nameplate_prompt()` 函数
   - 新增 `post_nameplate_table()` 函数
   - 新增 `post_meter_reading()` 函数
   - 更新 `build_meter_prompt()` 函数签名
   - 更新 `process_once()` 主处理函数

2. `pytest.ini` - 添加 `pythonpath = .` 配置

3. `services/backend/app/api/v1/assets.py` - 后端 API 扩展
   - 新增 `meter_location` Query 参数（第 504-507 行）
   - 支持 `meter_location` 写入 `asset.location_meta`（第 548-558 行）

4. `desktop/nicegui_app/ui/dialogs.py` - PC UI 前端增强
   - 新增 `meter_location_input` 输入框（第 943 行）
   - 实现 `_update_meter_fields_visibility()` 条件显示逻辑（第 956-963 行）
   - 上传时发送 `meter_location` 参数到后端（第 1074-1076 行）

5. `docs/03-优化记录/开发日志.md` - 本文档，添加 meter_location 功能记录

### ⏳ 正在进行的工作
- 后端 OAuth2 认证集成测试（受认证限制，采用绕过方式直接测试 GLM API）
- Android 真机/模拟器环境下对完整流程的端到端测试

### 📋 未完成 / 计划中
- 完整的 Worker 轮询机制测试与监控
- 更多设备类型的铭牌识别（风机、水泵、锅炉等）
- 提示词进一步优化（根据实际使用反馈迭代）
- 基于工程结构 Zone + 文本 `zone_label` 的"按区域查看设备/能耗"视图设计与实现

---

## 使用说明

- 本日志抽象了关键时间点的"已完成 / 正在进行 / 未完成"工作，方便快速回顾项目演进。
- 后续每新增一篇 `03-优化记录/20xx-xx-xx-*.md`，建议同步在本文件中追加一个日期小节，更新对应的功能状态。
