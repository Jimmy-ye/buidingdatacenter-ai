# BDC-AI 开发日志

> 覆盖范围：MVP 启动 → 2026-01-27
> 信息来源：`docs/00-项目总览/*`、`docs/03-优化记录/*`

---

## 2025-01-01 ~ 2025-01-21：MVP 搭建阶段

### ✅ 完成的功能
- **后端核心搭建**
  - FastAPI + PostgreSQL（从 SQLite 迁移）
  - 基础模型：Project / Building / System / Device / Asset / SensorData
  - API 网关 / 配置管理 / 基础测试

- **多模态 AI 能力**
  - 集成 PaddleOCR、GLM-4V
  - 场景问题、仪表读数识别
  - Prompt 设计与 JSON 结果结构化

- **工程结构与 PC UI MVP**
  - 工程结构树（Building/Zone/System/Device）
  - PC UI 初版（NiceGUI）：项目浏览、资产列表、AI 结果展示

### ⏳ 当时正在进行的工作
- 完善工程结构 API 与查询性能
- 梳理多模态数据中心表结构与索引

### 📋 未完成 / 计划中
- 正式版 Agent 编排（LangGraph 等）
- 时序数据与能耗仿真对接

---

## 2026-01-23：PC UI 架构升级 & 系统为主挂点方案

### ✅ 完成的功能 / 工作
- **PC UI 架构重构收尾**（见《项目进度总结》《PC UI重构完整记录》）
  - pc_app 从 1939 行精简到 1044 行，UI 拆分为 `ui/*`、状态拆分为 `state/*`、事件拆分为 `events/*`
  - 测试用例与文档更新，整体版本号到 0.4.0，MVP 完成度提升到 95%

### ⏳ 正在进行的工作
- **系统视角资产挂载设计**  
  - 文档：《2026-01-23-系统为主设备可选改造清单.md》
  - 明确：`system_id` 为主挂点，`device_id/zone_id` 可选，API 过滤规则已设计

### 📋 未完成 / 计划中
- 按文档实施数据库迁移（`assets.system_id` 等）
- 后端 `/assets` 查询与系统视角接口改造
- PC UI 与移动端按系统视角的资产视图与上传流程落地

---

## 2026-01-24：账号权限系统安全审查

### ✅ 完成的功能 / 工作
- **安全审查报告**（《2026-01-24-账号权限系统安全审查.md》）
  - 系统级认证、密码哈希、JWT 使用符合设计
  - 角色/权限模型、审计日志结构验证无重大偏差

### ⏳ 正在进行的工作（基于审查结论）
- 梳理业务 API（项目 / 资产 / 工程结构）与权限依赖差异
- 计划为 `UserRole`/`ProjectMember` 增加数据库唯一约束

### 📋 未完成 / 计划中
- 对所有业务 API 全面接入 `get_current_user` + `PermissionChecker`
- 修复 ORM 关系定义与唯一约束（报告中已列出具体字段）
- 强化生产环境 JWT 密钥、默认账号策略

---

## 2026-01-25：认证系统落地 + 后端部署完成

### ✅ 完成的功能 / 工作
- **认证系统实施与验证**（《2026-01-25-认证系统完整记录.md》）
  - 修复 `/api/v1/projects/` 未受保护问题
  - 完整测试 9/9 用例通过，认证系统达到生产级安全
  - 文档与测试记录更新完备

- **后端部署完成**（《后端部署完成总结.md》）
  - PostgreSQL、FastAPI、GLM-4V Worker 部署并联通
  - 本地访问与 Tailscale 远程访问（100.93.101.76）配置完成
  - 启动脚本与故障排查文档整理完毕

- **优化记录文档中心更新**（《03-优化记录/README.md》）
  - 建立优化文档索引与状态标记（✅ 最新 / ⏳ 待实施 / 📋 计划中）

### ⏳ 正在进行的工作
- 基于安全审查结果，对剩余业务端点逐步补充权限控制
- 完善部署脚本与监控/日志方案

### 📋 未完成 / 计划中
- MinIO 对象存储接入
- 更多 AI 分析模型扩展
- 部分前端界面（尤其移动端）与高级权限管理功能

---

## 2026-01-26：移动端认证与权限、缓存与环境联调、PC UI 联调

### ✅ 完成的功能 / 工作
- **移动端认证整合与测试通过**
  - 文档：《2026-01-26-移动端测试总结与问题修复.md》《2026-01-26-移动端认证测试结果.md》
  - 已实现：
    - 登录 / Token 管理（access + refresh，`flutter_secure_storage` 存储）
    - 自动登录（SharedPreferences 缓存用户信息）
    - `AuthService` + `AuthProvider` + `UserInfo/RoleInfo` 模型完整
    - Web 端测试验证：登录、`/auth/me`、项目列表、结构树请求均携带 `Authorization` 头成功

- **移动端核心功能与需求状态整理**
  - 文档：《移动端功能需求明确与实现计划.md》
  - 已完成功能（移动端视角）：
    - 项目列表、工程结构树、系统/设备资产视图
    - 拍照上传、批量删除（source=mobile）
    - 用户认证、权限模型（底层）

- **移动端权限控制底层能力完成**
  - 文档：《移动端权限控制实现状态分析.md》
  - `UserInfo.hasPermission` / `AuthService.hasPermission` / `AuthProvider.hasPermission` 已实现
  - 超级管理员拥有全部权限语义在移动端与 PC-UI 对齐

- **离线缓存与网络行为梳理**
  - 文档：《离线缓存功能与前后端传输条件详解.md》
  - 已实现：
    - 工程结构树缓存（SharedPreferences，24h 过期）
    - 图片缓存（`cached_network_image`）
  - 确认：项目列表缓存与"离线上传任务队列"尚未实现

- **PC-UI 远程后端联调与权限修复**
  - 文档：《PC-UI远程后端联调与权限修复记录.md》
  - 关键修复：
    - Windows 中文环境下 requirements 安装编码问题（`PYTHONUTF8=1`）
    - 结构树按钮、资产详情面板按钮的 None 判空
    - PC-UI 项目创建/更新补充 `Authorization: Bearer`，修复 403
    - PC-UI UI 版本号更新，便于验证前端是否为最新

- **移动端"添加设备"功能完成（P0）** ✨
  - 实施文档：`feature/mobile-auth-integration` 分支
  - 代码实现：
    - `lib/models/structure.dart`: 新增 `DeviceCreate` 模型（型号必填，其他可选）
    - `lib/config/constants.dart`: 新增 `createDevice(String systemId)` API 端点
    - `lib/services/project_service.dart`: 实现 `createDevice` API 方法
    - `lib/providers/structure_provider.dart`: 实现 `createDevice` 方法，支持自动刷新树
    - `lib/pages/structure_tree_page.dart`:
      - `SystemNode` 标题行添加"添加设备"按钮（`add_circle_outline` 图标）
      - 新增 `AddDeviceDialog` 对话框（StatefulWidget）
      - `_showAddDeviceDialog` 方法集成 `structures:create` 权限检查
  - 功能特性：
    - ✅ 权限检查：只有 `structures:create` 权限的用户可见按钮
    - ✅ 表单验证：型号必填，设备类型/额定功率/序列号/标签可选
    - ✅ 自动刷新：创建成功后自动刷新工程结构树
    - ✅ 用户友好：包含加载状态、成功/失败提示

- **移动端删除权限控制完成（P1）** ✨
  - 实施文档：`feature/mobile-auth-integration` 分支
  - 代码实现（`lib/pages/assets_page.dart`）：
    - 新增 `_canDeleteAssets` getter（检查 `assets:delete` 权限）
    - `_enterSelectionMode()` 方法添加权限检查
    - `_deleteSelectedAssets()` 方法添加权限检查
    - AppBar"选择删除"按钮根据权限条件显示（`if (_canDeleteAssets)`）
  - 功能特性：
    - ✅ UI 层控制：无权限用户看不到"选择删除"按钮
    - ✅ 方法层检查：即使绕过 UI，方法也会验证权限
    - ✅ 友好提示：权限不足时显示清晰的提示信息

### ⏳ 正在进行的工作
- **移动端权限在 UI 层的继续落地**
  - 按《移动端权限控制实现状态分析》：
    - ~~结构树新增节点按钮（`structures:create`）– P1~~ ✅ 已完成
    - ~~资产删除权限检查（`assets:delete`）– P1~~ ✅ 已完成
    - 项目创建/删除按钮（`projects:create/delete`）– P0
    - OCR/LLM 按钮权限（`assets:run_ocr/run_llm`）– P2

- **移动端 Token 自动刷新与并发场景进一步测试**
  - 刷新逻辑已按方案 A 实现（防止 401 并发导致误登出）
  - 测试清单中仍有：长时间空闲、并发请求、401 模拟等待补充验证

- **移动端功能测试与验证**
  - 添加设备功能：权限测试、表单验证测试、功能测试
  - 删除权限控制：有权限/无权限用户按钮显示、选择模式、删除操作测试

- **Android 真机/模拟器环境问题**
  - 目前主要依赖 Flutter Web（Chrome）进行登录与权限验证
  - Android 构建受 OneDrive/安装路径影响，仍待彻底解决

### 📋 未完成 / 计划中
- **离线上传与一键同步功能**
  - 需求：地下机房无信号连续拍照，回到有网环境后一键同步
  - 状态：仅完成离线“查看”缓存（结构树 + 图片），**未实现离线上传任务队列与自动重传**
  - 计划：在 `AssetProvider` 增加“待上传队列”与本地持久化（Hive/SharedPreferences），并提供“同步”入口

- **资产文件访问方案与迁移**
  - 文档：《资产文件访问方案与迁移计划.md》
  - 状态：方案与迁移步骤已明确，标记为“⏳ 待实施”

- **系统为主设备可选资产视角的端到端落地**
  - 后端迁移脚本、API 查询、PC UI 与移动端联动尚在规划/未实施阶段

---

## 使用说明

- 本日志抽象了关键时间点的“已完成 / 正在进行 / 未完成”工作，方便快速回顾项目演进。
- 后续每新增一篇 `03-优化记录/20xx-xx-xx-*.md`，建议同步在本文件中追加一个日期小节，更新对应的功能状态。
