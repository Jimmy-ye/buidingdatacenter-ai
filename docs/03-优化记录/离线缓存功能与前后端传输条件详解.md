# ç¦»çº¿ç¼“å­˜åŠŸèƒ½ä¸å‰åç«¯ä¼ è¾“æ¡ä»¶è¯¦è§£

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**ï¼š2026-01-23
**é€‚ç”¨é¡¹ç›®**ï¼šBDC-AI ç§»åŠ¨ç«¯
**ç›¸å…³æ–‡æ¡£**ï¼šmobile/DEV_CHECKLIST.md, mobile/PROJECT_PLAN.md

---

## ğŸ“š ç›®å½•

1. [ç¦»çº¿ç¼“å­˜åŠŸèƒ½æ¦‚è¿°](#ç¦»çº¿ç¼“å­˜åŠŸèƒ½æ¦‚è¿°)
2. [SharedPreferences ç¼“å­˜æœºåˆ¶](#sharedpreferences-ç¼“å­˜æœºåˆ¶)
3. [é¡¹ç›®ä¸­çš„ç¼“å­˜é…ç½®](#é¡¹ç›®ä¸­çš„ç¼“å­˜é…ç½®)
4. [å‰åç«¯ä¼ è¾“æ¡ä»¶](#å‰åç«¯ä¼ è¾“æ¡ä»¶)
5. [ç½‘ç»œå±‚å®ç°](#ç½‘ç»œå±‚å®ç°)
6. [å®Œæ•´çš„ç¼“å­˜å®ç°ç¤ºä¾‹](#å®Œæ•´çš„ç¼“å­˜å®ç°ç¤ºä¾‹)
7. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)

---

## ğŸ“– ç¦»çº¿ç¼“å­˜åŠŸèƒ½æ¦‚è¿°

### ä»€ä¹ˆæ˜¯ç¦»çº¿ç¼“å­˜ï¼Ÿ

**ç¦»çº¿ç¼“å­˜ï¼ˆOffline Cacheï¼‰**æ˜¯æŒ‡ç§»åŠ¨ç«¯åº”ç”¨å°†ç½‘ç»œè¯·æ±‚çš„æ•°æ®å­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨å™¨ä¸­ï¼Œä½¿å¾—ï¼š
- âœ… åœ¨æ— ç½‘ç»œæˆ–ç½‘ç»œä¸ç¨³å®šæ—¶ï¼Œç”¨æˆ·ä»å¯æŸ¥çœ‹å†å²æ•°æ®
- âœ… å‡å°‘é‡å¤çš„ç½‘ç»œè¯·æ±‚ï¼Œæå‡åº”ç”¨æ€§èƒ½
- âœ… èŠ‚çœç”¨æˆ·æµé‡ï¼ŒåŠ å¿«æ•°æ®åŠ è½½é€Ÿåº¦
- âœ… æå‡ç”¨æˆ·ä½“éªŒï¼Œé¿å…ç™½å±å’ŒåŠ è½½ç­‰å¾…

### ç¦»çº¿ç¼“å­˜çš„ç±»å‹

| ç¼“å­˜ç±»å‹ | å­˜å‚¨ä½ç½® | å®¹é‡é™åˆ¶ | é€‚ç”¨åœºæ™¯ | é¡¹ç›®ä½¿ç”¨ |
|----------|----------|----------|----------|----------|
| **SharedPreferences** | é”®å€¼å¯¹æ–‡ä»¶ | ~1MB | é…ç½®ã€æ ‡è®°ã€å°‘é‡æ•°æ® | âœ… å·¥ç¨‹ç»“æ„ç¼“å­˜ |
| **SQLite** | å…³ç³»å‹æ•°æ®åº“ | æ— é™åˆ¶ | å¤§é‡ç»“æ„åŒ–æ•°æ® | âŒ æš‚ä¸ä½¿ç”¨ |
| **Hive** | NoSQL æ•°æ®åº“ | æ— é™åˆ¶ | å¯¹è±¡å­˜å‚¨ | âŒ æš‚ä¸ä½¿ç”¨ |
| **æ–‡ä»¶ç³»ç»Ÿ** | æ–‡ä»¶å¤¹å’Œæ–‡ä»¶ | å–å†³äºå­˜å‚¨ç©ºé—´ | å›¾ç‰‡ã€è§†é¢‘ã€æ–‡æ¡£ | âŒ æš‚ä¸ä½¿ç”¨ |
| **cached_network_image** | å†…å­˜+ç£ç›˜ | è‡ªåŠ¨ç®¡ç† | ç½‘ç»œå›¾ç‰‡ç¼“å­˜ | âœ… å›¾ç‰‡ç¼“å­˜ |

### æœ¬é¡¹ç›®çš„ç¼“å­˜ç­–ç•¥

**å·²å®ç°**ï¼š
- âœ… `cached_network_image` - ç½‘ç»œå›¾ç‰‡è‡ªåŠ¨ç¼“å­˜ï¼ˆå·²é…ç½®ï¼‰
- âœ… `shared_preferences` - å·¥ç¨‹ç»“æ„æ ‘ç¼“å­˜ï¼ˆå·²æ·»åŠ ä¾èµ–ï¼Œå¾…å®ç°ï¼‰

**å¾…å®ç°**ï¼š
- â³ å·¥ç¨‹ç»“æ„æ ‘çš„ 24 å°æ—¶ç¼“å­˜
- â³ é¡¹ç›®åˆ—è¡¨çš„æœ¬åœ°ç¼“å­˜
- â³ ç¦»çº¿æ¨¡å¼æç¤º

---

## ğŸ”§ SharedPreferences ç¼“å­˜æœºåˆ¶

### SharedPreferences ç‰¹ç‚¹

**ä¼˜ç‚¹**ï¼š
- âœ… ç®€å•æ˜“ç”¨ï¼Œé”®å€¼å¯¹å­˜å‚¨
- âœ… åŸç”Ÿæ”¯æŒï¼Œæ€§èƒ½ä¼˜ç§€
- âœ… æŒä¹…åŒ–å­˜å‚¨ï¼Œåº”ç”¨å…³é—­åæ•°æ®ä¸ä¸¢å¤±
- âœ… æ”¯æŒ Stringã€intã€doubleã€boolã€List<String>

**ç¼ºç‚¹**ï¼š
- âŒ åªæ”¯æŒç®€å•æ•°æ®ç±»å‹
- âŒ ä¸æ”¯æŒå¤æ‚å¯¹è±¡ï¼ˆéœ€è¦ JSON åºåˆ—åŒ–ï¼‰
- âŒ å®¹é‡é™åˆ¶ï¼ˆçº¦ 1MBï¼‰
- âŒ ä¸æ”¯æŒå…³ç³»æŸ¥è¯¢

### æ”¯æŒçš„æ•°æ®ç±»å‹

```dart
// SharedPreferences æ”¯æŒçš„æ•°æ®ç±»å‹
String           // å­—ç¬¦ä¸²
int              // æ•´æ•°
double           // æµ®ç‚¹æ•°
bool             // å¸ƒå°”å€¼
List<String>     // å­—ç¬¦ä¸²åˆ—è¡¨
// âš ï¸ ä¸æ”¯æŒï¼šè‡ªå®šä¹‰å¯¹è±¡ã€Mapã€åµŒå¥—åˆ—è¡¨
```

### åŸºæœ¬ç”¨æ³•

```dart
import 'package:shared_preferences/shared_preferences.dart';

// 1. è·å–å®ä¾‹
final prefs = await SharedPreferences.getInstance();

// 2. å†™å…¥æ•°æ®
await prefs.setString('key', 'value');
await prefs.setInt('count', 10);
await prefs.setBool('is_logged_in', true);
await prefs.setDouble('price', 99.99);
await prefs.setStringList('tags', ['flutter', 'dart']);

// 3. è¯»å–æ•°æ®
String? value = prefs.getString('key');
int? count = prefs.getInt('count');
bool? isLoggedIn = prefs.getBool('is_logged_in');
double? price = prefs.getDouble('price');
List<String>? tags = prefs.getStringList('tags');

// 4. åˆ é™¤æ•°æ®
await prefs.remove('key');

// 5. æ¸…ç©ºæ‰€æœ‰æ•°æ®
await prefs.clear();

// 6. æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨
bool hasKey = prefs.containsKey('key');
```

---

## ğŸ“¦ é¡¹ç›®ä¸­çš„ç¼“å­˜é…ç½®

### 1. ä¾èµ–é…ç½®ï¼ˆå·²æ·»åŠ ï¼‰

**æ–‡ä»¶**ï¼š`mobile/bdc_ai_app/pubspec.yaml`

```yaml
dependencies:
  # å…±äº«åå¥½ï¼ˆç¦»çº¿ç¼“å­˜ï¼‰
  shared_preferences: ^2.2.2
```

### 2. ç¼“å­˜å¸¸é‡é…ç½®

**æ–‡ä»¶**ï¼š`mobile/bdc_ai_app/lib/config/constants.dart`

```dart
/// åº”ç”¨é…ç½®å¸¸é‡
class AppConfig {
  /// API åŸºç¡€ URL
  static const String baseUrl = 'http://localhost:8000';

  /// API è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  static const int apiTimeout = 30000;

  /// èµ„äº§åˆ—è¡¨é»˜è®¤åŠ è½½æ•°é‡
  static const int defaultAssetLimit = 5;

  /// â­ ç¦»çº¿ç¼“å­˜æ—¶é•¿ï¼ˆå°æ—¶ï¼‰
  static const int cacheDurationHours = 24;
}
```

### 3. ç¼“å­˜é”®åè§„èŒƒ

**å»ºè®®çš„ç¼“å­˜é”®å**ï¼š

```dart
/// ç¼“å­˜é”®åå¸¸é‡
class CacheKeys {
  // é¡¹ç›®ç›¸å…³
  static const String projectList = 'cache_project_list';
  static const String projectListTimestamp = 'cache_project_list_timestamp';

  // å·¥ç¨‹ç»“æ„æ ‘
  static const String structureTree = 'cache_structure_tree_'; // + projectId
  static const String structureTreeTimestamp = 'cache_structure_tree_timestamp_'; // + projectId

  // ç”¨æˆ·è®¾ç½®
  static const String lastSelectedProject = 'last_selected_project';
  static const String apiBaseUrl = 'api_base_url';

  // ç¦»çº¿æ¨¡å¼æ ‡è®°
  static const String offlineMode = 'offline_mode_enabled';
}
```

---

## ğŸŒ å‰åç«¯ä¼ è¾“æ¡ä»¶

### 1. ç½‘ç»œè¿æ¥è¦æ±‚

#### åç«¯æœåŠ¡å™¨æ¡ä»¶

**å¿…é¡»æ»¡è¶³**ï¼š
- âœ… åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œï¼ˆ`python -m uvicorn services.backend.app.main:app --reload`ï¼‰
- âœ… ç›‘å¬ç«¯å£å¯è®¿é—®ï¼ˆé»˜è®¤ `localhost:8000` æˆ– `10.0.2.2:8000`ï¼‰
- âœ… CORS é…ç½®å…è®¸ç§»åŠ¨ç«¯æ¥æº

**åç«¯ CORS é…ç½®**ï¼ˆå·²å®Œæˆï¼‰ï¼š

**æ–‡ä»¶**ï¼š`services/backend/app/main.py`

```python
from fastapi.middleware.cors import CORSMiddleware

# é…ç½® CORS ä¸­é—´ä»¶ â­
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:3000",
        "http://127.0.0.1:3000",
        "*",  # å¼€å‘ç¯å¢ƒå…è®¸æ‰€æœ‰æ¥æºï¼ˆç”Ÿäº§ç¯å¢ƒåº”é™åˆ¶å…·ä½“åŸŸåï¼‰
    ],
    allow_credentials=True,
    allow_methods=["*"],  # å…è®¸æ‰€æœ‰ HTTP æ–¹æ³•
    allow_headers=["*"],  # å…è®¸æ‰€æœ‰è¯·æ±‚å¤´
)
```

#### ç§»åŠ¨ç«¯ç½‘ç»œé…ç½®

**Android æ¨¡æ‹Ÿå™¨**ï¼š
```dart
// lib/config/constants.dart
static const String baseUrl = 'http://10.0.2.2:8000';
```
- âœ… `10.0.2.2` æ˜¯ Android æ¨¡æ‹Ÿå™¨è®¿é—®ä¸»æœºçš„ç‰¹æ®Š IP
- âŒ ä¸èƒ½ä½¿ç”¨ `localhost`ï¼ˆæ¨¡æ‹Ÿå™¨çš„ localhost æŒ‡å‘æ¨¡æ‹Ÿå™¨è‡ªå·±ï¼‰

**çœŸæœºè®¾å¤‡**ï¼š
```dart
static const String baseUrl = 'http://YOUR_PC_IP:8000';
// ä¾‹å¦‚ï¼šhttp://192.168.1.100:8000
```
- âœ… ä½¿ç”¨ä¸»æœºåœ¨å±€åŸŸç½‘ä¸­çš„ IP åœ°å€
- âœ… æ‰‹æœºå’Œç”µè„‘è¿æ¥åŒä¸€ Wi-Fi
- âœ… é˜²ç«å¢™å…è®¸ 8000 ç«¯å£

**Web ç‰ˆ**ï¼š
```dart
static const String baseUrl = 'http://localhost:8000';
```
- âœ… Web ç‰ˆå¯ä»¥ç›´æ¥ä½¿ç”¨ localhost

### 2. HTTP è¯·æ±‚æ ¼å¼è¦æ±‚

#### GET è¯·æ±‚ï¼ˆæŸ¥è¯¢æ•°æ®ï¼‰

```dart
// ç¤ºä¾‹ï¼šè·å–é¡¹ç›®åˆ—è¡¨
GET http://localhost:8000/api/v1/projects/

// å“åº”ï¼ˆJSONï¼‰
[
  {
    "id": "uuid-1",
    "name": "æ¼”ç¤ºé¡¹ç›®",
    "customer": "å®¢æˆ·åç§°",
    "address": "é¡¹ç›®åœ°å€",
    "status": "active"
  }
]
```

#### POST è¯·æ±‚ï¼ˆä¸Šä¼ æ•°æ®ï¼‰

**å…³é”®**ï¼šåŒºåˆ† Query å‚æ•°å’Œ Form å‚æ•°

```dart
// ç¤ºä¾‹ï¼šä¸Šä¼ å›¾ç‰‡
POST http://localhost:8000/api/v1/assets/upload_image_with_note

// â­ Query å‚æ•°ï¼ˆåœ¨ URL ä¸­ï¼‰
?project_id=xxx&source=mobile&device_id=yyy&content_role=scene_issue&auto_route=true

// â­ Form å‚æ•°ï¼ˆåœ¨è¯·æ±‚ä½“ä¸­ï¼‰
Content-Type: multipart/form-data; boundary=---WebKitFormBoundary
Content-Disposition: form-data; name="note"

è¿™æ˜¯å·¥ç¨‹å¸ˆå¤‡æ³¨

// â­ æ–‡ä»¶æ•°æ®
Content-Disposition: form-data; name="file"; filename="photo.jpg"
Content-Type: image/jpeg

[äºŒè¿›åˆ¶å›¾ç‰‡æ•°æ®]
```

**é”™è¯¯ç¤ºä¾‹**ï¼ˆå¯¼è‡´ HTTP 422ï¼‰ï¼š
```dart
// âŒ é”™è¯¯ï¼šæ‰€æœ‰å‚æ•°éƒ½æ”¾åœ¨ Form å­—æ®µä¸­
final fields = <String, String>{
  'project_id': projectId,  // âŒ åº”è¯¥åœ¨ URL ä¸­
  'source': 'mobile',        // âŒ åº”è¯¥åœ¨ URL ä¸­
  'note': note,              // âœ… æ­£ç¡®ï¼šnote å¯ä»¥åœ¨ Form ä¸­
};
```

**æ­£ç¡®ç¤ºä¾‹**ï¼š
```dart
// âœ… æ­£ç¡®ï¼šQuery å‚æ•°åœ¨ URLï¼ŒForm å‚æ•°åœ¨ body
var endpoint = '${ApiEndpoints.uploadImage}?project_id=$projectId&source=mobile';
if (deviceId != null) endpoint += '&device_id=$deviceId';
endpoint += '&content_role=$contentRole';
endpoint += '&auto_route=${autoRoute ? "true" : "false"}';

final fields = <String, String>{
  if (note != null) 'note': note,  // âœ… åªæœ‰ note åœ¨ Form ä¸­
};
```

### 3. å“åº”æ ¼å¼è¦æ±‚

**æˆåŠŸå“åº”**ï¼š
```json
HTTP 200 OK
Content-Type: application/json

{
  "id": "asset-uuid",
  "title": "èµ„äº§æ ‡é¢˜",
  "modality": "image",
  "source": "mobile",
  "created_at": "2026-01-23T10:30:00Z"
}
```

**é”™è¯¯å“åº”**ï¼š
```json
HTTP 422 Unprocessable Entity
Content-Type: application/json

{
  "detail": [
    {
      "loc": ["query", "project_id"],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
```

### 4. è¶…æ—¶å’Œé‡è¯•æœºåˆ¶

```dart
// lib/services/api_service.dart
class ApiService {
  static const int _timeoutMs = 30000; // 30 ç§’è¶…æ—¶

  Future<http.Response> get(String endpoint) async {
    try {
      final uri = Uri.parse('${ApiConfig.baseUrl}$endpoint');
      final response = await http
          .get(uri)
          .timeout(Duration(milliseconds: _timeoutMs));

      if (response.statusCode >= 200 && response.statusCode < 300) {
        return response;
      } else {
        throw ApiException(
          'HTTP ${response.statusCode}: ${response.body}',
          statusCode: response.statusCode,
        );
      }
    } on http.ClientException catch (e) {
      throw NetworkException('ç½‘ç»œè¿æ¥å¤±è´¥: $e');
    } on TimeoutException catch (e) {
      throw NetworkException('è¯·æ±‚è¶…æ—¶: $e');
    }
  }
}
```

---

## ğŸŒ ç½‘ç»œå±‚å®ç°

### ApiService å®Œæ•´å®ç°

**æ–‡ä»¶**ï¼š`mobile/bdc_ai_app/lib/services/api_service.dart`

```dart
import 'dart:async';
import 'dart:convert';
import 'dart:io';
import 'package:flutter/foundation.dart';
import 'package:http/http.dart' as http;
import 'package:http_parser/http_parser.dart';
import '../config/constants.dart';

/// API å¼‚å¸¸
class ApiException implements Exception {
  final String message;
  final int? statusCode;

  ApiException(this.message, {this.statusCode});

  @override
  String toString() => 'ApiException: $message (Status: $statusCode)';
}

/// ç½‘ç»œå¼‚å¸¸
class NetworkException implements Exception {
  final String message;

  NetworkException(this.message);

  @override
  String toString() => 'NetworkException: $message';
}

/// HTTP å®¢æˆ·ç«¯å°è£…
class ApiService {
  /// åŸºç¡€ URL
  final String baseUrl;

  /// è¶…æ—¶æ—¶é—´
  final int timeoutMs;

  ApiService({
    String? baseUrl,
    this.timeoutMs = AppConfig.apiTimeout,
  }) : baseUrl = baseUrl ?? AppConfig.baseUrl;

  /// GET è¯·æ±‚
  Future<http.Response> get(String endpoint) async {
    try {
      final uri = Uri.parse('$baseUrl$endpoint');
      debugPrint('GET: $uri');

      final response = await http
          .get(uri)
          .timeout(Duration(milliseconds: timeoutMs));

      _checkResponse(response);
      return response;
    } on SocketException catch (e) {
      throw NetworkException('ç½‘ç»œè¿æ¥å¤±è´¥: $e');
    } on TimeoutException catch (e) {
      throw NetworkException('è¯·æ±‚è¶…æ—¶: $e');
    } on HttpException catch (e) {
      throw NetworkException('HTTP é”™è¯¯: $e');
    }
  }

  /// POST è¯·æ±‚ï¼ˆJSONï¼‰
  Future<http.Response> post(
    String endpoint, {
    Map<String, dynamic>? body,
  }) async {
    try {
      final uri = Uri.parse('$baseUrl$endpoint');
      debugPrint('POST: $uri');
      debugPrint('Body: ${jsonEncode(body)}');

      final response = await http
          .post(
            uri,
            headers: {'Content-Type': 'application/json'},
            body: jsonEncode(body),
          )
          .timeout(Duration(milliseconds: timeoutMs));

      _checkResponse(response);
      return response;
    } on SocketException catch (e) {
      throw NetworkException('ç½‘ç»œè¿æ¥å¤±è´¥: $e');
    } on TimeoutException catch (e) {
      throw NetworkException('è¯·æ±‚è¶…æ—¶: $e');
    }
  }

  /// POST è¯·æ±‚ï¼ˆMultipart è¡¨å•ï¼‰
  Future<http.Response> postMultipart(
    String endpoint, {
    Map<String, String> fields = const {},
    List<http.MultipartFile> files = const [],
  }) async {
    try {
      final uri = Uri.parse('$baseUrl$endpoint');
      debugPrint('POST (Multipart): $uri');
      debugPrint('Fields: $fields');
      debugPrint('Files: ${files.length} ä¸ª');

      final request = http.MultipartRequest('POST', uri);

      // æ·»åŠ è¡¨å•å­—æ®µ
      request.fields.addAll(fields);

      // æ·»åŠ æ–‡ä»¶
      request.files.addAll(files);

      // å‘é€è¯·æ±‚
      final streamedResponse = await request.send().timeout(
        Duration(milliseconds: timeoutMs),
      );

      final response = await http.Response.fromStream(streamedResponse);

      _checkResponse(response);
      return response;
    } on SocketException catch (e) {
      throw NetworkException('ç½‘ç»œè¿æ¥å¤±è´¥: $e');
    } on TimeoutException catch (e) {
      throw NetworkException('è¯·æ±‚è¶…æ—¶: $e');
    }
  }

  /// DELETE è¯·æ±‚
  Future<http.Response> delete(String endpoint) async {
    try {
      final uri = Uri.parse('$baseUrl$endpoint');
      debugPrint('DELETE: $uri');

      final response = await http
          .delete(uri)
          .timeout(Duration(milliseconds: timeoutMs));

      _checkResponse(response);
      return response;
    } on SocketException catch (e) {
      throw NetworkException('ç½‘ç»œè¿æ¥å¤±è´¥: $e');
    } on TimeoutException catch (e) {
      throw NetworkException('è¯·æ±‚è¶…æ—¶: $e');
    }
  }

  /// æ£€æŸ¥å“åº”çŠ¶æ€
  void _checkResponse(http.Response response) {
    if (response.statusCode >= 200 && response.statusCode < 300) {
      return; // æˆåŠŸ
    }

    // è§£æé”™è¯¯ä¿¡æ¯
    String errorMessage;
    try {
      final data = jsonDecode(response.body);
      errorMessage = data['detail'] ?? 'Unknown error';
    } catch (e) {
      errorMessage = response.body;
    }

    throw ApiException(
      'HTTP ${response.statusCode}: $errorMessage',
      statusCode: response.statusCode,
    );
  }
}
```

---

## ğŸ’» å®Œæ•´çš„ç¼“å­˜å®ç°ç¤ºä¾‹

### å·¥ç¨‹ç»“æ„æ ‘ç¼“å­˜å®ç°

**æ–‡ä»¶**ï¼š`mobile/bdc_ai_app/lib/providers/structure_provider.dart`

```dart
import 'dart:convert';
import 'package:flutter/foundation.dart';
import 'package:shared_preferences/shared_preferences.dart';
import '../models/structure.dart';
import '../services/project_service.dart';
import '../config/constants.dart';

/// ç¼“å­˜é”®åå¸¸é‡
class CacheKeys {
  static const String structureTree = 'cache_structure_tree_';
  static const String structureTreeTimestamp = 'cache_structure_tree_timestamp_';
}

class StructureProvider extends ChangeNotifier {
  final ProjectService _service = ProjectService();

  // çŠ¶æ€
  List<Building> buildings = [];
  bool isLoading = false;
  String? errorMessage;

  // å±•å¼€/æŠ˜å çŠ¶æ€
  Set<String> _expandedBuildings = {};
  Set<String> _expandedSystems = {};

  /// è·å–å·¥ç¨‹ç»“æ„æ ‘ï¼ˆå¸¦ç¼“å­˜ï¼‰
  Future<void> loadStructureTree(String projectId) async {
    _setLoading(true);
    _clearError();

    try {
      // â­ 1. å°è¯•ä»ç¼“å­˜åŠ è½½
      final cachedData = await _loadFromCache(projectId);

      if (cachedData != null) {
        // æœ‰ç¼“å­˜ï¼Œå…ˆæ˜¾ç¤ºç¼“å­˜æ•°æ®
        debugPrint('ä½¿ç”¨ç¼“å­˜çš„å·¥ç¨‹ç»“æ„æ ‘');
        buildings = cachedData;
        notifyListeners();

        // æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ
        final isExpired = await _isCacheExpired(projectId);
        if (!isExpired) {
          // ç¼“å­˜æœªè¿‡æœŸï¼Œç›´æ¥ä½¿ç”¨
          debugPrint('ç¼“å­˜æœªè¿‡æœŸï¼Œè·³è¿‡ç½‘ç»œè¯·æ±‚');
          return;
        }

        debugPrint('ç¼“å­˜å·²è¿‡æœŸï¼Œåå°åˆ·æ–°æ•°æ®');
      }

      // â­ 2. ä»ç½‘ç»œåŠ è½½æœ€æ–°æ•°æ®
      debugPrint('ä»ç½‘ç»œåŠ è½½å·¥ç¨‹ç»“æ„æ ‘');
      buildings = await _service.getStructureTree(projectId);

      // â­ 3. ä¿å­˜åˆ°ç¼“å­˜
      await _saveToCache(projectId, buildings);

      notifyListeners();
    } catch (e) {
      // ç½‘ç»œè¯·æ±‚å¤±è´¥
      debugPrint('ç½‘ç»œè¯·æ±‚å¤±è´¥: $e');

      if (cachedData != null) {
        // æœ‰ç¼“å­˜æ•°æ®ï¼Œç»§ç»­ä½¿ç”¨ç¼“å­˜
        debugPrint('ç½‘ç»œå¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®');
        buildings = cachedData;
        errorMessage = null;
      } else {
        // æ— ç¼“å­˜æ•°æ®ï¼Œæ˜¾ç¤ºé”™è¯¯
        _setError('åŠ è½½å¤±è´¥: $e');
      }
    } finally {
      _setLoading(false);
    }
  }

  /// ä»ç¼“å­˜åŠ è½½æ•°æ®
  Future<List<Building>?> _loadFromCache(String projectId) async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final cacheKey = '${CacheKeys.structureTree}$projectId';
      final jsonString = prefs.getString(cacheKey);

      if (jsonString == null) {
        debugPrint('æ— ç¼“å­˜æ•°æ®');
        return null;
      }

      final List<dynamic> jsonData = jsonDecode(jsonString);
      return jsonData.map((json) => Building.fromJson(json)).toList();
    } catch (e) {
      debugPrint('è¯»å–ç¼“å­˜å¤±è´¥: $e');
      return null;
    }
  }

  /// ä¿å­˜åˆ°ç¼“å­˜
  Future<void> _saveToCache(String projectId, List<Building> data) async {
    try {
      final prefs = await SharedPreferences.getInstance();

      // ä¿å­˜æ•°æ®
      final cacheKey = '${CacheKeys.structureTree}$projectId';
      final jsonString = jsonEncode(data.map((b) => b.toJson()).toList());
      await prefs.setString(cacheKey, jsonString);

      // ä¿å­˜æ—¶é—´æˆ³
      final timestampKey = '${CacheKeys.structureTreeTimestamp}$projectId';
      final timestamp = DateTime.now().millisecondsSinceEpoch;
      await prefs.setInt(timestampKey, timestamp);

      debugPrint('å·²ç¼“å­˜å·¥ç¨‹ç»“æ„æ ‘ï¼Œæœ‰æ•ˆæœŸ ${AppConfig.cacheDurationHours} å°æ—¶');
    } catch (e) {
      debugPrint('ä¿å­˜ç¼“å­˜å¤±è´¥: $e');
    }
  }

  /// æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ
  Future<bool> _isCacheExpired(String projectId) async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final timestampKey = '${CacheKeys.structureTreeTimestamp}$projectId';
      final timestamp = prefs.getInt(timestampKey);

      if (timestamp == null) {
        return true; // æ— æ—¶é—´æˆ³ï¼Œè§†ä¸ºè¿‡æœŸ
      }

      final cacheTime = DateTime.fromMillisecondsSinceEpoch(timestamp);
      final now = DateTime.now();
      final difference = now.difference(cacheTime);

      final isExpired = difference.inHours >= AppConfig.cacheDurationHours;

      debugPrint('ç¼“å­˜æ—¶é—´: $cacheTime');
      debugPrint('å½“å‰æ—¶é—´: $now');
      debugPrint('ç¼“å­˜æ—¶é•¿: ${difference.inHours} å°æ—¶');
      debugPrint('æ˜¯å¦è¿‡æœŸ: $isExpired');

      return isExpired;
    } catch (e) {
      debugPrint('æ£€æŸ¥ç¼“å­˜è¿‡æœŸå¤±è´¥: $e');
      return true; // å‡ºé”™æ—¶è§†ä¸ºè¿‡æœŸ
    }
  }

  /// æ¸…é™¤ç¼“å­˜
  Future<void> clearCache(String projectId) async {
    try {
      final prefs = await SharedPreferences.getInstance();

      await prefs.remove('${CacheKeys.structureTree}$projectId');
      await prefs.remove('${CacheKeys.structureTreeTimestamp}$projectId');

      debugPrint('å·²æ¸…é™¤å·¥ç¨‹ç»“æ„æ ‘ç¼“å­˜');
    } catch (e) {
      debugPrint('æ¸…é™¤ç¼“å­˜å¤±è´¥: $e');
    }
  }

  // ... å…¶ä»–æ–¹æ³•ï¼ˆtoggleBuilding, toggleSystem ç­‰ï¼‰
}
```

### ä½¿ç”¨æ•ˆæœ

```dart
// ç¬¬ä¸€æ¬¡åŠ è½½ï¼ˆæ— ç½‘ç»œï¼‰
// 1. ä»ç¼“å­˜åŠ è½½ â†’ å¤±è´¥ï¼ˆæ— ç¼“å­˜ï¼‰
// 2. ä»ç½‘ç»œåŠ è½½ â†’ å¤±è´¥ï¼ˆæ— ç½‘ç»œï¼‰
// 3. æ˜¾ç¤ºé”™è¯¯æç¤º

// ç¬¬äºŒæ¬¡åŠ è½½ï¼ˆæœ‰ç½‘ç»œï¼‰
// 1. ä»ç¼“å­˜åŠ è½½ â†’ å¤±è´¥ï¼ˆæ— ç¼“å­˜ï¼‰
// 2. ä»ç½‘ç»œåŠ è½½ â†’ æˆåŠŸ
// 3. ä¿å­˜åˆ°ç¼“å­˜
// 4. æ˜¾ç¤ºæ•°æ®

// ç¬¬ä¸‰æ¬¡åŠ è½½ï¼ˆæ— ç½‘ç»œï¼Œä½†24å°æ—¶å†…ï¼‰
// 1. ä»ç¼“å­˜åŠ è½½ â†’ æˆåŠŸ
// 2. æ˜¾ç¤ºç¼“å­˜æ•°æ®
// 3. æ£€æŸ¥ç¼“å­˜æ—¶é—´ â†’ æœªè¿‡æœŸ
// 4. è·³è¿‡ç½‘ç»œè¯·æ±‚
// 5. ç”¨æˆ·çœ‹åˆ°æ•°æ®ï¼ˆç¦»çº¿å¯ç”¨ï¼‰âœ…

// ç¬¬å››æ¬¡åŠ è½½ï¼ˆæ— ç½‘ç»œï¼Œè¶…è¿‡24å°æ—¶ï¼‰
// 1. ä»ç¼“å­˜åŠ è½½ â†’ æˆåŠŸ
// 2. æ˜¾ç¤ºç¼“å­˜æ•°æ®ï¼ˆæ—§æ•°æ®ï¼‰
// 3. æ£€æŸ¥ç¼“å­˜æ—¶é—´ â†’ å·²è¿‡æœŸ
// 4. å°è¯•åå°åˆ·æ–° â†’ å¤±è´¥ï¼ˆæ— ç½‘ç»œï¼‰
// 5. ç»§ç»­ä½¿ç”¨æ—§æ•°æ®ï¼ˆç”¨æˆ·å¯è§ï¼Œä½†å¯èƒ½æ˜¾ç¤º"æ•°æ®å¯èƒ½å·²è¿‡æœŸ"æç¤ºï¼‰
```

---

## â“ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1ï¼šAndroid æ¨¡æ‹Ÿå™¨æ— æ³•è¿æ¥åç«¯

**é”™è¯¯ç°è±¡**ï¼š
```
SocketException: Connection refused (OS Error: Connection refused, errno = 111), address = localhost, port = 8000
```

**åŸå› **ï¼š
- Android æ¨¡æ‹Ÿå™¨çš„ `localhost` æŒ‡å‘æ¨¡æ‹Ÿå™¨æœ¬èº«ï¼Œè€Œéä¸»æœº

**è§£å†³æ–¹æ¡ˆ**ï¼š
```dart
// lib/config/constants.dart
static const String baseUrl = 'http://10.0.2.2:8000';
```

---

### é—®é¢˜ 2ï¼šHTTP 422 ä¸Šä¼ é”™è¯¯

**é”™è¯¯ç°è±¡**ï¼š
```json
HTTP 422 Unprocessable Entity
{
  "detail": [
    {
      "loc": ["query", "project_id"],
      "msg": "field required"
    }
  ]
}
```

**åŸå› **ï¼š
- å‚æ•°ä½ç½®é”™è¯¯ï¼šQuery å‚æ•°æ”¾åœ¨ Form å­—æ®µä¸­

**è§£å†³æ–¹æ¡ˆ**ï¼š
```dart
// âŒ é”™è¯¯
final fields = <String, String>{
  'project_id': projectId,
  'note': note,
};

// âœ… æ­£ç¡®
var endpoint = '$url?project_id=$projectId&source=mobile';
final fields = <String, String>{
  'note': note,
};
```

---

### é—®é¢˜ 3ï¼šç¼“å­˜æ•°æ®æ ¼å¼é”™è¯¯

**é”™è¯¯ç°è±¡**ï¼š
```
FormatException: Unexpected character (at line 1)
```

**åŸå› **ï¼š
- JSON åºåˆ—åŒ–/ååºåˆ—åŒ–å¤±è´¥
- å¯¹è±¡ç¼ºå°‘ `toJson()` / `fromJson()` æ–¹æ³•

**è§£å†³æ–¹æ¡ˆ**ï¼š
```dart
class Building {
  final String id;
  final String name;

  // âœ… æ·»åŠ åºåˆ—åŒ–æ–¹æ³•
  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'name': name,
    };
  }

  factory Building.fromJson(Map<String, dynamic> json) {
    return Building(
      id: json['id']?.toString() ?? '',
      name: json['name']?.toString() ?? '',
    );
  }
}
```

---

### é—®é¢˜ 4ï¼šç¼“å­˜æœªç”Ÿæ•ˆ

**æ£€æŸ¥æ¸…å•**ï¼š
1. âœ… `shared_preferences` ä¾èµ–å·²æ·»åŠ 
2. âœ… è¿è¡Œ `flutter pub get`
3. âœ… ä½¿ç”¨ `SharedPreferences.getInstance()` è·å–å®ä¾‹
4. âœ… ä½¿ç”¨ `await` ç­‰å¾…å¼‚æ­¥æ“ä½œ
5. âœ… æ£€æŸ¥é”®åæ˜¯å¦ä¸€è‡´

**è°ƒè¯•ä»£ç **ï¼š
```dart
final prefs = await SharedPreferences.getInstance();

// æ£€æŸ¥æ˜¯å¦åŒ…å«é”®
bool hasKey = prefs.containsKey('my_key');
print('Has key: $hasKey');

// è¯»å–æ‰€æœ‰é”®
Set<String> allKeys = prefs.getKeys();
print('All keys: $allKeys');

// è¯»å–æ•°æ®
String? data = prefs.getString('my_key');
print('Data: $data');
```

---

### é—®é¢˜ 5ï¼šçœŸæœºæ— æ³•è¿æ¥åç«¯

**é”™è¯¯ç°è±¡**ï¼š
```
NetworkException: ç½‘ç»œè¿æ¥å¤±è´¥: Connection refused
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **æ£€æŸ¥ç”µè„‘å’Œæ‰‹æœºåœ¨åŒä¸€ Wi-Fi**

2. **è·å–ç”µè„‘ IP åœ°å€**ï¼š
```bash
# Windows
ipconfig

# æ‰¾åˆ° "æ— çº¿å±€åŸŸç½‘é€‚é…å™¨ WLAN" çš„ IPv4 åœ°å€
# ä¾‹å¦‚ï¼š192.168.1.100
```

3. **é…ç½®ç§»åŠ¨ç«¯ baseUrl**ï¼š
```dart
// lib/config/constants.dart
static const String baseUrl = 'http://192.168.1.100:8000';
```

4. **ç¡®ä¿é˜²ç«å¢™å…è®¸ 8000 ç«¯å£**ï¼š
```bash
# Windows é˜²ç«å¢™ - å…è®¸ç«¯å£
netsh advfirewall firewall add rule name="Allow 8000" dir=in action=allow protocol=TCP localport=8000
```

5. **ç¡®ä¿åç«¯ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£**ï¼š
```bash
# ä¸è¦ä½¿ç”¨ localhostï¼Œä½¿ç”¨ 0.0.0.0
python -m uvicorn services.backend.app.main:app --host 0.0.0.0 --port 8000
```

---

## ğŸ“Š ç¼“å­˜ç­–ç•¥å¯¹æ¯”

### ç­–ç•¥ 1ï¼šç®€å•ç¼“å­˜ï¼ˆæ¨èç”¨äºæœ¬é¡¹ç›®ï¼‰

```dart
// ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œæ€§èƒ½ä¼˜ç§€
// ç¼ºç‚¹ï¼šæ— æ•°æ®æ›´æ–°é€šçŸ¥

Future<List<Building>> loadStructureTree(String projectId) async {
  // 1. å°è¯•åŠ è½½ç¼“å­˜
  final cached = await _loadFromCache(projectId);
  if (cached != null && !_isExpired(projectId)) {
    return cached; // ç¼“å­˜æœ‰æ•ˆï¼Œç›´æ¥è¿”å›
  }

  // 2. ç¼“å­˜å¤±æ•ˆï¼Œä»ç½‘ç»œåŠ è½½
  final data = await _service.getStructureTree(projectId);

  // 3. ä¿å­˜åˆ°ç¼“å­˜
  await _saveToCache(projectId, data);

  return data;
}
```

### ç­–ç•¥ 2ï¼šCache-Firstï¼ˆæ¨èç”¨äºç¦»çº¿ä¼˜å…ˆåº”ç”¨ï¼‰

```dart
Future<List<Building>> loadStructureTree(String projectId) async {
  // 1. å…ˆè¿”å›ç¼“å­˜ï¼ˆå¿«é€Ÿæ˜¾ç¤ºï¼‰
  final cached = await _loadFromCache(projectId);
  if (cached != null) {
    // ç«‹å³æ˜¾ç¤ºç¼“å­˜æ•°æ®
    buildings = cached;
    notifyListeners();

    // åå°åˆ·æ–°
    _refreshInBackground(projectId);
  } else {
    // æ— ç¼“å­˜ï¼Œç›´æ¥åŠ è½½
    final data = await _service.getStructureTree(projectId);
    buildings = data;
    notifyListeners();
  }

  return buildings;
}

Future<void> _refreshInBackground(String projectId) async {
  try {
    final data = await _service.getStructureTree(projectId);
    await _saveToCache(projectId, data);

    // æ›´æ–° UI
    buildings = data;
    notifyListeners();
  } catch (e) {
    debugPrint('åå°åˆ·æ–°å¤±è´¥: $e');
  }
}
```

### ç­–ç•¥ 3ï¼šNetwork-Firstï¼ˆæ¨èç”¨äºå®æ—¶æ€§è¦æ±‚é«˜çš„åº”ç”¨ï¼‰

```dart
Future<List<Building>> loadStructureTree(String projectId) async {
  try {
    // 1. å…ˆå°è¯•ç½‘ç»œè¯·æ±‚
    final data = await _service.getStructureTree(projectId);
    await _saveToCache(projectId, data);
    return data;
  } catch (e) {
    // 2. ç½‘ç»œå¤±è´¥ï¼Œé™çº§åˆ°ç¼“å­˜
    debugPrint('ç½‘ç»œå¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜: $e');
    final cached = await _loadFromCache(projectId);

    if (cached != null) {
      return cached;
    }

    // 3. ç¼“å­˜ä¹Ÿå¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸
    throw Exception('æ— ç½‘ç»œä¸”æ— ç¼“å­˜æ•°æ®');
  }
}
```

---

## ğŸ¯ æ€»ç»“

### ç¦»çº¿ç¼“å­˜åŠŸèƒ½å®ç°è¦ç‚¹

| è¦ç‚¹ | è¯´æ˜ |
|------|------|
| **å­˜å‚¨æ–¹å¼** | SharedPreferencesï¼ˆé”®å€¼å¯¹ï¼‰ |
| **æ•°æ®åºåˆ—åŒ–** | JSON ç¼–ç /è§£ç  |
| **ç¼“å­˜æ—¶é•¿** | 24 å°æ—¶ï¼ˆå¯é…ç½®ï¼‰ |
| **ç¼“å­˜ç­–ç•¥** | Cache-Firstï¼ˆä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼‰ |
| **è¿‡æœŸæ£€æŸ¥** | æ—¶é—´æˆ³å¯¹æ¯” |
| **é™çº§ç­–ç•¥** | ç½‘ç»œå¤±è´¥æ—¶ä½¿ç”¨ç¼“å­˜ |
| **æ€§èƒ½ä¼˜åŒ–** | å…ˆæ˜¾ç¤ºç¼“å­˜ï¼Œåå°åˆ·æ–° |

### å‰åç«¯ä¼ è¾“æ¡ä»¶è¦ç‚¹

| è¦ç‚¹ | è¯´æ˜ |
|------|------|
| **ç½‘ç»œè¿æ¥** | åç«¯è¿è¡Œ + CORS é…ç½® |
| **Android æ¨¡æ‹Ÿå™¨** | ä½¿ç”¨ `10.0.2.2` è®¿é—®ä¸»æœº |
| **çœŸæœºè°ƒè¯•** | ä½¿ç”¨å±€åŸŸç½‘ IPï¼ˆå¦‚ `192.168.1.100`ï¼‰ |
| **å‚æ•°ä½ç½®** | Query å‚æ•°åœ¨ URLï¼ŒForm å‚æ•°åœ¨ body |
| **è¶…æ—¶æ—¶é—´** | 30 ç§’ï¼ˆå¯é…ç½®ï¼‰ |
| **é”™è¯¯å¤„ç†** | NetworkException + ApiException |
| **é‡è¯•æœºåˆ¶** | å»ºè®®å®ç°ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰ |

### é¡¹ç›®ç°çŠ¶

- âœ… `shared_preferences` ä¾èµ–å·²æ·»åŠ 
- âœ… ç¼“å­˜å¸¸é‡å·²é…ç½®ï¼ˆ`cacheDurationHours = 24`ï¼‰
- âœ… å›¾ç‰‡ç¼“å­˜å·²å®ç°ï¼ˆ`cached_network_image`ï¼‰
- â³ å·¥ç¨‹ç»“æ„æ ‘ç¼“å­˜å¾…å®ç°ï¼ˆå¯å‚è€ƒä¸Šè¿°ç¤ºä¾‹ï¼‰
- â³ é¡¹ç›®åˆ—è¡¨ç¼“å­˜å¾…å®ç°

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**ï¼š2026-01-23
**æœ€åæ›´æ–°æ—¶é—´**ï¼š2026-01-23
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0.0
