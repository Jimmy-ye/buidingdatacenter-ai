# 工程师备注 LLM 输出测试报告

生成时间：2025-01-21

---

## 测试目的

验证工程师备注（description字段）是否会影响GLM-4V的分析结果，以及影响的程度和方式。

---

## 测试方法

使用同一张测试图片（压力表），分别上传5次，每次附带不同的工程师备注：
- 场景问题分析（content_role=scene_issue）：无备注、提示漏水、提示设备老化
- 仪表读数识别（content_role=meter）：无备注、提示读数范围

通过对比LLM输出的 severity、summary、recommended_actions 等字段，分析备注的影响。

---

## 测试结果详细对比

### 场景问题分析对比

| 测试场景 | 工程师备注 | 严重度 | 问题类别 | 置信度 | 主要描述 |
|---------|-----------|--------|---------|--------|---------|
| **无备注** | 无 | 🟢 low | 设备维护 | 80% | 压力表有轻微锈蚀，正常使用 |
| **提示漏水** | "怀疑冷却塔底部有漏水痕迹，请重点检查" | 🟡 medium | 设备维护 | 70% | **怀疑冷却塔底部有漏水痕迹，请重点检查** |
| **提示老化** | "该冷却塔已运行8年，盘管可能存在老化腐蚀需要关注" | 🟡 medium | 设备维护 | 70% | **冷却塔盘管老化腐蚀需要关注** |

**关键发现**：
- ✅ **无备注时**：LLM判断为正常使用痕迹（low），描述客观
- ⚠️ **有备注时**：LLM受到备注影响，严重度升级为medium
- ⚠️ **问题现象**：测试用例2中，LLM直接将工程师备注原样作为summary输出，说明LLM过度依赖备注

---

### 仪表读数识别对比

| 测试场景 | 工程师备注 | 标题 | 严重度 | 置信度 | 读数结果 |
|---------|-----------|------|--------|--------|---------|
| **无备注** | 无 | "压力表读数为 0.8 MPa" | 🟡 medium | 90% | 0.8 MPa |
| **提示范围** | "这是温度表，读数应该在60-70℃之间" | "温度表读数约为 65℃" | 🟡 medium | 80% | 65℃ |

**关键发现**：
- ✅ **无备注时**：LLM正确识别为压力表，读数为 0.8 MPa
- ⚠️ **有备注时**：LLM受备注误导，将压力表识别为温度表，读数为 65℃
- ⚠️ **问题严重**：错误信息导致LLM给出错误的分析结果
- ✅ **优点**：LLM在建议措施中正确提示"读数需要人工确认"

---

## Prompt 工作机制分析

### 场景问题 Prompt（build_scene_prompt）

```python
if note:
    base += "\n\n工程师备注如下，请一并参考：\n" + note
return base
```

**设计意图**：
- 让LLM参考工程师的现场观察
- 补充图片中不可见的信息（如设备使用年限、历史问题等）

**实际效果**：
- ✅ 好的方面：LLM能够理解备注内容，并将其纳入分析
- ⚠️ 问题方面：LLM有时会过度依赖备注，直接复制作为输出，而非独立判断

### 仪表读数 Prompt（build_meter_prompt）

```python
if note:
    base += "\n\n工程师备注如下（可作为读数参考，但不要盲从）：\n" + note
return base
```

**设计意图**：
- 提示LLM备注仅供参考，不要盲从
- 避免被错误信息误导

**实际效果**：
- ⚠️ 问题严重：即使加了"不要盲从"的提示，LLM仍被错误备注误导
- ✅ 好的方面：LLM在建议措施中提醒"需要人工确认"，说明它有一定的不确定性

---

## 问题总结

### 1. 过度依赖工程师备注

**现象**：
- 测试用例2中，summary直接复制工程师备注："怀疑冷却塔底部有漏水痕迹，请重点检查"
- 测试用例5中，LLM将压力表误识别为温度表，因为备注说"这是温度表"

**影响**：
- LLM失去独立判断能力
- 工程师备注错误会导致错误的分析结果

### 2. 缺少信息来源区分

**现象**：
- LLM没有区分哪些信息来自图片观察，哪些来自工程师备注
- summary中混搭了图片内容和备注内容

**影响**：
- 用户无法判断结论的可信度
- 无法追溯分析依据

### 3. 置信度机制未发挥作用

**现象**：
- 即使LLM被误导（如压力表→温度表），置信度仍给到80%
- "不要盲从"的提示没有起到约束作用

**影响**：
- 高置信度的错误结论更具误导性

---

## 改进建议

### 方案 1：优化 Prompt（立即可行）

**当前Prompt**：
```
工程师备注如下，请一并参考：
{note}
```

**优化Prompt**：
```
工程师备注如下，仅供参考。请以图片内容为主进行判断：
- 如果备注与图片一致，可以引用备注内容
- 如果备注与图片不一致，以图片观察为准
- 如果备注提到图片中不可见的信息（如设备年限），可以在分析中参考

工程师备注：
{note}
```

**优点**：
- 明确信息优先级：图片 > 备注
- 引导LLM独立判断
- 告诉LLM何时可以参考备注

---

### 方案 2：结构化输出（中长期方案）

**当前输出**：
```json
{
  "summary": "怀疑冷却塔底部有漏水痕迹，请重点检查",
  ...
}
```

**改进输出**：
```json
{
  "summary": "冷却塔底部有水迹残留，可能存在轻微渗漏",
  "observation_from_image": "冷却塔底部有水迹残留，设备外观正常",
  "reference_from_note": "工程师备注提到怀疑漏水",
  "information_sources": {
    "primary": "image",
    "supplementary": ["engineer_note"]
  },
  ...
}
```

**优点**：
- 明确区分信息来源
- 提高结果的可追溯性
- 用户可以判断结论的可信度

---

### 方案 3：分步式分析（长期方案）

**第一步**：仅分析图片，输出 `image_observation`
**第二步**：结合工程师备注，输出 `integrated_analysis`
**第三步**：如果备注与图片有冲突，输出 `conflict_alert`

**优点**：
- 最大化利用图片信息
- 避免备注误导
- 提供冲突预警

---

## 行动计划

### 立即行动（本次）

1. ✅ 修改 `build_scene_prompt()` 和 `build_meter_prompt()`
   - 增加信息优先级说明
   - 引导LLM独立判断

2. ✅ 增加测试用例
   - 备注与图片一致的情况
   - 备注与图片冲突的情况
   - 备注提供额外信息的情况

### 短期优化（1周内）

1. 重新运行测试，验证优化后的Prompt效果
2. 收集真实场景的工程师备注案例
3. 建立备注质量评估标准

### 中长期改进（1个月内）

1. 设计结构化输出schema
2. 实现分步式分析流程
3. 建立备注与图片的冲突检测机制

---

## 结论

### 主要发现

1. ✅ **工程师备注确实会影响LLM输出**
   - severity从low升级到medium
   - summary内容发生变化
   - 仪表读数被误导

2. ⚠️ **存在过度依赖问题**
   - LLM有时直接复制备注作为输出
   - 错误备注会误导分析结果
   - "不要盲从"提示效果有限

3. ✅ **Prompt优化可以改善**
   - 明确信息优先级
   - 引导独立判断
   - 区分信息来源

### 建议

**优先级1**：立即修改Prompt，增加信息优先级说明
**优先级2**：建立备注质量评估标准，避免错误备注
**优先级3**：中长期实现结构化输出和分步式分析

---

**报告生成时间**：2025-01-21
**测试资产数量**：5 个
**测试图片**：压力表（1张，重复使用）
**GLM模型**：glm-4v
**Worker版本**：scene_issue_glm_worker.py（当前版本）
