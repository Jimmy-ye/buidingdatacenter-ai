# ç§»åŠ¨ç«¯æ¥å£ä¿®å¤è®¡åˆ’

**åˆ›å»ºæ—¶é—´**ï¼š2026-01-23
**åŸºäº**ï¼šå®é™…æµ‹è¯• + å®¡æŸ¥æ–‡æ¡£
**ä¼˜å…ˆçº§**ï¼šP0 > P1 > P2

---

## ğŸ“‹ ä¿®å¤ä»»åŠ¡æ¸…å•

### ä»»åŠ¡ 1ï¼šä¿®å¤å·¥ç¨‹ç»“æ„æ ‘è¿”å›æ ¼å¼ï¼ˆP0 - é˜»å¡ï¼‰ğŸ”´

**æ–‡ä»¶**ï¼š`lib/services/project_service.dart`

**å½“å‰ä»£ç **ï¼ˆç¬¬ 94-103 è¡Œï¼‰ï¼š
```dart
Future<List<Building>> getStructureTree(String projectId) async {
  try {
    final response = await _api.get(ApiEndpoints.structureTree(projectId));
    final List<dynamic> data = jsonDecode(response.body);  // âŒ é”™è¯¯ï¼šæœŸæœ› Listï¼Œå®é™…æ˜¯ Map
    return data.map((json) => Building.fromJson(json)).toList();
  } catch (e) {
    debugPrint('è·å–å·¥ç¨‹ç»“æ„æ ‘å¤±è´¥: $e');
    rethrow;
  }
}
```

**é—®é¢˜**ï¼š
- åç«¯è¿”å›ï¼š`{"project_id": "...", "tree": {"id": "project-root", "children": [...]}}`
- ç§»åŠ¨ç«¯æœŸæœ›ï¼š`[Building, Building, ...]`

**ä¿®å¤åä»£ç **ï¼š
```dart
/// è·å–å·¥ç¨‹ç»“æ„æ ‘
///
/// API: GET /api/v1/projects/{id}/structure_tree
///
/// åç«¯è¿”å›æ ¼å¼ï¼š
/// ```json
/// {
///   "project_id": "...",
///   "tree": {
///     "id": "project-root",
///     "name": "é¡¹ç›®æ ¹",
///     "type": "project_root",
///     "children": [
///       {
///         "id": "...",
///         "name": "1å·å‚æˆ¿",
///         "type": "building",
///         "usage_type": "office",
///         "children": [...]
///       }
///     ]
///   }
/// }
/// ```
Future<List<Building>> getStructureTree(String projectId) async {
  try {
    final response = await _api.get(ApiEndpoints.structureTree(projectId));
    final Map<String, dynamic> data = jsonDecode(response.body);

    // â­ ä» tree.children ä¸­æå– Building åˆ—è¡¨
    final Map<String, dynamic>? tree = data['tree'];
    if (tree == null) {
      debugPrint('é”™è¯¯ï¼šå“åº”ä¸­ç¼ºå°‘ tree å­—æ®µ');
      return [];
    }

    final List<dynamic> children = tree['children'] ?? [];

    debugPrint('æˆåŠŸè§£æå·¥ç¨‹ç»“æ„æ ‘ï¼š${children.length} ä¸ªæ¥¼æ ‹');

    return children
        .map((json) => Building.fromJson(json as Map<String, dynamic>))
        .toList();
  } catch (e) {
    debugPrint('è·å–å·¥ç¨‹ç»“æ„æ ‘å¤±è´¥: $e');
    rethrow;
  }
}
```

**éªŒè¯æ­¥éª¤**ï¼š
1. åˆ·æ–°æµè§ˆå™¨ï¼ˆCtrl + Shift + Rï¼‰
2. ç‚¹å‡»é¡¹ç›®è¿›å…¥å·¥ç¨‹ç»“æ„é¡µ
3. ç¡®è®¤æ˜¾ç¤ºæ¥¼æ ‹åˆ—è¡¨
4. å±•å¼€æ¥¼æ ‹ï¼Œç¡®è®¤æ˜¾ç¤ºç³»ç»Ÿå’ŒåŒºåŸŸ

---

### ä»»åŠ¡ 2ï¼šä¿®å¤ Asset æ¨¡å‹å­—æ®µå¯¹é½ï¼ˆP1ï¼‰ğŸŸ¡

**æ–‡ä»¶**ï¼š`lib/models/asset.dart`

**å½“å‰ä»£ç **ï¼ˆç¬¬ 31-48 è¡Œï¼‰ï¼š
```dart
factory Asset.fromJson(Map<String, dynamic> json) {
  return Asset(
    id: json['id']?.toString() ?? '',
    title: json['title']?.toString() ?? 'æœªå‘½åèµ„äº§',
    modality: json['modality']?.toString() ?? 'unknown',
    source: json['source']?.toString() ?? 'unknown',
    contentRole: json['content_role']?.toString(),
    createdAt: json['created_at'] != null  // âŒ åªæ”¯æŒ created_at
        ? DateTime.parse(json['created_at'].toString())
        : DateTime.now(),
    note: json['note']?.toString(),
    rawUrl: json['raw_url']?.toString(),  // âŒ åªæ”¯æŒ raw_url
    deviceId: json['device_id']?.toString(),
    systemId: json['system_id']?.toString(),
    zoneId: json['zone_id']?.toString(),
    buildingId: json['building_id']?.toString(),
  );
}
```

**ä¿®å¤åä»£ç **ï¼š
```dart
factory Asset.fromJson(Map<String, dynamic> json) {
  return Asset(
    id: json['id']?.toString() ?? '',
    title: json['title']?.toString() ?? 'æœªå‘½åèµ„äº§',
    modality: json['modality']?.toString() ?? 'unknown',
    source: json['source']?.toString() ?? 'unknown',
    contentRole: json['content_role']?.toString(),
    // â­ ä¼˜å…ˆä½¿ç”¨ capture_timeï¼Œå…¼å®¹ created_at
    createdAt: _parseDateTime(json['capture_time'] ?? json['created_at']),
    note: json['note']?.toString(),
    // â­ æ”¯æŒ raw_urlã€file_pathã€download_urlï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
    rawUrl: json['raw_url']?.toString() ??
            json['download_url']?.toString() ??
            json['file_path']?.toString(),
    deviceId: json['device_id']?.toString(),
    systemId: json['system_id']?.toString(),
    zoneId: json['zone_id']?.toString(),
    buildingId: json['building_id']?.toString(),
  );
}

/// å®‰å…¨è§£æ DateTime
static DateTime _parseDateTime(dynamic value) {
  if (value == null) {
    debugPrint('è­¦å‘Šï¼šAsset æ—¶é—´å­—æ®µä¸ºç©ºï¼Œä½¿ç”¨å½“å‰æ—¶é—´');
    return DateTime.now();
  }
  if (value is DateTime) {
    return value;
  }
  try {
    return DateTime.parse(value.toString());
  } catch (e) {
    debugPrint('è­¦å‘Šï¼šæ— æ³•è§£ææ—¶é—´ "$value"ï¼Œä½¿ç”¨å½“å‰æ—¶é—´: $e');
    return DateTime.now();
  }
}
```

**éªŒè¯æ­¥éª¤**ï¼š
1. æŸ¥çœ‹èµ„äº§åˆ—è¡¨
2. ç¡®è®¤å›¾ç‰‡æ­£å¸¸æ˜¾ç¤º
3. ç¡®è®¤æ—¶é—´æ˜¾ç¤ºæ­£ç¡®ï¼ˆ"åˆšåˆš"ã€"5 åˆ†é’Ÿå‰"ç­‰ï¼‰

---

### ä»»åŠ¡ 3ï¼šéªŒè¯åˆ†é¡µå‚æ•°åï¼ˆP1ï¼‰ğŸŸ¡

**æ–‡ä»¶**ï¼š`lib/services/asset_service.dart`

**å½“å‰å®ç°**ï¼š
```dart
// ç¬¬ 17 è¡Œï¼šè®¾å¤‡èµ„äº§åˆ—è¡¨
final endpoint = '${ApiEndpoints.assets}?device_id=$deviceId&limit=$limit&offset=$offset';

// ç¬¬ 35 è¡Œï¼šç³»ç»Ÿèµ„äº§åˆ—è¡¨
final endpoint = '${ApiEndpoints.assets}?system_id=$systemId&limit=$limit&offset=$offset';
```

**éªŒè¯æ­¥éª¤**ï¼š
1. æ‰“å¼€èµ„äº§åˆ—è¡¨é¡µï¼ˆè®¾å¤‡æˆ–ç³»ç»Ÿï¼‰
2. ç‚¹å‡»"æŸ¥çœ‹æ›´å¤š"æŒ‰é’®
3. è§‚å¯Ÿåç«¯æ—¥å¿—ï¼š
   - å¦‚æœçœ‹åˆ° `?...&offset=5&limit=5` â†’ æ­£å¸¸å·¥ä½œ
   - å¦‚æœçœ‹åˆ° 400 é”™è¯¯æˆ–å‚æ•°æœªè¯†åˆ« â†’ éœ€è¦ä¿®æ”¹

**å¦‚æœéœ€è¦ä¿®æ”¹**ï¼š
```dart
// æ–¹æ¡ˆ Aï¼šå°† offset æ”¹ä¸º skip
final endpoint = '${ApiEndpoints.assets}?device_id=$deviceId&limit=$limit&skip=$offset';

// æ–¹æ¡ˆ Bï¼šä½¿ç”¨å‚æ•°æ˜ å°„ï¼ˆæ›´çµæ´»ï¼‰
Map<String, dynamic> params = {
  'device_id': deviceId,
  'limit': limit,
  'skip': offset, // æˆ– offsetï¼Œæ ¹æ®åç«¯å®é™…å‚æ•°å
};
final queryString = params.entries
    .map((e) => '${e.key}=${e.value}')
    .join('&');
final endpoint = '${ApiEndpoints.assets}?$queryString';
```

---

### ä»»åŠ¡ 4ï¼šå¢å¼ºä¸Šä¼ æ¥å£ï¼ˆP2ï¼‰â³

**æ–‡ä»¶**ï¼š`lib/services/asset_service.dart`

**å½“å‰ä»£ç **ï¼ˆç¬¬ 88-110 è¡Œï¼‰ï¼š
```dart
final fields = <String, String>{
  'project_id': projectId,
  if (deviceId != null && deviceId.isNotEmpty) 'device_id': deviceId,
  if (systemId != null && systemId.isNotEmpty) 'system_id': systemId,
  if (note != null && note.isNotEmpty) 'note': note,
};
```

**ä¿®å¤åä»£ç **ï¼š
```dart
final fields = <String, String>{
  'project_id': projectId,
  if (deviceId != null && deviceId.isNotEmpty) 'device_id': deviceId,
  if (systemId != null && systemId.isNotEmpty) 'system_id': systemId,
  if (note != null && note.isNotEmpty) 'note': note,
  // â­ æ ‡è¯†æ•°æ®æ¥æºä¸ºç§»åŠ¨ç«¯
  'source': 'mobile',
  // å¯é€‰ï¼šå¦‚æœåç«¯æ”¯æŒå†…å®¹è§’è‰²åˆ†ç±»
  // 'content_role': 'scene_issue', // æˆ–ç”±å‰ç«¯ä¼ é€’
};
```

**éªŒè¯æ­¥éª¤**ï¼š
1. æµ‹è¯•å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
2. æ£€æŸ¥åç«¯æ•°æ®åº“ä¸­ `source` å­—æ®µæ˜¯å¦ä¸º `'mobile'`
3. æ£€æŸ¥ä¸Šä¼ åèµ„äº§åˆ—è¡¨æ˜¯å¦è‡ªåŠ¨åˆ·æ–°

---

## ğŸ¯ æ‰§è¡Œé¡ºåº

### ç¬¬ 1 æ­¥ï¼šä¿®å¤å·¥ç¨‹ç»“æ„æ ‘ï¼ˆç«‹å³æ‰§è¡Œï¼‰
**ä¸ºä»€ä¹ˆ**ï¼šé˜»å¡ç”¨æˆ·æŸ¥çœ‹å·¥ç¨‹ç»“æ„é¡µé¢

**æ–‡ä»¶**ï¼š`lib/services/project_service.dart`
**è¡Œæ•°**ï¼š94-103
**ä¿®æ”¹**ï¼šä» `data['tree']['children']` è§£æ Building åˆ—è¡¨

### ç¬¬ 2 æ­¥ï¼šä¿®å¤ Asset æ¨¡å‹
**ä¸ºä»€ä¹ˆ**ï¼šç¡®ä¿èµ„äº§å›¾ç‰‡å’Œæ—¶é—´æ­£ç¡®æ˜¾ç¤º

**æ–‡ä»¶**ï¼š`lib/models/asset.dart`
**è¡Œæ•°**ï¼š31-48
**ä¿®æ”¹**ï¼šå…¼å®¹ `capture_time` å’Œ `file_path/download_url`

### ç¬¬ 3 æ­¥ï¼šéªŒè¯åˆ†é¡µå‚æ•°
**ä¸ºä»€ä¹ˆ**ï¼šç¡®ä¿"æŸ¥çœ‹æ›´å¤š"åŠŸèƒ½æ­£å¸¸

**æ–‡ä»¶**ï¼š`lib/services/asset_service.dart`
**è¡Œæ•°**ï¼š17, 35
**éªŒè¯**ï¼šæµ‹è¯•åˆ†é¡µæ˜¯å¦å·¥ä½œï¼Œå¿…è¦æ—¶ä¿®æ”¹å‚æ•°å

### ç¬¬ 4 æ­¥ï¼šå¢å¼ºä¸Šä¼ æ¥å£
**ä¸ºä»€ä¹ˆ**ï¼šæ·»åŠ æ¥æºæ ‡è¯†ï¼Œä¾¿äºåç«¯åŒºåˆ†æ•°æ®

**æ–‡ä»¶**ï¼š`lib/services/asset_service.dart`
**è¡Œæ•°**ï¼š88-110
**ä¿®æ”¹**ï¼šæ·»åŠ  `source='mobile'` å­—æ®µ

---

## âœ… éªŒæ”¶æ ‡å‡†

### P0 ä»»åŠ¡ï¼ˆå¿…é¡»å®Œæˆï¼‰ï¼š
- [x] å¯ä»¥æ­£å¸¸è¿›å…¥å·¥ç¨‹ç»“æ„é¡µé¢
- [x] æ¥¼æ ‹åˆ—è¡¨æ­£ç¡®æ˜¾ç¤º
- [x] ç³»ç»Ÿå’ŒåŒºåŸŸåˆ—è¡¨æ­£ç¡®æ˜¾ç¤º

### P1 ä»»åŠ¡ï¼ˆåº”è¯¥å®Œæˆï¼‰ï¼š
- [x] èµ„äº§åˆ—è¡¨å›¾ç‰‡æ­£å¸¸æ˜¾ç¤º
- [x] èµ„äº§æ—¶é—´æ˜¾ç¤ºæ­£ç¡®
- [x] "æŸ¥çœ‹æ›´å¤š"åˆ†é¡µåŠŸèƒ½æ­£å¸¸å·¥ä½œ

### P2 ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰ï¼š
- [ ] ä¸Šä¼ å›¾ç‰‡æ—¶å¸¦æœ‰ `source='mobile'` æ ‡è¯†
- [ ] ä¸Šä¼ ååˆ—è¡¨è‡ªåŠ¨åˆ·æ–°

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ä¸è¦ä¿®æ”¹åç«¯ä»£ç **
   - æ‰€æœ‰ä¿®æ”¹éƒ½åœ¨ç§»åŠ¨ç«¯è¿›è¡Œ
   - é€šè¿‡å…¼å®¹æ€§å¤„ç†é€‚é…åç«¯è¿”å›æ ¼å¼

2. **ä¿æŒå‘åå…¼å®¹**
   - ä½¿ç”¨ `??` å’Œ `?.` å¤„ç† null å€¼
   - æ”¯æŒå¤šç§å¯èƒ½çš„å­—æ®µåï¼ˆå¦‚ `capture_time ?? created_at`ï¼‰

3. **æ·»åŠ æ—¥å¿—è¾“å‡º**
   - ä½¿ç”¨ `debugPrint` è®°å½•å…³é”®æ­¥éª¤
   - ä¾¿äºè°ƒè¯•å’Œé—®é¢˜è¿½è¸ª

4. **é€æ­¥éªŒè¯**
   - æ¯å®Œæˆä¸€ä¸ªä»»åŠ¡å°±ç«‹å³æµ‹è¯•
   - ç¡®è®¤ä¿®æ”¹ç”Ÿæ•ˆåå†ç»§ç»­ä¸‹ä¸€ä¸ª

---

**åˆ›å»ºè€…**ï¼šClaude Code
**æœ€åæ›´æ–°**ï¼š2026-01-23
