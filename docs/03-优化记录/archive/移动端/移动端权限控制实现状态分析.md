# ç§»åŠ¨ç«¯æƒé™æ§åˆ¶å®ç°çŠ¶æ€åˆ†æ

> æ—¥æœŸï¼š2026-01-26  
> åˆ†æ”¯ï¼šfeature/mobile-auth-integration

---

## ğŸ“Š æƒé™æ§åˆ¶å®ç°å¯¹æ¯”

### âœ… å·²å®ç°éƒ¨åˆ†ï¼ˆåº•å±‚èƒ½åŠ›ï¼‰

#### 1. æ•°æ®æ¨¡å‹å±‚ï¼ˆUserInfoï¼‰

**æ–‡ä»¶**: `mobile/bdc_ai_app/lib/models/auth.dart`

```dart
class UserInfo {
  final String id;
  final String username;
  final bool isSuperuser;
  final List<RoleInfo> roles;
  
  /// è·å–æ‰€æœ‰æƒé™ä»£ç 
  List<String> get permissions {
    final Set<String> perms = {};
    for (final role in roles) {
      perms.addAll(role.permissions);
    }
    return perms.toList();
  }
  
  /// æ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å®šæƒé™
  bool hasPermission(String permissionCode) {
    if (isSuperuser) return true;  // è¶…çº§ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
    return permissions.contains(permissionCode);
  }
}
```

âœ… **åŠŸèƒ½å®Œæ•´**ï¼š
- æ”¯æŒ isSuperuser åˆ¤æ–­
- æ”¯æŒæƒé™åˆ—è¡¨èšåˆ
- æ”¯æŒç²¾ç¡®æƒé™æ£€æŸ¥

#### 2. æœåŠ¡å±‚ï¼ˆAuthServiceï¼‰

**æ–‡ä»¶**: `mobile/bdc_ai_app/lib/services/auth_service.dart`

```dart
class AuthService {
  bool hasPermission(String permissionCode) {
    return _currentUser?.hasPermission(permissionCode) ?? false;
  }
}
```

âœ… **åŠŸèƒ½å®Œæ•´**ï¼š
- æä¾›æƒé™æ£€æŸ¥å…¥å£
- å¤„ç†ç”¨æˆ·æœªç™»å½•æƒ…å†µ

#### 3. çŠ¶æ€ç®¡ç†å±‚ï¼ˆAuthProviderï¼‰

**æ–‡ä»¶**: `mobile/bdc_ai_app/lib/providers/auth_provider.dart`

```dart
class AuthProvider extends ChangeNotifier {
  bool hasPermission(String permissionCode) {
    return _authService.hasPermission(permissionCode);
  }
}
```

âœ… **åŠŸèƒ½å®Œæ•´**ï¼š
- Provider å°è£…ï¼ŒUI å¯ç›´æ¥è°ƒç”¨
- æ”¯æŒ Consumer æ¨¡å¼

---

### âŒ æœªå®ç°éƒ¨åˆ†ï¼ˆUI å±‚ï¼‰

#### é—®é¢˜ï¼šç§»åŠ¨ç«¯ UI æ²¡æœ‰æ ¹æ®æƒé™æ§åˆ¶æŒ‰é’®

**å¯¹æ¯” PC-UI çš„å®ç°**ï¼š

**PC-UI** (`desktop/nicegui_app/pc_app.py`) âœ… å·²å®ç°

```python
# æ ¹æ®æƒé™åŠ¨æ€åˆ›å»ºæŒ‰é’®
if auth_mgr.has_permission('projects:create'):
    project_create_btn = ui.button("ï¼‹é¡¹ç›®")

if auth_mgr.has_permission('structures:create'):
    building_add_btn = ui.button("ï¼‹æ¥¼æ ‹")
    system_add_btn = ui.button("ï¼‹ç³»ç»Ÿ")
    zone_add_btn = ui.button("ï¼‹åŒºåŸŸ")
    device_add_btn = ui.button("ï¼‹è®¾å¤‡")
```

**ç§»åŠ¨ç«¯** (`mobile/bdc_ai_app/lib/pages/projects_page.dart`) âŒ æœªå®ç°

```dart
// å½“å‰åªæœ‰ç”¨æˆ·èœå•å’Œç™»å‡º
AppBar(
  title: const Text('BDC-AI é¡¹ç›®åˆ—è¡¨'),
  actions: [
    // åªæœ‰ç”¨æˆ·èœå•ï¼Œæ²¡æœ‰æƒé™ç›¸å…³çš„æ“ä½œæŒ‰é’®
    PopupMenuButton<String>(...),
  ],
)

// é¡¹ç›®åˆ—è¡¨é¡µé¢æ²¡æœ‰ï¼š
// âŒ æ²¡æœ‰ "ï¼‹é¡¹ç›®" æŒ‰é’®
// âŒ æ²¡æœ‰é¡¹ç›® "ç¼–è¾‘" æŒ‰é’®
// âŒ æ²¡æœ‰é¡¹ç›® "åˆ é™¤" æŒ‰é’®
// âŒ æ²¡æœ‰ "ï¼‹æ¥¼æ ‹/ç³»ç»Ÿ/åŒºåŸŸ/è®¾å¤‡" æŒ‰é’®
```

---

## ğŸ” å…·ä½“ç¼ºå¤±åŠŸèƒ½

### 1. é¡¹ç›®ç®¡ç†ç›¸å…³æŒ‰é’®

**ç¼ºå¤±çš„åŠŸèƒ½**ï¼š

| åŠŸèƒ½ | æƒé™ä»£ç  | PC-UI | ç§»åŠ¨ç«¯ |
|------|----------|-------|--------|
| åˆ›å»ºé¡¹ç›® | `projects:create` | âœ… æœ‰æŒ‰é’® | âŒ æœªå®ç° |
| ç¼–è¾‘é¡¹ç›® | `projects:update` | âœ… æœ‰æŒ‰é’® | âŒ æœªå®ç° |
| åˆ é™¤é¡¹ç›® | `projects:delete` | âœ… æœ‰æŒ‰é’® | âŒ æœªå®ç° |

**ç§»åŠ¨ç«¯å½“å‰çŠ¶æ€**ï¼š
- åªèƒ½æŸ¥çœ‹é¡¹ç›®åˆ—è¡¨
- æ— æ³•åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤é¡¹ç›®

### 2. ç»“æ„æ ‘æ“ä½œæŒ‰é’®

**ç¼ºå¤±çš„åŠŸèƒ½**ï¼š

| åŠŸèƒ½ | æƒé™ä»£ç  | PC-UI | ç§»åŠ¨ç«¯ |
|------|----------|-------|--------|
| æ·»åŠ æ¥¼æ ‹ | `structures:create` | âœ… æœ‰æŒ‰é’® | âŒ æœªå®ç° |
| æ·»åŠ ç³»ç»Ÿ | `structures:create` | âœ… æœ‰æŒ‰é’® | âŒ æœªå®ç° |
| æ·»åŠ åŒºåŸŸ | `structures:create` | âœ… æœ‰æŒ‰é’® | âŒ æœªå®ç° |
| æ·»åŠ è®¾å¤‡ | `structures:create` | âœ… æœ‰æŒ‰é’® | âŒ æœªå®ç° |
| ç¼–è¾‘èŠ‚ç‚¹ | `structures:update` | âœ… æœ‰æŒ‰é’® | âŒ æœªå®ç° |
| åˆ é™¤èŠ‚ç‚¹ | `structures:delete` | âœ… æœ‰æŒ‰é’® | âŒ æœªå®ç° |

**ç§»åŠ¨ç«¯å½“å‰çŠ¶æ€**ï¼š
- åªèƒ½æŸ¥çœ‹ç»“æ„æ ‘
- æ— æ³•æ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤èŠ‚ç‚¹

### 3. èµ„äº§æ“ä½œæŒ‰é’®

**ç¼ºå¤±çš„åŠŸèƒ½**ï¼š

| åŠŸèƒ½ | æƒé™ä»£ç  | PC-UI | ç§»åŠ¨ç«¯ |
|------|----------|-------|--------|
| ä¸Šä¼ èµ„äº§ | `assets:create` | âœ… æœ‰æŒ‰é’® | âš ï¸ æœªæ£€æŸ¥æƒé™ |
| åˆ é™¤èµ„äº§ | `assets:delete` | âœ… æœ‰æŒ‰é’® | âš ï¸ æœªæ£€æŸ¥æƒé™ |
| è¿è¡Œ OCR | `assets:run_ocr` | âœ… æœ‰æŒ‰é’® | âŒ æœªå®ç° |
| è¿è¡Œ LLM | `assets:run_llm` | âœ… æœ‰æŒ‰é’® | âŒ æœªå®ç° |

**ç§»åŠ¨ç«¯å½“å‰çŠ¶æ€**ï¼š
- èµ„äº§é¡µé¢ä¸Šä¼ åŠŸèƒ½æœªåšæƒé™æ£€æŸ¥
- ç¼ºå°‘ OCR/LLM è¿è¡ŒæŒ‰é’®
- åˆ é™¤åŠŸèƒ½æœªåšæƒé™æ£€æŸ¥

---

## ğŸ“ å®ç°å»ºè®®

### æ–¹æ¡ˆ 1ï¼šæœ€å°å®ç°ï¼ˆæ¨èï¼‰

**ç›®æ ‡**ï¼šåœ¨ç°æœ‰åŸºç¡€ä¸Šæ·»åŠ æƒé™æ£€æŸ¥

```dart
// lib/pages/projects_page.dart

// åœ¨ AppBar ä¸­æ·»åŠ æ“ä½œæŒ‰é’®
AppBar(
  title: const Text('BDC-AI é¡¹ç›®åˆ—è¡¨'),
  actions: [
    // æ ¹æ®æƒé™æ˜¾ç¤º"ï¼‹é¡¹ç›®"æŒ‰é’®
    Consumer<AuthProvider>(
      builder: (context, auth, child) {
        if (auth.hasPermission('projects:create')) {
          return IconButton(
            icon: const Icon(Icons.add),
            onPressed: () {
              // æ˜¾ç¤ºåˆ›å»ºé¡¹ç›®å¯¹è¯æ¡†
            },
          );
        }
        return const SizedBox.shrink();
      },
    ),
    // ç”¨æˆ·èœå•
    ...buildUserMenu(),
  ],
);

// åœ¨é¡¹ç›®åˆ—è¡¨é¡¹ä¸­æ˜¾ç¤ºæ“ä½œæŒ‰é’®
Widget _buildProjectItem(Project project, AuthProvider auth) {
  return ListTile(
    title: Text(project.name),
    trailing: Row(
      children: [
        // ç¼–è¾‘æŒ‰é’®ï¼ˆéœ€è¦æƒé™ï¼‰
        if (auth.hasPermission('projects:update'))
          IconButton(
            icon: const Icon(Icons.edit),
            onPressed: () { /* ç¼–è¾‘é¡¹ç›® */ },
          ),
        // åˆ é™¤æŒ‰é’®ï¼ˆéœ€è¦æƒé™ï¼‰
        if (auth.hasPermission('projects:delete'))
          IconButton(
            icon: const Icon(Icons.delete),
            onPressed: () { /* åˆ é™¤é¡¹ç›® */ },
          ),
      ],
    ),
  );
}
```

### æ–¹æ¡ˆ 2ï¼šå®Œæ•´å®ç°

**ç›®æ ‡**ï¼šå‚è€ƒ PC-UIï¼Œå®ç°å®Œæ•´çš„æƒé™æ§åˆ¶ UI

éœ€è¦å®ç°ï¼š
1. é¡¹ç›®åˆ›å»º/ç¼–è¾‘/åˆ é™¤å¯¹è¯æ¡†
2. ç»“æ„æ ‘èŠ‚ç‚¹åˆ›å»º/ç¼–è¾‘/åˆ é™¤å¯¹è¯æ¡†
3. èµ„äº§ OCR/LLM è¿è¡ŒæŒ‰é’®
4. æƒé™ä¸è¶³æ—¶çš„å‹å¥½æç¤º

---

## ğŸ¯ æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šè¶…çº§ç®¡ç†å‘˜ï¼ˆsuperadminï¼‰

**æœŸæœ›è¡Œä¸º**ï¼š
- âœ… å¯ä»¥çœ‹åˆ°æ‰€æœ‰æŒ‰é’®ï¼ˆåˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ï¼‰
- âœ… å¯ä»¥æ‰§è¡Œæ‰€æœ‰æ“ä½œ

**è´¦æˆ·**: `admin` / `admin123`

### åœºæ™¯ 2ï¼šæ™®é€šç”¨æˆ·ï¼ˆæœ‰é™æƒé™ï¼‰

**æœŸæœ›è¡Œä¸º**ï¼š
- âœ… åªæ˜¾ç¤ºæœ‰æƒé™çš„æŒ‰é’®
- âœ… æ— æƒé™çš„æŒ‰é’®ä¸æ˜¾ç¤ºæˆ–ç¦ç”¨

**ç¤ºä¾‹**ï¼šå‡è®¾æœ‰ç”¨æˆ· `operator` åªæœ‰ `projects:view` æƒé™
- âœ… å¯ä»¥çœ‹åˆ°é¡¹ç›®åˆ—è¡¨
- âŒ ä¸èƒ½çœ‹åˆ°"ï¼‹é¡¹ç›®"æŒ‰é’®
- âŒ ä¸èƒ½çœ‹åˆ°"ç¼–è¾‘"ã€"åˆ é™¤"æŒ‰é’®

---

## ğŸ“‹ å®ç°ä¼˜å…ˆçº§

### P0ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
- [ ] é¡¹ç›®åˆ›å»ºæŒ‰é’®ï¼ˆ`projects:create`ï¼‰
- [ ] é¡¹ç›®åˆ é™¤æŒ‰é’®ï¼ˆ`projects:delete`ï¼‰

### P1ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
- [ ] ç»“æ„æ ‘æ·»åŠ èŠ‚ç‚¹æŒ‰é’®ï¼ˆ`structures:create`ï¼‰
- [ ] èµ„äº§åˆ é™¤æƒé™æ£€æŸ¥ï¼ˆ`assets:delete`ï¼‰

### P2ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
- [ ] OCR/LLM è¿è¡ŒæŒ‰é’®ï¼ˆ`assets:run_ocr`, `assets:run_llm`ï¼‰
- [ ] æƒé™ä¸è¶³æç¤ºä¼˜åŒ–

---

## ğŸ“Œ æ€»ç»“

**ç§»åŠ¨ç«¯æƒé™æ§åˆ¶çŠ¶æ€**ï¼š

âœ… **å·²å®ç°ï¼ˆ60%ï¼‰**ï¼š
- åº•å±‚æ•°æ®æ¨¡å‹å®Œæ•´
- æƒé™æ£€æŸ¥æ–¹æ³•å®Œæ•´
- ç”¨æˆ·è®¤è¯å’Œè§’è‰²ç®¡ç†å®Œæ•´

âŒ **æœªå®ç°ï¼ˆ40%ï¼‰**ï¼š
- UI å±‚æŒ‰é’®æƒé™æ§åˆ¶
- æ“ä½œå¯¹è¯æ¡†
- æƒé™ä¸è¶³æç¤º

**å»ºè®®**ï¼š
1. å…ˆå®ç° P0 åŠŸèƒ½ï¼ˆé¡¹ç›®åˆ›å»º/åˆ é™¤ï¼‰
2. é€æ­¥å®Œå–„å…¶ä»–æƒé™æ§åˆ¶
3. å‚è€ƒ PC-UI çš„å®ç°æ¨¡å¼

---

**æ–‡æ¡£ç»´æŠ¤**: BDC-AI å¼€å‘å›¢é˜Ÿ  
**åˆ›å»ºæ—¶é—´**: 2026-01-26
