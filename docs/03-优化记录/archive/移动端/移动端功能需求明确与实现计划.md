# 移动端功能需求明确与实现计划

> 日期：2026-01-26
> 分支：feature/mobile-auth-integration
> 基于文档：移动端开发完整指南 v1.0

---

## 📋 用户明确的功能需求

### ✅ 需要实现的功能

1. **添加设备** ⭐ 新增需求
   - 在系统下创建新设备
   - 关联到指定系统和区域
   - 后端 API：`POST /api/v1/engineering/systems/{system_id}/devices`

2. **拍照上传** ✅ 已完成
   - 拍照后添加到对应的设备资产
   - 支持三种类型：现场问题/铭牌/仪表
   - 自动解析选项
   - 已在 `assets_page.dart` 完整实现

3. **删除图片** ✅ 已完成，需要添加权限控制
   - 删除从移动端标记的图片（source='mobile'）
   - 批量删除功能已实现
   - **需要添加**：删除权限检查

### ❌ 不需要实现的功能

- ❌ 添加项目（在 PC-UI 完成）
- ❌ 添加楼栋（在 PC-UI 完成）
- ❌ 添加系统（在 PC-UI 完成）

---

## 📊 当前实现状态

### ✅ 已完成功能（95%）

| 功能 | 状态 | 文件 | 说明 |
|------|------|------|------|
| 项目列表 | ✅ 完成 | projects_page.dart | 显示项目列表 |
| 工程结构树 | ✅ 完成 | structure_tree_page.dart | 显示树结构，支持展开/折叠 |
| 设备资产视图 | ✅ 完成 | assets_page.dart | 点击设备查看资产 |
| 系统资产视图 | ✅ 完成 | assets_page.dart | 点击系统查看资产 ⭐ |
| 拍照上传 | ✅ 完成 | assets_page.dart | 支持三种类型，自动解析 |
| 批量删除 | ✅ 完成 | assets_page.dart | 只能删除 mobile 来源 |
| 用户认证 | ✅ 完成 | auth_*.dart | 登录、Token 管理、自动刷新 |
| 权限模型 | ✅ 完成 | models/auth.dart | UserInfo.hasPermission() |

### ⏳ 待实现功能

| 功能 | 优先级 | 工作量 | 说明 |
|------|--------|--------|------|
| 添加设备 | **P0** | 2-3h | 需要新增 UI 对话框 |
| 删除权限控制 | **P1** | 1h | 检查 `assets:delete` 权限 |

---

## 🎯 实现计划

### 任务 1：添加设备功能（P0 - 必须实现）

#### 后端 API

**端点**：`POST /api/v1/engineering/systems/{system_id}/devices`

**请求体**：
```json
{
  "name": "新风机组 1F",
  "zone_id": "uuid-or-null",
  "device_type": "ahu",
  "description": "主楼一层新风机组"
}
```

#### 前端实现步骤

1. **添加 DeviceCreate 模型** - `lib/models/structure.dart`
2. **添加 API 服务方法** - `lib/services/project_service.dart`
3. **添加 API 端点** - `lib/config/constants.dart`
4. **实现对话框 UI** - `lib/pages/structure_tree_page.dart`
5. **在系统节点显示按钮** - `lib/pages/structure_tree_page.dart`
6. **更新 StructureProvider** - `lib/providers/structure_provider.dart`
7. **添加权限检查** - 检查 `structures:create` 权限

---

### 任务 2：删除权限控制（P1 - 重要）

#### 当前问题

批量删除功能已实现，但**没有检查权限**。

#### 实现方案

1. **在进入选择模式前检查权限**
   ```dart
   if (!auth.hasPermission('assets:delete')) {
     ScaffoldMessenger.of(context).showSnackBar(
       const SnackBar(content: Text('您没有删除资产的权限')),
     );
     return;
   }
   ```

2. **隐藏批量删除按钮（无权限时）**
   ```dart
   if (auth.hasPermission('assets:delete')) {
     return IconButton(
       icon: const Icon(Icons.check_circle_outline),
       onPressed: _enterSelectionMode,
     );
   }
   return const SizedBox.shrink();
   ```

---

## 📝 测试计划

### 测试场景 1：添加设备

**前置条件**：
- 登录账户：admin（有 `structures:create` 权限）

**测试步骤**：
1. 进入某项目的工程结构树
2. 点击系统节点旁的"＋设备"按钮
3. 输入设备信息并确认
4. 验证设备出现在列表中

**期望结果**：
- ✅ 设备创建成功
- ✅ 列表自动刷新

### 测试场景 2：添加设备 - 权限控制

**前置条件**：
- 使用无 `structures:create` 权限的账户登录

**期望结果**：
- ✅ "＋设备"按钮不显示

### 测试场景 3：删除资产权限控制

**有权限用户**：
- ✅ 可以看到"选择"按钮
- ✅ 可以删除 mobile 来源的资产

**无权限用户**：
- ✅ 看不到"选择"按钮
- ✅ 无法删除资产

---

## 📋 实现检查清单

### 添加设备功能

- [ ] 后端 API 验证（已存在 ✅）
- [ ] 添加 DeviceCreate 模型
- [ ] 添加 createDevice API 方法
- [ ] 添加 API 端点常量
- [ ] 实现添加设备对话框 UI
- [ ] 在系统节点显示"＋设备"按钮
- [ ] 更新 StructureProvider
- [ ] 添加权限检查（`structures:create`）
- [ ] 测试功能
- [ ] 测试权限控制

### 删除权限控制

- [ ] 在进入选择模式前检查权限
- [ ] 隐藏"选择"按钮（无权限时）
- [ ] 测试有权限用户
- [ ] 测试无权限用户

---

## 📊 工作量估算

| 任务 | 预计时间 | 难度 |
|------|----------|------|
| 添加设备功能 | 2-3 小时 | 中等 |
| 删除权限控制 | 1 小时 | 简单 |
| 测试和调试 | 1-2 小时 | - |
| **总计** | **4-6 小时** | - |

---

## 📌 总结

**移动端定位**：
- ✅ 查看：项目、工程结构树、资产
- ✅ 操作：添加设备、拍照上传、删除资产
- ❌ 不负责：创建项目、楼栋、系统

**与 PC-UI 的分工**：
- **PC-UI**：项目管理、工程结构配置、数据分析
- **移动端**：现场设备管理、资产采集、照片上传

---

**文档维护**: BDC-AI 开发团队
**创建时间**: 2026-01-26
