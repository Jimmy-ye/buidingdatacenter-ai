# 移动端工程结构与接口审查

> 基于 `mobile/PROJECT_PLAN.md`、`mobile/DEV_CHECKLIST.md` 和当前 `mobile/bdc_ai_app` 代码实现，对移动端的 **结构完整性 / 逻辑完整性 / 接口正确性** 进行一次集中评审。

## 1. 结构完整性评估

### 1.1 工程分层与目录结构

- **入口与路由**
  - `lib/main.dart`：
    - 使用 `MultiProvider` 注入 `AppProvider / ProjectProvider / StructureProvider / AssetProvider`。
    - 路由配置：
      - `'/'` → `ProjectsPage`（项目列表首页）
      - `'/structure'` → `StructureTreePage`（工程结构树）
      - `'/assets'` → `AssetsPage`（资产快捷视图）
  - 与 `mobile/DEV_CHECKLIST.md` 第 4.1 节的规划一致。

- **模型层（models）**
  - `models/project.dart`：
    - 定义 `Project` 模型，包含 `id/name/client/address/description/status/createdAt` 等字段。
    - 提供 `statusText` 等便捷展示属性。
  - `models/structure.dart`：
    - 定义工程结构核心实体：`Building / System / ZoneInfo / Device`。
    - 结构关系：
      - `Building` 持有 `systems: List<System>` 与 `zones: List<ZoneInfo>`。
      - `System` 持有 `devices: List<Device>`。
      - `Device` 引用 `System`（功能归属）和可选 `Zone`（位置属性）。
    - 与后端《工程结构API设计.md》中 v2 结构保持一致：**Building→System→Device 为主树，Building→Zone 为位置维度**。
  - `models/asset.dart`：
    - 定义 `Asset` 模型，字段包括：
      - `id/title/modality/source/contentRole/createdAt/note/rawUrl`；
      - `deviceId/systemId/zoneId/buildingId`。
    - 提供模态/内容角色显示文本与时间格式化等便捷属性。

- **服务层（services）**
  - `services/api_service.dart`：
    - 封装 `GET/POST/PATCH/DELETE` 及 `postMultipart`，集中处理 BaseURL、错误码、异常转换。
  - `services/project_service.dart`：
    - `getProjects(...)`：包装 `GET /api/v1/projects/`，支持 status/type/client/name 过滤。
    - `getProjectDetail(id)`：包装 `GET /api/v1/projects/{id}`。
    - `getStructureTree(projectId)`：包装 `GET /api/v1/projects/{id}/structure_tree`。
  - `services/asset_service.dart`：
    - `getDeviceAssets(deviceId, limit, offset)`：调用 `GET /api/v1/assets/?device_id=...`。
    - `getSystemAssets(systemId, limit, offset)`：调用 `GET /api/v1/assets/?system_id=...`。
    - `uploadImage(...)`：调用 `POST /api/v1/assets/upload_image_with_note`，以 multipart 上传图片和备注，支持 `device_id` 或 `system_id`。
    - `getAssetDetail(assetId)`：`GET /api/v1/assets/{asset_id}`。

- **状态管理（providers）**
  - `ProjectProvider`：
    - 管理项目列表加载状态（`isLoading/hasError/isEmpty`），提供 `loadProjects` / `refreshProjects`。
  - `StructureProvider`：
    - 管理 `buildings: List<Building>`、加载状态与错误信息；
    - 维护楼栋与系统的展开/折叠状态集合；
    - 提供 `loadStructureTree` / `refreshStructureTree` / `expandAll` / `collapseAll` 等方法。
  - `AssetProvider`：
    - 引入视图类型枚举 `AssetViewType.device/system`；
    - 管理资产列表、分页状态（`pageSize/hasMore/isLoadingMore`）与当前视图上下文（`currentViewType/currentTargetId`）；
    - 提供：
      - `loadAssets(targetId, viewType, limit, offset)`；
      - `loadMoreAssets()` 分页加载；
      - `uploadImage(...)` 上传后自动刷新当前视图；
      - `getAssetDetail(assetId)` 获取详情；
      - `clearAssets()` 清空状态。

- **页面层（pages）**
  - `ProjectsPage`：
    - 首次进入自动加载项目列表；
    - 使用 `ProjectProvider` 显示加载/错误/空态；
    - 点击项目卡片后，通过 `AppProvider.selectProject(project)` 保存当前项目，并跳转 `/structure`。
  - `StructureTreePage`：
    - 从 `AppProvider` 读取当前项目 ID，调用 `StructureProvider.loadStructureTree`；
    - 以 **Building → (Systems + Zones)** 的层级展示：
      - `BuildingNode` 下直接渲染 `SystemNode` 列表与 `ZoneInfoTile` 列表，体现 **System/Zone 同级，Device 挂在 System 下**；
    - 核心交互：
      - 点击 `SystemNode` → `_openSystemAssets(system)` → 跳转 `/assets`，视图参数 `viewType='system'`；
      - 点击 `DeviceListItem` → `_openDeviceAssets(device)` → 跳转 `/assets`，视图参数 `viewType='device'`。
  - `AssetsPage`：
    - 从路由参数读取 `viewType/targetId/name`，根据 `viewType` 转换为 `AssetViewType.device/system`；
    - 调用 `AssetProvider.loadAssets` 加载最近 5 条资产；
    - 提供下拉刷新、"查看更多" 分页加载按钮、占位的上传与详情查看交互。

**小结**：

- 整体工程分层清晰，目录与文件命名与文档规划高度一致；
- System 作为主树节点，Zone 作为并列位置属性的设计在 UI 与数据结构中均有体现；
- system 级与 device 级视图在 Provider 和 Page 层均有专门支持；
- 从“结构完整性”角度，可以认为当前移动端骨架是健康且完整的。

## 2. 逻辑完整性评估

### 2.1 项目流（Project Flow）

- `ProjectsPage` + `ProjectProvider` + `ProjectService.getProjects()` 已完整实现：
  - 页面加载 → 调用 `loadProjects` → 显示加载/错误/空态/列表；
  - 支持刷新；
  - 点击项目卡片后通过 `AppProvider.selectProject` 设置当前项目，再跳转工程结构页。
- 逻辑上已满足 PROJECT_PLAN 中对项目选择的基本需求。

### 2.2 工程结构流（Structure Flow）

- `StructureTreePage` + `StructureProvider` + `ProjectService.getStructureTree()`：
  - 首次进入工程结构页时，根据当前项目 ID 调用 `loadStructureTree`；
  - 使用 `BuildingNode` / `SystemNode` / `DeviceListItem` / `ZoneInfoTile` 组件树展示结构；
  - 维护楼栋、系统的展开折叠状态；
  - 支持一键展开/折叠全部节点。
- UI 文案和注释中明确强调：
  - **System 是 Device 的主归属**；
  - **Building → Zone 仅作为位置信息，不在树结构中挂设备**。 

### 2.3 资产流（Asset Flow）

- `StructureTreePage` → 点击 System/Device 跳转 `AssetsPage`，传入：
  - `viewType='system' | 'device'`；
  - `targetId=system.id | device.id`；
  - `name`（用于资产页标题展示）。
- `AssetsPage`：
  - 根据 `viewType` 转换为 `AssetViewType` 枚举；
  - 调用 `AssetProvider.loadAssets`：
    - `viewType == device` → `AssetService.getDeviceAssets(device_id, limit=5, offset=0)`；
    - `viewType == system` → `AssetService.getSystemAssets(system_id, limit=5, offset=0)`；
  - 提供下拉刷新（`refreshAssets`）与"查看更多"分页加载（`loadMoreAssets`）。
- `AssetProvider.uploadImage(...)`：
  - 上传成功后，如果当前已有 `currentTargetId + currentViewType`，会自动调用 `refreshAssets()`，保持列表与后端状态同步。

### 2.4 待完善的逻辑

- `AssetsPage._pickAndUploadImage` 与 `_viewAssetDetail` 目前仅做了占位提示，实际拍照/相册选择与详情跳转需要按 Flutter 插件与后端 API 进一步实现。
- 资产总数 `_totalCount` 目前简单使用 `assets.length`，后续如后端增加精确计数字段，可考虑对齐。

**小结**：

- 从“端到端流”角度：**项目 → 工程结构树 → 设备/系统 → 资产列表** 的主流程已经贯通；
- system 视图已经在 Provider + Page 层完整落地；
- 上传与详情查看仍有 P2/P3 级别的功能待补，但不影响 MVP 的结构与主逻辑评估。

## 3. 接口正确性评估

### 3.1 工程结构接口对齐

- `ProjectService.getStructureTree(projectId)` 当前实现：

  ```dart
  final response = await _api.get(ApiEndpoints.structureTree(projectId));
  final List<dynamic> data = jsonDecode(response.body);
  return data.map((json) => Building.fromJson(json)).toList();
  ```

- 潜在问题：
  - 后端工程结构接口（结合 PC 端与文档）更可能返回形如：

    ```jsonc
    {
      "project_id": "...",
      "tree": { "id": "project-root", "children": [ { "type": "building", ... } ] }
    }
    ```

  - 若实际后端是这种结构，则需要在前端多一步适配，从 `tree.children` 中抽取 `Building` 节点再交给 `Building.fromJson`；
  - 如果后端已经提供了直接返回 `List[Building]` 的移动端专用接口，则当前实现是正确的。

> 建议：在接入后端联调前，确认 `/projects/{id}/structure_tree` 的实际返回 JSON；如为树状包装结构，则增加一个适配层，而不是直接 `jsonDecode` 为 `List<dynamic>`。

### 3.2 资产模型字段与后端 schema

- `models/asset.dart` 当前解析：

  ```dart
  createdAt: json['created_at'] != null
      ? DateTime.parse(json['created_at'].toString())
      : DateTime.now(),
  rawUrl: json['raw_url']?.toString(),
  note: json['note']?.toString(),
  ```

- 后端 Asset schema（结合 `models_asset.py` 和相关 Pydantic schema）中更核心的字段有：
  - `capture_time`：资产采集时间；
  - `file_path` / 下载端点：原始文件存储位置或下载路径；
  - `system_id/device_id/zone_id/building_id`：工程挂接关系。

- 潜在不一致点：
  - 若后端返回 `capture_time` 而非 `created_at`，则当前 `createdAt` 解析会回退到 `DateTime.now()`，时间显示会失真；
  - 若后端未提供 `raw_url` 字段，而是通过 `file_path` 或下载端点构造 URL，则 `AssetsPage` 中的 `Image.network(asset.rawUrl!)` 将无法正常显示图片。

> 建议：
>
> - `createdAt` 字段解析优先使用 `capture_time`，兼容 `created_at`：
>   - 例如：`final ts = json['capture_time'] ?? json['created_at'];`；
> - `rawUrl` 根据后端实际返回调整为：
>   - 要么解析 `file_path` 并由移动端拼接为完整下载 URL；
>   - 要么与后端约定一个稳定的 `download_url` 字段。

### 3.3 资产列表与分页参数

- `AssetService.getDeviceAssets` / `getSystemAssets` 当前使用的查询参数：

  ```dart
  '?device_id=$deviceId&limit=$limit&offset=$offset'
  '?system_id=$systemId&limit=$limit&offset=$offset'
  ```

- 这与 `mobile/API_CHECKLIST.md` 中的规划保持一致；
- 需要在联调阶段确认后端 `/assets/` 实际使用的是 `offset` 还是 `skip` 作为分页起点参数名，并做相应调整。

### 3.4 上传图片接口对齐

- 当前 `AssetService.uploadImage`：

  ```dart
  final fields = <String, String>{
    'project_id': projectId,
    if (deviceId != null && deviceId.isNotEmpty) 'device_id': deviceId,
    if (systemId != null && systemId.isNotEmpty) 'system_id': systemId,
    if (note != null && note.isNotEmpty) 'note': note,
  };

  final response = await _api.postMultipart(
    ApiEndpoints.uploadImage,
    fields: fields,
    files: [multipartFile],
  );
  ```

- 与后端 `POST /api/v1/assets/upload_image_with_note` 的设计方向一致：
  - 通过 multipart 上传文件；
  - 携带 `project_id` 与 `device_id` 或 `system_id`；
  - 填充 `note` 作为备注。

- 可选增强点：
  - 增加 `source='mobile'` 字段，便于后端区分数据来源；
  - 如后端支持 `content_role`（例如 scene_issue/nameplate 等），也可以在移动端增加选择字段后写入；
  - 如后端将 `project_id/device_id/system_id` 作为 query 参数接收，可以考虑把这些信息拼接到 URL 中，`fields` 专注于文本字段（note/title）。

## 4. 综合结论与后续建议

### 4.1 综合结论

- **结构完整性**：
  - 工程目录、分层架构（models/services/providers/pages）以及关键组件命名均与 `PROJECT_PLAN` 与 `DEV_CHECKLIST` 对齐；
  - System 作为工程主维度、Zone 作为位置属性的设计在结构与 UI 中得到正确体现；
  - system 级视图（资产列表与上传）在数据流与页面导航层面已经落地。

- **逻辑完整性**：
  - 项目选择 → 工程结构树 → 资产列表的主流程已经串通；
  - Provider 层的加载、错误、刷新与分页逻辑较为完备；
  - 上传与详情查看功能仍有一定占位逻辑，属于下一阶段可逐步完善的 P2/P3 功能。

- **接口正确性**：
  - 端点路径（projects / structure_tree / assets / upload_image_with_note）与查询参数（device_id/system_id/limit/offset）总体上与文档规划一致；
  - 主要需在联调阶段确认并修正的点集中在：
    - 工程结构树返回 JSON 的外层包装结构；
    - Asset 模型中时间字段与图片 URL 的具体字段名；
    - 分页参数名（offset vs skip）以及额外业务字段（source/content_role 等）。

### 4.2 建议的后续工作优先级

1. **接口细节对齐（高优先级）**
   - 与后端联调 `/projects/{id}/structure_tree` 与 `/assets/` / `upload_image_with_note`：
     - 确认字段名：`capture_time`/`created_at`、`raw_url`/`file_path`、分页参数名；
     - 据此微调 `Asset.fromJson`、`ProjectService.getStructureTree` 与相关 Service 调用。

2. **完善上传与详情功能（中优先级）**
   - 在 `AssetsPage._pickAndUploadImage` 中接入实际的图片选择/拍照逻辑；
   - 衔接 `AssetProvider.uploadImage`，打通移动端完整上传流程；
   - 实现资产详情页（或在现有详情占位逻辑上扩展）。

3. **与文档的双向更新（中优先级）**
   - 若后端 JSON 结构与原先规划有调整（尤其是 structure_tree、assets 字段），建议同步更新：
     - `mobile/PROJECT_PLAN.md` 中的接口示例；
     - `mobile/API_CHECKLIST.md` 中的字段说明；
     - 相关技术文档中对 System/Device/Zone/Asset 关系的示意图。

> 通过本次审查，可以认为移动端在“工程结构 + 资产视图（含系统级支持）”这一块已经具备比较完整的工程架构与主流程，后续开发的重点可以聚焦在 **接口字段的精细对齐** 与 **拍照上传/详情等交互体验** 的打磨上。
