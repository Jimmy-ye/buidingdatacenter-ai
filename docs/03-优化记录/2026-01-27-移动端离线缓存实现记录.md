# 2026-01-27 移动端离线缓存实现记录

**适用项目**：BDC-AI 移动端

---

## 1. 背景与目标

移动端在弱网 / 无网场景下，项目列表和工程结构树会出现白屏或长时间加载，影响现场使用体验。此前文档《离线缓存功能与前后端传输条件详解》已经给出了整体方案，但代码层面只完成了依赖与配置，核心实现尚未落地。

本次实现的目标：

- 为 **项目列表** 和 **工程结构树** 落地离线缓存能力。
- 网络正常时优先使用最新数据，网络异常或离线时自动回退到本地缓存。
- 控制缓存有效期为 **24 小时**，保证数据不过于陈旧。

不在本次范围内：

- 资产列表缓存。
- 上传队列与离线上传。

---

## 2. 技术方案概览

### 2.1 存储与配置

- 存储介质：`SharedPreferences`（键值对，JSON 字符串）。
- 缓存时长：`AppConfig.cacheDurationHours = 24`。
- 缓存策略：**Cache-First + 过期检查 + 网络失败降级**。
- 图片继续使用 `cached_network_image`，与本次实现互不影响。

### 2.2 缓存键名

在 `lib/config/constants.dart` 中新增：

- `CacheKeys.projectList` / `CacheKeys.projectListTimestamp`
- `CacheKeys.structureTree` / `CacheKeys.structureTreeTimestamp`
- `CacheKeys.offlineMode`（预留，将来可用于全局离线模式标记）

---

## 3. 代码改动一览

### 3.1 缓存键名常量（constants.dart）

文件：`mobile/bdc_ai_app/lib/config/constants.dart`

新增：

- `class CacheKeys`：集中管理所有与离线缓存相关的键名，避免硬编码字符串。

影响：

- `ProjectProvider`、`StructureProvider` 统一从此处取键名，后续如需调整只需改一处。

### 3.2 工程结构树缓存（StructureProvider）

文件：`mobile/bdc_ai_app/lib/providers/structure_provider.dart`

关键点：

- 新增依赖：
  - `dart:convert`
  - `package:shared_preferences/shared_preferences.dart`
  - `../config/constants.dart`
- 在 `loadStructureTree(String projectId)` 中实现缓存逻辑：
  1. 调用 `_loadFromCache(projectId)`。
  2. 若有缓存：
     - 立即将缓存数据赋给 `buildings` 并 `notifyListeners()`。
     - 调用 `_isCacheExpired(projectId)` 检查是否超过 `cacheDurationHours`：
       - 未过期：直接返回，不发网络请求。
       - 已过期：继续向下执行网络刷新逻辑。
  3. 若无缓存或缓存已过期：
     - 调 `_service.getStructureTree(projectId)` 从后端获取最新数据。
     - 成功后调用 `_saveToCache(projectId, buildings)` 写入缓存与时间戳。

- 新增私有方法：
  - `_loadFromCache(String projectId)`：从 SharedPreferences 读取 JSON，反序列化为 `List<Building>`。
  - `_saveToCache(String projectId, List<Building> data)`：序列化结构树，写入数据与时间戳。
  - `_isCacheExpired(String projectId)`：对比当前时间与缓存时间，判断是否超过 `cacheDurationHours`。
  - `clearStructureCache(String projectId)`：清理指定项目的结构树缓存（调试与手动刷新时可用）。

- 异常与 401/403 处理：
  - 保留原有对 `ApiException` 401/403 的特判，继续交由全局认证处理。
  - 对网络异常等其它错误：
    - 若 `cachedData != null`：降级使用缓存，不设置错误消息，仅记日志。
    - 若无缓存：保持原有 `_setError('加载工程结构失败: $e')` 行为。

效果：

- 有网 + 首次进入：从网络加载结构树，同时写入缓存。
- 有网 + 24 小时内再次进入：直接展示缓存，不访问后端。
- 无网 + 有缓存：仍能展示上次的工程结构树，不出现白屏。
- 无网 + 无缓存：仍会显示错误提示，行为与之前一致。

### 3.3 项目列表缓存（ProjectProvider）

文件：`mobile/bdc_ai_app/lib/providers/project_provider.dart`

关键点：

- 新增依赖：
  - `dart:convert`
  - `package:shared_preferences/shared_preferences.dart`
  - `../config/constants.dart`
- 在 `loadProjects` 中接入缓存逻辑，仅在 **无筛选条件**（`status/type/client/name` 全为 `null`）时启用缓存：

  1. 计算 `enableCache`：只有默认项目列表使用缓存，带筛选的请求始终走网络。
  2. `enableCache == true` 时：
     - 调 `_loadFromCache()`，如有缓存则立即展示并检查 `_isCacheExpired()`。
     - 未过期则直接返回；已过期则继续走网络刷新。
  3. 网络请求成功后，在 `enableCache == true` 时调用 `_saveToCache(_projects)` 写入数据与时间戳。

- 新增私有方法：
  - `_loadFromCache()`：从 SharedPreferences 读取项目列表 JSON，转为 `List<Project>`。
  - `_saveToCache(List<Project> data)`：写入 JSON 和时间戳。
  - `_isCacheExpired()`：检查项目列表缓存是否超过 `cacheDurationHours`。
  - `clearProjectCache()`：清理项目列表缓存。

- 异常与 401/403 处理：
  - 保留对 `ApiException` 401/403 的特判，继续交由全局认证处理。
  - 其它错误：
    - 若 `enableCache && cachedData != null`：降级使用之前的缓存数据，不展示错误页。
    - 否则仍按原逻辑设置错误消息。

效果：

- 应用启动后第一次进入项目列表：从网络获取数据并写入缓存。
- 再次进入项目页且在 24 小时内：直接使用缓存，避免每次都打后端。
- 网络断开但本地有缓存：仍能看到项目列表。
- 使用条件筛选时不走缓存，始终访问最新数据。

---

## 4. 行为总结

### 4.1 正常网络

- 项目列表 / 工程结构树首次访问：
  - 发起网络请求 → 更新 UI → 写入缓存与时间戳。
- 24 小时内再次访问：
  - 直接读取缓存并展示。
  - 如实现了“缓存已过期后台刷新”也不会阻塞首屏（当前实现为简单前台刷新）。

### 4.2 弱网 / 无网

- 若已有缓存：
  - Provider 在捕获到网络/超时异常时，会选择继续使用缓存数据，不弹出错误页。
- 若没有缓存：
  - 行为与改造前一致，提示加载失败（因为真的既没网络也没历史数据）。

### 4.3 401/403 认证失败

- 保持之前约定：
  - 401/403 仍触发全局认证失效处理（自动登出、回到登录页）。
  - Provider 不会设置 `errorMessage`，避免在业务页面显示“加载失败 (403)”界面。

---

## 5. 使用与调试建议

### 5.1 手动清理缓存

开发或测试时，如需强制重新拉取最新数据，可以调用：

- `StructureProvider.clearStructureCache(projectId)`
- `ProjectProvider.clearProjectCache()`

或直接在设备上清除应用数据。

### 5.2 日志观察点

常见日志片段：

- `工程结构树无缓存数据` / `项目列表无缓存数据`
- `工程结构树缓存未过期，跳过网络请求`
- `项目列表缓存已过期，尝试从网络刷新`
- `工程结构树请求失败，使用缓存数据: ...`

通过这些日志可以快速判断当前是走网络还是走缓存。

---

## 6. 后续规划

- 资产列表的离线缓存（按项目 / 系统 / 设备分层）。
- 上传队列与离线上传机制（本地排队 + 成功后清理）。
- 在 UI 层增加“离线模式”提示条，基于 `CacheKeys.offlineMode` 或专门的 Provider 管理全局离线状态。

本次改动已将基础设施和关键列表打通，为后续扩展奠定了基础。
