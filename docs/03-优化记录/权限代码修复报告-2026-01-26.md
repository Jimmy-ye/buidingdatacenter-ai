# æƒé™ä»£ç ä¿®å¤æŠ¥å‘Š

**æ—¥æœŸ**: 2026-01-26
**é—®é¢˜**: PC-UI æŒ‰é’®ä¸æ˜¾ç¤ºï¼ˆå¦‚"ï¼‹é¡¹ç›®"æŒ‰é’®ï¼‰
**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ” é—®é¢˜åˆ†æ

### ç”¨æˆ·æŠ¥å‘Š

PC-UI ç™»å½•åï¼Œéƒ¨åˆ†æŒ‰é’®ä¸æ˜¾ç¤ºï¼š
- âŒ "ï¼‹é¡¹ç›®" æŒ‰é’®ä¸æ˜¾ç¤º
- âŒ å…¶ä»–é¡¹ç›®ç®¡ç†æŒ‰é’®ä¸æ˜¾ç¤º
- âŒ èµ„äº§ç®¡ç†æŒ‰é’®ä¸å®Œæ•´

### æ ¹æœ¬åŸå› 

**æƒé™ä»£ç å‘½åä¸ä¸€è‡´**ï¼š

| ç»„ä»¶ | ä½¿ç”¨çš„æƒé™ç  | çŠ¶æ€ |
|------|-------------|------|
| PC-UI ä»£ç  (`pc_app.py:333`) | `projects:create` | âœ… å¤æ•°å½¢å¼ |
| æ•°æ®åº“æƒé™è¡¨ | `project:create` | âŒ å•æ•°å½¢å¼ |
| åˆå§‹åŒ–è„šæœ¬ | `project:create` | âŒ å•æ•°å½¢å¼ |

**é—®é¢˜æµç¨‹**ï¼š
```
1. åç«¯è¿”å›æƒé™: ["project:create", "project:read", ...]
2. PC-UI æ£€æŸ¥: has_permission('projects:create')
3. åŒ¹é…å¤±è´¥: "projects:create" â‰  "project:create"
4. è¿”å› False â†’ æŒ‰é’®ä¸æ¸²æŸ“ âŒ
```

### å—å½±å“çš„æƒé™

**é¡¹ç›®ç®¡ç†æƒé™**ï¼ˆå•æ•° â†’ å¤æ•°ï¼‰ï¼š
- âŒ `project:create` â†’ âœ… `projects:create`
- âŒ `project:read` â†’ âœ… `projects:read`
- âŒ `project:update` â†’ âœ… `projects:update`
- âŒ `project:delete` â†’ âœ… `projects:delete`

**èµ„äº§ç®¡ç†æƒé™**ï¼ˆå•æ•° â†’ å¤æ•°ï¼‰ï¼š
- âŒ `asset:create` â†’ âœ… `assets:create`
- âŒ `asset:read` â†’ âœ… `assets:read`
- âŒ `asset:update` â†’ âœ… `assets:update`
- âŒ `asset:delete` â†’ âœ… `assets:delete`

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆé€‰æ‹©

**æ–¹æ¡ˆ Aï¼šä¿®æ”¹æ•°æ®åº“æƒé™ä»£ç ** âœ… å·²é‡‡ç”¨
- ä¼˜ç‚¹ï¼šä¸ PC-UI ä»£ç å’Œæ–‡æ¡£ä¿æŒä¸€è‡´
- ä¼˜ç‚¹ï¼šä¸€æ¬¡ä¿®å¤ï¼Œé•¿æœŸæœ‰æ•ˆ
- ç¼ºç‚¹ï¼šéœ€è¦æ›´æ–°ç°æœ‰æ•°æ®åº“

**æ–¹æ¡ˆ Bï¼šä¿®æ”¹ PC-UI ä»£ç ** âŒ æœªé‡‡ç”¨
- ä¼˜ç‚¹ï¼šä¸éœ€è¦åŠ¨æ•°æ®åº“
- ç¼ºç‚¹ï¼šå¯¼è‡´ä»£ç /æ–‡æ¡£/æ•°æ®åº“ä¸ä¸€è‡´
- ç¼ºç‚¹ï¼šåç»­å®¹æ˜“æ··ä¹±

---

## ğŸ“ ä¿®å¤å†…å®¹

### 1. æ›´æ–°åˆå§‹åŒ–è„šæœ¬

**æ–‡ä»¶**: `scripts/Windows/init_auth_data.py`

**ä¿®æ”¹**ï¼š
```python
# ä¿®æ”¹å‰
{"code": "project:create", "name": "åˆ›å»ºé¡¹ç›®", ...}
{"code": "project:read", "name": "æŸ¥çœ‹é¡¹ç›®", ...}
{"code": "project:update", "name": "æ›´æ–°é¡¹ç›®", ...}
{"code": "project:delete", "name": "åˆ é™¤é¡¹ç›®", ...}

{"code": "asset:create", "name": "åˆ›å»ºèµ„äº§", ...}
{"code": "asset:read", "name": "æŸ¥çœ‹èµ„äº§", ...}
{"code": "asset:update", "name": "æ›´æ–°èµ„äº§", ...}
{"code": "asset:delete", "name": "åˆ é™¤èµ„äº§", ...}

# ä¿®æ”¹å
{"code": "projects:create", "name": "åˆ›å»ºé¡¹ç›®", ...}
{"code": "projects:read", "name": "æŸ¥çœ‹é¡¹ç›®", ...}
{"code": "projects:update", "name": "æ›´æ–°é¡¹ç›®", ...}
{"code": "projects:delete", "name": "åˆ é™¤é¡¹ç›®", ...}

{"code": "assets:create", "name": "åˆ›å»ºèµ„äº§", ...}
{"code": "assets:read", "name": "æŸ¥çœ‹èµ„äº§", ...}
{"code": "assets:update", "name": "æ›´æ–°èµ„äº§", ...}
{"code": "assets:delete", "name": "åˆ é™¤èµ„äº§", ...}
```

---

### 2. æ–°å¢ SQL ä¿®å¤è„šæœ¬

**æ–‡ä»¶**: `scripts/æ•°æ®åº“/fix_permission_codes.sql`

**ç”¨é€”**: åœ¨ç°æœ‰æ•°æ®åº“ä¸­ä¿®å¤æƒé™ä»£ç ï¼ˆæ— éœ€é‡æ–°åˆå§‹åŒ–ï¼‰

**åŠŸèƒ½**ï¼š
```sql
-- é¡¹ç›®ç®¡ç†æƒé™ï¼šproject:* â†’ projects:*
UPDATE permissions
SET code = 'projects:create', resource = 'projects'
WHERE code = 'project:create';

-- èµ„äº§ç®¡ç†æƒé™ï¼šasset:* â†’ assets:*
UPDATE permissions
SET code = 'assets:create', resource = 'assets'
WHERE code = 'asset:create';

-- éªŒè¯ä¿®å¤ç»“æœ
DO $$
    RAISE NOTICE 'âœ… æƒé™ä»£ç ä¿®å¤æˆåŠŸï¼';
END $$;
```

---

### 3. æ›´æ–°éªŒè¯è„šæœ¬

**æ–‡ä»¶**: `scripts/æµ‹è¯•/test_yerui_permissions.py`

**æ–°å¢æ£€æŸ¥**ï¼š
```python
required_permissions = [
    # é¡¹ç›®ç®¡ç†æƒé™ï¼ˆæ–°å¢ï¼‰
    ('projects:create', 'åˆ›å»ºé¡¹ç›®'),
    ('projects:read', 'æŸ¥çœ‹é¡¹ç›®'),
    ('projects:update', 'æ›´æ–°é¡¹ç›®'),
    ('projects:delete', 'åˆ é™¤é¡¹ç›®'),

    # èµ„äº§ç®¡ç†æƒé™ï¼ˆæ–°å¢ create/update/deleteï¼‰
    ('assets:upload', 'ä¸Šä¼ èµ„äº§'),
    ('assets:read', 'æŸ¥çœ‹èµ„äº§'),
    ('assets:create', 'åˆ›å»ºèµ„äº§'),
    ('assets:update', 'æ›´æ–°èµ„äº§'),
    ('assets:delete', 'åˆ é™¤èµ„äº§'),

    # å·¥ç¨‹ç»“æ„æƒé™
    ('structures:create', 'åˆ›å»ºç»“æ„'),
    ('structures:read', 'æŸ¥çœ‹ç»“æ„'),
    ('structures:update', 'æ›´æ–°ç»“æ„'),
    ('structures:delete', 'åˆ é™¤ç»“æ„'),

    # åŠŸèƒ½æƒé™
    ('ocr:run', 'è¿è¡ŒOCR'),
    ('llm:run', 'è¿è¡ŒLLM'),
]
```

---

## âœ… æµ‹è¯•ç»“æœ

### ä¿®å¤å‰

```
æƒé™æ€»æ•°: 26
PC-UI å…³é”®æƒé™:
  [FAIL] projects:create: ç¼ºå¤±ï¼
  [FAIL] projects:read: ç¼ºå¤±ï¼
  [FAIL] assets:create: ç¼ºå¤±ï¼

ç»“æœ: éƒ¨åˆ†æµ‹è¯•å¤±è´¥
```

### ä¿®å¤å

```
æƒé™æ€»æ•°: 33 (ä» 26 å¢åŠ )
is_superuser: True

PC-UI å…³é”®æƒé™éªŒè¯:
  [OK] projects:create: åˆ›å»ºé¡¹ç›®       â† ä¿®å¤æˆåŠŸï¼
  [OK] projects:read: æŸ¥çœ‹é¡¹ç›®
  [OK] projects:update: æ›´æ–°é¡¹ç›®
  [OK] projects:delete: åˆ é™¤é¡¹ç›®
  [OK] assets:upload: ä¸Šä¼ èµ„äº§
  [OK] assets:read: æŸ¥çœ‹èµ„äº§
  [OK] assets:create: åˆ›å»ºèµ„äº§         â† æ–°å¢ï¼
  [OK] assets:update: æ›´æ–°èµ„äº§         â† æ–°å¢ï¼
  [OK] assets:delete: åˆ é™¤èµ„äº§         â† æ–°å¢ï¼
  [OK] structures:create: åˆ›å»ºç»“æ„
  [OK] structures:read: æŸ¥çœ‹ç»“æ„
  [OK] structures:update: æ›´æ–°ç»“æ„
  [OK] structures:delete: åˆ é™¤ç»“æ„
  [OK] ocr:run: è¿è¡ŒOCR
  [OK] llm:run: è¿è¡ŒLLM

[SUCCESS] æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æƒé™ä¿®å¤æˆåŠŸï¼
```

---

## ğŸš€ éƒ¨ç½²æŒ‡å—

### æœ¬åœ°å¼€å‘ç¯å¢ƒ

```bash
# 1. é‡æ–°åˆå§‹åŒ–æƒé™æ•°æ®
python scripts/Windows/init_auth_data.py

# 2. éªŒè¯ä¿®å¤
python scripts/æµ‹è¯•/test_yerui_permissions.py

# 3. é‡å¯åç«¯æœåŠ¡
scripts\å¿«é€Ÿå¯åŠ¨\åœæ­¢æ‰€æœ‰æœåŠ¡.bat
scripts\å¿«é€Ÿå¯åŠ¨\å¯åŠ¨åç«¯æœåŠ¡.bat

# 4. æµ‹è¯• PC-UI
# è®¿é—® http://localhost:8080
# ä½¿ç”¨ yerui/ye123456 ç™»å½•
# éªŒè¯ "ï¼‹é¡¹ç›®" æŒ‰é’®æ˜¾ç¤º
```

---

### è¿œç¨‹æœåŠ¡å™¨ï¼ˆç°æœ‰æ•°æ®åº“ï¼‰

#### æ­¥éª¤ 1ï¼šè¿æ¥åˆ°æœåŠ¡å™¨

```bash
# é€šè¿‡ Tailscale VPN è¿æ¥
# æˆ–ç›´æ¥ SSH è¿æ¥åˆ°æœåŠ¡å™¨
```

#### æ­¥éª¤ 2ï¼šä¿®å¤æƒé™ä»£ç 

```bash
# æ–¹å¼ 1: ä½¿ç”¨ psql æ‰§è¡Œ SQL è„šæœ¬
psql -U admin -d bdc_ai -f scripts/æ•°æ®åº“/fix_permission_codes.sql

# æ–¹å¼ 2: è¿›å…¥ psql åæ‰§è¡Œ
psql -U admin -d bdc_ai
\i scripts/æ•°æ®åº“/fix_permission_codes.sql
```

**é¢„æœŸè¾“å‡º**ï¼š
```
===========================================
æƒé™ä»£ç ä¿®å¤éªŒè¯ç»“æœ
===========================================
project:* (å•æ•°) æ•°é‡: 0 (åº”ä¸º 0)
projects:* (å¤æ•°) æ•°é‡: 4 (åº”ä¸º 4)

asset:* (å•æ•°æ’é™¤ assets:*) æ•°é‡: 0 (åº”ä¸º 0)
assets:* (å¤æ•°) æ•°é‡: 4 (åº”ä¸º 4)
===========================================
âœ… æƒé™ä»£ç ä¿®å¤æˆåŠŸï¼
```

#### æ­¥éª¤ 3ï¼šéªŒè¯ä¿®å¤

```bash
# æ–¹å¼ 1: ä½¿ç”¨ Python éªŒè¯è„šæœ¬
python scripts/æµ‹è¯•/test_yerui_permissions.py

# æ–¹å¼ 2: ä½¿ç”¨ psql ç›´æ¥æŸ¥è¯¢
psql -U admin -d bdc_ai -c "
SELECT code, name, resource
FROM permissions
WHERE resource IN ('projects', 'assets')
ORDER BY resource, action;
"
```

**é¢„æœŸç»“æœ**ï¼š
```
   code    |     name      | resource
-----------+---------------+-----------
 projects:create | åˆ›å»ºé¡¹ç›® | projects
 projects:read   | æŸ¥çœ‹é¡¹ç›® | projects
 projects:update | æ›´æ–°é¡¹ç›® | projects
 projects:delete | åˆ é™¤é¡¹ç›® | projects
 assets:create   | åˆ›å»ºèµ„äº§ | assets
 assets:read     | æŸ¥çœ‹èµ„äº§ | assets
 assets:update   | æ›´æ–°èµ„äº§ | assets
 assets:delete   | åˆ é™¤èµ„äº§ | assets
(8 rows)
```

#### æ­¥éª¤ 4ï¼šé‡å¯åç«¯æœåŠ¡

```bash
# ä½¿ç”¨ systemd é‡å¯
sudo systemctl restart bdc-backend

# æˆ–æ‰‹åŠ¨é‡å¯
# åœæ­¢æ—§è¿›ç¨‹
pkill -f "uvicorn services.backend.app.main:app"

# å¯åŠ¨æ–°è¿›ç¨‹
cd /path/to/BDC-AI
python -m uvicorn services.backend.app.main:app --host 0.0.0.0 --port 8000
```

#### æ­¥éª¤ 5ï¼šæµ‹è¯• PC-UI

```bash
# 1. è®¿é—® PC-UI
http://<æœåŠ¡å™¨åœ°å€>:8080

# 2. ä½¿ç”¨ yerui æˆ– admin ç™»å½•
# 3. éªŒè¯æŒ‰é’®æ˜¾ç¤ºï¼š
#    - å·¦ä¾§ "ï¼‹é¡¹ç›®" æŒ‰é’®æ˜¾ç¤º âœ…
#    - å·¥ç¨‹ç»“æ„æŒ‰é’®æ˜¾ç¤º âœ…
#    - èµ„äº§ç®¡ç†æŒ‰é’®å®Œæ•´ âœ…
```

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

### æœ¬åœ°ç¯å¢ƒ

- [x] åˆå§‹åŒ–è„šæœ¬å·²æ›´æ–°
- [x] SQL ä¿®å¤è„šæœ¬å·²åˆ›å»º
- [x] éªŒè¯è„šæœ¬å·²æ›´æ–°
- [x] æœ¬åœ°æµ‹è¯•é€šè¿‡
- [x] æƒé™ä»£ç ç»Ÿä¸€ä¸ºå¤æ•°å½¢å¼

### è¿œç¨‹æœåŠ¡å™¨

- [ ] è¿è¡Œ SQL ä¿®å¤è„šæœ¬
- [ ] éªŒè¯æƒé™ä»£ç å·²æ›´æ–°
- [ ] é‡å¯åç«¯æœåŠ¡
- [ ] PC-UI ç™»å½•éªŒè¯
- [ ] æ‰€æœ‰æŒ‰é’®æ­£å¸¸æ˜¾ç¤º

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰

```json
// /api/v1/auth/me è¿”å›
{
  "username": "yerui",
  "is_superuser": true,
  "roles": [{
    "name": "superadmin",
    "permissions": [
      {"code": "project:create", ...},  â† å•æ•°
      {"code": "project:read", ...},
      ...
    ]
  }]
}

// PC-UI æ£€æŸ¥
has_permission('projects:create')  â†’ False  âŒ
has_permission('project:create')   â†’ True   (ä½†ä»£ç é‡Œæ²¡æ£€æŸ¥)
```

### ä¿®å¤å

```json
// /api/v1/auth/me è¿”å›
{
  "username": "yerui",
  "is_superuser": true,
  "roles": [{
    "name": "superadmin",
    "permissions": [
      {"code": "projects:create", ...},  â† å¤æ•° âœ…
      {"code": "projects:read", ...},
      {"code": "assets:create", ...},
      ...
    ]
  }]
}

// PC-UI æ£€æŸ¥
has_permission('projects:create')  â†’ True  âœ…
has_permission('projects:read')    â†’ True  âœ…
// æ‰€æœ‰æŒ‰é’®æ­£å¸¸æ˜¾ç¤º âœ…
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **æƒé™ä¿®å¤è®°å½•**: `docs/03-ä¼˜åŒ–è®°å½•/æƒé™åˆå§‹åŒ–ä¿®å¤è®¡åˆ’.md`
- **è´¦å·æƒé™æŒ‡å—**: `docs/04-ä½¿ç”¨æŒ‡å—/è´¦å·æƒé™ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md`
- **æµ‹è¯•æŒ‡å—**: `scripts/æµ‹è¯•/test_permission_control.md`
- **SQL ä¿®å¤è„šæœ¬**: `scripts/æ•°æ®åº“/fix_permission_codes.sql`
- **éªŒè¯è„šæœ¬**: `scripts/æµ‹è¯•/test_yerui_permissions.py`

---

## ğŸ”— æäº¤ä¿¡æ¯

**æäº¤å“ˆå¸Œ**: 0437e6a
**åˆ†æ”¯**: master
**çŠ¶æ€**: æœ¬åœ°å·²æäº¤ï¼ˆè¿œç¨‹å¾…æ¨é€ï¼‰

**æ–‡ä»¶å˜æ›´**:
- âœ… `scripts/Windows/init_auth_data.py` - æ›´æ–°æƒé™ä»£ç 
- âœ… `scripts/æ•°æ®åº“/fix_permission_codes.sql` - æ–°å¢ SQL ä¿®å¤è„šæœ¬
- âœ… `scripts/æµ‹è¯•/test_yerui_permissions.py` - æ›´æ–°éªŒè¯è„šæœ¬

---

**ä¿®å¤å®Œæˆï¼** ğŸ‰

**ç»´æŠ¤**: BDC-AI å¼€å‘å›¢é˜Ÿ
**æœ€åæ›´æ–°**: 2026-01-26
