# å®‰å…¨åˆ é™¤ç­–ç•¥è®¾è®¡

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰äº† BDC-AI å¹³å°ä¸­é¡¹ç›®å’Œç›¸å…³æ•°æ®çš„å®‰å…¨åˆ é™¤ç­–ç•¥ï¼ŒåŒ…æ‹¬è½¯åˆ é™¤ã€æŒ‰æ ‡ç­¾ç­›é€‰ã€åˆ é™¤ç¡®è®¤ç­‰æœºåˆ¶ï¼Œä»¥é˜²æ­¢è¯¯åˆ é™¤é‡è¦æ•°æ®ã€‚

---

## ğŸ¯ è®¾è®¡ç›®æ ‡

1. **é˜²æ­¢è¯¯åˆ **ï¼šæä¾›å¤šé‡ç¡®è®¤æœºåˆ¶
2. **å¯æ¢å¤æ€§**ï¼šæ”¯æŒè½¯åˆ é™¤å’Œæ¢å¤åŠŸèƒ½
3. **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒæŒ‰æ ‡ç­¾ã€æ—¶é—´èŒƒå›´ç­‰æ¡ä»¶æ‰¹é‡åˆ é™¤
4. **å®¡è®¡è¿½è¸ª**ï¼šè®°å½•æ‰€æœ‰åˆ é™¤æ“ä½œçš„å®Œæ•´æ—¥å¿—
5. **çº§è”å¤„ç†**ï¼šæ­£ç¡®å¤„ç†å…³è”æ•°æ®çš„åˆ é™¤

---

## ğŸ“Š æ•°æ®æ¨¡å‹æ‰©å±•

### 1. æ·»åŠ è½¯åˆ é™¤å­—æ®µ

åœ¨ `Project`ã€`Asset`ã€`Building`ã€`Zone`ã€`System`ã€`Device` ç­‰æ ¸å¿ƒè¡¨ä¸­æ·»åŠ è½¯åˆ é™¤å­—æ®µï¼š

```python
# shared/db/models_project.py

class Project(Base):
    __tablename__ = "projects"

    # ... ç°æœ‰å­—æ®µ ...

    # è½¯åˆ é™¤ç›¸å…³å­—æ®µ
    is_deleted = Column(Boolean, default=False, nullable=False, index=True)
    deleted_at = Column(DateTime, nullable=True)
    deleted_by = Column(String(100), nullable=True)  # æ“ä½œäºº
    deletion_reason = Column(String(500), nullable=True)  # åˆ é™¤åŸå› 
```

### 2. åˆ é™¤å®¡è®¡è¡¨

åˆ›å»ºåˆ é™¤å®¡è®¡æ—¥å¿—è¡¨ï¼š

```python
# shared/db/models_audit.py

class DeletionAudit(Base):
    """åˆ é™¤æ“ä½œå®¡è®¡æ—¥å¿—"""
    __tablename__ = "deletion_audits"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    entity_type = Column(String(50), nullable=False)  # Project, Asset, Building ç­‰
    entity_id = Column(UUID(as_uuid=True), nullable=False)
    operation = Column(String(20), nullable=False)  # soft_delete, hard_delete, restore
    operator = Column(String(100), nullable=False)  # æ“ä½œäºº
    reason = Column(String(500), nullable=True)  # åˆ é™¤åŸå› 
    metadata = Column(JSONB, nullable=True)  # å…¶ä»–å…ƒæ•°æ®
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
```

---

## ğŸ·ï¸ æµ‹è¯•é¡¹ç›®æ ‡ç­¾ç­–ç•¥

### æ ‡ç­¾è§„èŒƒ

ä¸ºæµ‹è¯•é¡¹ç›®æ·»åŠ ç»Ÿä¸€çš„æ ‡ç­¾ï¼Œæ–¹ä¾¿è¯†åˆ«å’Œæ‰¹é‡åˆ é™¤ï¼š

```python
# æ¨èçš„æµ‹è¯•é¡¹ç›®æ ‡ç­¾
TEST_TAGS = {
    "environment": "test",  # ç¯å¢ƒç±»å‹ï¼štest, dev, staging, prod
    "auto_generated": "true",  # æ˜¯å¦è‡ªåŠ¨ç”Ÿæˆ
    "temporary": "true",  # æ˜¯å¦ä¸´æ—¶é¡¹ç›®
    "test_category": "unit",  # æµ‹è¯•ç±»å‹ï¼šunit, integration, e2e
}
```

### é¡¹ç›®åˆ›å»ºæ—¶è‡ªåŠ¨æ‰“æ ‡

```python
# services/backend/app/api/v1/projects.py

@router.post("/")
async def create_project(
    payload: ProjectCreate,
    db: Session = Depends(get_db),
) -> ProjectRead:
    """åˆ›å»ºæ–°é¡¹ç›®ï¼ˆè‡ªåŠ¨æ‰“æ ‡ï¼‰"""
    project = Project(**payload.model_dump())

    # è‡ªåŠ¨æ£€æµ‹æµ‹è¯•é¡¹ç›®å¹¶æ‰“æ ‡
    if is_test_project(payload.name):
        if not project.tags:
            project.tags = {}
        project.tags["environment"] = "test"
        project.tags["auto_generated"] = "true"
        project.tags["temporary"] = "true"

    db.add(project)
    db.commit()
    db.refresh(project)
    return project


def is_test_project(name: str) -> bool:
    """æ£€æµ‹æ˜¯å¦ä¸ºæµ‹è¯•é¡¹ç›®"""
    test_keywords = ["test", "demo", "example", "sample", "auto", "temp"]
    return any(keyword in name.lower() for keyword in test_keywords)
```

---

## ğŸ—‘ï¸ åˆ é™¤ç­–ç•¥

### ç­–ç•¥ 1ï¼šè½¯åˆ é™¤ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šæ‰€æœ‰åˆ é™¤æ“ä½œ

**å®ç°**ï¼š

```python
@router.delete("/{project_id}", status_code=status.HTTP_204_NO_CONTENT)
async def delete_project(
    project_id: str,
    reason: str = Query(None, description="åˆ é™¤åŸå› "),
    hard_delete: bool = Query(False, description="æ˜¯å¦ç‰©ç†åˆ é™¤ï¼ˆå±é™©æ“ä½œï¼‰"),
    operator: str = Header(None, description="æ“ä½œäºº"),
    db: Session = Depends(get_db)
) -> None:
    """åˆ é™¤é¡¹ç›®ï¼ˆæ”¯æŒè½¯åˆ é™¤å’Œç¡¬åˆ é™¤ï¼‰"""
    project = db.query(Project).filter(Project.id == project_uuid).first()
    if not project:
        raise HTTPException(status_code=404, detail="Project not found")

    if hard_delete:
        # ç¡¬åˆ é™¤ï¼šç‰©ç†åˆ é™¤æ•°æ®ï¼ˆå±é™©æ“ä½œï¼Œéœ€è¦é¢å¤–ç¡®è®¤ï¼‰
        if not reason:
            raise HTTPException(
                status_code=400,
                detail="ç¡¬åˆ é™¤å¿…é¡»æä¾›åˆ é™¤åŸå› "
            )

        # å…ˆåˆ é™¤å…³è”çš„ Asset
        db.query(Asset).filter(Asset.project_id == project_uuid).delete()
        # ç„¶ååˆ é™¤é¡¹ç›®ï¼ˆå·¥ç¨‹ç»“æ„é€šè¿‡ CASCADE åˆ é™¤ï¼‰
        db.delete(project)

        # è®°å½•å®¡è®¡æ—¥å¿—
        audit = DeletionAudit(
            entity_type="Project",
            entity_id=project_uuid,
            operation="hard_delete",
            operator=operator or "system",
            reason=reason,
            metadata={"project_name": project.name}
        )
        db.add(audit)

    else:
        # è½¯åˆ é™¤ï¼šä»…æ ‡è®°ä¸ºå·²åˆ é™¤
        project.is_deleted = True
        project.deleted_at = datetime.utcnow()
        project.deleted_by = operator or "system"
        project.deletion_reason = reason

        # è®°å½•å®¡è®¡æ—¥å¿—
        audit = DeletionAudit(
            entity_type="Project",
            entity_id=project_uuid,
            operation="soft_delete",
            operator=operator or "system",
            reason=reason,
            metadata={"project_name": project.name}
        )
        db.add(audit)

    db.commit()
    return None
```

### ç­–ç•¥ 2ï¼šæ‰¹é‡è½¯åˆ é™¤

**é€‚ç”¨åœºæ™¯**ï¼šæ‰¹é‡æ¸…ç†æµ‹è¯•é¡¹ç›®

```python
@router.post("/bulk-delete", status_code=status.HTTP_204_NO_CONTENT)
async def bulk_delete_projects(
    filters: ProjectFilter,  # æŒ‰æ ‡ç­¾ã€åç§°ç­‰ç­›é€‰
    reason: str = Query(..., description="åˆ é™¤åŸå› ï¼ˆå¿…å¡«ï¼‰"),
    confirm: bool = Query(False, description="ç¡®è®¤åˆ é™¤ï¼ˆéœ€æ˜¾å¼è®¾ç½®ä¸º Trueï¼‰"),
    operator: str = Header(None, description="æ“ä½œäºº"),
    db: Session = Depends(get_db)
) -> None:
    """æ‰¹é‡è½¯åˆ é™¤é¡¹ç›®ï¼ˆæŒ‰æ¡ä»¶ç­›é€‰ï¼‰"""
    if not confirm:
        raise HTTPException(
            status_code=400,
            detail="è¯·è®¾ç½® confirm=true ä»¥ç¡®è®¤æ‰¹é‡åˆ é™¤"
        )

    # æ„å»ºæŸ¥è¯¢
    query = db.query(Project).filter(Project.is_deleted == False)

    # æŒ‰æ ‡ç­¾ç­›é€‰ï¼ˆä¾‹å¦‚ï¼šåˆ é™¤æ‰€æœ‰æµ‹è¯•é¡¹ç›®ï¼‰
    if filters.tags:
        for key, value in filters.tags.items():
            query = query.filter(Project.tags[key].astext == value)

    # æŒ‰åç§°æ¨¡å¼ç­›é€‰
    if filters.name_pattern:
        query = query.filter(Project.name.ilike(f"%{filters.name_pattern}%"))

    # æŒ‰åˆ›å»ºæ—¶é—´ç­›é€‰
    if filters.created_before:
        query = query.filter(Project.created_at < filters.created_before)

    projects_to_delete = query.all()

    if not projects_to_delete:
        raise HTTPException(
            status_code=404,
            detail="æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„é¡¹ç›®"
        )

    # æ‰§è¡Œè½¯åˆ é™¤
    for project in projects_to_delete:
        project.is_deleted = True
        project.deleted_at = datetime.utcnow()
        project.deleted_by = operator or "system"
        project.deletion_reason = reason

        # è®°å½•å®¡è®¡æ—¥å¿—
        audit = DeletionAudit(
            entity_type="Project",
            entity_id=project.id,
            operation="bulk_soft_delete",
            operator=operator or "system",
            reason=reason,
            metadata={"project_name": project.name}
        )
        db.add(audit)

    db.commit()

    # è¿”å›åˆ é™¤ç»Ÿè®¡
    return {
        "deleted_count": len(projects_to_delete),
        "message": f"å·²è½¯åˆ é™¤ {len(projects_to_delete)} ä¸ªé¡¹ç›®"
    }
```

### ç­–ç•¥ 3ï¼šæ¢å¤å·²åˆ é™¤é¡¹ç›®

```python
@router.post("/{project_id}/restore", response_model=ProjectRead)
async def restore_project(
    project_id: str,
    operator: str = Header(None, description="æ“ä½œäºº"),
    db: Session = Depends(get_db)
) -> ProjectRead:
    """æ¢å¤å·²è½¯åˆ é™¤çš„é¡¹ç›®"""
    project = db.query(Project).filter(
        Project.id == project_uuid,
        Project.is_deleted == True
    ).first()

    if not project:
        raise HTTPException(
            status_code=404,
            detail="æœªæ‰¾åˆ°å·²åˆ é™¤çš„é¡¹ç›®"
        )

    # æ¢å¤é¡¹ç›®
    project.is_deleted = False
    project.deleted_at = None
    project.deleted_by = None
    project.deletion_reason = None

    # è®°å½•å®¡è®¡æ—¥å¿—
    audit = DeletionAudit(
        entity_type="Project",
        entity_id=project_uuid,
        operation="restore",
        operator=operator or "system",
        reason="æ¢å¤å·²åˆ é™¤é¡¹ç›®",
        metadata={"project_name": project.name}
    )
    db.add(audit)

    db.commit()
    db.refresh(project)
    return project
```

---

## ğŸ” æŸ¥è¯¢è¿‡æ»¤

### é»˜è®¤è¿‡æ»¤å·²åˆ é™¤é¡¹ç›®

```python
@router.get("/", response_model=List[ProjectRead])
async def list_projects(
    skip: int = 0,
    limit: int = 100,
    include_deleted: bool = Query(False, description="æ˜¯å¦åŒ…å«å·²åˆ é™¤é¡¹ç›®"),
    db: Session = Depends(get_db)
) -> List[ProjectRead]:
    """è·å–é¡¹ç›®åˆ—è¡¨ï¼ˆé»˜è®¤ä¸åŒ…å«å·²åˆ é™¤é¡¹ç›®ï¼‰"""
    query = db.query(Project)

    # é»˜è®¤ä¸æ˜¾ç¤ºå·²åˆ é™¤é¡¹ç›®
    if not include_deleted:
        query = query.filter(Project.is_deleted == False)

    projects = query.order_by(Project.name).offset(skip).limit(limit).all()
    return projects
```

### æŸ¥çœ‹å·²åˆ é™¤é¡¹ç›®

```python
@router.get("/deleted", response_model=List[ProjectRead])
async def list_deleted_projects(
    skip: int = 0,
    limit: int = 100,
    db: Session = Depends(get_db)
) -> List[ProjectRead]:
    """æŸ¥çœ‹å·²åˆ é™¤é¡¹ç›®åˆ—è¡¨"""
    projects = db.query(Project)\
        .filter(Project.is_deleted == True)\
        .order_by(Project.deleted_at.desc())\
        .offset(skip)\
        .limit(limit)\
        .all()
    return projects
```

---

## ğŸ› ï¸ å·¥å…·è„šæœ¬

### æ™ºèƒ½æ¸…ç†è„šæœ¬

```python
# scripts/cleanup_test_projects.py

import httpx
import asyncio
from datetime import datetime, timedelta
from typing import List, Dict

BACKEND_BASE_URL = "http://127.0.0.1:8000/api/v1"


async def cleanup_test_projects(
    name_pattern: str = "test",
    days_old: int = 7,
    dry_run: bool = True
):
    """
    æ™ºèƒ½æ¸…ç†æµ‹è¯•é¡¹ç›®

    Args:
        name_pattern: é¡¹ç›®åç§°æ¨¡å¼ï¼ˆé»˜è®¤åŒ¹é…åŒ…å« "test" çš„é¡¹ç›®ï¼‰
        days_old: ä»…åˆ é™¤ N å¤©å‰åˆ›å»ºçš„é¡¹ç›®ï¼ˆé»˜è®¤ 7 å¤©ï¼‰
        dry_run: é¢„æ¼”æ¨¡å¼ï¼Œä¸å®é™…åˆ é™¤ï¼ˆé»˜è®¤ Trueï¼‰
    """
    async with httpx.AsyncClient(timeout=30.0) as client:
        # è·å–æ‰€æœ‰é¡¹ç›®
        resp = await client.get(f"{BACKEND_BASE_URL}/projects/")
        projects = resp.json()

        # ç­›é€‰ç¬¦åˆæ¡ä»¶çš„æµ‹è¯•é¡¹ç›®
        cutoff_date = datetime.now() - timedelta(days=days_old)
        test_projects = [
            p for p in projects
            if (
                name_pattern in p['name'].lower() and
                datetime.fromisoformat(p['created_at']) < cutoff_date
            )
        ]

        print(f"æ‰¾åˆ° {len(test_projects)} ä¸ªç¬¦åˆæ¡ä»¶çš„æµ‹è¯•é¡¹ç›®ï¼š\n")

        for project in test_projects:
            created_at = datetime.fromisoformat(project['created_at'])
            age_days = (datetime.now() - created_at).days
            print(f"  - {project['name']}")
            print(f"    åˆ›å»ºæ—¶é—´: {created_at} ({age_days} å¤©å‰)")
            print(f"    ID: {project['id']}\n")

        if dry_run:
            print("[DRY RUN] é¢„æ¼”æ¨¡å¼ï¼Œä¸ä¼šå®é™…åˆ é™¤é¡¹ç›®")
            print(f"å¦‚éœ€å®é™…åˆ é™¤ï¼Œè¯·è®¾ç½® dry_run=False")
        else:
            # æ‰¹é‡è½¯åˆ é™¤
            confirm = input(f"ç¡®è®¤åˆ é™¤ä»¥ä¸Š {len(test_projects)} ä¸ªé¡¹ç›®ï¼Ÿ(yes/no): ")
            if confirm.lower() == 'yes':
                resp = await client.post(
                    f"{BACKEND_BASE_URL}/projects/bulk-delete",
                    params={
                        "reason": f"è‡ªåŠ¨æ¸…ç† {days_old} å¤©å‰çš„æµ‹è¯•é¡¹ç›®",
                        "confirm": True
                    },
                    json={
                        "tags": {"environment": "test"},
                        "name_pattern": name_pattern,
                        "created_before": cutoff_date.isoformat()
                    }
                )
                print("åˆ é™¤å®Œæˆï¼")
            else:
                print("å–æ¶ˆåˆ é™¤")


if __name__ == "__main__":
    asyncio.run(cleanup_test_projects(
        name_pattern="test",
        days_old=7,
        dry_run=True  # é¢„æ¼”æ¨¡å¼ï¼Œä¸å®é™…åˆ é™¤
    ))
```

---

## ğŸ“ API æ€»ç»“

### æ–°å¢ API ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/api/v1/projects/` | DELETE | åˆ é™¤é¡¹ç›®ï¼ˆæ”¯æŒè½¯åˆ é™¤/ç¡¬åˆ é™¤ï¼‰ |
| `/api/v1/projects/bulk-delete` | POST | æ‰¹é‡è½¯åˆ é™¤é¡¹ç›® |
| `/api/v1/projects/{id}/restore` | POST | æ¢å¤å·²åˆ é™¤é¡¹ç›® |
| `/api/v1/projects/deleted` | GET | æŸ¥çœ‹å·²åˆ é™¤é¡¹ç›®åˆ—è¡¨ |
| `/api/v1/projects/deletion-audits` | GET | æŸ¥çœ‹åˆ é™¤å®¡è®¡æ—¥å¿— |

### æŸ¥è¯¢å‚æ•°

| å‚æ•° | ç±»å‹ | æè¿° |
|------|------|------|
| `include_deleted` | boolean | æ˜¯å¦åŒ…å«å·²åˆ é™¤é¡¹ç›®ï¼ˆé»˜è®¤ Falseï¼‰ |
| `hard_delete` | boolean | æ˜¯å¦ç‰©ç†åˆ é™¤ï¼ˆé»˜è®¤ Falseï¼Œå±é™©æ“ä½œï¼‰ |
| `reason` | string | åˆ é™¤åŸå› ï¼ˆç¡¬åˆ é™¤å¿…å¡«ï¼‰ |
| `confirm` | boolean | ç¡®è®¤æ‰¹é‡åˆ é™¤ï¼ˆéœ€æ˜¾å¼è®¾ç½®ä¸º Trueï¼‰ |

---

## âš ï¸ å®‰å…¨å»ºè®®

1. **é»˜è®¤è½¯åˆ é™¤**ï¼šæ‰€æœ‰åˆ é™¤æ“ä½œé»˜è®¤ä¸ºè½¯åˆ é™¤ï¼Œç‰©ç†åˆ é™¤éœ€è¦æ˜¾å¼æŒ‡å®š
2. **å¤šé‡ç¡®è®¤**ï¼šæ‰¹é‡åˆ é™¤éœ€è¦è®¾ç½® `confirm=true`
3. **å¿…å¡«åŸå› **ï¼šç‰©ç†åˆ é™¤å¿…é¡»æä¾›åˆ é™¤åŸå› 
4. **æƒé™æ§åˆ¶**ï¼šåˆ é™¤æ“ä½œéœ€è¦ç®¡ç†å‘˜æƒé™
5. **å®šæœŸæ¸…ç†**ï¼šå®šæœŸï¼ˆå¦‚æ¯æœˆï¼‰æ¸…ç†è¶…è¿‡ 90 å¤©çš„è½¯åˆ é™¤æ•°æ®
6. **å¤‡ä»½é‡è¦**ï¼šç‰©ç†åˆ é™¤å‰è‡ªåŠ¨å¤‡ä»½æ•°æ®

---

## ğŸ“… å®æ–½è®¡åˆ’

### é˜¶æ®µ 1ï¼šæ•°æ®åº“è¿ç§»ï¼ˆ1 å¤©ï¼‰
- [ ] æ·»åŠ è½¯åˆ é™¤å­—æ®µåˆ°æ ¸å¿ƒè¡¨
- [ ] åˆ›å»ºåˆ é™¤å®¡è®¡è¡¨
- [ ] ç¼–å†™ Alembic è¿ç§»è„šæœ¬

### é˜¶æ®µ 2ï¼šAPI å®ç°ï¼ˆ2 å¤©ï¼‰
- [ ] å®ç°è½¯åˆ é™¤é€»è¾‘
- [ ] å®ç°æ‰¹é‡åˆ é™¤ API
- [ ] å®ç°æ¢å¤åŠŸèƒ½
- [ ] æ›´æ–°æŸ¥è¯¢è¿‡æ»¤é€»è¾‘

### é˜¶æ®µ 3ï¼šå·¥å…·è„šæœ¬ï¼ˆ1 å¤©ï¼‰
- [ ] ç¼–å†™æ™ºèƒ½æ¸…ç†è„šæœ¬
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•
- [ ] ç¼–å†™ä½¿ç”¨æ–‡æ¡£

### é˜¶æ®µ 4ï¼šæµ‹è¯•ä¸ä¸Šçº¿ï¼ˆ1 å¤©ï¼‰
- [ ] æµ‹è¯•è½¯åˆ é™¤å’Œæ¢å¤æµç¨‹
- [ ] æµ‹è¯•æ‰¹é‡åˆ é™¤åŠŸèƒ½
- [ ] ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

**æ€»è®¡**ï¼šçº¦ 5 å¤©

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [SQLAlchemy Soft Delete Pattern](https://docs.sqlalchemy.org/en/20/orm/persistence_techniques.html)
- [PostgreSQL JSONB Queries](https://www.postgresql.org/docs/current/datatype-json.html)
- [FastAPI Best Practices](https://fastapi.tiangolo.com/tutorial/)
