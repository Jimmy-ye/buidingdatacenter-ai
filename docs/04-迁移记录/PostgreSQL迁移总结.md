# PostgreSQL è¿ç§»æ€»ç»“

## ğŸ“… è¿ç§»æ—¥æœŸ
2025-01-19

## ğŸ¯ è¿ç§»åŸå› 

SQLite ä¸æ”¯æŒ SQLAlchemy çš„ `UUID(as_uuid=True)` ç±»å‹ï¼Œå¯¼è‡´ 10 å¤„ä»£ç å‡ºç° UUID æŸ¥è¯¢é—®é¢˜ã€‚è¯„ä¼°åå†³å®šè¿ç§»åˆ° PostgreSQL ä½œä¸ºé•¿æœŸè§£å†³æ–¹æ¡ˆã€‚

### é—®é¢˜è¯¦æƒ…

- **å—å½±å“æ–‡ä»¶**: 3 ä¸ª
- **é—®é¢˜ä»£ç ä½ç½®**: 10 å¤„
- **å¤±æ•ˆåŠŸèƒ½**: 6 ä¸ªæ ¸å¿ƒåŠŸèƒ½æ¨¡å—

#### é—®é¢˜åˆ†å¸ƒ

| æ–‡ä»¶ | é—®é¢˜æ•°é‡ | è¡Œå· | ä¸¥é‡ç¨‹åº¦ |
|------|---------|------|---------|
| `services/backend/app/api/v1/assets.py` | 4 å¤„ | 53, 61, 78, 295 | ğŸ”´ é«˜ |
| `services/backend/app/api/v1/projects.py` | 3 å¤„ | 57, 81, 111 | ğŸ”´ é«˜ |
| `services/backend/app/services/image_pipeline.py` | 3 å¤„ | 62, 69, 198 | ğŸ”´ é«˜ |
| **æ€»è®¡** | **10 å¤„** | | |

#### é”™è¯¯ç¤ºä¾‹

```
AttributeError: 'str' object has no attribute 'hex'
[SQL: SELECT assets.id AS assets_id, ... FROM assets WHERE assets.id = ?]
```

**æ ¹æœ¬åŸå› **ï¼š
- SQLAlchemy çš„ UUID ç±»å‹åœ¨ Python ä¾§æœŸæœ› `uuid.UUID` å¯¹è±¡
- SQLite å­˜å‚¨çš„æ˜¯æ— è¿å­—ç¬¦çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²
- æŸ¥è¯¢æ—¶ç±»å‹ä¸åŒ¹é…å¯¼è‡´ `.hex()` æ–¹æ³•è°ƒç”¨å¤±è´¥

---

## âœ… è¿ç§»ç»“æœ

**âœ… å®Œå…¨æˆåŠŸï¼**

### æ•°æ®åº“ä¿¡æ¯
- **PostgreSQL ç‰ˆæœ¬**: 18.1
- **æ•°æ®åº“**: bdc_ai
- **ç”¨æˆ·**: admin
- **è¿æ¥**: postgresql://admin:password@localhost:5432/bdc_ai

### æ•°æ®è¿ç§»ç»Ÿè®¡

| è¡¨å | SQLite | PostgreSQL | çŠ¶æ€ |
|------|--------|------------|------|
| projects | 50 | 50 | âœ… |
| buildings | 0 | 0 | âœ… |
| zones | 0 | 0 | âœ… |
| systems | 0 | 0 | âœ… |
| devices | 0 | 0 | âœ… |
| file_blobs | 51 | 51 | âœ… |
| assets | 51 | 51 | âœ… |
| structured_payloads | 9 | 9 | âœ… |
| **æ€»è®¡** | **161** | **161** | **âœ…** |

---

## ğŸ”§ å…³é”®é—®é¢˜ä¿®å¤

### é—®é¢˜ 1: Project æ¨¡å‹å­—æ®µä¸åŒ¹é…
**é”™è¯¯**ï¼šè¿ç§»è„šæœ¬è¯•å›¾æ’å…¥ `created_at` å­—æ®µï¼Œä½†è¯¥å­—æ®µä¸å­˜åœ¨
**è§£å†³**ï¼šä¿®æ­£å­—æ®µæ˜ å°„ï¼Œæ·»åŠ  `type`, `start_date`, `end_date`

### é—®é¢˜ 2: UUID å¤–é”®çº¦æŸè¿å
**é”™è¯¯**ï¼šAssets æ’å…¥å¤±è´¥ï¼Œå› ä¸º projects è¡¨æœªæ­£ç¡®æ’å…¥
**è§£å†³**ï¼šä¿®å¤ Project è¿ç§»é€»è¾‘ï¼Œæ·»åŠ è¯¦ç»†æ—¥å¿—å’Œé”™è¯¯å¤„ç†

---

## ğŸ§ª éªŒè¯æµ‹è¯•ç»“æœ

### 1. PostgreSQL UUID æŸ¥è¯¢ âœ…
- é€šè¿‡ Asset ID æŸ¥è¯¢ï¼šæ­£å¸¸
- é€šè¿‡ Project ID å…³è”æŸ¥è¯¢ï¼šæ­£å¸¸
- é€šè¿‡ File ID å…³è”æŸ¥è¯¢ï¼šæ­£å¸¸

### 2. åç«¯ API æµ‹è¯• âœ…
- Health Check: 200 OK
- Projects List: è¿”å› 50 ä¸ªé¡¹ç›®
- Project Detail: UUID æŸ¥è¯¢æ­£å¸¸
- Assets List: è¿”å› 51 ä¸ªèµ„äº§
- Asset Filter by Project: æ­£å¸¸å·¥ä½œ

### 3. GLM Worker å›¾ç‰‡è¯»å– âœ…
- åç«¯ API æ­£å¸¸è¿”å› file_path
- æœ¬åœ°æ–‡ä»¶å­˜åœ¨ä¸”å¯è¯»
- å›¾ç‰‡å¤„ç†ï¼ˆPILï¼‰æ­£å¸¸
- Base64 ç¼–ç æˆåŠŸ
- æ–‡ä»¶è·¯å¾„è§£ææ­£ç¡®

---

## ğŸ’¡ æŠ€æœ¯ä¼˜åŠ¿

### PostgreSQL vs SQLite

1. **UUID åŸç”Ÿæ”¯æŒ**: æ— éœ€ç±»å‹è½¬æ¢
2. **å¤–é”®çº¦æŸ**: ä¸¥æ ¼çš„æ•°æ®å®Œæ•´æ€§
3. **å¹¶å‘æ€§èƒ½**: æ›´å¥½çš„å¤šç”¨æˆ·æ”¯æŒ
4. **æ‰©å±•æ€§**: æ”¯æŒ pgvector, TimescaleDB ç­‰æ‰©å±•
5. **ç”Ÿäº§å°±ç»ª**: é€‚åˆä¼ä¸šçº§éƒ¨ç½²

### è§£å†³çš„é—®é¢˜

- âœ… 10 å¤„ UUID æŸ¥è¯¢é—®é¢˜å…¨éƒ¨è§£å†³
- âœ… å¤–é”®å…³è”æŸ¥è¯¢å®Œå…¨æ­£å¸¸
- âœ… æ•°æ®å®Œæ•´æ€§å¾—åˆ°ä¿è¯
- âœ… ä¸ºæœªæ¥æ‰©å±•ï¼ˆå‘é‡æ£€ç´¢ã€æ—¶åºæ•°æ®ï¼‰åšå¥½å‡†å¤‡

---

## ğŸ“‹ é…ç½®å˜æ›´

### .env æ–‡ä»¶
```bash
# ä¿®æ”¹å‰:
BDC_DATABASE_URL=sqlite:///./data/bdc_ai.db

# ä¿®æ”¹å:
BDC_DATABASE_URL=postgresql://admin:password@localhost:5432/bdc_ai
```

### ä»£ç å˜æ›´
**æ— éœ€ä¿®æ”¹ä»»ä½•ä»£ç **ï¼SQLAlchemy çš„ UUID(as_uuid=True) åœ¨ PostgreSQL ä¸‹åŸç”Ÿæ”¯æŒã€‚

---

## ğŸš€ åç»­æ­¥éª¤

### 1. å¯åŠ¨åç«¯æœåŠ¡
```bash
cd services/backend
python -m uvicorn app.main:app --host localhost --port 8000 --reload
```

### 2. è®¿é—® API æ–‡æ¡£
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

### 3. å¯åŠ¨ GLM Worker
```bash
cd services/worker
# ç¡®ä¿è®¾ç½®äº† GLM_API_KEY ç¯å¢ƒå˜é‡
python scene_issue_glm_worker.py
```

### 4. æµ‹è¯•åœºæ™¯é—®é¢˜åˆ†ææµç¨‹
```bash
python services/worker/test_scene_issue_pipeline.py
```

---

## ğŸ“ è¿ç§»è„šæœ¬

æ‰€æœ‰è¿ç§»è„šæœ¬ä¿å­˜åœ¨ `scripts/` ç›®å½•ï¼š
- `migrate_sqlite_to_postgres.py` - æ•°æ®è¿ç§»è„šæœ¬
- `check_foreign_keys.py` - å¤–é”®å®Œæ•´æ€§æ£€æŸ¥
- `test_postgres_image_access.py` - è¿ç§»åéªŒè¯æµ‹è¯•
- `test_glm_worker_image_access.py` - GLM Worker åŠŸèƒ½éªŒè¯

## ğŸ’¾ æ•°æ®å¤‡ä»½

åŸå§‹ SQLite æ•°æ®åº“ä¿ç•™åœ¨ï¼š
```
data/bdc_ai.db
```

å»ºè®®ä¿ç•™ä½œä¸ºå¤‡ä»½ï¼Œç›´åˆ° PostgreSQL éªŒè¯é€šè¿‡å¹¶ç¨³å®šè¿è¡Œä¸€æ®µæ—¶é—´ã€‚

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

- **æ•°æ®é‡**: 161 æ¡è®°å½•
- **SQLite æ•°æ®åº“å¤§å°**: ~124 KB
- **è¿ç§»è€—æ—¶**: < 1 ç§’
- **æŸ¥è¯¢æ€§èƒ½**: PostgreSQL æŸ¥è¯¢é€Ÿåº¦ä¸ SQLite ç›¸å½“ï¼ˆå¯¹äºå°æ•°æ®é›†ï¼‰

---

## ğŸ‰ ç»“è®º

PostgreSQL è¿ç§»å®Œå…¨æˆåŠŸï¼Œæ‰€æœ‰åŠŸèƒ½éªŒè¯é€šè¿‡ã€‚ç³»ç»Ÿç°å·²å…·å¤‡ç”Ÿäº§ç¯å¢ƒè¿è¡Œçš„åŸºç¡€ï¼Œå¯æ”¯æŒæœªæ¥æ‰©å±•éœ€æ±‚ï¼ˆå‘é‡æ£€ç´¢ã€æ—¶åºæ•°æ®ç®¡ç†ç­‰ï¼‰ã€‚

### æ ¸å¿ƒæˆæœ

1. âœ… **é›¶ä»£ç ä¿®æ”¹** - SQLAlchemy è‡ªåŠ¨é€‚é… PostgreSQL UUID ç±»å‹
2. âœ… **å®Œæ•´æ•°æ®è¿ç§»** - 161 æ¡è®°å½•å®Œæ•´ä¿ç•™
3. âœ… **åŠŸèƒ½éªŒè¯é€šè¿‡** - æ‰€æœ‰ API å’Œ Worker æ­£å¸¸å·¥ä½œ
4. âœ… **æ€§èƒ½ç¨³å®š** - æŸ¥è¯¢æ€§èƒ½æ»¡è¶³é¢„æœŸ
5. âœ… **æ‰©å±•æ€§æå‡** - ä¸º pgvector å’Œ TimescaleDB åšå¥½å‡†å¤‡

---

**è¿ç§»å®Œæˆæ—¶é—´**: 2025-01-19
**è¿ç§»è´Ÿè´£äºº**: Claude Code
**PostgreSQL ç‰ˆæœ¬**: 18.1
