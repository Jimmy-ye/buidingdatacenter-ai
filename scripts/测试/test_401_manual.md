# 401 自动处理测试指南

## 📋 测试目标

验证 PC-UI 认证系统在遇到 401 错误时能够：
1. ✅ 自动检测 401 响应
2. ✅ 自动清除本地 Token 和用户信息
3. ✅ 显示"登录已过期"通知
4. ✅ 自动跳转到登录页面

---

## 🚀 快速开始

### 方法 1：使用测试页面（推荐）

#### 步骤 1：确保服务运行

```bash
# 终端 1: 启动后端
python -m uvicorn services.backend.app.main:app --host 0.0.0.0 --port 8000 --reload

# 终端 2: 启动 PC-UI
python -m desktop.nicegui_app.pc_app
```

#### 步骤 2：登录系统

1. 访问 http://localhost:8080
2. 自动跳转到登录页
3. 使用 admin/admin123 登录
4. 成功进入主页

#### 步骤 3：访问测试页面

在浏览器中访问：**http://localhost:8080/test-401**

您会看到 401 自动处理测试页面，包含三个测试场景。

#### 步骤 4：测试场景

##### 场景 1: 使用无效 Token

**操作**：点击"触发场景 1"按钮

**预期行为**：
1. ✅ 显示通知："成功触发 401 错误"
2. ✅ 自动跳转到登录页（`/login`）
3. ✅ 显示黄色通知："登录已过期，请重新登录"
4. ✅ Token 已被清除

**验证**：
- 在浏览器开发工具（F12）中检查：
  - Application → Local Storage → `auth_token` 应该被删除
  - Application → Local Storage → `auth_user` 应该被删除

##### 场景 2: 模拟过期 Token

**操作**：点击"触发场景 2"按钮

**预期行为**：
1. ✅ 显示通知："成功触发 401 错误"
2. ✅ 自动跳转到登录页

**说明**：
- 此场景使用一个过期的 JWT token
- 后端应该拒绝该 token 并返回 401

##### 场景 3: 无 Token 访问

**操作**：点击"触发场景 3"按钮

**预期行为**：
1. ✅ 显示通知："API 调用异常（预期行为）"
2. ✅ 自动跳转到登录页
3. ✅ Token 已被清除

**说明**：
- 此场景临时移除 token，然后通过 AuthManager 调用 API
- AuthManager 会检测到 401 并自动登出

---

### 方法 2：手动浏览器测试

#### 测试步骤：

1. **登录系统**
   - 访问 http://localhost:8080
   - 使用 admin/admin123 登录
   - 确认进入主页

2. **手动删除 Token**

   打开浏览器开发工具（F12）：
   ```
   Application → Local Storage → http://localhost:8080
   找到 auth_token 和 auth_user
   右键删除
   ```

3. **触发 401 错误**

   在主页上：
   - 点击"刷新"按钮
   - 或按 F5 刷新页面
   - 或尝试访问任何需要认证的功能（如项目列表）

4. **验证自动登出**

   **预期行为**：
   - ✅ 自动跳转到登录页
   - ✅ 显示"登录已过期"通知（如果实现）
   - ✅ 无法访问需要认证的页面

---

### 方法 3：使用开发者工具

#### Network 面板测试

1. **打开开发者工具**（F12）
2. **切换到 Network 标签**
3. **登录系统**
4. **查看任意 API 请求**
5. **修改 Token 为无效值**

   在 Network 标签中找到请求：
   ```
   右键 → Copy as cURL
   修改 Authorization header
   在终端中运行
   ```

6. **或在浏览器 Console 中运行**：
   ```javascript
   // 删除 token
   localStorage.removeItem('auth_token');
   localStorage.removeItem('auth_user');

   // 尝试访问受保护页面
   location.reload();
   ```

---

## ✅ 测试检查清单

### 自动处理验证

| 检查项 | 预期结果 | 实际结果 | 状态 |
|--------|---------|---------|------|
| 401 检测 | AuthManager 检测到 401 响应 | | ⬜ |
| 自动登出 | Token 和用户信息被清除 | | ⬜ |
| 通知显示 | 显示"登录已过期"提示 | | ⬜ |
| 自动跳转 | 跳转到 `/login` 页面 | | ⬜ |
| 无法绕过 | 直接访问主页仍跳转到登录页 | | ⬜ |

### 存储清理验证

在浏览器开发工具中检查：

- [ ] Application → Local Storage
  - [ ] `auth_token` 已删除
  - [ ] `auth_user` 已删除

### 用户体验验证

- [ ] 通知显示清晰易懂
- [ ] 跳转流畅不卡顿
- [ ] 用户无需手动操作
- [ ] 重新登录可以正常使用

---

## 🐛 故障排查

### 问题 1：没有自动跳转到登录页

**可能原因**：
1. 401 处理逻辑未正确实现
2. `ui.navigate.to('/login')` 未执行
3. 页面 JavaScript 错误

**调试步骤**：
1. 打开浏览器控制台（F12 → Console）
2. 查看是否有 JavaScript 错误
3. 检查 Network 标签，确认收到 401 响应
4. 检查 `auth_manager.py` 中的 `_handle_401` 方法

### 问题 2：没有显示"登录已过期"通知

**可能原因**：
1. 通知代码未执行
2. NiceGUI 通知功能配置问题

**调试步骤**：
1. 检查浏览器控制台是否有错误
2. 手动测试通知：在 Console 运行
   ```javascript
   // 如果 NiceGUI 暴露了通知 API
   notify('测试通知', type='warning')
   ```

### 问题 3：Token 未被清除

**可能原因**：
1. `logout()` 方法未正确执行
2. Local Storage 清除失败

**调试步骤**：
1. 在浏览器开发工具中检查 Local Storage
2. 手动测试登出功能（点击登出按钮）
3. 检查 `auth_manager.py` 中的 `logout` 方法

---

## 📊 测试结果记录

### 场景 1: 无效 Token

| 步骤 | 预期 | 实际 | 状态 |
|------|------|------|------|
| 触发 401 | 返回 401 状态码 | | ⬜ |
| 检测 401 | 调用 _handle_401 | | ⬜ |
| 自动登出 | 清除 Token 和用户 | | ⬜ |
| 显示通知 | "登录已过期" | | ⬜ |
| 自动跳转 | 跳转到 /login | | ⬜ |

### 场景 2: 过期 Token

| 步骤 | 预期 | 实际 | 状态 |
|------|------|------|------|
| 触发 401 | 返回 401 状态码 | | ⬜ |
| 自动登出 | 清除 Token 和用户 | | ⬜ |
| 自动跳转 | 跳转到 /login | | ⬜ |

### 场景 3: 无 Token 访问

| 步骤 | 预期 | 实际 | 状态 |
|------|------|------|------|
| 触发 401 | 返回 401 状态码 | | ⬜ |
| 自动登出 | 清除 Token 和用户 | | ⬜ |
| 自动跳转 | 跳转到 /login | | ⬜ |

---

## 🎯 测试完成后

### 如果所有测试通过 ✅

恭喜！401 自动处理机制工作正常。可以继续：

- [ ] **任务 #3**: 添加 refresh_token 支持
- [ ] **任务 #4**: 实现前端权限控制
- [ ] **任务 #5**: 移动端认证整合

### 如果测试失败 ❌

请记录失败的场景和错误信息，然后：

1. 检查 `auth_manager.py` 中的 `_handle_401` 方法
2. 检查 `pc_app.py` 中是否正确调用了 AuthManager
3. 查看浏览器控制台和后端日志
4. 告诉我具体的错误信息，我会协助修复

---

## 📚 相关代码

- **401 处理实现**: `desktop/nicegui_app/auth_manager.py` (第 113-131 行)
- **测试页面**: `desktop/nicegui_app/test_401_page.py`
- **认证方案**: `docs/02-技术文档/pc-ui/PC-UI和移动端认证整合实施方案.md`

---

**文档维护**: BDC-AI 开发团队
**最后更新**: 2026-01-26
