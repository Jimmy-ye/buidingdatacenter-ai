# å‰ç«¯æƒé™æ§åˆ¶æµ‹è¯•æŒ‡å—

## ğŸ“‹ æµ‹è¯•ç›®æ ‡

éªŒè¯ PC-UI å‰ç«¯æƒé™æ§åˆ¶åŠŸèƒ½ï¼š
1. âœ… æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å’Œè§’è‰²
2. âœ… æ ¹æ®æƒé™æ˜¾ç¤º/éšè—æŒ‰é’®
3. âœ… ä¸åŒæƒé™ç”¨æˆ·çœ‹åˆ°ä¸åŒçš„UI
4. âœ… è¶…çº§ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°æ‰€æœ‰åŠŸèƒ½

---

## ğŸ”‘ æƒé™ä»£ç è¯´æ˜

### é¡¹ç›®æƒé™
- `projects:create` - åˆ›å»ºé¡¹ç›®
- `projects:update` - ç¼–è¾‘é¡¹ç›®
- `projects:delete` - åˆ é™¤é¡¹ç›®

### å·¥ç¨‹ç»“æ„æƒé™
- `structures:create` - åˆ›å»ºæ¥¼æ ‹/ç³»ç»Ÿ/åŒºåŸŸ/è®¾å¤‡
- `structures:update` - ç¼–è¾‘å·¥ç¨‹ç»“æ„
- `structures:delete` - åˆ é™¤å·¥ç¨‹ç»“æ„

### èµ„äº§æƒé™
- `assets:upload` - ä¸Šä¼ èµ„äº§
- `assets:delete` - åˆ é™¤èµ„äº§

### åŠŸèƒ½æƒé™
- `ocr:run` - è¿è¡Œ OCR
- `llm:run` - ç”Ÿæˆ LLM æŠ¥å‘Š

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹æ³• 1ï¼šæ‰‹åŠ¨æµ‹è¯•ï¼ˆæ¨èï¼‰

#### æ­¥éª¤ 1ï¼šå¯åŠ¨æœåŠ¡

```bash
# ç»ˆç«¯ 1: å¯åŠ¨åç«¯
python -m uvicorn services.backend.app.main:app --host 0.0.0.0 --port 8000 --reload

# ç»ˆç«¯ 2: å¯åŠ¨ PC-UI
python -m desktop.nicegui_app.pc_app
```

#### æ­¥éª¤ 2ï¼šä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•

1. è®¿é—® http://localhost:8080
2. ä½¿ç”¨ `admin/admin123` ç™»å½•
3. æŸ¥çœ‹é¡µé¢å³ä¸Šè§’ï¼Œåº”è¯¥æ˜¾ç¤ºï¼š
   ```
   ç”¨æˆ·: admin | ç®¡ç†å‘˜ | å·¥ç¨‹å¸ˆ
   ```
   ï¼ˆæ˜¾ç¤ºæ‰€æœ‰è§’è‰²ï¼‰

#### æ­¥éª¤ 3ï¼šæµ‹è¯•è¶…çº§ç®¡ç†å‘˜æƒé™

**é¢„æœŸè¡Œä¸º**ï¼š
- âœ… å¯ä»¥çœ‹åˆ°æ‰€æœ‰æŒ‰é’®ï¼ˆé¡¹ç›®åˆ›å»º/ç¼–è¾‘/åˆ é™¤ã€ç»“æ„æ·»åŠ /ç¼–è¾‘/åˆ é™¤ã€èµ„äº§ä¸Šä¼ /åˆ é™¤ã€OCR/LLMï¼‰
- âœ… å¯ä»¥æ‰§è¡Œæ‰€æœ‰æ“ä½œ
- âœ… ä¸åº”è¯¥çœ‹åˆ°ä»»ä½•"æ— æƒé™"æç¤º

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æ£€æŸ¥å·¦ä¾§å·¥ç¨‹ç»“æ„æ ‘
   - åº”è¯¥çœ‹åˆ°ï¼š`ï¼‹é¡¹ç›®`ã€`ç¼–è¾‘`ã€`åˆ é™¤` æŒ‰é’®
   - åº”è¯¥çœ‹åˆ°ï¼š`ï¼‹æ¥¼æ ‹`ã€`ï¼‹ç³»ç»Ÿ`ã€`ï¼‹åŒºåŸŸ`ã€`ï¼‹è®¾å¤‡` æŒ‰é’®
   - åº”è¯¥çœ‹åˆ°ï¼š`ç¼–è¾‘æ¥¼æ ‹`ã€`åˆ é™¤æ¥¼æ ‹` æŒ‰é’®

2. æ£€æŸ¥å³ä¾§èµ„äº§åˆ—è¡¨
   - åº”è¯¥çœ‹åˆ°ï¼š`ä¸Šä¼ å›¾ç‰‡èµ„äº§`ã€`åˆ é™¤é€‰ä¸­èµ„äº§`ã€`æ‰¹é‡åˆ é™¤å·²é€‰èµ„äº§` æŒ‰é’®

3. é€‰æ‹©ä¸€ä¸ªå›¾ç‰‡èµ„äº§
   - åº”è¯¥çœ‹åˆ°ï¼š`è¿è¡Œ OCR`ã€`ç”Ÿæˆç°åœºé—®é¢˜æŠ¥å‘Š` æŒ‰é’®

#### æ­¥éª¤ 4ï¼šæµ‹è¯•å—é™ç”¨æˆ·ï¼ˆéœ€è¦åˆ›å»ºï¼‰

**åˆ›å»ºæµ‹è¯•ç”¨æˆ·**ï¼š
```bash
# ä½¿ç”¨åç«¯ API åˆ›å»ºæµ‹è¯•ç”¨æˆ·
curl -X POST http://localhost:8000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "viewer",
    "password": "viewer123",
    "email": "viewer@test.com"
  }'

# æˆ–ä½¿ç”¨å·²æœ‰çš„æµ‹è¯•ç”¨æˆ·
```

**æµ‹è¯•åªè¯»ç”¨æˆ·**ï¼š
1. ç™»å‡ºå½“å‰è´¦æˆ·
2. ä½¿ç”¨æµ‹è¯•è´¦æˆ·ç™»å½•ï¼ˆæ— æƒé™æˆ–åªæœ‰ view æƒé™ï¼‰
3. æ£€æŸ¥æŒ‰é’®æ˜¾ç¤ºï¼š
   - âŒ ä¸åº”è¯¥çœ‹åˆ°ï¼š`ï¼‹é¡¹ç›®`ã€`ç¼–è¾‘`ã€`åˆ é™¤` æŒ‰é’®
   - âŒ ä¸åº”è¯¥çœ‹åˆ°ï¼š`ï¼‹æ¥¼æ ‹`ã€`ï¼‹ç³»ç»Ÿ` ç­‰åˆ›å»ºæŒ‰é’®
   - âŒ ä¸åº”è¯¥çœ‹åˆ°ï¼š`ä¸Šä¼ å›¾ç‰‡èµ„äº§`ã€`åˆ é™¤é€‰ä¸­èµ„äº§` æŒ‰é’®
   - âŒ ä¸åº”è¯¥çœ‹åˆ°ï¼š`è¿è¡Œ OCR`ã€`ç”Ÿæˆç°åœºé—®é¢˜æŠ¥å‘Š` æŒ‰é’®

---

### æ–¹æ³• 2ï¼šä½¿ç”¨å¼€å‘è€…å·¥å…·æ£€æŸ¥

#### æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯

1. ç™»å½•åï¼Œæ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. åˆ‡æ¢åˆ° Console æ ‡ç­¾
3. è¿è¡Œä»¥ä¸‹ä»£ç æ£€æŸ¥ç”¨æˆ·æƒé™ï¼š

```javascript
// æŸ¥çœ‹ NiceGUI å­˜å‚¨
console.log('ç”¨æˆ·ä¿¡æ¯:', localStorage);
```

#### æ£€æŸ¥æŒ‰é’®å¯è§æ€§

åœ¨ Console ä¸­è¿è¡Œï¼š
```javascript
// æŸ¥æ‰¾æ‰€æœ‰æŒ‰é’®
const buttons = document.querySelectorAll('button');
buttons.forEach(btn => {
  console.log('æŒ‰é’®æ–‡æœ¬:', btn.textContent.trim());
  console.log('æŒ‰é’®å¯è§:', !btn.classList.contains('hidden'));
});
```

---

### æ–¹æ³• 3ï¼šä½¿ç”¨ Python æµ‹è¯•è„šæœ¬

åˆ›å»ºæµ‹è¯•è„šæœ¬ `test_permissions.py`ï¼š

```python
# -*- coding: utf-8 -*-
"""
æµ‹è¯•å‰ç«¯æƒé™æ§åˆ¶
"""
import sys
sys.path.insert(0, '.')

from desktop.nicegui_app.auth_manager import auth_manager

# æµ‹è¯•è¶…çº§ç®¡ç†å‘˜
print("=" * 60)
print("æµ‹è¯•è¶…çº§ç®¡ç†å‘˜æƒé™")
print("=" * 60)

# æ¨¡æ‹Ÿç™»å½•
success, msg = auth_manager.login("admin", "admin123")
print(f"ç™»å½•ç»“æœ: {success}, {msg}")

if success:
    print(f"\nç”¨æˆ·ä¿¡æ¯: {auth_manager.user}")
    print(f"è§’è‰²åˆ—è¡¨: {auth_manager.get_roles()}")
    print(f"æƒé™åˆ—è¡¨: {auth_manager.get_all_permissions()[:10]}...")  # æ˜¾ç¤ºå‰10ä¸ª

    print("\næƒé™æ£€æŸ¥:")
    print(f"  projects:create: {auth_manager.has_permission('projects:create')}")
    print(f"  projects:delete: {auth_manager.has_permission('projects:delete')}")
    print(f"  structures:create: {auth_manager.has_permission('structures:create')}")
    print(f"  assets:upload: {auth_manager.has_permission('assets:upload')}")
    print(f"  ocr:run: {auth_manager.has_permission('ocr:run')}")
    print(f"  æ˜¯å¦è¶…çº§ç®¡ç†å‘˜: {auth_manager.is_superuser()}")

# æµ‹è¯•ç™»å‡º
auth_manager.logout()
print("\nå·²ç™»å‡º")
```

è¿è¡Œæµ‹è¯•ï¼š
```bash
python test_permissions.py
```

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

### ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º

| æ£€æŸ¥é¡¹ | é¢„æœŸç»“æœ | å®é™…ç»“æœ | çŠ¶æ€ |
|--------|---------|---------|------|
| æ˜¾ç¤ºç”¨æˆ·å | æ˜¾ç¤ºå½“å‰ç™»å½•ç”¨æˆ·å | | â¬œ |
| æ˜¾ç¤ºè§’è‰² | æ˜¾ç¤ºç”¨æˆ·çš„æ‰€æœ‰è§’è‰²ï¼ˆç”¨ \| åˆ†éš”ï¼‰ | | â¬œ |
| æ— è§’è‰²æ—¶ | æ˜¾ç¤º"æ— è§’è‰²" | | â¬œ |
| æœªç™»å½•æ—¶ | ä¸æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ | | â¬œ |

### é¡¹ç›®æŒ‰é’®æƒé™æ§åˆ¶

| æ£€æŸ¥é¡¹ | é¢„æœŸç»“æœ | å®é™…ç»“æœ | çŠ¶æ€ |
|--------|---------|---------|------|
| æœ‰ `projects:create` | æ˜¾ç¤º `ï¼‹é¡¹ç›®` æŒ‰é’® | | â¬œ |
| æœ‰ `projects:update` | æ˜¾ç¤º `ç¼–è¾‘` æŒ‰é’® | | â¬œ |
| æœ‰ `projects:delete` | æ˜¾ç¤º `åˆ é™¤` æŒ‰é’® | | â¬œ |
| æ— æƒé™ | ä¸æ˜¾ç¤ºå¯¹åº”æŒ‰é’® | | â¬œ |

### å·¥ç¨‹ç»“æ„æŒ‰é’®æƒé™æ§åˆ¶

| æ£€æŸ¥é¡¹ | é¢„æœŸç»“æœ | å®é™…ç»“æœ | çŠ¶æ€ |
|--------|---------|---------|------|
| æœ‰ `structures:create` | æ˜¾ç¤º `ï¼‹æ¥¼æ ‹/ç³»ç»Ÿ/åŒºåŸŸ/è®¾å¤‡` æŒ‰é’® | | â¬œ |
| æœ‰ `structures:update` | æ˜¾ç¤º `ç¼–è¾‘æ¥¼æ ‹` æŒ‰é’® | | â¬œ |
| æœ‰ `structures:delete` | æ˜¾ç¤º `åˆ é™¤æ¥¼æ ‹` æŒ‰é’® | | â¬œ |
| æ— æƒé™ | ä¸æ˜¾ç¤ºå¯¹åº”æŒ‰é’® | | â¬œ |

### èµ„äº§æŒ‰é’®æƒé™æ§åˆ¶

| æ£€æŸ¥é¡¹ | é¢„æœŸç»“æœ | å®é™…ç»“æœ | çŠ¶æ€ |
|--------|---------|---------|------|
| æœ‰ `assets:upload` | æ˜¾ç¤º `ä¸Šä¼ å›¾ç‰‡èµ„äº§` æŒ‰é’® | | â¬œ |
| æœ‰ `assets:delete` | æ˜¾ç¤º `åˆ é™¤é€‰ä¸­èµ„äº§` æŒ‰é’® | | â¬œ |
| æœ‰ `assets:delete` | æ˜¾ç¤º `æ‰¹é‡åˆ é™¤å·²é€‰èµ„äº§` æŒ‰é’® | | â¬œ |
| æ— æƒé™ | ä¸æ˜¾ç¤ºå¯¹åº”æŒ‰é’® | | â¬œ |

### OCR/LLM æŒ‰é’®æƒé™æ§åˆ¶

| æ£€æŸ¥é¡¹ | é¢„æœŸç»“æœ | å®é™…ç»“æœ | çŠ¶æ€ |
|--------|---------|---------|------|
| æœ‰ `ocr:run` | æ˜¾ç¤º `è¿è¡Œ OCR` æŒ‰é’® | | â¬œ |
| æœ‰ `llm:run` | æ˜¾ç¤º `ç”Ÿæˆç°åœºé—®é¢˜æŠ¥å‘Š` æŒ‰é’® | | â¬œ |
| æ— æƒé™ | ä¸æ˜¾ç¤ºå¯¹åº”æŒ‰é’® | | â¬œ |

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šç”¨æˆ·åæ˜¾ç¤ºä½†è§’è‰²ä¸æ˜¾ç¤º

**å¯èƒ½åŸå› **ï¼š
1. ç™»å½•åæœªæˆåŠŸè°ƒç”¨ `/auth/me` ç«¯ç‚¹
2. åç«¯æœªè¿”å›è§’è‰²ä¿¡æ¯
3. è§’è‰²åˆ—è¡¨ä¸ºç©º

**è°ƒè¯•æ­¥éª¤**ï¼š
1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
2. æ£€æŸ¥åç«¯æ—¥å¿—ï¼Œç¡®è®¤ `/auth/me` è¯·æ±‚æ˜¯å¦æˆåŠŸ
3. åœ¨ Python ä¸­æµ‹è¯•ï¼š
   ```python
   from desktop.nicegui_app.auth_manager import auth_manager
   auth_manager.login("admin", "admin123")
   print(f"ç”¨æˆ·è¯¦æƒ…: {auth_manager._user_details}")
   print(f"è§’è‰²: {auth_manager._roles}")
   print(f"æƒé™: {auth_manager._permissions}")
   ```

### é—®é¢˜ 2ï¼šæœ‰æƒé™ä½†æŒ‰é’®ä¸æ˜¾ç¤º

**å¯èƒ½åŸå› **ï¼š
1. æƒé™ä»£ç ä¸åŒ¹é…ï¼ˆå‰ç«¯æ£€æŸ¥çš„æƒé™ä»£ç ä¸åç«¯è¿”å›çš„ä¸ä¸€è‡´ï¼‰
2. åç«¯æœªè¿”å›è¯¥æƒé™
3. æŒ‰é’®åˆå§‹åŒ–æ—¶è®¤è¯ç®¡ç†å™¨æœªåŠ è½½å®Œæˆ

**è°ƒè¯•æ­¥éª¤**ï¼š
1. æ£€æŸ¥åç«¯è¿”å›çš„æƒé™åˆ—è¡¨ï¼š
   ```python
   auth_manager.login("admin", "admin123")
   print(f"æ‰€æœ‰æƒé™: {auth_manager.get_all_permissions()}")
   ```

2. æ£€æŸ¥ç‰¹å®šæƒé™ï¼š
   ```python
   print(f"projects:create: {auth_manager.has_permission('projects:create')}")
   ```

3. æ£€æŸ¥å‰ç«¯ä»£ç ä¸­çš„æƒé™ä»£ç æ˜¯å¦æ­£ç¡®

### é—®é¢˜ 3ï¼šè¶…çº§ç®¡ç†å‘˜çœ‹ä¸åˆ°æ‰€æœ‰æŒ‰é’®

**å¯èƒ½åŸå› **ï¼š
1. `is_superuser` æ ‡å¿—æœªæ­£ç¡®è®¾ç½®
2. è¶…çº§ç®¡ç†å‘˜æƒé™æ£€æŸ¥é€»è¾‘é”™è¯¯

**è°ƒè¯•æ­¥éª¤**ï¼š
1. æ£€æŸ¥ç”¨æˆ·å¯¹è±¡ï¼š
   ```python
   auth_manager.login("admin", "admin123")
   print(f"ç”¨æˆ·: {auth_manager.user}")
   print(f"æ˜¯å¦è¶…çº§ç®¡ç†å‘˜: {auth_manager.is_superuser()}")
   ```

2. æ£€æŸ¥ `has_permission` æ–¹æ³•é€»è¾‘

### é—®é¢˜ 4ï¼šç‚¹å‡»æŒ‰é’®æ—¶æŠ¥é”™

**å¯èƒ½åŸå› **ï¼š
1. æŒ‰é’®ä¸º Noneï¼ˆæ— æƒé™ï¼‰ä½†ä»£ç æœªæ£€æŸ¥
2. æŒ‰é’®äº‹ä»¶ç»‘å®šå¤±è´¥

**è°ƒè¯•æ­¥éª¤**ï¼š
1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯
2. æ£€æŸ¥ `pc_app.py` ä¸­æ˜¯å¦æ­£ç¡®æ·»åŠ äº† None æ£€æŸ¥

---

## ğŸ“Š æµ‹è¯•ç»“æœè®°å½•

### è¶…çº§ç®¡ç†å‘˜æµ‹è¯•

| ç”¨æˆ·å | è§’è‰² | é¢„æœŸå¯è§æŒ‰é’®æ•° | å®é™…å¯è§æŒ‰é’®æ•° | çŠ¶æ€ |
|--------|------|--------------|--------------|------|
| admin | ç®¡ç†å‘˜,å·¥ç¨‹å¸ˆ | 12+ | | â¬œ |

### å—é™ç”¨æˆ·æµ‹è¯•

| ç”¨æˆ·å | è§’è‰² | é¢„æœŸå¯è§æŒ‰é’®æ•° | å®é™…å¯è§æŒ‰é’®æ•° | çŠ¶æ€ |
|--------|------|--------------|--------------|------|
| viewer | åªè¯»ç”¨æˆ· | 0-2 | | â¬œ |

---

## ğŸ¯ æµ‹è¯•å®Œæˆå

### å¦‚æœæ‰€æœ‰æµ‹è¯•é€šè¿‡ âœ…

æ­å–œï¼å‰ç«¯æƒé™æ§åˆ¶åŠŸèƒ½æ­£å¸¸ã€‚å¯ä»¥ç»§ç»­ï¼š

- [ ] **ä»»åŠ¡ #5**: ç§»åŠ¨ç«¯è®¤è¯æ•´åˆï¼ˆFlutterï¼‰
- [ ] **ä»£ç å®¡æŸ¥**: æ£€æŸ¥æƒé™æ§åˆ¶é€»è¾‘æ˜¯å¦å®Œå–„
- [ ] **æ–‡æ¡£æ›´æ–°**: æ›´æ–°ç”¨æˆ·æ‰‹å†Œï¼Œè¯´æ˜æƒé™æ§åˆ¶åŠŸèƒ½

### å¦‚æœæµ‹è¯•å¤±è´¥ âŒ

è¯·è®°å½•å¤±è´¥çš„åœºæ™¯å’Œé”™è¯¯ä¿¡æ¯ï¼Œç„¶åï¼š

1. æ£€æŸ¥ `auth_manager.py` ä¸­çš„æƒé™æ£€æŸ¥æ–¹æ³•
2. æ£€æŸ¥ `pc_app.py` ä¸­çš„æŒ‰é’®åˆå§‹åŒ–ä»£ç 
3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°å’Œåç«¯æ—¥å¿—
4. å‘Šè¯‰æˆ‘å…·ä½“çš„é”™è¯¯ä¿¡æ¯ï¼Œæˆ‘ä¼šååŠ©ä¿®å¤

---

## ğŸ“š ç›¸å…³ä»£ç 

- **æƒé™æ£€æŸ¥å®ç°**: `desktop/nicegui_app/auth_manager.py` (ç¬¬ 388-494 è¡Œ)
- **æŒ‰é’®æƒé™æ§åˆ¶**: `desktop/nicegui_app/pc_app.py` (ç¬¬ 327-366, 453-504 è¡Œ)
- **ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º**: `desktop/nicegui_app/pc_app.py` (ç¬¬ 357-363 è¡Œ)
- **åç«¯æƒé™ç³»ç»Ÿ**: `services/backend/app/schemas/auth.py`

---

**æ–‡æ¡£ç»´æŠ¤**: BDC-AI å¼€å‘å›¢é˜Ÿ
**æœ€åæ›´æ–°**: 2026-01-26
