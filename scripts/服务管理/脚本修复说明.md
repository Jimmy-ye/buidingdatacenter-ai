# Worker 启动脚本修复说明

**修复时间**: 2026-01-26
**问题**: bat 脚本找不到 `scene_issue_glm_worker.py` 文件

---

## 问题原因

`scene_issue_glm_worker.py` 文件位于 `services/worker/` 目录下，但启动脚本位于 `scripts/服务管理/` 目录下。脚本直接调用 `scene_issue_glm_worker.py` 时，由于当前目录不正确，导致找不到文件。

**错误信息**:
```
python: can't open file 'D:\\BDC-AI\\scripts\\服务管理\\scene_issue_glm_worker.py': [Errno 2] No such file or directory
```

---

## 解决方案

在所有 Worker 启动脚本中添加了目录切换逻辑：

```batch
REM 切换到脚本所在目录
cd /d "%~dp0"

REM 切换到 Worker 目录（向上两级，再进入 services/worker）
cd /d "%~dp0..\..\services\worker"
```

**路径说明**:
- `%~dp0` = 当前脚本所在目录 (`scripts/服务管理/`)
- `%~dp0..\..` = 向上两级 (`项目根目录/`)
- `%~dp0..\..\services\worker` = `services/worker/` 目录

---

## 修复的文件

### 1. 启动Worker.bat ✅

**修改**:
- 添加了 `cd /d "%~dp0..\..\services\worker"`
- 添加了当前目录显示 `echo - Worker Dir: %CD%`

**测试**:
```bash
# 运行脚本验证
scripts\服务管理\启动Worker.bat
```

### 2. 启动Worker_Python311.bat ✅

**修改**:
- 添加了 `cd /d "%~dp0..\..\services\worker"`
- 添加了当前目录显示

**测试**:
```bash
scripts\服务管理\启动Worker_Python311.bat
```

### 3. 监控Worker.bat ✅

**修改**:
- 添加了 `cd /d "%~dp0..\..\services\worker"`
- 添加了当前目录显示

**测试**:
```bash
scripts\服务管理\监控Worker.bat
```

---

## 测试脚本检查结果 ✅

### scripts/测试/ 目录下的脚本

**检查的文件**:
- `test_image_routing_smoke.py`
- `test_scene_issue_pipeline.py`
- `test_worker_flow.py`

**结果**: ✅ 无问题

**原因**: 测试脚本通过 HTTP API 调用后端，不直接运行 worker 文件，因此不受路径影响。

---

## 验证步骤

### 1. 验证修复是否生效

```bash
# 启动 Worker
cd D:\BDC-AI
scripts\服务管理\启动Worker.bat

# 应该看到输出:
# - Current directory: D:\BDC-AI\services\worker
# - Worker 正常启动
```

### 2. 验证 Worker 功能

```bash
# 检查 Worker 进程
tasklist | findstr python

# 检查 Worker 日志
# Worker 应该正常轮询后端 API
```

---

## 文件结构

```
D:\BDC-AI\
├── scripts/
│   └── 服务管理/              # 启动脚本位置
│       ├── 启动Worker.bat      # ✅ 已修复
│       ├── 启动Worker_Python311.bat  # ✅ 已修复
│       ├── 启动Worker测试.bat    # 无问题（只测试配置）
│       ├── 测试配置.bat          # 无问题（只测试配置）
│       └── 监控Worker.bat        # ✅ 已修复
│
└── services/
    └── worker/                # Worker 实际位置
        └── scene_issue_glm_worker.py  # ✅ 目标文件
```

---

## 其他说明

### 路径计算示例

假设脚本位置: `D:\BDC-AI\scripts\服务管理\启动Worker.bat`

```
%~dp0           = D:\BDC-AI\scripts\服务管理\
%~dp0..         = D:\BDC-AI\scripts\
%~dp0..\..       = D:\BDC-AI\
%~dp0..\..\services\worker = D:\BDC-AI\services\worker\
```

### 为什么不使用绝对路径？

使用相对路径的好处：
- ✅ 项目可以移动到任何位置
- ✅ 不同开发者可以使用不同的安装路径
- ✅ 更灵活和可移植

---

## 后续建议

1. **创建快捷方式**:
   - 可以在桌面创建这些 bat 文件的快捷方式
   - 方便快速启动 Worker

2. **添加到开机启动** (可选):
   ```batch
   # 将快捷方式复制到启动文件夹
   # Win+R 输入: shell:startup
   ```

3. **监控 Worker 状态**:
   - 使用 `监控Worker.bat` 实时查看 Worker 输出
   - 或通过后端 API 检查资产处理状态

---

**修复完成！** ✅

所有 Worker 启动脚本已修复，可以正常工作。
