# æŠ€æœ¯è§£ææ–‡æ¡£

æœ¬æ–‡æ¡£é›†åˆç”¨äºæ·±å…¥è§£æé¡¹ç›®ä¸­å„ä¸ªæ¨¡å—çš„å·¥ä½œåŸç†ã€æŠ€æœ¯ç»†èŠ‚å’Œå®é™…åº”ç”¨ã€‚

---

## ç›®å½•

1. [Backend éª¨æ¶è¯¦è§£](#backend-éª¨æ¶è¯¦è§£)
   - [æ ¸å¿ƒç»„æˆ](#æ ¸å¿ƒç»„æˆ)
   - [ä¾èµ–åº“è¯¦è§£](#ä¾èµ–åº“è¯¦è§£)
   - [å·¥ä½œæµç¨‹](#å·¥ä½œæµç¨‹)
   - [ä»£ç å±‚é¢è§£æ](#ä»£ç å±‚é¢è§£æ)
   - [å®é™…åº”ç”¨åœºæ™¯](#å®é™…åº”ç”¨åœºæ™¯)
   - [éª¨æ¶çš„è§’è‰²å®šä½](#éª¨æ¶çš„è§’è‰²å®šä½)

2. [å¤šæ¨¡æ€æ•°æ®å¤„ç†è¯¦è§£](#å¤šæ¨¡æ€æ•°æ®å¤„ç†è¯¦è§£)
   - [æ ¸å¿ƒç»„æˆ](#æ ¸å¿ƒç»„æˆ-1)
   - [ä¾èµ–åº“è¯¦è§£](#ä¾èµ–åº“è¯¦è§£-1)
   - [OCR å›¾ç‰‡è¯†åˆ«æµç¨‹](#ocr-å›¾ç‰‡è¯†åˆ«æµç¨‹)
   - [GLM-4V åœºæ™¯é—®é¢˜åˆ†ææµç¨‹](#glm-4v-åœºæ™¯é—®é¢˜åˆ†ææµç¨‹)
   - [ä»£ç å±‚é¢è§£æ](#ä»£ç å±‚é¢è§£æ-1)
   - [å®é™…åº”ç”¨åœºæ™¯](#å®é™…åº”ç”¨åœºæ™¯-1)
   - [å¸¸è§é—®é¢˜ä¸è§£å†³](#å¸¸è§é—®é¢˜ä¸è§£å†³)

---

# Backend éª¨æ¶è¯¦è§£

## ğŸ“– æ¦‚è¿°

Backend éª¨æ¶æ˜¯æ•´ä¸ª BDC-AI é¡¹ç›®çš„**åŸºç¡€è®¾æ–½å’Œæ ¸å¿ƒæ¡†æ¶**ï¼Œå°±åƒå»ºç­‘çš„åœ°åŸºå’Œæ¡†æ¶ï¼Œä¸ºæ‰€æœ‰ä¸šåŠ¡åŠŸèƒ½æä¾›æ”¯æ’‘ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- âœ… æä¾›ç¨³å®šçš„ Web æœåŠ¡èƒ½åŠ›
- âœ… æä¾›æ•°æ®åº“è¿æ¥å’Œ ORM æ”¯æŒ
- âœ… æä¾›é…ç½®ç®¡ç†å’Œç¯å¢ƒé€‚é…
- âœ… æä¾›è§„èŒƒçš„ä»£ç ç»“æ„
- âœ… æ”¯æŒå¿«é€Ÿæ‰©å±•æ–°åŠŸèƒ½

---

## æ ¸å¿ƒç»„æˆ

### é¡¹ç›®ç»“æ„

```
services/backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py              # FastAPI åº”ç”¨å…¥å£ï¼ˆæ€»ç»ç†ï¼‰
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ v1/
â”‚           â”œâ”€â”€ health.py    # API è·¯ç”±ï¼ˆæœåŠ¡å‘˜ï¼‰
â”‚           â”œâ”€â”€ projects.py  # é¡¹ç›®ç®¡ç†
â”‚           â””â”€â”€ assets.py    # èµ„äº§ç®¡ç†
â”‚   â”œâ”€â”€ schemas/             # Pydantic æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ services/            # ä¸šåŠ¡é€»è¾‘
â”‚       â””â”€â”€ image_pipeline.py
â”œâ”€â”€ requirements.txt         # Python ä¾èµ–æ¸…å•

shared/                      # å…±äº«èµ„æºåº“
â”œâ”€â”€ config/
â”‚   â””â”€â”€ settings.py          # é…ç½®ä¸­å¿ƒ
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ base.py              # æ•°æ®åº“åœ°åŸºï¼ˆORM åŸºç±»ï¼‰
â”‚   â”œâ”€â”€ session.py           # æ•°æ®åº“è¿æ¥æ± 
â”‚   â”œâ”€â”€ models_project.py    # é¡¹ç›®ç›¸å…³æ¨¡å‹
â”‚   â””â”€â”€ models_asset.py      # èµ„äº§ç›¸å…³æ¨¡å‹
â””â”€â”€ utils/                   # å·¥å…·ç®±ï¼ˆå¾…å¼€å‘ï¼‰
```

### ç»„ä»¶èŒè´£

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ | ç±»æ¯” |
|------|------|------|------|
| Web æ¡†æ¶ | main.py | ç»Ÿç­¹å…¨å±€ï¼Œç®¡ç†è·¯ç”± | æ€»ç»ç† |
| API è·¯ç”± | health.py, projects.py, assets.py | å¤„ç†å…·ä½“è¯·æ±‚ | æœåŠ¡å‘˜ |
| é…ç½®ç®¡ç† | settings.py | ç®¡ç†ç¯å¢ƒé…ç½® | é…ç½®ä¸­å¿ƒ |
| æ•°æ®åº“åŸºç±» | base.py | ORM å£°æ˜å¼åŸºç±» | èŠ±åå†Œæ¨¡æ¿ |
| ä¼šè¯ç®¡ç† | session.py | æ•°æ®åº“è¿æ¥æ±  | è¿æ¥æ± ç®¡ç†å™¨ |
| æ•°æ®æ¨¡å‹ | models_project.py, models_asset.py | æ•°æ®è¡¨å®šä¹‰ | æ•°æ®å­—å…¸ |

---

## ä¾èµ–åº“è¯¦è§£

### requirements.txt

```txt
fastapi==0.104.1
uvicorn[standard]==0.24.0
sqlalchemy==2.0.23
psycopg2-binary==2.9.9
python-dotenv
```

### 1. FastAPI - Web æ¡†æ¶

**ä½œç”¨**ï¼šæä¾› Web æœåŠ¡çš„åŸºç¡€æ¶æ„

**é€šä¿—ç†è§£**ï¼šå°±åƒé¤å…çš„**å»ºç­‘è®¾è®¡å›¾**

```
FastAPI æä¾›ï¼š
â”œâ”€â”€ è·¯ç”±ç³»ç»Ÿï¼šå“ªä¸ªåœ°å€å¯¹åº”å“ªä¸ªåŠŸèƒ½
â”œâ”€â”€ è¯·æ±‚å¤„ç†ï¼šæ¥æ”¶å®¢æˆ·è®¢å•
â”œâ”€â”€ å“åº”æ ¼å¼ï¼šè§„èŒƒè¿”å›æ•°æ®
â”œâ”€â”€ æ•°æ®éªŒè¯ï¼šæ£€æŸ¥è®¢å•æ˜¯å¦åˆæ³•
â””â”€â”€ è‡ªåŠ¨æ–‡æ¡£ï¼šè‡ªåŠ¨ç”Ÿæˆèœå•ï¼ˆSwagger UIï¼‰
```

**ä»£ç ç¤ºä¾‹**ï¼š

```python
from fastapi import FastAPI

app = FastAPI(title="BDC-AI Backend", version="0.3.0")

@app.get("/api/v1/health/")
async def health_check():
    return {"status": "ok"}

# FastAPI è‡ªåŠ¨å¸®ä½ åšï¼š
# âœ“ ç›‘å¬ /api/v1/health/ è¿™ä¸ªåœ°å€
# âœ“ æ”¶åˆ°è¯·æ±‚æ—¶è°ƒç”¨ health_check å‡½æ•°
# âœ“ æŠŠè¿”å›çš„å­—å…¸è½¬æˆ JSON æ ¼å¼
# âœ“ åŠ ä¸Šæ­£ç¡®çš„ HTTP å¤´
# âœ“ è®°å½•è¯·æ±‚æ—¥å¿—
```

### 2. Uvicorn - ASGI æœåŠ¡å™¨

**ä½œç”¨**ï¼šå®é™…è¿è¡Œ Web æœåŠ¡çš„æœåŠ¡å™¨

**é€šä¿—ç†è§£**ï¼šå°±åƒé¤å…çš„**å®ä½“å¨æˆ¿å’Œå¨å¸ˆ**

```
Uvicorn æä¾›ï¼š
â”œâ”€â”€ ç›‘å¬ç«¯å£ï¼šç›¸å½“äº"å¼€é—¨è¥ä¸š"
â”œâ”€â”€ æ¥æ”¶è¿æ¥ï¼šç›¸å½“äº"æ¥å¾…å®¢äºº"
â”œâ”€â”€ å¤„ç†è¯·æ±‚ï¼šç›¸å½“äº"åšèœ"
â”œâ”€â”€ è¿”å›å“åº”ï¼šç›¸å½“äº"ä¸Šèœ"
â””â”€â”€ å¹¶å‘å¤„ç†ï¼šå¯ä»¥åŒæ—¶æ¥å¾…å¤šä¸ªå®¢äºº
```

**ç±»æ¯”**ï¼š
```
FastAPI = é¤å…è®¾è®¡å›¾ï¼ˆçº¸ä¸Šè°ˆå…µï¼‰
Uvicorn = çœŸæ­£çš„å¨æˆ¿ï¼ˆå®é™…å¹²æ´»ï¼‰

å…‰æœ‰è®¾è®¡å›¾æ²¡æ³•è¥ä¸šï¼Œå¿…é¡»æŠŠå¨æˆ¿å»ºèµ·æ¥ã€è¯·å¨å¸ˆã€å¼€ç«
æ‰èƒ½çœŸæ­£æ¥å¾…å®¢äºº
```

**å¯åŠ¨å‘½ä»¤**ï¼š

```bash
python -m uvicorn services.backend.app.main:app --host localhost --port 8000 --reload

# è¿™ä¸ªå‘½ä»¤åšäº†ä»€ä¹ˆï¼š
# 1. æ‰¾åˆ° FastAPI åº”ç”¨ï¼šservices.backend.app.main:app
# 2. åœ¨ localhost çš„ 8000 ç«¯å£å¼€åº—
# 3. å¼€å§‹ç›‘å¬ï¼Œç­‰å¾…å®¢äººï¼ˆç”¨æˆ·è¯·æ±‚ï¼‰
# 4. æ”¶åˆ°è¯·æ±‚åï¼ŒæŒ‰ç…§ FastAPI å®šä¹‰çš„å¤„ç†
# 5. å¤„ç†å®Œè¿”å›ç»“æœ

# --reloadï¼šä»£ç ä¿®æ”¹åè‡ªåŠ¨é‡å¯ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
```

### 3. SQLAlchemy - ORM å·¥å…·

**ä½œç”¨**ï¼šPython å¯¹è±¡ä¸æ•°æ®åº“ä¹‹é—´çš„ç¿»è¯‘å®˜

**é€šä¿—ç†è§£**ï¼šå°±åƒ**æ•°æ®åº“ç¿»è¯‘å®˜**

```
SQLAlchemy æä¾›ï¼š
â”œâ”€â”€ Python ç±» â†’ æ•°æ®åº“è¡¨ï¼ˆç¿»è¯‘ï¼‰
â”œâ”€â”€ Python å¯¹è±¡ â†’ æ•°æ®åº“è®°å½•ï¼ˆç¿»è¯‘ï¼‰
â”œâ”€â”€ Python æ“ä½œ â†’ SQL è¯­å¥ï¼ˆç¿»è¯‘ï¼‰

ç±»æ¯”ï¼š
ä½ ï¼ˆPython ç¨‹åºå‘˜ï¼‰ï¼šåªä¼šè¯´ Python
æ•°æ®åº“ï¼ˆPostgreSQLï¼‰ï¼šåªå¬å¾—æ‡‚ SQL
SQLAlchemyï¼ˆç¿»è¯‘å®˜ï¼‰ï¼šäº’ç›¸ç¿»è¯‘
```

**ä»£ç å¯¹æ¯”**ï¼š

```python
# âŒ æ²¡æœ‰ SQLAlchemyï¼ˆæ‰‹åŠ¨å†™ SQLï¼‰ï¼š
import psycopg2

def create_project(name, location):
    conn = psycopg2.connect(...)
    cursor = conn.cursor()

    # æ‰‹å†™ SQLï¼ˆå®¹æ˜“å‡ºé”™ï¼‰
    sql = """
        INSERT INTO projects (id, name, location, created_at)
        VALUES (gen_random_uuid(), %s, %s, NOW())
        RETURNING id
    """
    cursor.execute(sql, (name, location))
    project_id = cursor.fetchone()[0]
    conn.commit()
    return project_id

# âœ“ æœ‰ SQLAlchemyï¼ˆç”¨ Python å¯¹è±¡ï¼‰ï¼š
from shared.db.session import SessionLocal
from shared.db.models_project import Project
import uuid

def create_project(name, location):
    db = SessionLocal()
    project = Project(id=uuid.uuid4(), name=name, location=location)
    db.add(project)
    db.commit()
    db.refresh(project)
    return project.id
```

### 4. PostgreSQL - å…³ç³»å‹æ•°æ®åº“

**ä½œç”¨**ï¼šå­˜å‚¨å’Œç®¡ç†é¡¹ç›®æ•°æ®

**é€šä¿—ç†è§£**ï¼šå°±åƒ**æ–‡ä»¶æŸœ + ç´¢å¼•ç³»ç»Ÿ**

```
PostgreSQL æä¾›ï¼š
â”œâ”€â”€ æ•°æ®æŒä¹…åŒ–ï¼šæ•°æ®ä¸ä¼šä¸¢å¤±
â”œâ”€â”€ UUID ç±»å‹ï¼šåŸç”Ÿæ”¯æŒ UUIDï¼ˆä¸»é”®ï¼‰
â”œâ”€â”€ JSON ç±»å‹ï¼šå­˜å‚¨ç»“æ„åŒ–æ•°æ®
â”œâ”€â”€ å¤–é”®çº¦æŸï¼šä¿è¯æ•°æ®å®Œæ•´æ€§
â”œâ”€â”€ äº‹åŠ¡æ”¯æŒï¼šACID ç‰¹æ€§
â””â”€â”€ å¹¶å‘æ§åˆ¶ï¼šå¤šç”¨æˆ·åŒæ—¶è®¿é—®

å¯¹æ¯” SQLiteï¼š
SQLiteï¼šè½»é‡çº§ï¼Œé€‚åˆå•æœºã€å•ç”¨æˆ·
PostgreSQLï¼šä¼ä¸šçº§ï¼Œé€‚åˆæœåŠ¡å™¨ã€å¤šç”¨æˆ·ã€é«˜å¹¶å‘
```

**è¿ç§»åŸå› **ï¼š
```python
# SQLite çš„é—®é¢˜ï¼š
# âœ— ä¸æ”¯æŒ UUID(as_uuid=True)
# âœ— å¤–é”®çº¦æŸè¾ƒå¼±
# âœ— å¹¶å‘æ€§èƒ½æœ‰é™

# PostgreSQL çš„ä¼˜åŠ¿ï¼š
# âœ“ åŸç”Ÿ UUID æ”¯æŒ
# âœ“ ä¸¥æ ¼çš„å¤–é”®çº¦æŸ
# âœ“ æ›´å¥½çš„å¹¶å‘æ€§èƒ½
# âœ“ æ”¯æŒ JSONã€æ•°ç»„ç­‰é«˜çº§ç±»å‹
# âœ“ ç”Ÿäº§ç¯å¢ƒå°±ç»ª
```

### 5. psycopg2-binary - PostgreSQL é©±åŠ¨

**ä½œç”¨**ï¼šPython ä¸ PostgreSQL ä¹‹é—´çš„æ¡¥æ¢

**é€šä¿—ç†è§£**ï¼šå°±åƒ**ç”µè¯çº¿**

```
psycopg2-binary æä¾›ï¼š
â”œâ”€â”€ ç½‘ç»œè¿æ¥ï¼šè¿æ¥åˆ° PostgreSQL æœåŠ¡å™¨
â”œâ”€â”€ åè®®è½¬æ¢ï¼šPython è°ƒç”¨ â†’ PostgreSQL åè®®
â”œâ”€â”€ æ•°æ®ä¼ è¾“ï¼šå‘é€ SQLã€æ¥æ”¶ç»“æœ
â””â”€â”€ äºŒè¿›åˆ¶æ¨¡å¼ï¼šé«˜æ•ˆä¼ è¾“æ•°æ®ï¼ˆbyteaï¼‰

ç±»æ¯”ï¼š
SQLAlchemy = ç¿»è¯‘å®˜ï¼ˆPython â†” SQLï¼‰
psycopg2-binary = ç”µè¯çº¿ï¼ˆPython â†” PostgreSQLï¼‰
```

---

## å·¥ä½œæµç¨‹

### å®Œæ•´è¯·æ±‚å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·ï¼ˆæµè§ˆå™¨ï¼‰                           â”‚
â”‚                  è®¿é—® http://localhost:8000/api/v1/projects/  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 1. HTTP è¯·æ±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Uvicorn æœåŠ¡å™¨ï¼ˆç›‘å¬ 8000 ç«¯å£ï¼‰                â”‚
â”‚  å·¥ä½œï¼šç›‘å¬ç«¯å£ï¼Œç­‰å¾…è¯·æ±‚ï¼Œæ”¶åˆ°åè½¬äº¤ç»™ FastAPI              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 2. ä¼ é€’è¯·æ±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FastAPI åº”ç”¨ï¼ˆmain.py ä¸­çš„ appï¼‰                â”‚
â”‚  å·¥ä½œï¼šæŸ¥çœ‹è·¯ç”±è¡¨ï¼Œæ‰¾åˆ°å¯¹åº”çš„å¤„ç†å‡½æ•°                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 3. è°ƒç”¨å¤„ç†å‡½æ•°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          projects.py ä¸­çš„ list_projects() å‡½æ•°               â”‚
â”‚  å·¥ä½œï¼šæ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢ï¼Œè¿”å›ç»“æœåˆ—è¡¨                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 4. è¿”å›ç»“æœ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FastAPI åº”ç”¨                              â”‚
â”‚  å·¥ä½œï¼šè½¬æˆ JSONï¼Œæ·»åŠ çŠ¶æ€ç å’Œå“åº”å¤´                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 5. HTTP å“åº”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç”¨æˆ·æµè§ˆå™¨                                 â”‚
â”‚           æ˜¾ç¤ºï¼š[{"id": "...", "name": "..."}, ...]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä»£ç å±‚é¢è§£æ

### 1. main.py - åº”ç”¨å…¥å£

**ä½ç½®**ï¼š`services/backend/app/main.py`

**ä»£ç **ï¼š

```python
from fastapi import FastAPI
from .api.v1 import health, projects, assets

# åˆ›å»º FastAPI åº”ç”¨å®ä¾‹
# å°±åƒæ³¨å†Œä¸€å®¶å…¬å¸ï¼Œé¢†å–è¥ä¸šæ‰§ç…§
app = FastAPI(title="BDC-AI Backend", version="0.3.0")

# æ³¨å†Œè·¯ç”±ï¼ˆæŒ‚è½½æœåŠ¡å°ï¼‰
# å°±åƒåœ¨å…¬å¸å¤§å…è®¾ç½®æœåŠ¡å°
app.include_router(health.router, prefix="/api/v1/health", tags=["health"])
app.include_router(projects.router, prefix="/api/v1/projects", tags=["projects"])
app.include_router(assets.router, prefix="/api/v1/assets", tags=["assets"])

@app.on_event("startup")
def on_startup() -> None:
    """åº”ç”¨å¯åŠ¨æ—¶åˆ›å»ºæ‰€æœ‰æ•°æ®åº“è¡¨"""
    from shared.db.base import Base
    from shared.db.session import engine

    Base.metadata.create_all(bind=engine)

# æ ¹è·¯å¾„å¤„ç†
@app.get("/")
async def read_root() -> dict:
    return {"status": "ok"}
```

### 2. settings.py - é…ç½®ç®¡ç†

**ä½ç½®**ï¼š`shared/config/settings.py`

**ä»£ç **ï¼š

```python
import os
from functools import lru_cache
from dotenv import load_dotenv
from pathlib import Path

# åŠ è½½ .env æ–‡ä»¶
load_dotenv(Path(__file__).parent.parent.parent / ".env")

class Settings:
    def __init__(self) -> None:
        # ä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œå¦‚æœæ²¡æœ‰å°±ç”¨é»˜è®¤å€¼
        self.database_url = os.getenv(
            "BDC_DATABASE_URL",
            "postgresql://admin:password@localhost:5432/bdc_ai"
        )
        self.local_storage_dir = os.getenv("BDC_LOCAL_STORAGE_DIR", "data/assets")

        # GLM API é…ç½®
        self.glm_api_key = os.getenv("GLM_API_KEY", "")
        self.glm_base_url = os.getenv("GLM_BASE_URL", "https://open.bigmodel.cn/api/paas/v4/")
        self.glm_vision_model = os.getenv("GLM_VISION_MODEL", "glm-4v")

# ä½¿ç”¨ lru_cache è£…é¥°å™¨å®ç°å•ä¾‹æ¨¡å¼
@lru_cache()
def get_settings() -> Settings:
    return Settings()
```

### 3. session.py - æ•°æ®åº“ä¼šè¯

**ä½ç½®**ï¼š`shared/db/session.py`

**ä»£ç **ï¼š

```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from shared.config.settings import get_settings

settings = get_settings()

# åˆ›å»ºå¼•æ“
engine = create_engine(settings.database_url, future=True)
#                            â†‘
#                            future=True: å¯ç”¨ SQLAlchemy 2.0 æ–°ç‰¹æ€§

# åˆ›å»ºä¼šè¯å·¥å‚
SessionLocal = sessionmaker(
    bind=engine,
    autocommit=False,   # ä¸è‡ªåŠ¨æäº¤ï¼ˆéœ€è¦æ‰‹åŠ¨ commitï¼‰
    autoflush=False,    # ä¸è‡ªåŠ¨åˆ·æ–°
    future=True         # SQLAlchemy 2.0 æ¨¡å¼
)

# ä¾èµ–æ³¨å…¥å‡½æ•°
def get_db() -> Generator:
    db = SessionLocal()  # åˆ›å»ºä¼šè¯ï¼ˆä»è¿æ¥æ± æ‹¿ä¸€ä¸ªè¿æ¥ï¼‰
    try:
        yield db         # æä¾›ç»™ä½¿ç”¨
    finally:
        db.close()       # ç”¨å®Œåå½’è¿˜è¿æ¥æ± 
```

**Engineï¼ˆå¼•æ“ï¼‰çš„å·¥ä½œåŸç†**ï¼š

```python
engine = create_engine("postgresql://...", pool_size=5, max_overflow=10)

# å¼•æ“ç»´æŠ¤ä¸€ä¸ªè¿æ¥æ± ï¼š
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ è¿æ¥1   â”‚ è¿æ¥2   â”‚ è¿æ¥3   â”‚ è¿æ¥4   â”‚ è¿æ¥5   â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# å½“ä½ è°ƒç”¨ SessionLocal()ï¼š
# â†’ ä»æ± å­é‡Œæ‹¿ä¸€ä¸ªç©ºé—²è¿æ¥ç»™ä½ 
#
# å½“ä½ è°ƒç”¨ db.close()ï¼š
# â†’ æŠŠè¿æ¥å½’è¿˜æ± å­ï¼Œç»™å…¶ä»–äººç”¨
```

---

## éª¨æ¶çš„è§’è‰²å®šä½

### è§’è‰² 1ï¼šæ¡†æ¶ - æä¾›ç»“æ„å’Œè§„èŒƒ

```
å°±åƒç›–æˆ¿å­çš„æ¡†æ¶ï¼š
â”œâ”€â”€ è§„å®šå“ªé‡Œæ˜¯æ‰¿é‡å¢™ï¼ˆä¸èƒ½ä¹±æ”¹ï¼‰
â”œâ”€â”€ è§„å®šå“ªé‡Œæ˜¯é—¨ï¼ˆè¿æ¥å¤–ç•Œï¼‰
â”œâ”€â”€ è§„å®šå“ªé‡Œæ˜¯çª—ï¼ˆé‡‡å…‰é€šé£ï¼‰
â””â”€â”€ ä¿è¯æˆ¿å­ç»“æ„ç¨³å›º

FastAPI + Uvicorn = Web æœåŠ¡æ¡†æ¶ï¼š
â”œâ”€â”€ è§„å®šè¯·æ±‚æ€ä¹ˆæ¥æ”¶ï¼ˆè·¯ç”±ç³»ç»Ÿï¼‰
â”œâ”€â”€ è§„å®šå“åº”æ€ä¹ˆè¿”å›ï¼ˆJSON æ ¼å¼ï¼‰
â”œâ”€â”€ è§„å®šé”™è¯¯æ€ä¹ˆå¤„ç†ï¼ˆå¼‚å¸¸æœºåˆ¶ï¼‰
â””â”€â”€ ä¿è¯æœåŠ¡ç¨³å®šè¿è¡Œ
```

### è§’è‰² 2ï¼šè¿æ¥å™¨ - è¿æ¥å„ä¸ªç»„ä»¶

```
å°±åƒæ°´ç”µç®¡ç½‘è¿æ¥å„ä¸ªæˆ¿é—´ï¼š
â”œâ”€â”€ æ°´ç®¡è¿æ¥å¨æˆ¿å’Œæµ´å®¤
â”œâ”€â”€ ç”µçº¿è¿æ¥å„ä¸ªæˆ¿é—´å’Œæ’åº§
â”œâ”€â”€ ç½‘çº¿è¿æ¥å„ä¸ªè®¾å¤‡

éª¨æ¶è¿æ¥ï¼š
â”œâ”€â”€ settings.py â”€â”€â”€â”€â”€â”
â”‚   é…ç½®æ•°æ®         â”œâ”€â”€â†’ è¿æ¥é…ç½®å’Œä»£ç 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”œâ”€â”€ session.py â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®åº“ä¼šè¯       â”œâ”€â”€â†’ è¿æ¥ä¸šåŠ¡é€»è¾‘å’Œæ•°æ®åº“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”œâ”€â”€ base.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ORM åŸºç±»         â”œâ”€â”€â†’ è¿æ¥ Python ç±»å’Œæ•°æ®åº“è¡¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è§’è‰² 3ï¼šåŸºç¡€è®¾æ–½ - æä¾›åŸºç¡€èƒ½åŠ›

```
å°±åƒåŸå¸‚çš„åŸºç¡€è®¾æ–½ï¼š
â”œâ”€â”€ é“è·¯ï¼šæä¾›é€šè¡Œèƒ½åŠ›
â”œâ”€â”€ æ°´ç”µï¼šæä¾›èƒ½æºä¾›åº”
â”œâ”€â”€ é€šä¿¡ï¼šæä¾›ä¿¡æ¯ä¼ è¾“

éª¨æ¶æä¾›ï¼š
â”œâ”€â”€ Web æœåŠ¡èƒ½åŠ›ï¼ˆFastAPIï¼‰
â”œâ”€â”€ å¹¶å‘å¤„ç†èƒ½åŠ›ï¼ˆUvicornï¼‰
â”œâ”€â”€ æ•°æ®æŒä¹…åŒ–èƒ½åŠ›ï¼ˆPostgreSQL + SQLAlchemyï¼‰
â”œâ”€â”€ é…ç½®ç®¡ç†èƒ½åŠ›ï¼ˆsettingsï¼‰
â””â”€â”€ ä¾èµ–æ³¨å…¥èƒ½åŠ›ï¼ˆFastAPI Dependsï¼‰
```

---

## æŠ€æœ¯äº®ç‚¹

### 1. SQLAlchemy 2.0 æ–°ç‰¹æ€§

```python
# future=True å¯ç”¨ SQLAlchemy 2.0
engine = create_engine(url, future=True)

# æ–°ç‰¹æ€§ï¼š
# 1. æ›´å¥½çš„ç±»å‹æç¤º
# 2. æ›´ç®€æ´çš„æŸ¥è¯¢è¯­æ³•
# 3. æ›´å¥½çš„å¼‚æ­¥æ”¯æŒ
# 4. æ›´æ˜ç¡®çš„é”™è¯¯æç¤º
```

### 2. UUID åŸç”Ÿæ”¯æŒ

```python
from sqlalchemy.dialects.postgresql import UUID
import uuid

class Project(Base):
    __tablename__ = "projects"

    # PostgreSQL åŸç”Ÿ UUID ç±»å‹
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = Column(String(200), nullable=False)

# ä¼˜åŠ¿ï¼š
# âœ“ è‡ªåŠ¨ç”Ÿæˆ UUID
# âœ“ å ç”¨ç©ºé—´å°ï¼ˆ16 å­—èŠ‚ï¼‰
# âœ“ ç´¢å¼•æ€§èƒ½å¥½
# âœ“ å…¨å±€å”¯ä¸€æ€§
```

### 3. é…ç½®ç®¡ç†å•ä¾‹æ¨¡å¼

```python
@lru_cache()
def get_settings() -> Settings:
    return Settings()

# å…¨å±€å”¯ä¸€é…ç½®å¯¹è±¡
# èŠ‚çœå†…å­˜ï¼Œä¿è¯ä¸€è‡´æ€§
```

---

# å¤šæ¨¡æ€æ•°æ®å¤„ç†è¯¦è§£

## ğŸ“– æ¦‚è¿°

å¤šæ¨¡æ€æ•°æ®å¤„ç†æ˜¯ BDC-AI é¡¹ç›®çš„**æ ¸å¿ƒèƒ½åŠ›å±‚**ï¼Œå°±åƒ"çœ¼ç›"å’Œ"å¤§è„‘"ï¼Œè®©ç³»ç»Ÿèƒ½å¤Ÿçœ‹æ‡‚å›¾ç‰‡ã€è¯»æ‡‚æ–‡æ¡£ã€ç†è§£å†…å®¹ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- âœ… å›¾ç‰‡æ–‡å­—è¯†åˆ«ï¼ˆOCRï¼‰ï¼šæå–è®¾å¤‡é“­ç‰Œã€ä»ªè¡¨è¯»æ•°ç­‰å…³é”®ä¿¡æ¯
- âœ… åœºæ™¯é—®é¢˜åˆ†æï¼ˆGLM-4Vï¼‰ï¼šæ™ºèƒ½è¯Šæ–­ç°åœºé—®é¢˜ï¼Œç»™å‡ºå»ºè®®æªæ–½
- âœ… æ™ºèƒ½å›¾ç‰‡è·¯ç”±ï¼šæ ¹æ®å†…å®¹è‡ªåŠ¨é€‰æ‹©å¤„ç†æ–¹å¼
- âœ… ç»“æ„åŒ–æ•°æ®å­˜å‚¨ï¼šå°†éç»“æ„åŒ–æ•°æ®è½¬ä¸ºå¯æŸ¥è¯¢çš„ç»“æ„åŒ–æ•°æ®
- âœ… å¤šç‰ˆæœ¬ç®¡ç†ï¼šä¿ç•™è§£æå†å²ï¼Œæ”¯æŒè¿½æº¯å’Œå¯¹æ¯”

**é€šä¿—ç†è§£**ï¼š
```
å¤šæ¨¡æ€æ•°æ®å¤„ç†å™¨ = è¶…çº§ç¿»è¯‘å®˜ + æ™ºèƒ½åˆ†æå¸ˆ

è¾“å…¥ï¼šå„ç§"çœ‹ä¸æ‡‚"çš„ä¸œè¥¿
â”œâ”€â”€ å›¾ç‰‡ï¼ˆè®¾å¤‡é“­ç‰Œã€ç°åœºç…§ç‰‡ï¼‰
â””â”€â”€ å¤‡æ³¨ï¼ˆå·¥ç¨‹å¸ˆè¯´æ˜ï¼‰

è¾“å‡ºï¼š
â”œâ”€â”€ OCR å¤„ç†ï¼ˆç”µè¡¨ã€é“­ç‰Œï¼‰â†’ æ–‡å­—å†…å®¹ + ä½ç½®åæ ‡
â”œâ”€â”€ GLM åˆ†æï¼ˆç°åœºé—®é¢˜ï¼‰â†’ é—®é¢˜è¯Šæ–­ + å»ºè®®æªæ–½
â””â”€â”€ ç»“æ„åŒ– JSON â†’ å­˜æ•°æ®åº“
```

---

## æ ¸å¿ƒç»„æˆ

### é¡¹ç›®ç»“æ„

```
services/backend/
â””â”€â”€ app/
    â”œâ”€â”€ api/v1/
    â”‚   â””â”€â”€ assets.py              # API æ¥å£
    â””â”€â”€ services/
        â””â”€â”€ image_pipeline.py      # å›¾ç‰‡å¤„ç†æµæ°´çº¿ï¼ˆæ™ºèƒ½è·¯ç”±ï¼‰

services/worker/
â””â”€â”€ scene_issue_glm_worker.py     # GLM Workerï¼ˆåå°å¤„ç†ï¼‰

shared/
â””â”€â”€ db/
    â””â”€â”€ models_asset.py            # Asset æ•°æ®æ¨¡å‹
```

### ç»„ä»¶èŒè´£

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ | ç±»æ¯” |
|------|------|------|------|
| æ™ºèƒ½è·¯ç”± | image_pipeline.py | æ ¹æ®å†…å®¹é€‰æ‹©å¤„ç†æ–¹å¼ | æ™ºèƒ½åˆ†æ‹£å‘˜ |
| OCR å¼•æ“ | PaddleOCR | å›¾ç‰‡æ–‡å­—è¯†åˆ« | ç¿»è¯‘å®˜ |
| GLM å¼•æ“ | GLM-4V API | åœºæ™¯é—®é¢˜æ™ºèƒ½åˆ†æ | ä¸“å®¶é¡¾é—® |
| Worker | scene_issue_glm_worker.py | åå°è‡ªåŠ¨å¤„ç† | è‡ªåŠ¨åŒ–æµæ°´çº¿ |
| æ•°æ®æ¨¡å‹ | models_asset.py | å­˜å‚¨åˆ†æç»“æœ | æ¡£æ¡ˆæŸœ |
| API æ¥å£ | assets.py | æ¥æ”¶ä¸Šä¼ ã€è¿”å›ç»“æœ | æœåŠ¡çª—å£ |

---

## ä¾èµ–åº“è¯¦è§£

### requirements.txtï¼ˆå¤šæ¨¡æ€éƒ¨åˆ†ï¼‰

```txt
# OCR ä¸å›¾åƒå¤„ç†
paddleocr==2.7.0.3          # ç™¾åº¦ OCR å¼•æ“
paddlepaddle==2.6.2         # æ·±åº¦å­¦ä¹ æ¡†æ¶åç«¯
opencv-python<=4.6.0.66     # å›¾åƒå¤„ç†åº“

# GLM API
openai                      # GLM API å®¢æˆ·ç«¯ï¼ˆå…¼å®¹ OpenAI SDKï¼‰
```

### 1. PaddleOCR - æ–‡å­—è¯†åˆ«å¼•æ“

**ä½œç”¨**ï¼šä»å›¾ç‰‡ä¸­æå–æ–‡å­—ä¿¡æ¯

**é€šä¿—ç†è§£**ï¼šå°±åƒ**äººç±»çš„çœ¼ç› + å¤§è„‘**

```
PaddleOCR çš„å·¥ä½œè¿‡ç¨‹ï¼š
â”œâ”€â”€ æ–‡å­—æ£€æµ‹ï¼šæ‰¾åˆ°æ–‡å­—åœ¨å“ªé‡Œï¼ˆåƒçœ¼ç›æ‰¾å­—ï¼‰
â”œâ”€â”€ æ–‡å­—åˆ†ç±»ï¼šåˆ¤æ–­æ–‡å­—æ–¹å‘ï¼ˆåƒæ­ªå¤´çœ‹ä¹¦ï¼‰
â”œâ”€â”€ æ–‡å­—è¯†åˆ«ï¼šè¯†åˆ«æ˜¯ä»€ä¹ˆå­—ï¼ˆåƒå¤§è„‘è®¤å­—ï¼‰
â””â”€â”€ ç»“æœè¾“å‡ºï¼šæ–‡å­— + åæ ‡ + ç½®ä¿¡åº¦
```

**ä»£ç ç¤ºä¾‹**ï¼š

```python
from paddleocr import PaddleOCR

# åˆå§‹åŒ– OCRï¼ˆé¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½æ¨¡å‹ï¼‰
ocr = PaddleOCR(
    use_angle_cls=True,    # å¯ç”¨æ–‡å­—æ–¹å‘åˆ†ç±»
    lang='ch'              # ä¸­æ–‡æ¨¡å‹ï¼ˆä¹Ÿæ”¯æŒè‹±æ–‡ï¼‰
)

# è¯†åˆ«å›¾ç‰‡
result = ocr.ocr('electric_meter.jpg', cls=True)

# è¿”å›ç»“æœæ ¼å¼ï¼š
# [
#   [
#     [[x1, y1], [x2, y2], [x3, y3], [x4, y4]],  # æ–‡å­—æ¡†åæ ‡
#     ('1234.5', 0.998)                           # (æ–‡å­—, ç½®ä¿¡åº¦)
#   ],
#   [
#     [[x1, y1], [x2, y2], [x3, y3], [x4, y4]],
#     ('kWÂ·h', 0.996)
#   ],
#   # ... æ›´å¤šæ–‡å­—è¡Œ
# ]
```

**æ€§èƒ½æŒ‡æ ‡**ï¼ˆCPU æ¨¡å¼ï¼ŒIntel i7ï¼‰ï¼š
- æ–‡å­—æ£€æµ‹ï¼š~0.6 ç§’
- æ–‡å­—åˆ†ç±»ï¼š~0.25 ç§’
- æ–‡å­—è¯†åˆ«ï¼š~3.3 ç§’
- **æ€»è€—æ—¶**ï¼šçº¦ 4.2 ç§’/å¼ 

### 2. GLM-4V - è§†è§‰å¤§æ¨¡å‹

**ä½œç”¨**ï¼šç†è§£å›¾ç‰‡å†…å®¹ï¼Œè¿›è¡Œåœºæ™¯é—®é¢˜åˆ†æ

**é€šä¿—ç†è§£**ï¼šå°±åƒ**èµ„æ·±å·¥ç¨‹å¸ˆä¸“å®¶**

```
GLM-4V çš„å·¥ä½œè¿‡ç¨‹ï¼š
â”œâ”€â”€ ç†è§£å›¾ç‰‡ï¼šçœ‹åˆ°ç°åœºç…§ç‰‡ï¼ˆåƒå·¥ç¨‹å¸ˆçœ‹ç°åœºï¼‰
â”œâ”€â”€ åˆ†æé—®é¢˜ï¼šè¯†åˆ«å¼‚å¸¸æƒ…å†µï¼ˆåƒä¸“å®¶è¯Šæ–­ï¼‰
â”œâ”€â”€ æ¨æ–­åŸå› ï¼šåˆ†æå¯èƒ½åŸå› ï¼ˆåƒç»éªŒåˆ¤æ–­ï¼‰
â””â”€â”€ ç»™å‡ºå»ºè®®ï¼šæä¾›æ”¹è¿›æªæ–½ï¼ˆåƒä¸“å®¶å»ºè®®ï¼‰
```

**ä»£ç ç¤ºä¾‹**ï¼š

```python
from openai import OpenAI

# åˆå§‹åŒ– GLM å®¢æˆ·ç«¯ï¼ˆä½¿ç”¨ OpenAI SDK å…¼å®¹æ¥å£ï¼‰
client = OpenAI(
    api_key="your_glm_api_key",
    base_url="https://open.bigmodel.cn/api/paas/v4/"
)

# è°ƒç”¨ GLM-4V
response = client.chat.completions.create(
    model="glm-4v",
    messages=[
        {
            "role": "user",
            "content": [
                {
                    "type": "image_url",
                    "image_url": {
                        "url": "data:image/jpeg;base64,..."
                    }
                },
                {
                    "type": "text",
                    "text": "åˆ†æè¿™å¼ ç°åœºç…§ç‰‡ï¼Œè¯†åˆ«é—®é¢˜å¹¶ç»™å‡ºå»ºè®®"
                }
            ]
        }
    ],
    response_format={"type": "json_object"},
    temperature=0.1
)

result = response.choices[0].message.content
```

**è¿”å›ç»“æœç¤ºä¾‹**ï¼š

```json
{
  "title": "åˆ¶å†·ç³»ç»Ÿæ•ˆç‡ä½ä¸‹",
  "issue_category": "å†·æºæ•ˆç‡",
  "severity": "high",
  "summary": "å†·å´å¡”æ°´ä½è¿‡é«˜ï¼Œå¯¼è‡´æ¢çƒ­æ•ˆç‡ä¸‹é™",
  "suspected_causes": [
    "æ°´ä½æ§åˆ¶å™¨æ•…éšœ",
    "æ°´ä½ä¼ æ„Ÿå™¨å¤±çµ"
  ],
  "recommended_actions": [
    "æ›´æ¢æ°´ä½æ§åˆ¶å™¨",
    "æ ¡å‡†æ°´ä½ä¼ æ„Ÿå™¨"
  ],
  "confidence": 0.8,
  "tags": ["å†·å´å¡”", "æ°´ä½", "æ•ˆç‡ä½ä¸‹"]
}
```

**æ€§èƒ½æŒ‡æ ‡**ï¼š
- API å“åº”æ—¶é—´ï¼š~10-30 ç§’
- å‡†ç¡®ç‡ï¼šé«˜ï¼ˆå¤§æ¨¡å‹èƒ½åŠ›ï¼‰
- æˆæœ¬ï¼šæŒ‰æ¬¡è®¡è´¹

### 3. OpenAI SDK - GLM API å®¢æˆ·ç«¯

**ä½œç”¨**ï¼šPython ä¸ GLM API ä¹‹é—´çš„æ¡¥æ¢

**é€šä¿—ç†è§£**ï¼šå°±åƒ**ç”µè¯**

```
OpenAI SDK æä¾›ï¼š
â”œâ”€â”€ API è°ƒç”¨å°è£…ï¼šç®€åŒ– HTTP è¯·æ±‚
â”œâ”€â”€ æ•°æ®ç±»å‹è½¬æ¢ï¼šPython å¯¹è±¡ â†” JSON
â”œâ”€â”€ é”™è¯¯å¤„ç†ï¼šç½‘ç»œå¼‚å¸¸ã€API é”™è¯¯
â””â”€â”€ æµå¼å“åº”ï¼šæ”¯æŒé€å­—è¾“å‡ºï¼ˆå¯é€‰ï¼‰

ç±»æ¯”ï¼š
æˆ‘ä»¬ï¼ˆPython ç¨‹åºï¼‰â†’ OpenAI SDK â†’ GLM API
     è¯´ä¸­æ–‡            æ‰“ç”µè¯          å¬ä¸­æ–‡
```

---

## OCR å›¾ç‰‡è¯†åˆ«æµç¨‹

### å®Œæ•´å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡                              â”‚
â”‚           é€‰æ‹©ç”µè¡¨ç…§ç‰‡ + å¤‡æ³¨"ç”µè¡¨è¯»æ•°" â†’ ç‚¹å‡»ä¸Šä¼              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 1. æ–‡ä»¶ä¸Šä¼ 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        API: POST /api/v1/assets/upload_image_with_note       â”‚
â”‚  å·¥ä½œï¼šæ¥æ”¶æ–‡ä»¶ï¼Œä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œåˆ›å»º Asset è®°å½•              â”‚
â”‚  ç»“æœï¼šè¿”å› asset_id                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 2. è‡ªåŠ¨è·¯ç”±
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              route_image_asset() å‡½æ•°                        â”‚
â”‚  åˆ¤æ–­ content_roleï¼š                                          â”‚
â”‚  â€¢ "meter" â†’ OCR æ–‡å­—æå–                                     â”‚
â”‚  â€¢ "scene_issue" â†’ GLM-4V åœºæ™¯é—®é¢˜åˆ†æï¼ˆä¸è‡ªåŠ¨è°ƒç”¨ï¼Œéœ€ Workerï¼‰â”‚
â”‚  â€¢ å…¶ä»– â†’ ä»…å­˜å‚¨                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 3. OCR å¤„ç†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PaddleOCR æ–‡å­—è¯†åˆ«ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰                   â”‚
â”‚  æ­¥éª¤ 1: æ–‡å­—æ£€æµ‹ï¼ˆ0.6ç§’ï¼‰                                    â”‚
â”‚      â†’ æ‰¾åˆ°æ‰€æœ‰æ–‡å­—æ¡†ä½ç½®                                     â”‚
â”‚  æ­¥éª¤ 2: æ–‡å­—åˆ†ç±»ï¼ˆ0.25ç§’ï¼‰                                   â”‚
â”‚      â†’ åˆ¤æ–­æ–‡å­—æ˜¯å¦éœ€è¦æ—‹è½¬                                   â”‚
â”‚  æ­¥éª¤ 3: æ–‡å­—è¯†åˆ«ï¼ˆ3.3ç§’ï¼‰                                    â”‚
â”‚      â†’ è¯†åˆ«æ¯ä¸ªæ–‡å­—æ¡†çš„å†…å®¹                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 4. ç»“æœå¤„ç†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ„é€ ç»“æ„åŒ– JSON æ•°æ®                             â”‚
â”‚  {                                                          â”‚
â”‚    "annotations": {                                         â”‚
â”‚      "ocr_lines": [                                         â”‚
â”‚        {"text": "1234.5", "bbox": [...], "confidence": 0.998},â”‚
â”‚        {"text": "kWÂ·h", "bbox": [...], "confidence": 0.996}  â”‚
â”‚      ]                                                      â”‚
â”‚    },                                                       â”‚
â”‚    "stats": {"avg_confidence": 0.997, "engine": "paddleocr"} â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 5. ä¿å­˜åˆ°æ•°æ®åº“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         åˆ›å»º AssetStructuredPayload è®°å½•                      â”‚
â”‚  â€¢ schema_type: "image_annotation"                           â”‚
â”‚  â€¢ version: 1.0                                              â”‚
â”‚  â€¢ payload: <ä¸Šé¢æ„é€ çš„ JSON>                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 6. æ›´æ–°çŠ¶æ€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ›´æ–° Asset.status å­—æ®µ                          â”‚
â”‚  â€¢ å¦‚æœå¹³å‡ç½®ä¿¡åº¦ >= 0.8: "parsed_ocr_ok"                    â”‚
â”‚  â€¢ å¦‚æœå¹³å‡ç½®ä¿¡åº¦ < 0.8: "parsed_ocr_low_conf"               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ 7. è¿”å›ç»“æœ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     è¿”å›ç»™ç”¨æˆ·                                â”‚
â”‚  {                                                          â”‚
â”‚    "id": "asset-uuid",                                      â”‚
â”‚    "status": "parsed_ocr_ok",                               â”‚
â”‚    "structured_payloads": [...]                            â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## GLM-4V åœºæ™¯é—®é¢˜åˆ†ææµç¨‹

### Worker åå°è‡ªåŠ¨å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  GLM Worker å¯åŠ¨ï¼ˆåå°è¿›ç¨‹ï¼‰                  â”‚
â”‚            python scene_issue_glm_worker.py                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ æ¯ 60 ç§’è½®è¯¢ä¸€æ¬¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æŸ¥è¯¢å¾…å¤„ç†çš„ scene_issue å›¾ç‰‡                    â”‚
â”‚  GET /api/v1/assets?modality=image&content_role=scene_issue  â”‚
â”‚  ç­›é€‰æ¡ä»¶ï¼šstatus IS NULL æˆ– status = "pending_scene_llm"    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ æ‰¾åˆ°å¾…å¤„ç†å›¾ç‰‡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  è¯»å–å›¾ç‰‡å’Œå¤‡æ³¨ä¿¡æ¯                            â”‚
â”‚  1. è·å– Asset è¯¦æƒ…ï¼ˆfile_path, descriptionï¼‰                â”‚
â”‚  2. ä»æœ¬åœ°å­˜å‚¨è¯»å–å›¾ç‰‡æ–‡ä»¶                                   â”‚
â”‚  3. è½¬æ¢ä¸º Base64 ç¼–ç                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ æ„é€  Prompt
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ„å»º GLM-4V åˆ†æ Prompt                      â”‚
â”‚  Prompt: "ä½ æ˜¯å»ºç­‘èŠ‚èƒ½è¯Šæ–­å·¥ç¨‹å¸ˆ...                          â”‚
â”‚           åˆ†æè¿™å¼ ç°åœºç…§ç‰‡ï¼Œè¯†åˆ«é—®é¢˜ã€åŸå› ã€å»ºè®®..."           â”‚
â”‚  å¤‡æ³¨ï¼š"ç®¡é“æ¥å£å¤„æœ‰æ¸—æ¼"                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ è°ƒç”¨ GLM API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è°ƒç”¨ GLM-4V APIï¼ˆ10-30ç§’ï¼‰                       â”‚
â”‚  â€¢ å‘é€å›¾ç‰‡ï¼ˆBase64ï¼‰+ Prompt                                â”‚
â”‚  â€¢ ç­‰å¾… GLM åˆ†æ                                            â”‚
â”‚  â€¢ æ¥æ”¶ JSON ç»“æœ                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ ç»“æœå¤„ç†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è§„èŒƒåŒ–åˆ†æç»“æœ                                   â”‚
â”‚  â€¢ ç¡®ä¿ JSON æ ¼å¼æ­£ç¡®                                       â”‚
â”‚  â€¢ è¡¥å……é»˜è®¤å€¼ï¼ˆå¦‚ç©ºåˆ—è¡¨ï¼‰                                    â”‚
â”‚  â€¢ æ•°æ®ç±»å‹è½¬æ¢ï¼ˆå­—ç¬¦ä¸² â†’ åˆ—è¡¨ï¼‰                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ æäº¤ç»“æœ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      POST /api/v1/assets/{asset_id}/scene_issue_report       â”‚
â”‚  æäº¤åˆ†æç»“æœåˆ°åç«¯ API                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ æ›´æ–°çŠ¶æ€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ›´æ–° Asset.status = "parsed_scene_llm"         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“ ç»§ç»­è½®è¯¢
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç­‰å¾… 60 ç§’ï¼Œç»§ç»­ä¸‹ä¸€è½®è½®è¯¢                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Worker é…ç½®

**ç¯å¢ƒå˜é‡**ï¼š

```bash
# .env æ–‡ä»¶
GLM_API_KEY=your_glm_api_key_here
GLM_BASE_URL=https://open.bigmodel.cn/api/paas/v4/
GLM_VISION_MODEL=glm-4v
BDC_BACKEND_BASE_URL=http://localhost:8000
BDC_LOCAL_STORAGE_DIR=data/assets
BDC_SCENE_WORKER_POLL_INTERVAL=60  # è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰
```

**è½®è¯¢é€»è¾‘**ï¼š

```python
import time
from openai import OpenAI

client = OpenAI(api_key=GLM_API_KEY, base_url=GLM_BASE_URL)

def main():
    print("Starting GLM-4V scene_issue worker...")

    while True:
        # 1. æŸ¥è¯¢å¾…å¤„ç†å›¾ç‰‡
        assets = get_pending_scene_assets()

        if not assets:
            print("No pending assets found")
        else:
            # 2. å¤„ç†æ¯ä¸ªå¾…å¤„ç†å›¾ç‰‡
            for asset in assets:
                print(f"Processing asset {asset['id']}...")

                # 3. è¯»å–å›¾ç‰‡
                image_content = get_image_content(asset)
                if not image_content:
                    continue

                # 4. è°ƒç”¨ GLM-4V
                result = call_glm_vision(image_content, asset['description'])
                if not result:
                    continue

                # 5. æäº¤ç»“æœ
                post_scene_issue_report(asset['id'], result)

        # 6. ç­‰å¾…ä¸‹ä¸€è½®
        time.sleep(POLL_INTERVAL)

if __name__ == "__main__":
    main()
```

---

## ä»£ç å±‚é¢è§£æ

### 1. image_pipeline.py - æ™ºèƒ½è·¯ç”±

**ä½ç½®**ï¼š`services/backend/app/services/image_pipeline.py`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š

```python
from paddleocr import PaddleOCR
import logging

logger = logging.getLogger(__name__)

# å•ä¾‹æ¨¡å¼ï¼šå…¨å±€åªåˆ›å»ºä¸€ä¸ª OCR å®ä¾‹
_ocr_client = None

def _get_ocr_client():
    """è·å– OCR å®¢æˆ·ç«¯ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰"""
    global _ocr_client

    if _ocr_client is None:
        logger.info("åˆå§‹åŒ– PaddleOCR å®¢æˆ·ç«¯...")
        _ocr_client = PaddleOCR(
            use_angle_cls=True,
            lang='ch',
            show_log=False,
        )
        logger.info("PaddleOCR å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ")

    return _ocr_client


def route_image_asset(db: Session, asset_id: UUID) -> Asset:
    """
    æ™ºèƒ½å›¾ç‰‡è·¯ç”±ï¼šæ ¹æ® content_role è‡ªåŠ¨é€‰æ‹©å¤„ç†æ–¹å¼

    å¤„ç†æµç¨‹ï¼š
    1. æŸ¥è¯¢ Asset è®°å½•
    2. æ£€æŸ¥ modality å’Œ content_role
    3. æ ¹æ®ç±»å‹é€‰æ‹©å¤„ç†ï¼š
       - meter â†’ OCR æ–‡å­—æå–
       - scene_issue â†’ æ›´æ–°çŠ¶æ€ä¸º pending_scene_llm
       - å…¶ä»– â†’ ä»…å­˜å‚¨
    4. æ›´æ–° Asset çŠ¶æ€
    """
    asset = db.query(Asset).filter(Asset.id == asset_id).one()

    if asset.modality != "image":
        raise ValueError(f"ä¸æ”¯æŒçš„æ¨¡æ€ç±»å‹: {asset.modality}")

    role = (asset.content_role or "").lower()

    # è·¯ç”±é€»è¾‘
    if role == "meter":
        # ç”µè¡¨ã€é“­ç‰Œ â†’ OCR æ–‡å­—æå–
        logger.info(f"Asset {asset_id}: è·¯ç”±åˆ° OCR å¤„ç†")
        structured = process_image_with_ocr(db, asset_id)

    elif role == "scene_issue":
        # åœºæ™¯é—®é¢˜ â†’ æ›´æ–°çŠ¶æ€ï¼Œç­‰å¾… GLM Worker å¤„ç†
        logger.info(f"Asset {asset_id}: è·¯ç”±åˆ° GLM-4V å¤„ç†")
        asset.status = "pending_scene_llm"
        db.commit()
        db.refresh(asset)

    else:
        # å…¶ä»–ç±»å‹ â†’ ä»…å­˜å‚¨
        logger.info(f"Asset {asset_id}: ä»…å­˜å‚¨ï¼Œä¸è‡ªåŠ¨å¤„ç†")
        asset.status = "uploaded"
        db.commit()
        db.refresh(asset)

    return asset
```

### 2. scene_issue_glm_worker.py - GLM Worker

**ä½ç½®**ï¼š`services/worker/scene_issue_glm_worker.py`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š

```python
import time
import base64
import io
from pathlib import Path
from PIL import Image
from openai import OpenAI
import requests

# ç¯å¢ƒå˜é‡é…ç½®
BACKEND_BASE_URL = os.getenv("BDC_BACKEND_BASE_URL", "http://127.0.0.1:8000")
LOCAL_STORAGE_DIR = os.getenv("BDC_LOCAL_STORAGE_DIR", "./data/local_storage")
GLM_API_KEY = os.getenv("GLM_API_KEY", "")
GLM_BASE_URL = os.getenv("GLM_BASE_URL", "https://open.bigmodel.cn/api/paas/v4/")
VISION_MODEL = os.getenv("GLM_VISION_MODEL", "glm-4v")
POLL_INTERVAL = int(os.getenv("BDC_SCENE_WORKER_POLL_INTERVAL", "60"))

# åˆå§‹åŒ– GLM å®¢æˆ·ç«¯
client = OpenAI(api_key=GLM_API_KEY, base_url=GLM_BASE_URL)


def get_pending_scene_assets():
    """ä»åç«¯è·å–å¾…å¤„ç†çš„ scene_issue å›¾ç‰‡"""
    params = {
        "modality": "image",
        "content_role": "scene_issue",
    }

    resp = requests.get(
        f"{BACKEND_BASE_URL}/api/v1/assets",
        params=params,
        timeout=30
    )

    if resp.status_code != 200:
        return []

    assets = resp.json()
    # ç­›é€‰å¾…å¤„ç†çš„å›¾ç‰‡
    pending = [a for a in assets if a.get("status") in (None, "pending_scene_llm")]
    return pending


def get_image_content_from_detail(detail: dict):
    """ä» Asset è¯¦æƒ…è·å–å›¾ç‰‡å†…å®¹ï¼ˆBase64 ç¼–ç ï¼‰"""
    file_path = detail.get("file_path")
    if not file_path:
        return None

    full_path = Path(LOCAL_STORAGE_DIR) / file_path
    if not full_path.is_file():
        return None

    # è¯»å–å›¾ç‰‡å¹¶è½¬æ¢
    try:
        with Image.open(full_path) as img:
            if img.mode in ("RGBA", "P"):
                img = img.convert("RGB")

            buffered = io.BytesIO()
            img.save(buffered, format="JPEG")
            img_str = base64.b64encode(buffered.getvalue()).decode()

            return {
                "type": "image_url",
                "image_url": {
                    "url": f"data:image/jpeg;base64,{img_str}"
                }
            }
    except Exception as e:
        print(f"Error processing image: {e}")
        return None


def call_glm_vision(image_content: dict, note: str = None):
    """è°ƒç”¨ GLM-4V API è¿›è¡Œåœºæ™¯é—®é¢˜åˆ†æ"""
    prompt = """
ä½ æ˜¯ä¸€åå»ºç­‘èŠ‚èƒ½ä¸è¿è¡Œè¯Šæ–­å·¥ç¨‹å¸ˆåŠ©æ‰‹ã€‚
è¯·ç»“åˆç°åœºç…§ç‰‡åˆ†æç°åœºé—®é¢˜æˆ–è¿è¡ŒçŠ¶æ€ã€‚

ä¸¥æ ¼æŒ‰ç…§ä¸‹åˆ— JSON ç»“æ„è¾“å‡ºï¼š
{
  "title": "ä¸€å¥è¯çš„ç®€çŸ­æ ‡é¢˜",
  "issue_category": "é—®é¢˜ç±»åˆ«",
  "severity": "low | medium | high",
  "summary": "å¯¹ç°åœºä¸»è¦é—®é¢˜æˆ–çŠ¶æ€çš„ç®€è¦æè¿°",
  "suspected_causes": ["å¯èƒ½åŸå› 1", "å¯èƒ½åŸå› 2"],
  "recommended_actions": ["å»ºè®®æªæ–½1", "å»ºè®®æªæ–½2"],
  "confidence": 0.0 åˆ° 1.0 ä¹‹é—´çš„æ•°å­—,
  "tags": ["è‹¥å¹²çŸ­æ ‡ç­¾"]
}
"""

    if note:
        prompt += f"\n\nå·¥ç¨‹å¸ˆå¤‡æ³¨ï¼š{note}"

    try:
        response = client.chat.completions.create(
            model=VISION_MODEL,
            messages=[
                {
                    "role": "user",
                    "content": [
                        image_content,
                        {"type": "text", "text": prompt}
                    ]
                }
            ],
            response_format={"type": "json_object"},
            temperature=0.1
        )

        content = response.choices[0].message.content
        return json.loads(content)

    except Exception as e:
        print(f"GLM API Error: {e}")
        return None


def post_scene_issue_report(asset_id: str, payload: dict):
    """æäº¤åœºæ™¯é—®é¢˜æŠ¥å‘Šåˆ°åç«¯ API"""
    url = f"{BACKEND_BASE_URL}/api/v1/assets/{asset_id}/scene_issue_report"

    try:
        resp = requests.post(url, json=payload, timeout=60)
        if resp.status_code in (200, 201):
            print(f"[OK] Reported scene_issue for asset {asset_id}")
            return True
        else:
            print(f"[WARN] Failed: HTTP {resp.status_code}")
            return False
    except Exception as e:
        print(f"[ERROR] Exception: {e}")
        return False


def main():
    """ä¸»å¾ªç¯"""
    print("Starting GLM-4V scene_issue worker...")
    print(f"Backend: {BACKEND_BASE_URL}")
    print(f"Local storage: {LOCAL_STORAGE_DIR}")

    while True:
        print(f"\n[{time.strftime('%Y-%m-%d %H:%M:%S')}] Checking for pending assets...")

        assets = get_pending_scene_assets()
        print(f"Found {len(assets)} pending assets")

        for asset in assets:
            asset_id = asset.get("id")
            print(f"Processing {asset_id}...")

            # è·å–è¯¦æƒ…
            resp = requests.get(f"{BACKEND_BASE_URL}/api/v1/assets/{asset_id}")
            detail = resp.json()

            # è¯»å–å›¾ç‰‡
            image_content = get_image_content_from_detail(detail)
            if not image_content:
                continue

            # è°ƒç”¨ GLM
            note = detail.get("description") or ""
            result = call_glm_vision(image_content, note)
            if not result:
                continue

            # æäº¤ç»“æœ
            post_scene_issue_report(asset_id, result)

        # ç­‰å¾…ä¸‹ä¸€è½®
        print(f"Waiting {POLL_INTERVAL} seconds...")
        time.sleep(POLL_INTERVAL)


if __name__ == "__main__":
    main()
```

---

## å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šè¯†åˆ«ç”µè¡¨è¯»æ•°

**ç›®æ ‡**ï¼šä»ç”µè¡¨ç…§ç‰‡ä¸­æå–è¯»æ•°

**è¾“å…¥**ï¼šç”µè¡¨ç…§ç‰‡ + å¤‡æ³¨"ç”µè¡¨è¯»æ•°"

**OCR è¯†åˆ«ç»“æœ**ï¼š

```json
{
  "annotations": {
    "ocr_lines": [
      {"text": "1234.5", "confidence": 0.998},
      {"text": "kWÂ·h", "confidence": 0.996}
    ]
  },
  "stats": {
    "avg_confidence": 0.997,
    "engine": "paddleocr"
  }
}
```

**åç»­å¤„ç†**ï¼šå¯ä»¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æˆ– LLM æå–æ•°å€¼ï¼š`1234.5`

### åœºæ™¯ 2ï¼šåˆ†æç°åœºé—®é¢˜

**ç›®æ ‡**ï¼šè¯†åˆ«ç°åœºé—®é¢˜å¹¶ç»™å‡ºå»ºè®®

**è¾“å…¥**ï¼šç®¡é“æ¸—æ¼ç…§ç‰‡ + å¤‡æ³¨"ç®¡é“æ¥å£å¤„æœ‰æ¸—æ¼"

**GLM-4V åˆ†æç»“æœ**ï¼š

```json
{
  "title": "ç®¡é“æ¥å£æ¸—æ¼",
  "issue_category": "è®¾å¤‡ç»´æŠ¤",
  "severity": "medium",
  "summary": "ç®¡é“æ¥å£å¤„å‡ºç°æ¸—æ¼ï¼Œå¯èƒ½å½±å“ç³»ç»Ÿæ­£å¸¸è¿è¡Œ",
  "suspected_causes": [
    "å¯†å°å«è€åŒ–",
    "æ¥å£æ¾åŠ¨",
    "å‹åŠ›è¿‡å¤§"
  ],
  "recommended_actions": [
    "æ›´æ¢å¯†å°å«",
    "ç´§å›ºæ¥å£",
    "æ£€æŸ¥ç³»ç»Ÿå‹åŠ›"
  ],
  "confidence": 0.85,
  "tags": ["ç®¡é“", "æ¸—æ¼", "ç»´æŠ¤"]
}
```

### åœºæ™¯ 3ï¼šæ‰¹é‡å¤„ç†ç°åœºç…§ç‰‡

**å®ç°**ï¼š

```bash
# 1. ä¸Šä¼ å¤šå¼ ç°åœºé—®é¢˜ç…§ç‰‡
for file in issue_*.jpg; do
    curl -X POST "http://localhost:8000/api/v1/assets/upload_image_with_note" \
        -F "project_id=$PROJECT_ID" \
        -F "modality=image" \
        -F "content_role=scene_issue" \
        -F "file=@$file" \
        -F "note=ç°åœºé—®é¢˜ç…§ç‰‡"
done

# 2. å¯åŠ¨ GLM Workerï¼ˆä¼šè‡ªåŠ¨å¤„ç†ï¼‰
python services/worker/scene_issue_glm_worker.py

# Worker ä¼šï¼š
# - æ¯ 60 ç§’è½®è¯¢ä¸€æ¬¡
# - æ‰¾åˆ°å¾…å¤„ç†çš„å›¾ç‰‡
# - è°ƒç”¨ GLM-4V åˆ†æ
# - æäº¤ç»“æœåˆ°åç«¯
# - æ›´æ–°çŠ¶æ€ä¸º "parsed_scene_llm"
```

---

## å¸¸è§é—®é¢˜ä¸è§£å†³

### âŒ é—®é¢˜ 1ï¼šPaddleOCR é¦–æ¬¡è¿è¡Œæ…¢

**ç°è±¡**ï¼šç¬¬ä¸€æ¬¡è°ƒç”¨ OCR æ—¶å¡ä½ 2-3 åˆ†é’Ÿ

**åŸå› **ï¼šPaddleOCR é¦–æ¬¡è¿è¡Œéœ€è¦ä¸‹è½½æ¨¡å‹æ–‡ä»¶

```
ä¸‹è½½å†…å®¹ï¼š
â”œâ”€â”€ æ£€æµ‹æ¨¡å‹ï¼šch_PP-OCRv4_det_infer.tar (~4.9 MB)
â”œâ”€â”€ è¯†åˆ«æ¨¡å‹ï¼šch_PP-OCRv4_rec_infer.tar (~11 MB)
â””â”€â”€ åˆ†ç±»æ¨¡å‹ï¼šch_ppocr_mobile_v2.0_cls_infer.tar (~2.2 MB)

ä¸‹è½½ä½ç½®ï¼š
C:\Users\<ç”¨æˆ·å>\.paddleocr\whl\
```

**è§£å†³**ï¼š
- âœ… è€å¿ƒç­‰å¾…ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰
- âœ… åç»­è¿è¡Œä¼šä½¿ç”¨ç¼“å­˜ï¼Œé€Ÿåº¦å¿«
- âœ… å¯ä»¥æå‰ä¸‹è½½æ¨¡å‹åˆ°ç¦»çº¿ç¯å¢ƒ

### âŒ é—®é¢˜ 2ï¼šGLM API è°ƒç”¨å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
openai.error.AuthenticationError: Incorrect API key provided
```

**åŸå› **ï¼šAPI Key é…ç½®é”™è¯¯æˆ–æœªé…ç½®

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥ .env æ–‡ä»¶
cat .env | grep GLM_API_KEY

# åº”è¯¥è¾“å‡ºï¼š
# GLM_API_KEY=your_actual_api_key_here

# å¦‚æœæ²¡æœ‰é…ç½®ï¼Œæ·»åŠ åˆ° .envï¼š
echo "GLM_API_KEY=your_glm_api_key_here" >> .env
```

### âŒ é—®é¢˜ 3ï¼šå›¾ç‰‡æ–‡ä»¶è¯»å–å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
FileNotFoundError: Local image file not found
```

**åŸå› **ï¼š
- `BDC_LOCAL_STORAGE_DIR` é…ç½®é”™è¯¯
- æ–‡ä»¶è·¯å¾„ä¸åŒ¹é…
- æ–‡ä»¶æœªæ­£ç¡®ä¿å­˜

**è§£å†³**ï¼š
```python
# æ£€æŸ¥é…ç½®
from shared.config.settings import get_settings
settings = get_settings()
print(f"æœ¬åœ°å­˜å‚¨ç›®å½•: {settings.local_storage_dir}")

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
from pathlib import Path
file_path = Path(settings.local_storage_dir) / "project_id" / "uuid.jpg"
print(f"æ–‡ä»¶å­˜åœ¨: {file_path.exists()}")
```

---

## æœ€ä½³å®è·µ

### 1. ä½¿ç”¨æ™ºèƒ½è·¯ç”±

```python
# âœ“ æ¨èï¼šè®©ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©å¤„ç†æ–¹å¼
POST /api/v1/assets/upload_image_with_note
?content_role=meter
&auto_route=true

# æ ¹æ® content_role è‡ªåŠ¨ï¼š
# â€¢ meter â†’ OCR
# â€¢ scene_issue â†’ GLM-4V
# â€¢ å…¶ä»– â†’ ä»…å­˜å‚¨
```

### 2. ä½¿ç”¨ Worker åå°å¤„ç†

```python
# âœ“ æ¨èï¼šå¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡ API
# 1. ä¸Šä¼ å›¾ç‰‡ï¼ˆç«‹å³è¿”å›ï¼‰
POST /api/v1/assets/upload_image_with_note
?content_role=scene_issue

# 2. Worker åå°è‡ªåŠ¨å¤„ç†
# ï¼ˆæ— éœ€æ‰‹åŠ¨è§¦å‘ï¼Œè½®è¯¢å¤„ç†ï¼‰
```

### 3. å¤šç‰ˆæœ¬ç®¡ç†

```python
# âœ“ æ¨èï¼šä¿ç•™æ‰€æœ‰å†å²ç‰ˆæœ¬
# æ¯æ¬¡é‡æ–°è§£æç”Ÿæˆæ–°ç‰ˆæœ¬
# é€šè¿‡ created_at æ’åºè·å–æœ€æ–°ç‰ˆ
payloads = db.query(AssetStructuredPayload)\
    .filter(AssetStructuredPayload.asset_id == asset_id)\
    .order_by(AssetStructuredPayload.created_at.desc())\
    .all()

# æœ€æ–°ç‰ˆæœ¬
latest = payloads[0] if payloads else None
```

---

## æ€»ç»“

å¤šæ¨¡æ€æ•°æ®å¤„ç†æ¨¡å—æä¾›ï¼š

| èƒ½åŠ› | å®ç°æ–¹å¼ | æ€§èƒ½ |
|------|----------|------|
| å›¾ç‰‡æ–‡å­—è¯†åˆ« | PaddleOCR 2.7.0.3 | 4.2 ç§’/å¼  |
| åœºæ™¯é—®é¢˜åˆ†æ | GLM-4V API | 10-30 ç§’/å¼  |
| æ™ºèƒ½è·¯ç”± | content_role åˆ¤æ–­ | è‡ªåŠ¨ |
| ç»“æ„åŒ–å­˜å‚¨ | PostgreSQL + JSON | è‡ªåŠ¨ |
| ç‰ˆæœ¬ç®¡ç† | AssetStructuredPayload | è‡ªåŠ¨ |
| åå°å¤„ç† | GLM Worker | 60 ç§’è½®è¯¢ |

**ç®€å•è¯´**ï¼šè¿™ä¸ªæ¨¡å—è®©"çœ‹ä¸æ‡‚å›¾ç‰‡"çš„è®¡ç®—æœºï¼Œå˜æˆäº†"èƒ½è¯»æ‡‚å†…å®¹ + åˆ†æé—®é¢˜"çš„æ™ºèƒ½åŠ©æ‰‹ï¼

---

## ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®è§„åˆ’æ–‡æ¡£](../GUIDEBOOK/PLAN.md)
- [å¼€æºæŠ€æœ¯æ ˆæ¨è](../GUIDEBOOK/OPEN_SOURCE_RECOMMENDATIONS.md)
- [README ä¸»æ–‡æ¡£](../README.md)
- [é¡¹ç›®è¿›åº¦æ€»ç»“](../PROJECT_PROGRESS_SUMMARY.md)
- [PostgreSQL è¿ç§»æ€»ç»“](../POSTGRESQL_MIGRATION_SUMMARY.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.0
**æœ€åæ›´æ–°**: 2025-01-19
**ç»´æŠ¤è€…**: BDC-AI å¼€å‘å›¢é˜Ÿ
