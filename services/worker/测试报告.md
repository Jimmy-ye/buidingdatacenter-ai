# Worker 测试报告

**测试时间**: 2026-01-25

---

## 测试结果

### ✅ 后端连接测试
- **状态**: 通过
- **后端地址**: http://localhost:8000
- **HTTP 状态**: 200
- **说明**: 后端服务运行正常

### ✅ 配置检查
- **状态**: 通过
- **BDC_BACKEND_BASE_URL**: http://localhost:8000
- **GLM_API_KEY**: 2534e2ce718848... (已配置)
- **BDC_LOCAL_STORAGE_DIR**: ../data/assets

### ✅ 资产检查
- **状态**: 通过
- **总资产数**: 0
- **待处理数**: 0
- **说明**: 当前数据库中没有待处理的 scene_issue 资产

### ✅ GLM API 测试
- **状态**: 通过
- **API 地址**: https://open.bigmodel.cn/api/paas/v4/
- **模型**: glm-4-flash (测试)
- **说明**: API 连接成功，可以正常调用

---

## Worker 状态

### 当前运行状态
- **进程**: Worker 正在后台运行
- **轮询间隔**: 60 秒
- **模式**: 自动轮询模式

### Worker 工作流程
```
启动 Worker
    ↓
每 60 秒轮询一次
    ↓
查找 pending_scene_llm 状态的资产
    ↓
如果找到，调用 GLM-4V 分析
    ↓
回写分析结果
    ↓
更新状态为 parsed_scene_llm
```

---

## 测试 Worker 功能

### 方法 1：上传测试图片

```bash
# 1. 创建测试项目
curl -X POST "http://localhost:8000/api/v1/projects/" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Worker 测试项目",
    "client": "测试客户",
    "location": "测试地点",
    "status": "active"
  }'

# 2. 上传图片（记得替换 {PROJECT_ID}）
curl -X POST "http://localhost:8000/api/v1/assets/upload_image_with_note?project_id={PROJECT_ID}&source=mobile&content_role=scene_issue&auto_route=true" \
  -F "file=@test.jpg" \
  -F "note=管道保温层破损，需要检查"
```

### 方法 2：观察 Worker 日志

Worker 会在下次轮询时（最多 60 秒）自动处理新上传的图片。

**预期输出**:
```
[2025-01-25 15:30:00] Checking for pending scene_issue assets...
Processing asset abc123...
[OK] Reported scene_issue_report_v1 for asset abc123
```

---

## 查看 Worker 处理结果

### 通过 API 查看
```bash
# 替换 {ASSET_ID}
curl "http://localhost:8000/api/v1/assets/{ASSET_ID}"
```

### 预期结果结构
```json
{
  "id": "asset-uuid",
  "processing_status": "parsed_scene_llm",
  "structured_payloads": [
    {
      "schema_type": "scene_issue_report_v1",
      "payload": {
        "title": "管道保温层破损",
        "issue_category": "设备维护",
        "severity": "medium",
        "summary": "现场管道保温层存在明显破损...",
        "suspected_causes": [
          "保温材料老化",
          "外力损伤"
        ],
        "recommended_actions": [
          "更换破损保温层",
          "检查相邻管道"
        ],
        "confidence": 0.85,
        "tags": ["保温", "管道", "维护"]
      }
    }
  ]
}
```

---

## Worker 管理

### 查看运行状态
```bash
# 查看进程
tasklist | findstr python

# 查看网络连接
netstat -ano | findstr :8000
```

### 重启 Worker
1. 按 `Ctrl+C` 停止当前 Worker
2. 运行 `启动Worker.bat` 重新启动

### 停止 Worker
在 Worker 窗口按 `Ctrl+C`

---

## 总结

✅ **所有核心测试通过**

| 测试项 | 状态 | 说明 |
|--------|------|------|
| 后端连接 | ✅ | 服务正常 |
| 环境配置 | ✅ | 配置正确 |
| 数据库查询 | ✅ | 连接成功 |
| GLM API | ✅ | API 可用 |

**Worker 已就绪，可以正常工作。**

当前数据库中没有待处理资产，Worker 正在等待新任务上传后自动处理。
